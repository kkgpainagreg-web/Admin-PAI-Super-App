<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Guru Super App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { 50: '#ecfdf5', 100: '#d1fae5', 200: '#a7f3d0', 300: '#6ee7b7', 400: '#34d399', 500: '#10b981', 600: '#059669', 700: '#047857', 800: '#065f46', 900: '#064e3b' },
                        secondary: { 50: '#f0f9ff', 100: '#e0f2fe', 200: '#bae6fd', 300: '#7dd3fc', 400: '#38bdf8', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1', 800: '#075985', 900: '#0c4a6e' },
                        accent: { 50: '#fdf4ff', 100: '#fae8ff', 200: '#f5d0fe', 300: '#f0abfc', 400: '#e879f9', 500: '#d946ef', 600: '#c026d3', 700: '#a21caf', 800: '#86198f', 900: '#701a75' },
                        dark: { 800: '#1e293b', 900: '#0f172a' }
                    },
                    fontFamily: { 
                        sans: ['Plus Jakarta Sans', 'sans-serif'],
                        arabic: ['Amiri', 'serif']
                    }
                }
            }
        }
                // ==========================================
        // LKPD (LEMBAR KERJA PESERTA DIDIK) - COMPLETE
        // ==========================================
        function getLKPDHTML() {
            return checkPremiumAccess('LKPD') || `
                <div class="space-y-6 animate-slide-in">
                    <div class="bg-gradient-to-r from-teal-500 to-cyan-500 rounded-xl p-6 text-white">
                        <div class="flex items-start space-x-4">
                            <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-file-alt text-2xl"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg mb-1">Lembar Kerja Peserta Didik (LKPD)</h3>
                                <p class="text-teal-100 text-sm">LKPD menggunakan bahasa yang mudah dipahami siswa, berbeda dengan Modul Ajar yang untuk guru.</p>
                            </div>
                        </div>
                    </div>

                    <div class="card p-6">
                        <div class="flex flex-col md:flex-row md:items-center justify-between mb-6">
                            <h3 class="text-lg font-bold text-gray-900 mb-4 md:mb-0">Daftar LKPD</h3>
                            <button onclick="showCreateLKPDModal()" class="btn-primary text-white px-4 py-2 rounded-lg">
                                <i class="fas fa-plus mr-2"></i>Buat LKPD Baru
                            </button>
                        </div>

                        <div id="lkpdList" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div class="col-span-full text-center py-12 text-gray-500">
                                <i class="fas fa-file-alt text-5xl mb-4 text-gray-300"></i>
                                <p>Belum ada LKPD. Buat LKPD baru untuk siswa Anda.</p>
                            </div>
                        </div>
                    </div>

                    <!-- LKPD dari Modul Ajar -->
                    <div class="card p-6">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">LKPD dari Modul Ajar</h3>
                        <p class="text-gray-600 text-sm mb-4">LKPD yang otomatis dibuat dari Modul Ajar yang memiliki opsi LKPD aktif.</p>
                        <div id="lkpdFromModul" class="space-y-3">
                            <!-- Will be populated -->
                        </div>
                    </div>
                </div>
            `;
        }

        async function initLKPD() {
            if (userData?.plan !== 'premium') return;
            await loadLKPDList();
            await loadLKPDFromModul();
        }

        async function loadLKPDList() {
            try {
                const snapshot = await db.collection('users').doc(currentUser.uid)
                    .collection('lkpd').orderBy('createdAt', 'desc').get();

                const container = document.getElementById('lkpdList');
                
                if (snapshot.empty) {
                    container.innerHTML = `
                        <div class="col-span-full text-center py-12 text-gray-500">
                            <i class="fas fa-file-alt text-5xl mb-4 text-gray-300"></i>
                            <p>Belum ada LKPD. Buat LKPD baru untuk siswa Anda.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = snapshot.docs.map(doc => {
                    const lkpd = doc.data();
                    return `
                        <div class="bg-gray-50 hover:bg-gray-100 p-4 rounded-xl transition">
                            <div class="flex items-start justify-between mb-3">
                                <div class="w-10 h-10 bg-teal-100 text-teal-600 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-file-alt"></i>
                                </div>
                                <div class="flex space-x-1">
                                    <button onclick="previewLKPD('${doc.id}')" class="text-gray-400 hover:text-blue-600 p-1" title="Preview">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button onclick="printLKPD('${doc.id}')" class="text-gray-400 hover:text-primary-600 p-1" title="Cetak">
                                        <i class="fas fa-print"></i>
                                    </button>
                                    <button onclick="deleteLKPD('${doc.id}')" class="text-gray-400 hover:text-red-600 p-1" title="Hapus">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <h4 class="font-bold text-gray-900 mb-1">${lkpd.judul}</h4>
                            <p class="text-sm text-gray-500 mb-2">${lkpd.kelas} â€¢ ${lkpd.materi}</p>
                            <div class="flex items-center space-x-2 text-xs">
                                <span class="bg-teal-100 text-teal-700 px-2 py-1 rounded-full">${lkpd.jenisTugas || 'Individu'}</span>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading LKPD:', error);
            }
        }

        async function loadLKPDFromModul() {
            try {
                const snapshot = await db.collection('users').doc(currentUser.uid)
                    .collection('modul_ajar').where('hasLKPD', '==', true).get();

                const container = document.getElementById('lkpdFromModul');
                
                if (snapshot.empty) {
                    container.innerHTML = `
                        <p class="text-gray-500 text-sm">Belum ada Modul Ajar dengan LKPD aktif.</p>
                    `;
                    return;
                }

                container.innerHTML = snapshot.docs.map(doc => {
                    const modul = doc.data();
                    return `
                        <div class="flex items-center justify-between bg-gray-50 p-4 rounded-xl">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-rose-100 text-rose-600 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-book-open"></i>
                                </div>
                                <div>
                                    <h4 class="font-medium text-gray-900">${modul.judul}</h4>
                                    <p class="text-sm text-gray-500">${modul.kelas}</p>
                                </div>
                            </div>
                            <button onclick="generateLKPDFromModul('${doc.id}')" class="text-primary-600 hover:text-primary-700 font-medium text-sm">
                                <i class="fas fa-magic mr-1"></i>Generate LKPD
                            </button>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading modul:', error);
            }
        }

        function showCreateLKPDModal() {
            const modal = document.getElementById('modalContainer');
            modal.innerHTML = `
                <div class="fixed inset-0 z-50 flex items-start justify-center p-4 bg-black/50 backdrop-blur-sm overflow-y-auto">
                    <div class="bg-white rounded-2xl w-full max-w-2xl my-8">
                        <div class="sticky top-0 bg-white border-b px-6 py-4 rounded-t-2xl flex items-center justify-between">
                            <h3 class="text-xl font-bold text-gray-900">Buat LKPD Baru</h3>
                            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <form id="createLKPDForm" class="p-6 space-y-5">
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Judul LKPD</label>
                                    <input type="text" id="lkpdJudul" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl" placeholder="Contoh: Ayo Belajar Shalat!">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                                    <select id="lkpdKelas" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl bg-white">
                                        <option value="">Pilih Kelas</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Materi Pembelajaran</label>
                                <input type="text" id="lkpdMateri" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl" placeholder="Contoh: Tata Cara Shalat Fardhu">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tujuan Pembelajaran (Bahasa Siswa)</label>
                                <textarea id="lkpdTujuan" rows="2" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl" placeholder="Contoh: Setelah mengerjakan LKPD ini, kamu akan bisa mempraktikkan shalat dengan benar."></textarea>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Petunjuk Pengerjaan</label>
                                <textarea id="lkpdPetunjuk" rows="3" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl" placeholder="1. Baca dengan teliti setiap pertanyaan&#10;2. Kerjakan dengan jujur&#10;3. Tanyakan kepada guru jika ada yang tidak dipahami"></textarea>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-quran mr-1"></i>Teks Arab (opsional)
                                </label>
                                <textarea id="lkpdArabic" rows="2" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl arabic-text" dir="rtl" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ù‡Ù†Ø§..."></textarea>
                            </div>

                            <div>
                                <div class="flex items-center justify-between mb-3">
                                    <label class="block text-sm font-medium text-gray-700">Soal/Tugas</label>
                                    <button type="button" onclick="addLKPDSoal()" class="text-primary-600 hover:text-primary-700 text-sm font-medium">
                                        <i class="fas fa-plus mr-1"></i>Tambah Soal
                                    </button>
                                </div>
                                <div id="lkpdSoalContainer" class="space-y-3">
                                    <div class="bg-gray-50 p-4 rounded-xl" data-soal="1">
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="font-medium text-gray-700">Soal 1</span>
                                            <select class="text-sm px-2 py-1 border rounded-lg" data-field="tipe">
                                                <option value="essay">Essay</option>
                                                <option value="pilgan">Pilihan Ganda</option>
                                                <option value="isian">Isian Singkat</option>
                                                <option value="praktik">Praktik</option>
                                            </select>
                                        </div>
                                        <textarea class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg" rows="2" data-field="pertanyaan" placeholder="Tuliskan soal..."></textarea>
                                    </div>
                                </div>
                            </div>

                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Jenis Tugas</label>
                                    <select id="lkpdJenis" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl bg-white">
                                        <option value="individu">Individu</option>
                                        <option value="kelompok">Kelompok</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Waktu Pengerjaan</label>
                                    <input type="text" id="lkpdWaktu" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl" placeholder="Contoh: 30 menit">
                                </div>
                            </div>

                            <div class="flex justify-end space-x-3 pt-4 border-t">
                                <button type="button" onclick="closeModal()" class="px-4 py-2 border-2 border-gray-200 rounded-xl text-gray-700 hover:bg-gray-50">
                                    Batal
                                </button>
                                <button type="submit" class="btn-primary text-white px-6 py-2 rounded-xl">
                                    <i class="fas fa-save mr-2"></i>Simpan LKPD
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            // Load kelas
            db.collection('users').doc(currentUser.uid)
                .collection('kelas').orderBy('nama').get()
                .then(snapshot => {
                    const select = document.getElementById('lkpdKelas');
                    snapshot.forEach(doc => {
                        const kelas = doc.data();
                        select.innerHTML += `<option value="${kelas.nama}">${kelas.nama}</option>`;
                    });
                });

            // Form submit
            document.getElementById('createLKPDForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await saveLKPD();
            });
        }

        let lkpdSoalCount = 1;

        function addLKPDSoal() {
            lkpdSoalCount++;
            const container = document.getElementById('lkpdSoalContainer');
            const div = document.createElement('div');
            div.className = 'bg-gray-50 p-4 rounded-xl';
            div.dataset.soal = lkpdSoalCount;
            div.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <span class="font-medium text-gray-700">Soal ${lkpdSoalCount}</span>
                    <div class="flex items-center space-x-2">
                        <select class="text-sm px-2 py-1 border rounded-lg" data-field="tipe">
                            <option value="essay">Essay</option>
                            <option value="pilgan">Pilihan Ganda</option>
                            <option value="isian">Isian Singkat</option>
                            <option value="praktik">Praktik</option>
                        </select>
                        <button type="button" onclick="this.closest('[data-soal]').remove()" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <textarea class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg" rows="2" data-field="pertanyaan" placeholder="Tuliskan soal..."></textarea>
            `;
            container.appendChild(div);
        }

        async function saveLKPD() {
            showLoading();

            // Collect soal
            const soalList = [];
            document.querySelectorAll('#lkpdSoalContainer > div').forEach((div, idx) => {
                soalList.push({
                    nomor: idx + 1,
                    tipe: div.querySelector('[data-field="tipe"]').value,
                    pertanyaan: div.querySelector('[data-field="pertanyaan"]').value
                });
            });

            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('lkpd').add({
                        judul: document.getElementById('lkpdJudul').value,
                        kelas: document.getElementById('lkpdKelas').value,
                        materi: document.getElementById('lkpdMateri').value,
                        tujuan: document.getElementById('lkpdTujuan').value,
                        petunjuk: document.getElementById('lkpdPetunjuk').value,
                        teksArab: document.getElementById('lkpdArabic').value,
                        soal: soalList,
                        jenisTugas: document.getElementById('lkpdJenis').value,
                        waktu: document.getElementById('lkpdWaktu').value,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                hideLoading();
                closeModal();
                showToast('LKPD berhasil disimpan!');
                loadLKPDList();
                lkpdSoalCount = 1;
            } catch (error) {
                hideLoading();
                showToast('Gagal menyimpan: ' + error.message, 'error');
            }
        }

        async function previewLKPD(id) {
            showLoading();
            try {
                const doc = await db.collection('users').doc(currentUser.uid)
                    .collection('lkpd').doc(id).get();
                
                if (!doc.exists) {
                    hideLoading();
                    showToast('LKPD tidak ditemukan', 'error');
                    return;
                }

                const lkpd = doc.data();
                hideLoading();

                const modal = document.getElementById('modalContainer');
                modal.innerHTML = `
                    <div class="fixed inset-0 z-50 flex items-start justify-center p-4 bg-black/50 backdrop-blur-sm overflow-y-auto">
                        <div class="bg-white rounded-2xl w-full max-w-3xl my-8 print-full">
                            <div class="sticky top-0 bg-white border-b px-6 py-4 rounded-t-2xl flex items-center justify-between no-print">
                                <h3 class="text-xl font-bold text-gray-900">Preview LKPD</h3>
                                <div class="flex items-center space-x-2">
                                    <button onclick="window.print()" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200">
                                        <i class="fas fa-print mr-2"></i>Cetak
                                    </button>
                                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                                        <i class="fas fa-times text-xl"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="p-8" id="lkpdPrintArea">
                                <!-- Header -->
                                <div class="text-center mb-6 pb-4 border-b-2 border-gray-300">
                                    <h1 class="text-2xl font-bold text-gray-900 mb-1">LEMBAR KERJA PESERTA DIDIK</h1>
                                    <h2 class="text-xl font-semibold text-primary-600">${lkpd.judul}</h2>
                                </div>

                                <!-- Info -->
                                <div class="grid grid-cols-2 gap-4 mb-6 text-sm">
                                    <div class="flex">
                                        <span class="w-32 text-gray-600">Mata Pelajaran</span>
                                        <span class="font-medium">: PAI & Budi Pekerti</span>
                                    </div>
                                    <div class="flex">
                                        <span class="w-32 text-gray-600">Kelas</span>
                                        <span class="font-medium">: ${lkpd.kelas}</span>
                                    </div>
                                    <div class="flex">
                                        <span class="w-32 text-gray-600">Materi</span>
                                        <span class="font-medium">: ${lkpd.materi}</span>
                                    </div>
                                    <div class="flex">
                                        <span class="w-32 text-gray-600">Waktu</span>
                                        <span class="font-medium">: ${lkpd.waktu || '-'}</span>
                                    </div>
                                </div>

                                <!-- Identitas Siswa -->
                                <div class="bg-gray-50 p-4 rounded-lg mb-6">
                                    <div class="grid grid-cols-2 gap-4">
                                        <div class="flex items-center">
                                            <span class="w-20 text-gray-600">Nama</span>
                                            <span>: ________________________________</span>
                                        </div>
                                        <div class="flex items-center">
                                            <span class="w-20 text-gray-600">No. Absen</span>
                                            <span>: __________</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Tujuan -->
                                ${lkpd.tujuan ? `
                                <div class="mb-6">
                                    <h3 class="font-bold text-gray-900 mb-2"><i class="fas fa-bullseye text-primary-500 mr-2"></i>Tujuan Pembelajaran</h3>
                                    <p class="text-gray-700 bg-primary-50 p-3 rounded-lg">${lkpd.tujuan}</p>
                                </div>
                                ` : ''}

                                <!-- Teks Arab -->
                                ${lkpd.teksArab ? `
                                <div class="mb-6">
                                    <div class="bg-blue-50 p-4 rounded-lg">
                                        <p class="arabic-text text-2xl leading-loose">${lkpd.teksArab}</p>
                                    </div>
                                </div>
                                ` : ''}

                                <!-- Petunjuk -->
                                ${lkpd.petunjuk ? `
                                <div class="mb-6">
                                    <h3 class="font-bold text-gray-900 mb-2"><i class="fas fa-info-circle text-blue-500 mr-2"></i>Petunjuk Pengerjaan</h3>
                                    <div class="bg-blue-50 p-3 rounded-lg text-gray-700 whitespace-pre-line">${lkpd.petunjuk}</div>
                                </div>
                                ` : ''}

                                <!-- Soal -->
                                <div class="mb-6">
                                    <h3 class="font-bold text-gray-900 mb-4"><i class="fas fa-tasks text-green-500 mr-2"></i>Soal / Tugas</h3>
                                    <div class="space-y-6">
                                        ${(lkpd.soal || []).map((s, idx) => `
                                            <div class="border-l-4 border-primary-500 pl-4">
                                                <p class="font-medium text-gray-900 mb-2">${idx + 1}. ${s.pertanyaan}</p>
                                                ${s.tipe === 'essay' ? `
                                                    <div class="border-2 border-gray-200 rounded-lg p-4 min-h-[100px] bg-white">
                                                        <p class="text-gray-400 text-sm">Jawaban:</p>
                                                    </div>
                                                ` : s.tipe === 'isian' ? `
                                                    <div class="border-b-2 border-gray-300 w-full h-8"></div>
                                                ` : `
                                                    <div class="border-2 border-gray-200 rounded-lg p-4 min-h-[60px] bg-white"></div>
                                                `}
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>

                                <!-- Footer -->
                                <div class="mt-8 pt-4 border-t text-center text-sm text-gray-500">
                                    <p>Selamat mengerjakan! Semoga berhasil! ðŸŒŸ</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

            } catch (error) {
                hideLoading();
                showToast('Gagal memuat LKPD: ' + error.message, 'error');
            }
        }

        async function deleteLKPD(id) {
            if (!confirm('Hapus LKPD ini?')) return;
            
            showLoading();
            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('lkpd').doc(id).delete();
                hideLoading();
                showToast('LKPD berhasil dihapus!');
                loadLKPDList();
            } catch (error) {
                hideLoading();
                showToast('Gagal menghapus: ' + error.message, 'error');
            }
        }

        // ==========================================
        // BANK SOAL - COMPLETE
        // ==========================================
        function getBankSoalHTML() {
            return checkPremiumAccess('Bank Soal') || `
                <div class="space-y-6 animate-slide-in">
                    <div class="bg-gradient-to-r from-orange-500 to-amber-500 rounded-xl p-6 text-white">
                        <div class="flex items-start space-x-4">
                            <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-question-circle text-2xl"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg mb-1">Bank Soal PAI</h3>
                                <p class="text-orange-100 text-sm">Kelola koleksi soal berdasarkan ATP dengan dukungan teks Arab.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Filter & Stats -->
                    <div class="grid md:grid-cols-4 gap-4">
                        <div class="bg-white p-4 rounded-xl border">
                            <p class="text-2xl font-bold text-gray-900" id="totalSoal">0</p>
                            <p class="text-sm text-gray-500">Total Soal</p>
                        </div>
                        <div class="bg-white p-4 rounded-xl border">
                            <p class="text-2xl font-bold text-blue-600" id="soalPG">0</p>
                            <p class="text-sm text-gray-500">Pilihan Ganda</p>
                        </div>
                        <div class="bg-white p-4 rounded-xl border">
                            <p class="text-2xl font-bold text-green-600" id="soalEssay">0</p>
                            <p class="text-sm text-gray-500">Essay</p>
                        </div>
                        <div class="bg-white p-4 rounded-xl border">
                            <p class="text-2xl font-bold text-purple-600" id="soalIsian">0</p>
                            <p class="text-sm text-gray-500">Isian</p>
                        </div>
                    </div>

                    <div class="card p-6">
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                            <div class="flex flex-wrap gap-3">
                                <select id="filterElemen" class="px-4 py-2 border-2 border-gray-200 rounded-xl bg-white" onchange="filterSoal()">
                                    <option value="">Semua Elemen</option>
                                    <option value="Al-Qur'an dan Hadis">Al-Qur'an dan Hadis</option>
                                    <option value="Akidah">Akidah</option>
                                    <option value="Akhlak">Akhlak</option>
                                    <option value="Fikih">Fikih</option>
                                    <option value="Sejarah">Sejarah Peradaban Islam</option>
                                </select>
                                <select id="filterTipe" class="px-4 py-2 border-2 border-gray-200 rounded-xl bg-white" onchange="filterSoal()">
                                    <option value="">Semua Tipe</option>
                                    <option value="pilgan">Pilihan Ganda</option>
                                    <option value="essay">Essay</option>
                                    <option value="isian">Isian Singkat</option>
                                </select>
                                <select id="filterKesulitan" class="px-4 py-2 border-2 border-gray-200 rounded-xl bg-white" onchange="filterSoal()">
                                    <option value="">Semua Level</option>
                                    <option value="mudah">Mudah (C1-C2)</option>
                                    <option value="sedang">Sedang (C3-C4)</option>
                                    <option value="sulit">Sulit (C5-C6)</option>
                                </select>
                            </div>
                            <button onclick="showAddSoalModal()" class="btn-primary text-white px-4 py-2 rounded-lg whitespace-nowrap">
                                <i class="fas fa-plus mr-2"></i>Tambah Soal
                            </button>
                        </div>

                        <div id="soalList" class="space-y-4">
                            <div class="text-center py-12 text-gray-500">
                                <i class="fas fa-question-circle text-5xl mb-4 text-gray-300"></i>
                                <p>Belum ada soal. Tambahkan soal untuk membangun bank soal.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Generate Soal dari ATP -->
                    <div class="card p-6">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">
                            <i class="fas fa-magic text-purple-500 mr-2"></i>Generate Soal dari ATP
                        </h3>
                        <p class="text-gray-600 text-sm mb-4">Pilih ATP yang sudah dibuat untuk generate soal otomatis.</p>
                        <div class="flex flex-wrap gap-3">
                            <select id="atpForSoal" class="flex-1 px-4 py-2 border-2 border-gray-200 rounded-xl bg-white">
                                <option value="">Pilih ATP</option>
                            </select>
                            <input type="number" id="jumlahSoalGenerate" min="1" max="20" value="5" class="w-24 px-4 py-2 border-2 border-gray-200 rounded-xl" placeholder="Jumlah">
                            <button onclick="generateSoalFromATP()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-xl transition">
                                <i class="fas fa-bolt mr-2"></i>Generate
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function initBankSoal() {
            if (userData?.plan !== 'premium') return;
            await loadSoalList();
            await loadATPForSoal();
        }

        async function loadSoalList() {
            try {
                const snapshot = await db.collection('users').doc(currentUser.uid)
                    .collection('bank_soal').orderBy('createdAt', 'desc').get();

                const container = document.getElementById('soalList');
                let totalPG = 0, totalEssay = 0, totalIsian = 0;
                
                if (snapshot.empty) {
                    container.innerHTML = `
                        <div class="text-center py-12 text-gray-500">
                            <i class="fas fa-question-circle text-5xl mb-4 text-gray-300"></i>
                            <p>Belum ada soal. Tambahkan soal untuk membangun bank soal.</p>
                        </div>
                    `;
                    document.getElementById('totalSoal').textContent = '0';
                    document.getElementById('soalPG').textContent = '0';
                    document.getElementById('soalEssay').textContent = '0';
                    document.getElementById('soalIsian').textContent = '0';
                    return;
                }

                container.innerHTML = snapshot.docs.map(doc => {
                    const soal = doc.data();
                    if (soal.tipe === 'pilgan') totalPG++;
                    else if (soal.tipe === 'essay') totalEssay++;
                    else totalIsian++;

                    const levelColors = {
                        mudah: 'bg-green-100 text-green-700',
                        sedang: 'bg-yellow-100 text-yellow-700',
                        sulit: 'bg-red-100 text-red-700'
                    };

                    return `
                        <div class="border rounded-xl p-4 hover:border-primary-300 transition">
                            <div class="flex items-start justify-between mb-3">
                                <div class="flex items-center space-x-2">
                                    <span class="text-xs ${levelColors[soal.kesulitan] || 'bg-gray-100 text-gray-700'} px-2 py-1 rounded-full">${soal.kesulitan || 'sedang'}</span>
                                    <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full">${soal.tipe}</span>
                                    <span class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded-full">${soal.elemen}</span>
                                </div>
                                <div class="flex space-x-1">
                                    <button onclick="editSoal('${doc.id}')" class="text-gray-400 hover:text-primary-600 p-1">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteSoal('${doc.id}')" class="text-gray-400 hover:text-red-600 p-1">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <p class="text-gray-900 mb-2">${soal.pertanyaan}</p>
                            ${soal.teksArab ? `<p class="arabic-text text-xl text-blue-800 bg-blue-50 p-2 rounded mb-2">${soal.teksArab}</p>` : ''}
                            ${soal.tipe === 'pilgan' && soal.opsi ? `
                                <div class="grid grid-cols-2 gap-2 text-sm mt-3">
                                    ${soal.opsi.map((opt, idx) => `
                                        <div class="flex items-center space-x-2 ${soal.jawaban === idx ? 'text-green-600 font-medium' : 'text-gray-600'}">
                                            <span class="w-6 h-6 rounded-full ${soal.jawaban === idx ? 'bg-green-100' : 'bg-gray-100'} flex items-center justify-center text-xs">${String.fromCharCode(65 + idx)}</span>
                                            <span>${opt}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');

                document.getElementById('totalSoal').textContent = snapshot.size;
                document.getElementById('soalPG').textContent = totalPG;
                document.getElementById('soalEssay').textContent = totalEssay;
                document.getElementById('soalIsian').textContent = totalIsian;

            } catch (error) {
                console.error('Error loading soal:', error);
            }
        }

        async function loadATPForSoal() {
            try {
                const snapshot = await db.collection('users').doc(currentUser.uid)
                    .collection('atp').get();
                
                const select = document.getElementById('atpForSoal');
                snapshot.forEach(doc => {
                    const atp = doc.data();
                    select.innerHTML += `<option value="${doc.id}">${atp.faseNama} - ${atp.elemenNama}</option>`;
                });
            } catch (error) {
                console.error('Error loading ATP:', error);
            }
        }

        function showAddSoalModal() {
            const modal = document.getElementById('modalContainer');
            modal.innerHTML = `
                <div class="fixed inset-0 z-50 flex items-start justify-center p-4 bg-black/50 backdrop-blur-sm overflow-y-auto">
                    <div class="bg-white rounded-2xl w-full max-w-2xl my-8">
                        <div class="sticky top-0 bg-white border-b px-6 py-4 rounded-t-2xl flex items-center justify-between">
                            <h3 class="text-xl font-bold text-gray-900">Tambah Soal Baru</h3>
                            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <form id="addSoalForm" class="p-6 space-y-5">
                            <div class="grid md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipe Soal</label>
                                    <select id="soalTipe" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl bg-white" onchange="toggleOpsiPilgan()">
                                        <option value="pilgan">Pilihan Ganda</option>
                                        <option value="essay">Essay</option>
                                        <option value="isian">Isian Singkat</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Elemen</label>
                                    <select id="soalElemen" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl bg-white">
                                        <option value="Al-Qur'an dan Hadis">Al-Qur'an dan Hadis</option>
                                        <option value="Akidah">Akidah</option>
                                        <option value="Akhlak">Akhlak</option>
                                        <option value="Fikih">Fikih</option>
                                        <option value="Sejarah">Sejarah Peradaban Islam</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tingkat Kesulitan</label>
                                    <select id="soalKesulitan" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl bg-white">
                                        <option value="mudah">Mudah (C1-C2)</option>
                                        <option value="sedang">Sedang (C3-C4)</option>
                                        <option value="sulit">Sulit (C5-C6)</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Pertanyaan</label>
                                <textarea id="soalPertanyaan" rows="3" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl" placeholder="Tuliskan pertanyaan..."></textarea>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-quran mr-1"></i>Teks Arab (opsional)
                                </label>
                                <textarea id="soalArabic" rows="2" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl arabic-text" dir="rtl" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ù‡Ù†Ø§..."></textarea>
                            </div>

                            <!-- Opsi Pilihan Ganda -->
                            <div id="opsiPilganContainer">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Opsi Jawaban</label>
                                <div class="space-y-3">
                                    <div class="flex items-center space-x-3">
                                        <input type="radio" name="jawabanBenar" value="0" class="w-5 h-5 text-primary-600">
                                        <span class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center font-medium">A</span>
                                        <input type="text" id="opsiA" class="flex-1 px-3 py-2 border-2 border-gray-200 rounded-lg" placeholder="Opsi A">
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        <input type="radio" name="jawabanBenar" value="1" class="w-5 h-5 text-primary-600">
                                        <span class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center font-medium">B</span>
                                        <input type="text" id="opsiB" class="flex-1 px-3 py-2 border-2 border-gray-200 rounded-lg" placeholder="Opsi B">
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        <input type="radio" name="jawabanBenar" value="2" class="w-5 h-5 text-primary-600">
                                        <span class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center font-medium">C</span>
                                        <input type="text" id="opsiC" class="flex-1 px-3 py-2 border-2 border-gray-200 rounded-lg" placeholder="Opsi C">
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        <input type="radio" name="jawabanBenar" value="3" class="w-5 h-5 text-primary-600">
                                        <span class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center font-medium">D</span>
                                        <input type="text" id="opsiD" class="flex-1 px-3 py-2 border-2 border-gray-200 rounded-lg" placeholder="Opsi D">
                                    </div>
                                </div>
                                <p class="text-xs text-gray-500 mt-2"><i class="fas fa-info-circle mr-1"></i>Pilih radio button untuk jawaban yang benar</p>
                            </div>

                            <!-- Kunci Jawaban Essay/Isian -->
                            <div id="kunciJawabanContainer" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Kunci Jawaban</label>
                                <textarea id="kunciJawaban" rows="2" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl" placeholder="Tuliskan kunci jawaban..."></textarea>
                            </div>

                            <div class="flex justify-end space-x-3 pt-4 border-t">
                                <button type="button" onclick="closeModal()" class="px-4 py-2 border-2 border-gray-200 rounded-xl text-gray-700 hover:bg-gray-50">
                                    Batal
                                </button>
                                <button type="submit" class="btn-primary text-white px-6 py-2 rounded-xl">
                                    <i class="fas fa-save mr-2"></i>Simpan Soal
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            // Form submit
            document.getElementById('addSoalForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await saveSoal();
            });
        }

        function toggleOpsiPilgan() {
            const tipe = document.getElementById('soalTipe').value;
            const opsiContainer = document.getElementById('opsiPilganContainer');
            const kunciContainer = document.getElementById('kunciJawabanContainer');

            if (tipe === 'pilgan') {
                opsiContainer.classList.remove('hidden');
                kunciContainer.classList.add('hidden');
            } else {
                opsiContainer.classList.add('hidden');
                kunciContainer.classList.remove('hidden');
            }
        }

        async function saveSoal() {
            showLoading();

            const tipe = document.getElementById('soalTipe').value;
            let soalData = {
                tipe,
                elemen: document.getElementById('soalElemen').value,
                kesulitan: document.getElementById('soalKesulitan').value,
                pertanyaan: document.getElementById('soalPertanyaan').value,
                teksArab: document.getElementById('soalArabic').value,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (tipe === 'pilgan') {
                soalData.opsi = [
                    document.getElementById('opsiA').value,
                    document.getElementById('opsiB').value,
                    document.getElementById('opsiC').value,
                    document.getElementById('opsiD').value
                ];
                const jawabanBenar = document.querySelector('input[name="jawabanBenar"]:checked');
                soalData.jawaban = jawabanBenar ? parseInt(jawabanBenar.value) : 0;
            } else {
                soalData.kunciJawaban = document.getElementById('kunciJawaban').value;
            }

            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('bank_soal').add(soalData);

                hideLoading();
                closeModal();
                showToast('Soal berhasil disimpan!');
                loadSoalList();
            } catch (error) {
                hideLoading();
                showToast('Gagal menyimpan: ' + error.message, 'error');
            }
        }

        async function deleteSoal(id) {
            if (!confirm('Hapus soal ini?')) return;
            
            showLoading();
            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('bank_soal').doc(id).delete();
                hideLoading();
                showToast('Soal berhasil dihapus!');
                loadSoalList();
            } catch (error) {
                hideLoading();
                showToast('Gagal menghapus: ' + error.message, 'error');
            }
        }

        // ==========================================
        // JURNAL PEMBELAJARAN - COMPLETE
        // ==========================================
        function getJurnalHTML() {
            return checkPremiumAccess('Jurnal Pembelajaran') || `
                <div class="space-y-6 animate-slide-in">
                    <div class="bg-gradient-to-r from-emerald-500 to-teal-500 rounded-xl p-6 text-white">
                        <div class="flex items-start space-x-4">
                            <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-book text-2xl"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg mb-1">Jurnal Pembelajaran</h3>
                                <p class="text-emerald-100 text-sm">Catat kegiatan pembelajaran harian. Data otomatis diambil dari jadwal dan modul ajar.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Filter -->
                    <div class="card p-4">
                        <div class="flex flex-wrap gap-4">
                            <div class="flex-1 min-w-[200px]">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                                <select id="jurnalKelas" class="w-full px-4 py-2 border-2 border-gray-200 rounded-xl bg-white" onchange="loadJurnalByKelas()">
                                    <option value="">Semua Kelas</option>
                                </select>
                            </div>
                            <div class="flex-1 min-w-[200px]">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Bulan</label>
                                <input type="month" id="jurnalBulan" class="w-full px-4 py-2 border-2 border-gray-200 rounded-xl" onchange="loadJurnalByKelas()">
                            </div>
                            <div class="flex items-end">
                                <button onclick="showAddJurnalModal()" class="btn-primary text-white px-4 py-2 rounded-xl h-[42px]">
                                    <i class="fas fa-plus mr-2"></i>Tambah Jurnal
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Jurnal List -->
                    <div class="card p-6">
                        <div id="jurnalList" class="space-y-4">
                            <div class="text-center py-12 text-gray-500">
                                <i class="fas fa-book text-5xl mb-4 text-gray-300"></i>
                                <p>Belum ada jurnal pembelajaran.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Add from Schedule -->
                    <div class="card p-6">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">
                            <i class="fas fa-calendar-check text-blue-500 mr-2"></i>Jadwal Hari Ini
                        </h3>
                        <div id="jadwalHariIni" class="space-y-3">
                            <!-- Will be populated -->
                        </div>
                    </div>
                </div>
            `;
        }

        async function initJurnal() {
            if (userData?.plan !== 'premium') return;
            
            // Set default month
            const now = new Date();
            document.getElementById('jurnalBulan').value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            
            // Load kelas
            const snapshot = await db.collection('users').doc(currentUser.uid)
                .collection('kelas').orderBy('nama').get();
            
            const select = document.getElementById('jurnalKelas');
            snapshot.forEach(doc => {
                const kelas = doc.data();
                select.innerHTML += `<option value="${doc.id}">${kelas.nama}</option>`;
            });

            await loadJurnalByKelas();
            await loadJadwalHariIni();
        }

        async function loadJurnalByKelas() {
            const kelasId = document.getElementById('jurnalKelas').value;
            const bulan = document.getElementById('jurnalBulan').value;

            try {
                let query = db.collection('users').doc(currentUser.uid)
                    .collection('jurnal').orderBy('tanggal', 'desc');

                if (kelasId) {
                    query = query.where('kelasId', '==', kelasId);
                }

                const snapshot = await query.limit(50).get();
                const container = document.getElementById('jurnalList');

                if (snapshot.empty) {
                    container.innerHTML = `
                        <div class="text-center py-12 text-gray-500">
                            <i class="fas fa-book text-5xl mb-4 text-gray-300"></i>
                            <p>Belum ada jurnal pembelajaran.</p>
                        </div>
                    `;
                    return;
                }

                const hariNames = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];

                container.innerHTML = snapshot.docs.map(doc => {
                    const jurnal = doc.data();
                    const tanggal = jurnal.tanggal?.toDate ? jurnal.tanggal.toDate() : new Date(jurnal.tanggal);
                    const hari = hariNames[tanggal.getDay()];

                    return `
                        <div class="border rounded-xl p-4 hover:border-primary-300 transition">
                            <div class="flex items-start justify-between mb-3">
                                <div class="flex items-center space-x-3">
                                    <div class="w-12 h-12 bg-emerald-100 text-emerald-600 rounded-xl flex flex-col items-center justify-center">
                                        <span class="text-xs">${hari.substring(0, 3)}</span>
                                        <span class="font-bold">${tanggal.getDate()}</span>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-gray-900">${jurnal.namaKelas}</h4>
                                        <p class="text-sm text-gray-500">Jam ke-${jurnal.jamKe} â€¢ ${jurnal.jamMulai || ''}</p>
                                    </div>
                                </div>
                                <div class="flex space-x-1">
                                    <button onclick="editJurnal('${doc.id}')" class="text-gray-400 hover:text-primary-600 p-1">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteJurnal('${doc.id}')" class="text-gray-400 hover:text-red-600 p-1">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-3 mb-3">
                                <p class="text-sm text-gray-700"><strong>Materi:</strong> ${jurnal.materi}</p>
                                <p class="text-sm text-gray-600 mt-1"><strong>Kegiatan:</strong> ${jurnal.kegiatan}</p>
                            </div>
                            <div class="flex items-center justify-between text-sm">
                                <div class="flex items-center space-x-4">
                                    <span class="text-green-600"><i class="fas fa-check-circle mr-1"></i>Hadir: ${jurnal.hadir || 0}</span>
                                    <span class="text-red-600"><i class="fas fa-times-circle mr-1"></i>Tidak Hadir: ${jurnal.tidakHadir || 0}</span>
                                </div>
                                ${jurnal.catatan ? `<span class="text-gray-500"><i class="fas fa-sticky-note mr-1"></i>Ada catatan</span>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading jurnal:', error);
            }
        }

        async function loadJadwalHariIni() {
            const today = new Date().getDay();
            const hariIndex = today === 0 ? 6 : today - 1; // Convert to Monday = 0

            try {
                const snapshot = await db.collection('users').doc(currentUser.uid)
                    .collection('jadwal').where('hari', '==', hariIndex).get();

                const container = document.getElementById('jadwalHariIni');

                if (snapshot.empty) {
                    container.innerHTML = `<p class="text-gray-500 text-sm">Tidak ada jadwal hari ini.</p>`;
                    return;
                }

                container.innerHTML = snapshot.docs.map(doc => {
                    const jadwal = doc.data();
                    return `
                        <div class="flex items-center justify-between bg-blue-50 p-3 rounded-xl">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-blue-100 text-blue-600 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div>
                                    <p class="font-medium text-gray-900">${jadwal.namaKelas}</p>
                                    <p class="text-sm text-gray-500">${jadwal.jamMulai} - ${jadwal.jamSelesai}</p>
                                </div>
                            </div>
                            <button onclick="quickAddJurnal('${doc.id}', '${jadwal.namaKelas}', '${jadwal.kelasId}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1.5 rounded-lg text-sm transition">
                                <i class="fas fa-plus mr-1"></i>Isi Jurnal
                            </button>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading jadwal:', error);
            }
        }

        function showAddJurnalModal() {
            const modal = document.getElementById('modalContainer');
            modal.innerHTML = `
                <div class="fixed inset-0 z-50 flex items-start justify-center p-4 bg-black/50 backdrop-blur-sm overflow-y-auto">
                    <div class="bg-white rounded-2xl w-full max-w-xl my-8">
                        <div class="sticky top-0 bg-white border-b px-6 py-4 rounded-t-2xl flex items-center justify-between">
                            <h3 class="text-xl font-bold text-gray-900">Tambah Jurnal Pembelajaran</h3>
                            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <form id="addJurnalForm" class="p-6 space-y-5">
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                                    <input type="date" id="jurnalTanggal" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl" value="${new Date().toISOString().split('T')[0]}">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                                    <select id="jurnalKelasInput" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl bg-white">
                                        <option value="">Pilih Kelas</option>
                                    </select>
                                </div>
                            </div>

                            <div class="grid md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Jam Ke</label>
                                    <input type="text" id="jurnalJamKe" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl" placeholder="1-2">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Hadir</label>
                                    <input type="number" id="jurnalHadir" min="0" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl" placeholder="30">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tidak Hadir</label>
                                    <input type="number" id="jurnalTidakHadir" min="0" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl" placeholder="2">
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Materi Pembelajaran</label>
                                <input type="text" id="jurnalMateriInput" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl" placeholder="Contoh: Rukun Iman">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Kegiatan Pembelajaran</label>
                                <textarea id="jurnalKegiatan" rows="3" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl" placeholder="Jelaskan kegiatan pembelajaran yang dilakukan..."></textarea>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Catatan (opsional)</label>
                                <textarea id="jurnalCatatan" rows="2" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl" placeholder="Catatan tambahan, kendala, atau refleksi..."></textarea>
                            </div>

                            <div class="flex justify-end space-x-3 pt-4 border-t">
                                <button type="button" onclick="closeModal()" class="px-4 py-2 border-2 border-gray-200 rounded-xl text-gray-700 hover:bg-gray-50">
                                    Batal
                                </button>
                                <button type="submit" class="btn-primary text-white px-6 py-2 rounded-xl">
                                    <i class="fas fa-save mr-2"></i>Simpan
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            // Load kelas
            db.collection('users').doc(currentUser.uid)
                .collection('kelas').orderBy('nama').get()
                .then(snapshot => {
                    const select = document.getElementById('jurnalKelasInput');
                    snapshot.forEach(doc => {
                        const kelas = doc.data();
                        select.innerHTML += `<option value="${doc.id}" data-nama="${kelas.nama}">${kelas.nama}</option>`;
                    });
                });

            // Form submit
            document.getElementById('addJurnalForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await saveJurnal();
            });
        }

        async function saveJurnal() {
            showLoading();

            const kelasSelect = document.getElementById('jurnalKelasInput');
            const kelasId = kelasSelect.value;
            const namaKelas = kelasSelect.selectedOptions[0]?.dataset.nama || '';

            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('jurnal').add({
                        tanggal: new Date(document.getElementById('jurnalTanggal').value),
                        kelasId,
                        namaKelas,
                        jamKe: document.getElementById('jurnalJamKe').value,
                        hadir: parseInt(document.getElementById('jurnalHadir').value) || 0,
                        tidakHadir: parseInt(document.getElementById('jurnalTidakHadir').value) || 0,
                        materi: document.getElementById('jurnalMateriInput').value,
                        kegiatan: document.getElementById('jurnalKegiatan').value,
                        catatan: document.getElementById('jurnalCatatan').value,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                hideLoading();
                closeModal();
                showToast('Jurnal berhasil disimpan!');
                loadJurnalByKelas();
            } catch (error) {
                hideLoading();
                showToast('Gagal menyimpan: ' + error.message, 'error');
            }
        }

        async function deleteJurnal(id) {
            if (!confirm('Hapus jurnal ini?')) return;
            
            showLoading();
            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('jurnal').doc(id).delete();
                hideLoading();
                showToast('Jurnal berhasil dihapus!');
                loadJurnalByKelas();
            } catch (error) {
                hideLoading();
                showToast('Gagal menghapus: ' + error.message, 'error');
            }
        }

        // ==========================================
        // ABSENSI - COMPLETE
        // ==========================================
        function getAbsensiHTML() {
            return `
                <div class="space-y-6 animate-slide-in">
                    <div class="bg-gradient-to-r from-blue-500 to-indigo-500 rounded-xl p-6 text-white">
                        <div class="flex items-start space-x-4">
                            <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-user-check text-2xl"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg mb-1">Absensi Siswa</h3>
                                <p class="text-blue-100 text-sm">Kelola kehadiran siswa per kelas dan per pertemuan.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Filter -->
                    <div class="card p-4">
                        <div class="flex flex-wrap gap-4">
                            <div class="flex-1 min-w-[200px]">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                                <select id="absensiKelasSelect" class="w-full px-4 py-2 border-2 border-gray-200 rounded-xl bg-white" onchange="loadAbsensiKelas()">
                                    <option value="">Pilih Kelas</option>
                                </select>
                            </div>
                            <div class="flex-1 min-w-[200px]">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                                <input type="date" id="absensiTanggal" class="w-full px-4 py-2 border-2 border-gray-200 rounded-xl" value="${new Date().toISOString().split('T')[0]}" onchange="loadAbsensiKelas()">
                            </div>
                            <div class="flex items-end">
                                <button onclick="saveAbsensi()" class="btn-primary text-white px-4 py-2 rounded-xl h-[42px]">
                                    <i class="fas fa-save mr-2"></i>Simpan
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Absensi Table -->
                    <div class="card p-6">
                        <div id="absensiContent" class="text-center py-12 text-gray-500">
                            <i class="fas fa-user-check text-5xl mb-4 text-gray-300"></i>
                            <p>Pilih kelas untuk melihat dan mengisi absensi</p>
                        </div>
                    </div>

                    <!-- Rekap -->
                    <div class="card p-6">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Rekap Kehadiran</h3>
                        <div id="rekapAbsensi" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="bg-green-50 p-4 rounded-xl text-center">
                                <p class="text-3xl font-bold text-green-600" id="totalHadirAbsen">0</p>
                                <p class="text-sm text-gray-600">Hadir</p>
                            </div>
                            <div class="bg-yellow-50 p-4 rounded-xl text-center">
                                <p class="text-3xl font-bold text-yellow-600" id="totalIzinAbsen">0</p>
                                <p class="text-sm text-gray-600">Izin</p>
                            </div>
                            <div class="bg-blue-50 p-4 rounded-xl text-center">
                                <p class="text-3xl font-bold text-blue-600" id="totalSakitAbsen">0</p>
                                <p class="text-sm text-gray-600">Sakit</p>
                            </div>
                            <div class="bg-red-50 p-4 rounded-xl text-center">
                                <p class="text-3xl font-bold text-red-600" id="totalAlphaAbsen">0</p>
                                <p class="text-sm text-gray-600">Alpha</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function initAbsensi() {
            const snapshot = await db.collection('users').doc(currentUser.uid)
                .collection('kelas').orderBy('nama').get();
            
            const select = document.getElementById('absensiKelasSelect');
            snapshot.forEach(doc => {
                const kelas = doc.data();
                select.innerHTML += `<option value="${doc.id}" data-nama="${kelas.nama}">${kelas.nama}</option>`;
            });
        }

        async function loadAbsensiKelas() {
            const kelasId = document.getElementById('absensiKelasSelect').value;
            const tanggal = document.getElementById('absensiTanggal').value;
            
            if (!kelasId) {
                document.getElementById('absensiContent').innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <i class="fas fa-user-check text-5xl mb-4 text-gray-300"></i>
                        <p>Pilih kelas untuk melihat dan mengisi absensi</p>
                    </div>
                `;
                return;
            }

            showLoading();

            try {
                // Load siswa
                const siswaSnap = await db.collection('users').doc(currentUser.uid)
                    .collection('siswa').where('kelasId', '==', kelasId).orderBy('nama').get();

                // Load existing absensi
                const absensiSnap = await db.collection('users').doc(currentUser.uid)
                    .collection('absensi').doc(`${kelasId}_${tanggal}`).get();
                
                const existingAbsensi = absensiSnap.exists ? absensiSnap.data().data || {} : {};

                const container = document.getElementById('absensiContent');

                if (siswaSnap.empty) {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-users text-4xl text-gray-300 mb-3"></i>
                            <p class="text-gray-500 mb-4">Belum ada data siswa di kelas ini.</p>
                            <button onclick="navigateTo('import')" class="text-primary-600 hover:underline">Import Data Siswa</button>
                        </div>
                    `;
                    hideLoading();
                    return;
                }

                container.innerHTML = `
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase w-12">No</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Nama Siswa</th>
                                    <th class="px-4 py-3 text-center text-xs font-semibold text-gray-500 uppercase w-20">Hadir</th>
                                    <th class="px-4 py-3 text-center text-xs font-semibold text-gray-500 uppercase w-20">Izin</th>
                                    <th class="px-4 py-3 text-center text-xs font-semibold text-gray-500 uppercase w-20">Sakit</th>
                                    <th class="px-4 py-3 text-center text-xs font-semibold text-gray-500 uppercase w-20">Alpha</th>
                                </tr>
                            </thead>
                            <tbody id="absensiTableBody">
                                ${siswaSnap.docs.map((doc, idx) => {
                                    const siswa = doc.data();
                                    const status = existingAbsensi[doc.id] || 'H';
                                    return `
                                        <tr class="border-t" data-siswa-id="${doc.id}">
                                            <td class="px-4 py-3 text-center">${idx + 1}</td>
                                            <td class="px-4 py-3 font-medium">${siswa.nama}</td>
                                            <td class="px-4 py-3 text-center">
                                                <input type="radio" name="absen_${doc.id}" value="H" ${status === 'H' ? 'checked' : ''} class="w-5 h-5 text-green-600" onchange="updateRekapAbsensi()">
                                            </td>
                                            <td class="px-4 py-3 text-center">
                                                <input type="radio" name="absen_${doc.id}" value="I" ${status === 'I' ? 'checked' : ''} class="w-5 h-5 text-yellow-600" onchange="updateRekapAbsensi()">
                                            </td>
                                            <td class="px-4 py-3 text-center">
                                                <input type="radio" name="absen_${doc.id}" value="S" ${status === 'S' ? 'checked' : ''} class="w-5 h-5 text-blue-600" onchange="updateRekapAbsensi()">
                                            </td>
                                            <td class="px-4 py-3 text-center">
                                                <input type="radio" name="absen_${doc.id}" value="A" ${status === 'A' ? 'checked' : ''} class="w-5 h-5 text-red-600" onchange="updateRekapAbsensi()">
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;

                hideLoading();
                updateRekapAbsensi();

            } catch (error) {
                hideLoading();
                showToast('Gagal memuat data: ' + error.message, 'error');
            }
        }

        function updateRekapAbsensi() {
            let hadir = 0, izin = 0, sakit = 0, alpha = 0;

            document.querySelectorAll('#absensiTableBody input[type="radio"]:checked').forEach(radio => {
                switch(radio.value) {
                    case 'H': hadir++; break;
                    case 'I': izin++; break;
                    case 'S': sakit++; break;
                    case 'A': alpha++; break;
                }
            });

            document.getElementById('totalHadirAbsen').textContent = hadir;
            document.getElementById('totalIzinAbsen').textContent = izin;
            document.getElementById('totalSakitAbsen').textContent = sakit;
            document.getElementById('totalAlphaAbsen').textContent = alpha;
        }

        async function saveAbsensi() {
            const kelasId = document.getElementById('absensiKelasSelect').value;
            const tanggal = document.getElementById('absensiTanggal').value;
            const namaKelas = document.getElementById('absensiKelasSelect').selectedOptions[0]?.dataset.nama || '';

            if (!kelasId) {
                showToast('Pilih kelas terlebih dahulu', 'error');
                return;
            }

            showLoading();

            const data = {};
            document.querySelectorAll('#absensiTableBody tr').forEach(row => {
                const siswaId = row.dataset.siswaId;
                const checkedRadio = row.querySelector('input[type="radio"]:checked');
                if (siswaId && checkedRadio) {
                    data[siswaId] = checkedRadio.value;
                }
            });

            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('absensi').doc(`${kelasId}_${tanggal}`).set({
                        kelasId,
                        namaKelas,
                        tanggal,
                        data,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                hideLoading();
                showToast('Absensi berhasil disimpan!');
            } catch (error) {
                hideLoading();
                showToast('Gagal menyimpan: ' + error.message, 'error');
            }
        }

        // ==========================================
        // DAFTAR NILAI - COMPLETE
        // ==========================================
        function getNilaiHTML() {
            return `
                <div class="space-y-6 animate-slide-in">
                    <div class="bg-gradient-to-r from-yellow-500 to-orange-500 rounded-xl p-6 text-white">
                        <div class="flex items-start space-x-4">
                            <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-star text-2xl"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg mb-1">Daftar Nilai</h3>
                                <p class="text-yellow-100 text-sm">Kelola nilai formatif dan sumatif siswa.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Filter -->
                    <div class="card p-4">
                        <div class="flex flex-wrap gap-4">
                            <div class="flex-1 min-w-[150px]">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                                <select id="nilaiKelasSelect" class="w-full px-4 py-2 border-2 border-gray-200 rounded-xl bg-white" onchange="loadNilaiKelas()">
                                    <option value="">Pilih Kelas</option>
                                </select>
                            </div>
                            <div class="flex-1 min-w-[150px]">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Jenis Penilaian</label>
                                <select id="nilaiJenisSelect" class="w-full px-4 py-2 border-2 border-gray-200 rounded-xl bg-white" onchange="loadNilaiKelas()">
                                    <option value="formatif">Penilaian Formatif</option>
                                    <option value="sumatif">Penilaian Sumatif</option>
                                </select>
                            </div>
                            <div class="flex-1 min-w-[150px]">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Elemen</label>
                                <select id="nilaiElemenSelect" class="w-full px-4 py-2 border-2 border-gray-200 rounded-xl bg-white" onchange="loadNilaiKelas()">
                                    <option value="">Semua Elemen</option>
                                    <option value="Al-Qur'an">Al-Qur'an dan Hadis</option>
                                    <option value="Akidah">Akidah</option>
                                    <option value="Akhlak">Akhlak</option>
                                    <option value="Fikih">Fikih</option>
                                    <option value="Sejarah">Sejarah</option>
                                </select>
                            </div>
                            <div class="flex items-end space-x-2">
                                <button onclick="showAddKolonNilaiModal()" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-xl hover:bg-gray-200">
                                    <i class="fas fa-plus mr-2"></i>Kolom
                                </button>
                                <button onclick="saveNilai()" class="btn-primary text-white px-4 py-2 rounded-xl">
                                    <i class="fas fa-save mr-2"></i>Simpan
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Nilai Table -->
                    <div class="card p-6">
                        <div id="nilaiContent" class="text-center py-12 text-gray-500">
                            <i class="fas fa-star text-5xl mb-4 text-gray-300"></i>
                            <p>Pilih kelas untuk input dan melihat nilai</p>
                        </div>
                    </div>

                    <!-- Statistics -->
                    <div class="grid md:grid-cols-3 gap-4">
                        <div class="card p-4">
                            <h4 class="text-sm font-medium text-gray-500 mb-1">Rata-rata Kelas</h4>
                            <p class="text-2xl font-bold text-primary-600" id="rataRataNilai">-</p>
                        </div>
                        <div class="card p-4">
                            <h4 class="text-sm font-medium text-gray-500 mb-1">Nilai Tertinggi</h4>
                            <p class="text-2xl font-bold text-green-600" id="nilaiTertinggi">-</p>
                        </div>
                        <div class="card p-4">
                            <h4 class="text-sm font-medium text-gray-500 mb-1">Nilai Terendah</h4>
                            <p class="text-2xl font-bold text-red-600" id="nilaiTerendah">-</p>
                        </div>
                    </div>
                </div>
            `;
        }

        async function initNilai() {
            const snapshot = await db.collection('users').doc(currentUser.uid)
                .collection('kelas').orderBy('nama').get();
            
            const select = document.getElementById('nilaiKelasSelect');
            snapshot.forEach(doc => {
                const kelas = doc.data();
                select.innerHTML += `<option value="${doc.id}" data-nama="${kelas.nama}">${kelas.nama}</option>`;
            });
        }

        async function loadNilaiKelas() {
            const kelasId = document.getElementById('nilaiKelasSelect').value;
            const jenis = document.getElementById('nilaiJenisSelect').value;
            
            if (!kelasId) {
                document.getElementById('nilaiContent').innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <i class="fas fa-star text-5xl mb-4 text-gray-300"></i>
                        <p>Pilih kelas untuk input dan melihat nilai</p>
                    </div>
                `;
                return;
            }

            showLoading();

            try {
                // Load siswa
                const siswaSnap = await db.collection('users').doc(currentUser.uid)
                    .collection('siswa').where('kelasId', '==', kelasId).orderBy('nama').get();

                // Load existing nilai
                const nilaiSnap = await db.collection('users').doc(currentUser.uid)
                    .collection('nilai').doc(`${kelasId}_${jenis}`).get();
                
                const existingNilai = nilaiSnap.exists ? nilaiSnap.data() : { kolom: ['Tugas 1', 'Tugas 2', 'UH 1'], data: {} };

                const container = document.getElementById('nilaiContent');

                if (siswaSnap.empty) {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-users text-4xl text-gray-300 mb-3"></i>
                            <p class="text-gray-500 mb-4">Belum ada data siswa di kelas ini.</p>
                            <button onclick="navigateTo('import')" class="text-primary-600 hover:underline">Import Data Siswa</button>
                        </div>
                    `;
                    hideLoading();
                    return;
                }

                const kolom = existingNilai.kolom || ['Tugas 1', 'UH 1'];

                container.innerHTML = `
                    <div class="overflow-x-auto">
                        <table class="w-full" id="nilaiTable">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-3 text-left text-xs font-semibold text-gray-500 uppercase w-12">No</th>
                                    <th class="px-3 py-3 text-left text-xs font-semibold text-gray-500 uppercase min-w-[150px]">Nama Siswa</th>
                                    ${kolom.map((k, idx) => `
                                        <th class="px-3 py-3 text-center text-xs font-semibold text-gray-500 uppercase w-20">
                                            ${k}
                                            <button onclick="removeKolomNilai(${idx})" class="ml-1 text-red-400 hover:text-red-600">
                                                <i class="fas fa-times text-xs"></i>
                                            </button>
                                        </th>
                                    `).join('')}
                                    <th class="px-3 py-3 text-center text-xs font-semibold text-gray-500 uppercase w-20 bg-gray-100">Rata-rata</th>
                                </tr>
                            </thead>
                            <tbody id="nilaiTableBody">
                                ${siswaSnap.docs.map((doc, idx) => {
                                    const siswa = doc.data();
                                    const nilaiSiswa = existingNilai.data?.[doc.id] || {};
                                    const nilaiArr = kolom.map(k => parseFloat(nilaiSiswa[k]) || 0);
                                    const rata2 = nilaiArr.length > 0 ? (nilaiArr.reduce((a,b) => a+b, 0) / nilaiArr.length).toFixed(1) : 0;
                                    
                                    return `
                                        <tr class="border-t" data-siswa-id="${doc.id}">
                                            <td class="px-3 py-2 text-center text-sm">${idx + 1}</td>
                                            <td class="px-3 py-2 font-medium text-sm">${siswa.nama}</td>
                                            ${kolom.map(k => `
                                                <td class="px-3 py-2 text-center">
                                                    <input type="number" min="0" max="100" value="${nilaiSiswa[k] || ''}" 
                                                           data-kolom="${k}"
                                                           class="w-16 px-2 py-1 text-center border rounded-lg text-sm"
                                                           onchange="calculateRataRata(this)">
                                                </td>
                                            `).join('')}
                                            <td class="px-3 py-2 text-center font-bold bg-gray-50 rata-rata">${rata2}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;

                // Store kolom info
                window.currentKolomNilai = kolom;

                hideLoading();
                calculateStatistik();

            } catch (error) {
                hideLoading();
                showToast('Gagal memuat data: ' + error.message, 'error');
            }
        }

        function calculateRataRata(input) {
            const row = input.closest('tr');
            const inputs = row.querySelectorAll('input[type="number"]');
            let total = 0, count = 0;
            
            inputs.forEach(inp => {
                const val = parseFloat(inp.value);
                if (!isNaN(val)) {
                    total += val;
                    count++;
                }
            });

            const rata2 = count > 0 ? (total / count).toFixed(1) : 0;
            row.querySelector('.rata-rata').textContent = rata2;
            
            calculateStatistik();
        }

        function calculateStatistik() {
            const rataRataElements = document.querySelectorAll('.rata-rata');
            let total = 0, count = 0, max = 0, min = 100;

            rataRataElements.forEach(el => {
                const val = parseFloat(el.textContent);
                if (!isNaN(val) && val > 0) {
                    total += val;
                    count++;
                    if (val > max) max = val;
                    if (val < min) min = val;
                }
            });

            document.getElementById('rataRataNilai').textContent = count > 0 ? (total / count).toFixed(1) : '-';
            document.getElementById('nilaiTertinggi').textContent = count > 0 ? max : '-';
            document.getElementById('nilaiTerendah').textContent = count > 0 ? min : '-';
        }

        function showAddKolonNilaiModal() {
            const nama = prompt('Masukkan nama kolom nilai (contoh: Tugas 2, UH 2, PTS):');
            if (nama && nama.trim()) {
                window.currentKolomNilai = window.currentKolomNilai || [];
                window.currentKolomNilai.push(nama.trim());
                loadNilaiKelas();
            }
        }

        async function saveNilai() {
            const kelasId = document.getElementById('nilaiKelasSelect').value;
            const jenis = document.getElementById('nilaiJenisSelect').value;
            const namaKelas = document.getElementById('nilaiKelasSelect').selectedOptions[0]?.dataset.nama || '';

            if (!kelasId) {
                showToast('Pilih kelas terlebih dahulu', 'error');
                return;
            }

            showLoading();

            const data = {};
            document.querySelectorAll('#nilaiTableBody tr').forEach(row => {
                const siswaId = row.dataset.siswaId;
                const nilaiSiswa = {};
                
                row.querySelectorAll('input[type="number"]').forEach(input => {
                    const kolom = input.dataset.kolom;
                    const nilai = input.value;
                    if (nilai) nilaiSiswa[kolom] = parseFloat(nilai);
                });
                
                if (siswaId) data[siswaId] = nilaiSiswa;
            });

            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('nilai').doc(`${kelasId}_${jenis}`).set({
                        kelasId,
                        namaKelas,
                        jenis,
                        kolom: window.currentKolomNilai || [],
                        data,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                hideLoading();
                showToast('Nilai berhasil disimpan!');
            } catch (error) {
                hideLoading();
                showToast('Gagal menyimpan: ' + error.message, 'error');
            }
        }

        // ==========================================
        // PRINT & EXPORT FUNCTIONS
        // ==========================================
        function printProta(id) {
            showToast('Mempersiapkan cetak...', 'info');
            // Implementation for print
        }

        function exportProtaPDF(id) {
            showToast('Export PDF akan segera tersedia', 'info');
        }

        function printLKPD(id) {
            previewLKPD(id);
        }

        // ==========================================
        // ADMIN PANEL (SUPER ADMIN)
        // ==========================================
        function getAdminHTML() {
            if (currentUser?.email !== SUPER_ADMIN_EMAIL) {
                return `
                    <div class="flex items-center justify-center min-h-[60vh]">
                        <div class="text-center">
                            <i class="fas fa-lock text-5xl text-gray-300 mb-4"></i>
                            <h2 class="text-xl font-bold text-gray-900">Akses Ditolak</h2>
                            <p class="text-gray-600">Halaman ini hanya untuk Super Admin.</p>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="space-y-6 animate-slide-in">
                    <div class="bg-gradient-to-r from-red-600 to-pink-600 rounded-xl p-6 text-white">
                        <h2 class="text-2xl font-bold mb-2">Admin Panel</h2>
                        <p class="text-red-100">Kelola pengguna dan langganan aplikasi.</p>
                    </div>

                    <div class="grid md:grid-cols-4 gap-4">
                        <div class="card p-4">
                            <p class="text-3xl font-bold text-gray-900" id="adminTotalUsers">0</p>
                            <p class="text-sm text-gray-500">Total Pengguna</p>
                        </div>
                        <div class="card p-4">
                            <p class="text-3xl font-bold text-green-600" id="adminFreeUsers">0</p>
                            <p class="text-sm text-gray-500">Free Users</p>
                        </div>
                        <div class="card p-4">
                            <p class="text-3xl font-bold text-yellow-600" id="adminPremiumUsers">0</p>
                            <p class="text-sm text-gray-500">Premium Users</p>
                        </div>
                        <div class="card p-4">
                            <p class="text-3xl font-bold text-blue-600" id="adminSchoolPlan">0</p>
                            <p class="text-sm text-gray-500">Paket Sekolah</p>
                        </div>
                    </div>

                    <div class="card p-6">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Daftar Pengguna</h3>
                        <div id="adminUserList" class="space-y-3">
                            <!-- User list -->
                        </div>
                    </div>
                </div>
            `;
        }

        async function initAdmin() {
            if (currentUser?.email !== SUPER_ADMIN_EMAIL) return;

            try {
                const snapshot = await db.collection('users').orderBy('createdAt', 'desc').get();
                
                let total = 0, free = 0, premium = 0, school = 0;
                
                const container = document.getElementById('adminUserList');
                container.innerHTML = snapshot.docs.map(doc => {
                    const user = doc.data();
                    total++;
                    if (user.plan === 'premium') premium++;
                    else if (user.plan === 'school') school++;
                    else free++;

                    return `
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-primary-100 text-primary-600 rounded-full flex items-center justify-center font-bold">
                                    ${(user.name || 'U').charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <p class="font-medium text-gray-900">${user.name || 'Unknown'}</p>
                                    <p class="text-sm text-gray-500">${user.email}</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-3">
                                <span class="text-xs px-2 py-1 rounded-full ${user.plan === 'premium' ? 'bg-yellow-100 text-yellow-700' : 'bg-gray-100 text-gray-700'}">
                                    ${user.plan || 'free'}
                                </span>
                                <button onclick="upgradeUser('${doc.id}')" class="text-primary-600 hover:text-primary-700 text-sm">
                                    Upgrade
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

                document.getElementById('adminTotalUsers').textContent = total;
                document.getElementById('adminFreeUsers').textContent = free;
                document.getElementById('adminPremiumUsers').textContent = premium;
                document.getElementById('adminSchoolPlan').textContent = school;

            } catch (error) {
                console.error('Error loading admin data:', error);
            }
        }

        async function upgradeUser(userId) {
            if (!confirm('Upgrade user ini ke Premium?')) return;

            showLoading();
            try {
                await db.collection('users').doc(userId).update({
                    plan: 'premium',
                    upgradedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                hideLoading();
                showToast('User berhasil di-upgrade!');
                initAdmin();
            } catch (error) {
                hideLoading();
                showToast('Gagal upgrade: ' + error.message, 'error');
            }
        }

        // ==========================================
        // SETTINGS & HELP
        // ==========================================
        function getSettingsHTML() {
            return `
                <div class="space-y-6 animate-slide-in">
                    <div class="card p-6">
                        <h3 class="text-lg font-bold text-gray-900 mb-6">Pengaturan Akun</h3>
                        
                        <div class="space-y-6">
                            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                                <div>
                                    <h4 class="font-medium text-gray-900">Notifikasi Email</h4>
                                    <p class="text-sm text-gray-500">Terima notifikasi via email</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-600"></div>
                                </label>
                            </div>

                            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                                <div>
                                    <h4 class="font-medium text-gray-900">Mode Gelap</h4>
                                    <p class="text-sm text-gray-500">Tampilan dark mode</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-600"></div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="card p-6">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Keamanan</h3>
                        <button onclick="changePassword()" class="w-full p-4 bg-gray-50 rounded-xl text-left hover:bg-gray-100 transition">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <i class="fas fa-key text-gray-400"></i>
                                    <span>Ubah Password</span>
                                </div>
                                <i class="fas fa-chevron-right text-gray-400"></i>
                            </div>
                        </button>
                    </div>

                    <div class="card p-6 border-red-200">
                        <h3 class="text-lg font-bold text-red-600 mb-4">Zona Berbahaya</h3>
                        <button onclick="deleteAccount()" class="w-full p-4 bg-red-50 rounded-xl text-left hover:bg-red-100 transition text-red-600">
                            <div class="flex items-center space-x-3">
                                <i class="fas fa-trash"></i>
                                <span>Hapus Akun</span>
                            </div>
                        </button>
                    </div>
                </div>
            `;
        }

        function changePassword() {
            showToast('Fitur ubah password akan segera tersedia', 'info');
        }

        function deleteAccount() {
            showToast('Hubungi admin untuk menghapus akun', 'info');
        }

        // Add settings and help to router
        const originalLoadPageContent = loadPageContent;
        loadPageContent = function(page) {
            if (page === 'settings') {
                document.getElementById('mainContent').innerHTML = getSettingsHTML();
                return;
            }
            if (page === 'admin') {
                document.getElementById('mainContent').innerHTML = getAdminHTML();
                initAdmin();
                return;
            }
            originalLoadPageContent(page);
        };
    </script>
    <style>
        * { font-family: 'Plus Jakarta Sans', sans-serif; }
        .arabic-text { font-family: 'Amiri', serif; direction: rtl; text-align: right; font-size: 1.5em; line-height: 2; }
        .sidebar-link { transition: all 0.2s ease; }
        .sidebar-link:hover, .sidebar-link.active { background: linear-gradient(90deg, rgba(16, 185, 129, 0.1) 0%, transparent 100%); border-left: 3px solid #10b981; }
        .sidebar-link.active { background: linear-gradient(90deg, rgba(16, 185, 129, 0.15) 0%, transparent 100%); }
        .card { background: white; border-radius: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: all 0.3s ease; }
        .card:hover { box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        .btn-primary { background: linear-gradient(135deg, #059669 0%, #10b981 100%); }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); }
        .gradient-bg { background: linear-gradient(135deg, #059669 0%, #0ea5e9 100%); }
        .stat-card { position: relative; overflow: hidden; }
        .stat-card::before { content: ''; position: absolute; top: -50%; right: -50%; width: 100%; height: 100%; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%); }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        .animate-slide-in { animation: slideIn 0.3s ease forwards; }
        .table-row:hover { background-color: #f8fafc; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #10b981; box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1); }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #f1f5f9; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .tooltip { position: relative; }
        .tooltip::after { content: attr(data-tip); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); padding: 4px 8px; background: #1e293b; color: white; font-size: 12px; border-radius: 4px; white-space: nowrap; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .tooltip:hover::after { opacity: 1; }
        /* Print Styles */
        @media print {
            .no-print { display: none !important; }
            .print-full { width: 100% !important; margin: 0 !important; padding: 20px !important; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- App Container -->
    <div id="app" class="flex min-h-screen">
        <!-- Sidebar -->
        <aside id="sidebar" class="fixed lg:static inset-y-0 left-0 z-40 w-72 bg-white border-r border-gray-200 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 flex flex-col">
            <!-- Logo -->
            <div class="p-6 border-b border-gray-100">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 gradient-bg rounded-xl flex items-center justify-center shadow-lg">
                        <i class="fas fa-chalkboard-teacher text-white"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-gray-900">Admin Guru</h1>
                        <p class="text-xs text-gray-500">Super App</p>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <nav class="flex-1 p-4 space-y-1 overflow-y-auto scrollbar-thin">
                <!-- Dashboard -->
                <a href="#dashboard" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 active" data-page="dashboard">
                    <i class="fas fa-home w-5 text-center"></i>
                    <span>Dashboard</span>
                </a>

                <!-- Profil & Dasar -->
                <div class="pt-4">
                    <p class="px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Profil & Dasar</p>
                    <a href="#profil" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700" data-page="profil">
                        <i class="fas fa-user w-5 text-center"></i>
                        <span>Profil Guru</span>
                    </a>
                    <a href="#kalender" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700" data-page="kalender">
                        <i class="fas fa-calendar-alt w-5 text-center"></i>
                        <span>Kalender Pendidikan</span>
                    </a>
                    <a href="#jadwal" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700" data-page="jadwal">
                        <i class="fas fa-clock w-5 text-center"></i>
                        <span>Jadwal Pelajaran</span>
                    </a>
                </div>

                <!-- Perencanaan -->
                <div class="pt-4">
                    <p class="px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Perencanaan</p>
                    <a href="#atp" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700" data-page="atp">
                        <i class="fas fa-route w-5 text-center"></i>
                        <span>ATP</span>
                    </a>
                    <a href="#prota" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700" data-page="prota">
                        <i class="fas fa-calendar-check w-5 text-center"></i>
                        <span>Prota</span>
                    </a>
                    <a href="#promes" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700" data-page="promes">
                        <i class="fas fa-calendar-week w-5 text-center"></i>
                        <span>Promes</span>
                        <span class="ml-auto text-xs bg-primary-100 text-primary-700 px-2 py-0.5 rounded-full">Pro</span>
                    </a>
                </div>

                <!-- Pembelajaran -->
                <div class="pt-4">
                    <p class="px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Pembelajaran</p>
                    <a href="#modul-ajar" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700" data-page="modul-ajar">
                        <i class="fas fa-book-open w-5 text-center"></i>
                        <span>Modul Ajar</span>
                        <span class="ml-auto text-xs bg-primary-100 text-primary-700 px-2 py-0.5 rounded-full">Pro</span>
                    </a>
                    <a href="#lkpd" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700" data-page="lkpd">
                        <i class="fas fa-file-alt w-5 text-center"></i>
                        <span>LKPD</span>
                        <span class="ml-auto text-xs bg-primary-100 text-primary-700 px-2 py-0.5 rounded-full">Pro</span>
                    </a>
                    <a href="#bank-soal" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700" data-page="bank-soal">
                        <i class="fas fa-question-circle w-5 text-center"></i>
                        <span>Bank Soal</span>
                        <span class="ml-auto text-xs bg-primary-100 text-primary-700 px-2 py-0.5 rounded-full">Pro</span>
                    </a>
                </div>

                <!-- Pelaksanaan -->
                <div class="pt-4">
                    <p class="px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Pelaksanaan</p>
                    <a href="#jurnal" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700" data-page="jurnal">
                        <i class="fas fa-book w-5 text-center"></i>
                        <span>Jurnal Pembelajaran</span>
                        <span class="ml-auto text-xs bg-primary-100 text-primary-700 px-2 py-0.5 rounded-full">Pro</span>
                    </a>
                    <a href="#absensi" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700" data-page="absensi">
                        <i class="fas fa-user-check w-5 text-center"></i>
                        <span>Absensi</span>
                    </a>
                    <a href="#nilai" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700" data-page="nilai">
                        <i class="fas fa-star w-5 text-center"></i>
                        <span>Daftar Nilai</span>
                    </a>
                </div>

                <!-- Tools -->
                <div class="pt-4">
                    <p class="px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Tools</p>
                    <a href="#ai-assistant" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700" data-page="ai-assistant">
                        <i class="fas fa-robot w-5 text-center"></i>
                        <span>AI Assistant</span>
                        <span class="ml-auto text-xs bg-accent-100 text-accent-700 px-2 py-0.5 rounded-full">New</span>
                    </a>
                    <a href="#import" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700" data-page="import">
                        <i class="fas fa-file-import w-5 text-center"></i>
                        <span>Import Data</span>
                    </a>
                </div>
            </nav>

            <!-- User Profile in Sidebar -->
            <div class="p-4 border-t border-gray-100">
                <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-xl">
                    <div id="sidebarUserPhoto" class="w-10 h-10 bg-primary-500 rounded-full flex items-center justify-center text-white font-bold">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p id="sidebarUserName" class="text-sm font-semibold text-gray-900 truncate">Loading...</p>
                        <p id="sidebarUserPlan" class="text-xs text-gray-500 flex items-center">
                            <span class="w-2 h-2 bg-green-500 rounded-full mr-1"></span>
                            Free Plan
                        </p>
                    </div>
                    <button onclick="logout()" class="text-gray-400 hover:text-red-500 transition" title="Logout">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Sidebar Overlay (Mobile) -->
        <div id="sidebarOverlay" class="fixed inset-0 bg-black/50 z-30 hidden lg:hidden" onclick="toggleSidebar()"></div>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col min-h-screen">
            <!-- Top Header -->
            <header class="bg-white border-b border-gray-200 sticky top-0 z-20 no-print">
                <div class="flex items-center justify-between px-4 lg:px-8 h-16">
                    <!-- Mobile Menu Button -->
                    <button onclick="toggleSidebar()" class="lg:hidden text-gray-600 hover:text-gray-900">
                        <i class="fas fa-bars text-xl"></i>
                    </button>

                    <!-- Page Title -->
                    <div class="hidden lg:block">
                        <h2 id="pageTitle" class="text-xl font-bold text-gray-900">Dashboard</h2>
                    </div>

                    <!-- Right Actions -->
                    <div class="flex items-center space-x-4">
                        <!-- Quick Actions -->
                        <button onclick="generateAllDocuments()" class="hidden sm:flex items-center space-x-2 btn-primary text-white px-4 py-2 rounded-lg text-sm font-medium">
                            <i class="fas fa-magic"></i>
                            <span>Generate Semua</span>
                        </button>

                        <!-- Notifications -->
                        <button class="relative text-gray-500 hover:text-gray-700">
                            <i class="fas fa-bell text-xl"></i>
                            <span class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full text-white text-xs flex items-center justify-center">3</span>
                        </button>

                        <!-- User Dropdown -->
                        <div class="relative">
                            <button onclick="toggleUserMenu()" class="flex items-center space-x-2">
                                <div id="headerUserPhoto" class="w-9 h-9 bg-primary-500 rounded-full flex items-center justify-center text-white text-sm font-bold">
                                    <i class="fas fa-user"></i>
                                </div>
                            </button>
                            <div id="userMenu" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-xl shadow-lg border border-gray-100 py-2">
                                <div class="px-4 py-3 border-b border-gray-100">
                                    <p id="menuUserName" class="font-semibold text-gray-900">Loading...</p>
                                    <p id="menuUserEmail" class="text-sm text-gray-500">Loading...</p>
                                </div>
                                <a href="#profil" class="flex items-center space-x-3 px-4 py-2 text-gray-700 hover:bg-gray-50" onclick="navigateTo('profil')">
                                    <i class="fas fa-user-cog w-5"></i>
                                    <span>Profil Saya</span>
                                </a>
                                <a href="#subscription" class="flex items-center space-x-3 px-4 py-2 text-gray-700 hover:bg-gray-50">
                                    <i class="fas fa-crown w-5 text-yellow-500"></i>
                                    <span>Upgrade Premium</span>
                                </a>
                                <a href="#settings" class="flex items-center space-x-3 px-4 py-2 text-gray-700 hover:bg-gray-50">
                                    <i class="fas fa-cog w-5"></i>
                                    <span>Pengaturan</span>
                                </a>
                                <a href="#help" class="flex items-center space-x-3 px-4 py-2 text-gray-700 hover:bg-gray-50">
                                    <i class="fas fa-question-circle w-5"></i>
                                    <span>Bantuan</span>
                                </a>
                                <div class="border-t border-gray-100 mt-2 pt-2">
                                    <button onclick="logout()" class="flex items-center space-x-3 px-4 py-2 text-red-600 hover:bg-red-50 w-full">
                                        <i class="fas fa-sign-out-alt w-5"></i>
                                        <span>Keluar</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Dynamic Content Area -->
            <div id="mainContent" class="flex-1 p-4 lg:p-8 overflow-y-auto">
                <!-- Content will be loaded dynamically -->
            </div>
        </main>
    </div>

    <!-- Modal Container -->
    <div id="modalContainer"></div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-6 right-6 z-[100] hidden">
        <div id="toastContent" class="bg-gray-900 text-white px-6 py-4 rounded-xl shadow-lg flex items-center space-x-3 transform transition-all">
            <i id="toastIcon" class="fas fa-check-circle text-xl text-green-400"></i>
            <span id="toastMessage">Notification</span>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 z-[100] hidden items-center justify-center bg-white/90 backdrop-blur-sm">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-primary-200 border-t-primary-600 rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-gray-600 font-medium">Memproses...</p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <!-- Application Scripts -->
    <script>
        // ==========================================
        // FIREBASE CONFIGURATION
        // ==========================================
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // ==========================================
        // GLOBAL STATE
        // ==========================================
        let currentUser = null;
        let userData = null;
        let currentPage = 'dashboard';

        // Super Admin Email
        const SUPER_ADMIN_EMAIL = 'afifaro@gmail.com';

        // ==========================================
        // CP PAI DATA (KEPKA BSKAP 046/2025)
        // ==========================================
        const CP_PAI_DATA = {
            faseA: {
                nama: "Fase A (Kelas 1-2 SD/MI)",
                elemen: {
                    alquran_hadis: {
                        nama: "Al-Qur'an dan Hadis",
                        cp: "Peserta didik mengenal huruf hijaiah, harakat, dan membaca surah-surah pendek.",
                        tp: [
                            "Mengenal huruf hijaiah dari Alif sampai Ya",
                            "Membedakan huruf hijaiah yang mirip bentuknya",
                            "Mengenal harakat fathah, kasrah, dan dhammah",
                            "Membaca surah Al-Fatihah dengan benar",
                            "Membaca surah An-Nas dengan benar",
                            "Menghafal surah Al-Fatihah",
                            "Menghafal surah An-Nas"
                        ]
                    },
                    akidah: {
                        nama: "Akidah",
                        cp: "Peserta didik mengenal rukun iman dan sifat-sifat Allah melalui pengamatan alam sekitar.",
                        tp: [
                            "Menyebutkan rukun iman yang enam",
                            "Mengenal Allah sebagai Tuhan Yang Maha Esa",
                            "Menyebutkan bukti-bukti keberadaan Allah",
                            "Mengenal malaikat dan tugasnya",
                            "Meyakini adanya kitab-kitab Allah"
                        ]
                    },
                    akhlak: {
                        nama: "Akhlak",
                        cp: "Peserta didik menunjukkan akhlak terpuji dalam kehidupan sehari-hari.",
                        tp: [
                            "Membiasakan mengucap salam",
                            "Membiasakan berdoa sebelum dan sesudah makan",
                            "Menunjukkan sikap jujur dalam perkataan",
                            "Menunjukkan sikap hormat kepada orang tua",
                            "Menunjukkan sikap sayang kepada teman"
                        ]
                    },
                    fikih: {
                        nama: "Fikih",
                        cp: "Peserta didik mengenal rukun Islam dan praktik ibadah sederhana.",
                        tp: [
                            "Menyebutkan rukun Islam yang lima",
                            "Mengenal syahadat dan artinya",
                            "Mengenal gerakan shalat",
                            "Praktik wudhu dengan bimbingan",
                            "Mengenal waktu-waktu shalat lima waktu"
                        ]
                    },
                    sejarah: {
                        nama: "Sejarah Peradaban Islam",
                        cp: "Peserta didik mengenal kisah para nabi dan teladan yang dapat diambil.",
                        tp: [
                            "Menceritakan kisah Nabi Adam AS",
                            "Menceritakan kisah Nabi Nuh AS",
                            "Menceritakan kisah Nabi Ibrahim AS",
                            "Menceritakan kisah Nabi Muhammad SAW masa kecil",
                            "Mengambil teladan dari kisah para nabi"
                        ]
                    }
                }
            },
            faseB: {
                nama: "Fase B (Kelas 3-4 SD/MI)",
                elemen: {
                    alquran_hadis: {
                        nama: "Al-Qur'an dan Hadis",
                        cp: "Peserta didik membaca Al-Qur'an dengan tajwid dasar dan menghafal surah-surah pendek.",
                        tp: [
                            "Membaca Al-Qur'an dengan makhraj yang benar",
                            "Menerapkan hukum nun mati dan tanwin",
                            "Menghafal surah Al-Kautsar beserta artinya",
                            "Menghafal surah Al-Ikhlas beserta artinya",
                            "Menghafal hadis tentang shalat",
                            "Mengamalkan kandungan surah yang dihafal"
                        ]
                    },
                    akidah: {
                        nama: "Akidah",
                        cp: "Peserta didik memahami sifat-sifat Allah dan mengimani hal-hal gaib.",
                        tp: [
                            "Menjelaskan sifat wajib Allah (13 sifat)",
                            "Menyebutkan nama-nama malaikat beserta tugasnya",
                            "Mengimani adanya hari akhir",
                            "Meyakini qada dan qadar Allah",
                            "Menunjukkan bukti keimanan dalam perilaku"
                        ]
                    },
                    akhlak: {
                        nama: "Akhlak",
                        cp: "Peserta didik menunjukkan akhlak terpuji kepada orang tua dan guru.",
                        tp: [
                            "Menjelaskan adab kepada orang tua",
                            "Mempraktikkan sikap patuh kepada orang tua",
                            "Menjelaskan adab kepada guru",
                            "Menunjukkan sikap hormat kepada guru",
                            "Membiasakan berterima kasih"
                        ]
                    },
                    fikih: {
                        nama: "Fikih",
                        cp: "Peserta didik memahami dan mempraktikkan shalat dan puasa.",
                        tp: [
                            "Menjelaskan syarat dan rukun shalat",
                            "Mempraktikkan shalat lima waktu dengan benar",
                            "Mengenal shalat berjamaah",
                            "Menjelaskan puasa Ramadhan",
                            "Mengenal tanda-tanda baligh"
                        ]
                    },
                    sejarah: {
                        nama: "Sejarah Peradaban Islam",
                        cp: "Peserta didik mengenal sejarah dakwah Nabi di Makkah.",
                        tp: [
                            "Menceritakan masa muda Nabi Muhammad SAW",
                            "Menjelaskan dakwah Nabi di Makkah",
                            "Menceritakan perjuangan sahabat Nabi",
                            "Mengenal peristiwa Isra Mi'raj",
                            "Mengambil hikmah dari sejarah dakwah"
                        ]
                    }
                }
            },
            faseC: {
                nama: "Fase C (Kelas 5-6 SD/MI)",
                elemen: {
                    alquran_hadis: {
                        nama: "Al-Qur'an dan Hadis",
                        cp: "Peserta didik membaca Al-Qur'an dengan lancar dan memahami kandungan surah.",
                        tp: [
                            "Membaca Al-Qur'an dengan lancar dan tartil",
                            "Menerapkan hukum bacaan mad",
                            "Menghafal surah Al-Qadr dan memahami artinya",
                            "Menghafal surah At-Tin dan memahami artinya",
                            "Menghafal hadis tentang akhlak",
                            "Mengamalkan isi kandungan hadis"
                        ]
                    },
                    akidah: {
                        nama: "Akidah",
                        cp: "Peserta didik memahami hari akhir dan hikmah mengimaninya.",
                        tp: [
                            "Menjelaskan tanda-tanda hari kiamat",
                            "Mengimani adanya hari pembalasan",
                            "Menjelaskan hikmah beriman kepada hari akhir",
                            "Menyebutkan amalan untuk bekal akhirat",
                            "Menunjukkan sikap hidup yang baik"
                        ]
                    },
                    akhlak: {
                        nama: "Akhlak",
                        cp: "Peserta didik menunjukkan akhlak terpuji dalam kehidupan sosial.",
                        tp: [
                            "Menjelaskan sikap toleransi antar umat beragama",
                            "Menunjukkan sikap menghargai perbedaan",
                            "Membiasakan sikap tolong-menolong",
                            "Menjelaskan adab dalam bermedia sosial",
                            "Mempraktikkan akhlak terpuji di masyarakat"
                        ]
                    },
                    fikih: {
                        nama: "Fikih",
                        cp: "Peserta didik memahami dan mempraktikkan zakat dan infak.",
                        tp: [
                            "Menjelaskan ketentuan zakat fitrah",
                            "Menjelaskan ketentuan zakat mal",
                            "Mempraktikkan pembayaran zakat",
                            "Menjelaskan hikmah berzakat",
                            "Membiasakan berinfak dan sedekah"
                        ]
                    },
                    sejarah: {
                        nama: "Sejarah Peradaban Islam",
                        cp: "Peserta didik mengenal sejarah dakwah Nabi di Madinah.",
                        tp: [
                            "Menjelaskan peristiwa hijrah ke Madinah",
                            "Menceritakan pembentukan masyarakat Madinah",
                            "Mengenal Piagam Madinah",
                            "Menceritakan perjuangan Nabi di Madinah",
                            "Mengambil hikmah dari Fathu Makkah"
                        ]
                    }
                }
            },
            faseD: {
                nama: "Fase D (Kelas 7-9 SMP/MTs)",
                elemen: {
                    alquran_hadis: {
                        nama: "Al-Qur'an dan Hadis",
                        cp: "Peserta didik membaca dan memahami Al-Qur'an dengan tajwid lengkap.",
                        tp: [
                            "Menerapkan hukum tajwid secara lengkap",
                            "Menganalisis kandungan ayat tentang toleransi",
                            "Menghafal ayat-ayat pilihan dengan tartil",
                            "Memahami hadis-hadis tentang ibadah",
                            "Mengamalkan kandungan Al-Qur'an dalam kehidupan"
                        ]
                    },
                    akidah: {
                        nama: "Akidah",
                        cp: "Peserta didik memahami rukun iman secara mendalam.",
                        tp: [
                            "Menganalisis dalil-dalil keberadaan Allah",
                            "Menjelaskan tugas dan sifat malaikat",
                            "Memahami kitab-kitab Allah dan fungsinya",
                            "Mengimani rasul-rasul Allah",
                            "Memahami qada dan qadar dengan hikmat"
                        ]
                    },
                    akhlak: {
                        nama: "Akhlak",
                        cp: "Peserta didik menunjukkan akhlak mahmudah dan menghindari mazmumah.",
                        tp: [
                            "Menganalisis akhlak terpuji dan tercela",
                            "Membiasakan sikap tawadhu dan istiqamah",
                            "Menghindari sikap hasad, ghibah, dan namimah",
                            "Menunjukkan etika digital yang baik",
                            "Mempraktikkan akhlak Islami di era modern"
                        ]
                    },
                    fikih: {
                        nama: "Fikih",
                        cp: "Peserta didik memahami sujud, haji, dan muamalah.",
                        tp: [
                            "Menjelaskan macam-macam sujud",
                            "Mempraktikkan sujud sahwi, tilawah, dan syukur",
                            "Memahami manasik haji dan umrah",
                            "Mengenal transaksi ekonomi Islam",
                            "Memahami hukum jual beli yang halal"
                        ]
                    },
                    sejarah: {
                        nama: "Sejarah Peradaban Islam",
                        cp: "Peserta didik memahami peradaban Islam dari Umayyah hingga Mughal.",
                        tp: [
                            "Menjelaskan perkembangan Dinasti Umayyah",
                            "Menganalisis kemajuan Dinasti Abbasiyah",
                            "Mengenal tokoh-tokoh cendekiawan Muslim",
                            "Memahami peradaban Islam di Asia",
                            "Mengambil hikmah dari sejarah peradaban"
                        ]
                    }
                }
            },
            faseE: {
                nama: "Fase E (Kelas 10 SMA/MA)",
                elemen: {
                    alquran_hadis: {
                        nama: "Al-Qur'an dan Hadis",
                        cp: "Peserta didik mengkaji ayat dan hadis tentang kompetisi dalam kebaikan.",
                        tp: [
                            "Menganalisis QS. Al-Baqarah: 148 tentang fastabiqul khairat",
                            "Memahami hadis tentang berlomba dalam kebaikan",
                            "Menghafal ayat-ayat tentang amal saleh",
                            "Mengimplementasikan semangat berkompetisi positif",
                            "Merefleksikan kandungan ayat dalam kehidupan"
                        ]
                    },
                    akidah: {
                        nama: "Akidah",
                        cp: "Peserta didik memahami Syu'ab al-Iman (cabang-cabang keimanan).",
                        tp: [
                            "Menjelaskan konsep Syu'ab al-Iman",
                            "Menganalisis hubungan iman, Islam, dan ihsan",
                            "Memahami maqashid aqidah",
                            "Menerapkan nilai-nilai keimanan",
                            "Mengembangkan spiritualitas yang kuat"
                        ]
                    },
                    akhlak: {
                        nama: "Akhlak",
                        cp: "Peserta didik memiliki karakter mulia dalam berinteraksi.",
                        tp: [
                            "Menganalisis akhlak dalam pergaulan",
                            "Memahami etika berkomunikasi",
                            "Menerapkan akhlak dalam media sosial",
                            "Membiasakan sikap ihsan dalam muamalah",
                            "Mengembangkan kepribadian yang berintegritas"
                        ]
                    },
                    fikih: {
                        nama: "Fikih",
                        cp: "Peserta didik memahami sumber dan kaidah hukum Islam.",
                        tp: [
                            "Menjelaskan sumber hukum Islam",
                            "Memahami metode ijtihad",
                            "Menganalisis kaidah-kaidah fikih",
                            "Mengenal mazhab-mazhab fikih",
                            "Menerapkan fikih dalam konteks kekinian"
                        ]
                    },
                    sejarah: {
                        nama: "Sejarah Peradaban Islam",
                        cp: "Peserta didik memahami sejarah masuk dan berkembangnya Islam di Indonesia.",
                        tp: [
                            "Menganalisis teori masuknya Islam ke Nusantara",
                            "Menjelaskan peran Walisongo dalam dakwah",
                            "Memahami kerajaan-kerajaan Islam di Indonesia",
                            "Menganalisis akulturasi budaya Islam-Nusantara",
                            "Mengapresiasi warisan Islam di Indonesia"
                        ]
                    }
                }
            },
            faseF: {
                nama: "Fase F (Kelas 11-12 SMA/MA)",
                elemen: {
                    alquran_hadis: {
                        nama: "Al-Qur'an dan Hadis",
                        cp: "Peserta didik mengkaji ayat dan hadis dengan pendekatan tematik.",
                        tp: [
                            "Menganalisis ayat tentang berpikir kritis",
                            "Memahami hadis tentang mencari ilmu",
                            "Mengkaji tafsir tematik kontemporer",
                            "Menerapkan metodologi pemahaman Al-Qur'an",
                            "Mengintegrasikan nilai Al-Qur'an dalam kehidupan"
                        ]
                    },
                    akidah: {
                        nama: "Akidah",
                        cp: "Peserta didik memiliki pemahaman akidah yang kokoh dan kontekstual.",
                        tp: [
                            "Menganalisis problematika akidah kontemporer",
                            "Memahami respons Islam terhadap ateisme",
                            "Menjelaskan hubungan sains dan agama",
                            "Mengembangkan worldview Islam",
                            "Mempertahankan akidah di era global"
                        ]
                    },
                    akhlak: {
                        nama: "Akhlak",
                        cp: "Peserta didik memiliki akhlak yang matang dan etika profesional.",
                        tp: [
                            "Menganalisis etika digital dan cyber ethics",
                            "Memahami akhlak dalam dunia kerja",
                            "Menerapkan etika lingkungan (eco-ethics)",
                            "Mengembangkan soft skills Islami",
                            "Memiliki integritas kepribadian Muslim"
                        ]
                    },
                    fikih: {
                        nama: "Fikih",
                        cp: "Peserta didik memahami fikih mawaris dan munakahat.",
                        tp: [
                            "Menjelaskan ketentuan waris dalam Islam",
                            "Menghitung pembagian waris",
                            "Memahami hukum pernikahan dalam Islam",
                            "Menganalisis fikih keluarga sakinah",
                            "Mengenal hukum kontemporer (fikih medis, dll)"
                        ]
                    },
                    sejarah: {
                        nama: "Sejarah Peradaban Islam",
                        cp: "Peserta didik memahami organisasi dan gerakan Islam dunia.",
                        tp: [
                            "Menganalisis organisasi Islam internasional",
                            "Memahami gerakan pembaharuan Islam",
                            "Mengenal tokoh-tokoh pembaharu Muslim",
                            "Menganalisis tantangan umat Islam kontemporer",
                            "Merumuskan peran generasi muda Muslim"
                        ]
                    }
                }
            }
        };

        // ==========================================
        // UTILITY FUNCTIONS
        // ==========================================
        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
            document.getElementById('loadingOverlay').classList.add('flex');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
            document.getElementById('loadingOverlay').classList.remove('flex');
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const msg = document.getElementById('toastMessage');
            
            msg.textContent = message;
            if (type === 'success') {
                icon.className = 'fas fa-check-circle text-xl text-green-400';
            } else if (type === 'error') {
                icon.className = 'fas fa-exclamation-circle text-xl text-red-400';
            } else {
                icon.className = 'fas fa-info-circle text-xl text-blue-400';
            }
            
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
        }

        function toggleUserMenu() {
            document.getElementById('userMenu').classList.toggle('hidden');
        }

        // Close user menu when clicking outside
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('userMenu');
            if (!e.target.closest('#userMenu') && !e.target.closest('[onclick="toggleUserMenu()"]')) {
                menu.classList.add('hidden');
            }
        });

        // ==========================================
        // AUTHENTICATION
        // ==========================================
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                await loadUserData();
                updateUI();
                initializeRouter();
            } else {
                window.location.href = 'index.html';
            }
        });

        async function loadUserData() {
            try {
                const doc = await db.collection('users').doc(currentUser.uid).get();
                if (doc.exists) {
                    userData = doc.data();
                } else {
                    // Create default user data
                    userData = {
                        name: currentUser.displayName || 'Guru',
                        email: currentUser.email,
                        role: currentUser.email === SUPER_ADMIN_EMAIL ? 'admin' : 'guru',
                        plan: 'free',
                        jenjang: '',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    await db.collection('users').doc(currentUser.uid).set(userData);
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        function updateUI() {
            // Update sidebar user info
            document.getElementById('sidebarUserName').textContent = userData?.name || 'Guru';
            document.getElementById('sidebarUserPlan').innerHTML = `
                <span class="w-2 h-2 ${userData?.plan === 'premium' ? 'bg-yellow-500' : 'bg-green-500'} rounded-full mr-1"></span>
                ${userData?.plan === 'premium' ? 'Premium' : 'Free'} Plan
            `;

            // Update header user info
            document.getElementById('menuUserName').textContent = userData?.name || 'Guru';
            document.getElementById('menuUserEmail').textContent = currentUser?.email || '';

            // Update avatar
            if (currentUser?.photoURL) {
                document.getElementById('sidebarUserPhoto').innerHTML = `<img src="${currentUser.photoURL}" class="w-full h-full rounded-full object-cover">`;
                document.getElementById('headerUserPhoto').innerHTML = `<img src="${currentUser.photoURL}" class="w-full h-full rounded-full object-cover">`;
            } else {
                const initial = (userData?.name || 'G').charAt(0).toUpperCase();
                document.getElementById('sidebarUserPhoto').innerHTML = initial;
                document.getElementById('headerUserPhoto').innerHTML = initial;
            }
        }

        async function logout() {
            try {
                await auth.signOut();
                window.location.href = 'index.html';
            } catch (error) {
                showToast('Gagal logout', 'error');
            }
        }

        // ==========================================
        // ROUTER
        // ==========================================
        function initializeRouter() {
            // Handle hash changes
            window.addEventListener('hashchange', handleRouteChange);
            
            // Handle sidebar link clicks
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = link.dataset.page;
                    window.location.hash = page;
                });
            });

            // Initial route
            handleRouteChange();
        }

        function handleRouteChange() {
            const hash = window.location.hash.slice(1) || 'dashboard';
            navigateTo(hash);
        }

        function navigateTo(page) {
            currentPage = page;
            
            // Update active state in sidebar
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.classList.remove('active');
                if (link.dataset.page === page) {
                    link.classList.add('active');
                }
            });

            // Update page title
            const titles = {
                'dashboard': 'Dashboard',
                'profil': 'Profil Guru',
                'kalender': 'Kalender Pendidikan',
                'jadwal': 'Jadwal Pelajaran',
                'atp': 'Alur Tujuan Pembelajaran (ATP)',
                'prota': 'Program Tahunan (Prota)',
                'promes': 'Program Semester (Promes)',
                'modul-ajar': 'Modul Ajar',
                'lkpd': 'LKPD',
                'bank-soal': 'Bank Soal',
                'jurnal': 'Jurnal Pembelajaran',
                'absensi': 'Absensi Siswa',
                'nilai': 'Daftar Nilai',
                'ai-assistant': 'AI Assistant',
                'import': 'Import Data'
            };
            document.getElementById('pageTitle').textContent = titles[page] || 'Dashboard';

            // Load page content
            loadPageContent(page);

            // Close sidebar on mobile
            if (window.innerWidth < 1024) {
                document.getElementById('sidebar').classList.add('-translate-x-full');
                document.getElementById('sidebarOverlay').classList.add('hidden');
            }
        }

        // ==========================================
        // PAGE CONTENT LOADER
        // ==========================================
        function loadPageContent(page) {
            const content = document.getElementById('mainContent');
            
            switch(page) {
                case 'dashboard':
                    content.innerHTML = getDashboardHTML();
                    initDashboard();
                    break;
                case 'profil':
                    content.innerHTML = getProfilHTML();
                    initProfil();
                    break;
                case 'kalender':
                    content.innerHTML = getKalenderHTML();
                    initKalender();
                    break;
                case 'jadwal':
                    content.innerHTML = getJadwalHTML();
                    initJadwal();
                    break;
                case 'atp':
                    content.innerHTML = getATPHTML();
                    initATP();
                    break;
                case 'prota':
                    content.innerHTML = getProtaHTML();
                    initProta();
                    break;
                case 'promes':
                    content.innerHTML = getPromesHTML();
                    initPromes();
                    break;
                case 'modul-ajar':
                    content.innerHTML = getModulAjarHTML();
                    initModulAjar();
                    break;
                case 'lkpd':
                    content.innerHTML = getLKPDHTML();
                    initLKPD();
                    break;
                case 'bank-soal':
                    content.innerHTML = getBankSoalHTML();
                    initBankSoal();
                    break;
                case 'jurnal':
                    content.innerHTML = getJurnalHTML();
                    initJurnal();
                    break;
                case 'absensi':
                    content.innerHTML = getAbsensiHTML();
                    initAbsensi();
                    break;
                case 'nilai':
                    content.innerHTML = getNilaiHTML();
                    initNilai();
                    break;
                case 'ai-assistant':
                    content.innerHTML = getAIAssistantHTML();
                    initAIAssistant();
                    break;
                case 'import':
                    content.innerHTML = getImportHTML();
                    initImport();
                    break;
                default:
                    content.innerHTML = getDashboardHTML();
                    initDashboard();
            }
        }

        // ==========================================
        // DASHBOARD PAGE
        // ==========================================
        function getDashboardHTML() {
            return `
                <div class="space-y-6 animate-slide-in">
                    <!-- Welcome Banner -->
                    <div class="bg-gradient-to-r from-primary-600 to-secondary-600 rounded-2xl p-6 lg:p-8 text-white">
                        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between">
                            <div>
                                <h2 class="text-2xl lg:text-3xl font-bold mb-2">Assalamu'alaikum, ${userData?.name || 'Guru'}! ðŸ‘‹</h2>
                                <p class="text-primary-100">Selamat datang di Admin Guru Super App. Mari kelola administrasi dengan mudah.</p>
                            </div>
                            <div class="mt-4 lg:mt-0">
                                <button onclick="startQuickSetup()" class="bg-white text-primary-600 px-6 py-3 rounded-xl font-semibold hover:bg-primary-50 transition">
                                    <i class="fas fa-magic mr-2"></i>Quick Setup
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Stats Grid -->
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="stat-card bg-gradient-to-br from-primary-500 to-primary-600 text-white p-5 rounded-2xl">
                            <div class="flex items-center justify-between mb-3">
                                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-users text-xl"></i>
                                </div>
                                <span class="text-xs bg-white/20 px-2 py-1 rounded-full">Total</span>
                            </div>
                            <p id="totalSiswa" class="text-3xl font-bold">0</p>
                            <p class="text-primary-100 text-sm">Siswa</p>
                        </div>
                        <div class="stat-card bg-gradient-to-br from-secondary-500 to-secondary-600 text-white p-5 rounded-2xl">
                            <div class="flex items-center justify-between mb-3">
                                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-door-open text-xl"></i>
                                </div>
                                <span class="text-xs bg-white/20 px-2 py-1 rounded-full">Total</span>
                            </div>
                            <p id="totalKelas" class="text-3xl font-bold">0</p>
                            <p class="text-secondary-100 text-sm">Kelas</p>
                        </div>
                        <div class="stat-card bg-gradient-to-br from-accent-500 to-accent-600 text-white p-5 rounded-2xl">
                            <div class="flex items-center justify-between mb-3">
                                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-book text-xl"></i>
                                </div>
                                <span class="text-xs bg-white/20 px-2 py-1 rounded-full">Total</span>
                            </div>
                            <p id="totalModul" class="text-3xl font-bold">0</p>
                            <p class="text-accent-100 text-sm">Modul Ajar</p>
                        </div>
                        <div class="stat-card bg-gradient-to-br from-orange-500 to-orange-600 text-white p-5 rounded-2xl">
                            <div class="flex items-center justify-between mb-3">
                                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-calendar-check text-xl"></i>
                                </div>
                                <span class="text-xs bg-white/20 px-2 py-1 rounded-full">Semester</span>
                            </div>
                            <p id="hariEfektif" class="text-3xl font-bold">0</p>
                            <p class="text-orange-100 text-sm">Hari Efektif</p>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="card p-6">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Aksi Cepat</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <button onclick="navigateTo('kalender')" class="p-4 bg-gray-50 hover:bg-primary-50 rounded-xl text-center transition group">
                                <div class="w-12 h-12 mx-auto mb-3 bg-primary-100 text-primary-600 rounded-xl flex items-center justify-center group-hover:bg-primary-500 group-hover:text-white transition">
                                    <i class="fas fa-calendar-alt text-xl"></i>
                                </div>
                                <p class="font-medium text-gray-700 text-sm">Atur Kalender</p>
                            </button>
                            <button onclick="navigateTo('jadwal')" class="p-4 bg-gray-50 hover:bg-secondary-50 rounded-xl text-center transition group">
                                <div class="w-12 h-12 mx-auto mb-3 bg-secondary-100 text-secondary-600 rounded-xl flex items-center justify-center group-hover:bg-secondary-500 group-hover:text-white transition">
                                    <i class="fas fa-clock text-xl"></i>
                                </div>
                                <p class="font-medium text-gray-700 text-sm">Atur Jadwal</p>
                            </button>
                            <button onclick="navigateTo('atp')" class="p-4 bg-gray-50 hover:bg-accent-50 rounded-xl text-center transition group">
                                <div class="w-12 h-12 mx-auto mb-3 bg-accent-100 text-accent-600 rounded-xl flex items-center justify-center group-hover:bg-accent-500 group-hover:text-white transition">
                                    <i class="fas fa-route text-xl"></i>
                                </div>
                                <p class="font-medium text-gray-700 text-sm">Buat ATP</p>
                            </button>
                            <button onclick="generateAllDocuments()" class="p-4 bg-gray-50 hover:bg-orange-50 rounded-xl text-center transition group">
                                <div class="w-12 h-12 mx-auto mb-3 bg-orange-100 text-orange-600 rounded-xl flex items-center justify-center group-hover:bg-orange-500 group-hover:text-white transition">
                                    <i class="fas fa-magic text-xl"></i>
                                </div>
                                <p class="font-medium text-gray-700 text-sm">Generate All</p>
                            </button>
                        </div>
                    </div>

                    <!-- Recent Activity & Progress -->
                    <div class="grid lg:grid-cols-2 gap-6">
                        <!-- Progress Card -->
                        <div class="card p-6">
                            <h3 class="text-lg font-bold text-gray-900 mb-4">Progress Administrasi</h3>
                            <div class="space-y-4">
                                <div>
                                    <div class="flex justify-between text-sm mb-1">
                                        <span class="text-gray-600">Profil Guru</span>
                                        <span id="progressProfil" class="font-medium text-primary-600">0%</span>
                                    </div>
                                    <div class="h-2 bg-gray-200 rounded-full">
                                        <div id="progressProfilBar" class="h-2 bg-primary-500 rounded-full transition-all duration-500" style="width: 0%"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between text-sm mb-1">
                                        <span class="text-gray-600">Kalender Pendidikan</span>
                                        <span id="progressKalender" class="font-medium text-secondary-600">0%</span>
                                    </div>
                                    <div class="h-2 bg-gray-200 rounded-full">
                                        <div id="progressKalenderBar" class="h-2 bg-secondary-500 rounded-full transition-all duration-500" style="width: 0%"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between text-sm mb-1">
                                        <span class="text-gray-600">Jadwal Pelajaran</span>
                                        <span id="progressJadwal" class="font-medium text-accent-600">0%</span>
                                    </div>
                                    <div class="h-2 bg-gray-200 rounded-full">
                                        <div id="progressJadwalBar" class="h-2 bg-accent-500 rounded-full transition-all duration-500" style="width: 0%"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between text-sm mb-1">
                                        <span class="text-gray-600">ATP & Dokumen</span>
                                        <span id="progressATP" class="font-medium text-orange-600">0%</span>
                                    </div>
                                    <div class="h-2 bg-gray-200 rounded-full">
                                        <div id="progressATPBar" class="h-2 bg-orange-500 rounded-full transition-all duration-500" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Recent Activity -->
                        <div class="card p-6">
                            <h3 class="text-lg font-bold text-gray-900 mb-4">Aktivitas Terakhir</h3>
                            <div id="recentActivity" class="space-y-3">
                                <div class="flex items-center space-x-3 text-gray-500">
                                    <i class="fas fa-info-circle"></i>
                                    <span class="text-sm">Belum ada aktivitas</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Help Section -->
                    <div class="card p-6 bg-gradient-to-r from-gray-50 to-gray-100">
                        <div class="flex flex-col md:flex-row md:items-center justify-between">
                            <div class="mb-4 md:mb-0">
                                <h3 class="text-lg font-bold text-gray-900 mb-1">Butuh Bantuan?</h3>
                                <p class="text-gray-600 text-sm">Pelajari cara menggunakan aplikasi ini dengan panduan lengkap.</p>
                            </div>
                            <div class="flex space-x-3">
                                <button onclick="showGuide()" class="bg-white text-gray-700 px-4 py-2 rounded-lg border border-gray-200 hover:bg-gray-50 transition flex items-center">
                                    <i class="fas fa-book-open mr-2"></i>Panduan
                                </button>
                                <button onclick="showVideoTutorial()" class="bg-primary-500 text-white px-4 py-2 rounded-lg hover:bg-primary-600 transition flex items-center">
                                    <i class="fas fa-play-circle mr-2"></i>Video Tutorial
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function initDashboard() {
            // Load statistics
            try {
                const statsRef = db.collection('users').doc(currentUser.uid);
                
                // Get siswa count
                const siswaSnap = await db.collection('users').doc(currentUser.uid).collection('siswa').get();
                document.getElementById('totalSiswa').textContent = siswaSnap.size;

                // Get kelas count
                const kelasSnap = await db.collection('users').doc(currentUser.uid).collection('kelas').get();
                document.getElementById('totalKelas').textContent = kelasSnap.size;

                // Get modul count
                const modulSnap = await db.collection('users').doc(currentUser.uid).collection('modul_ajar').get();
                document.getElementById('totalModul').textContent = modulSnap.size;

                // Get kalender
                const kalenderSnap = await db.collection('users').doc(currentUser.uid).collection('kalender').doc('aktif').get();
                if (kalenderSnap.exists) {
                    const kalender = kalenderSnap.data();
                    document.getElementById('hariEfektif').textContent = kalender.hariEfektif || 0;
                }

                // Calculate progress
                await calculateProgress();

            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        async function calculateProgress() {
            let profilProgress = 0;
            let kalenderProgress = 0;
            let jadwalProgress = 0;
            let atpProgress = 0;

            // Check profil
            if (userData?.satuan_pendidikan) profilProgress += 50;
            if (userData?.kepala_sekolah) profilProgress += 50;

            // Check kalender
            const kalenderSnap = await db.collection('users').doc(currentUser.uid).collection('kalender').get();
            if (kalenderSnap.size > 0) kalenderProgress = 100;

            // Check jadwal
            const jadwalSnap = await db.collection('users').doc(currentUser.uid).collection('jadwal').get();
            if (jadwalSnap.size > 0) jadwalProgress = 100;

            // Check ATP
            const atpSnap = await db.collection('users').doc(currentUser.uid).collection('atp').get();
            if (atpSnap.size > 0) atpProgress = 100;

            // Update UI
            document.getElementById('progressProfil').textContent = profilProgress + '%';
            document.getElementById('progressProfilBar').style.width = profilProgress + '%';
            document.getElementById('progressKalender').textContent = kalenderProgress + '%';
            document.getElementById('progressKalenderBar').style.width = kalenderProgress + '%';
            document.getElementById('progressJadwal').textContent = jadwalProgress + '%';
            document.getElementById('progressJadwalBar').style.width = jadwalProgress + '%';
            document.getElementById('progressATP').textContent = atpProgress + '%';
            document.getElementById('progressATPBar').style.width = atpProgress + '%';
        }

        function startQuickSetup() {
            showToast('Memulai Quick Setup...', 'info');
            navigateTo('profil');
        }

        function showGuide() {
            const modal = document.getElementById('modalContainer');
            modal.innerHTML = `
                <div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
                    <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                        <div class="sticky top-0 bg-white border-b border-gray-100 px-6 py-4 flex items-center justify-between">
                            <h3 class="text-xl font-bold text-gray-900">Panduan Penggunaan</h3>
                            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <div class="p-6 space-y-6">
                            <div class="bg-primary-50 border border-primary-200 rounded-xl p-4">
                                <h4 class="font-bold text-primary-800 mb-2"><i class="fas fa-lightbulb mr-2"></i>Konsep Single Input â€“ Multi Output</h4>
                                <p class="text-primary-700 text-sm">Input data sekali (Kalender, Jadwal, TP), sistem akan otomatis menghasilkan ATP, Prota, Promes, dan dokumen lainnya yang saling sinkron.</p>
                            </div>
                            
                            <div>
                                <h4 class="font-bold text-gray-900 mb-3">Langkah-langkah Penggunaan:</h4>
                                <div class="space-y-4">
                                    <div class="flex space-x-4">
                                        <div class="w-8 h-8 bg-primary-500 text-white rounded-full flex items-center justify-center flex-shrink-0 font-bold">1</div>
                                        <div>
                                            <h5 class="font-semibold text-gray-900">Lengkapi Profil</h5>
                                            <p class="text-gray-600 text-sm">Isi data diri, satuan pendidikan, dan nama kepala sekolah.</p>
                                        </div>
                                    </div>
                                    <div class="flex space-x-4">
                                        <div class="w-8 h-8 bg-primary-500 text-white rounded-full flex items-center justify-center flex-shrink-0 font-bold">2</div>
                                        <div>
                                            <h5 class="font-semibold text-gray-900">Atur Kalender Pendidikan</h5>
                                            <p class="text-gray-600 text-sm">Input hari efektif, libur, dan pekan ujian per semester.</p>
                                        </div>
                                    </div>
                                    <div class="flex space-x-4">
                                        <div class="w-8 h-8 bg-primary-500 text-white rounded-full flex items-center justify-center flex-shrink-0 font-bold">3</div>
                                        <div>
                                            <h5 class="font-semibold text-gray-900">Buat Jadwal Pelajaran</h5>
                                            <p class="text-gray-600 text-sm">Atur jadwal per kelas dengan jam custom.</p>
                                        </div>
                                    </div>
                                    <div class="flex space-x-4">
                                        <div class="w-8 h-8 bg-primary-500 text-white rounded-full flex items-center justify-center flex-shrink-0 font-bold">4</div>
                                        <div>
                                            <h5 class="font-semibold text-gray-900">Buat ATP</h5>
                                            <p class="text-gray-600 text-sm">Pilih CP dari database, sistem akan generate Tujuan Pembelajaran.</p>
                                        </div>
                                    </div>
                                    <div class="flex space-x-4">
                                        <div class="w-8 h-8 bg-primary-500 text-white rounded-full flex items-center justify-center flex-shrink-0 font-bold">5</div>
                                        <div>
                                            <h5 class="font-semibold text-gray-900">Generate Dokumen</h5>
                                            <p class="text-gray-600 text-sm">Klik "Generate All" untuk membuat Prota, Promes, dan dokumen lainnya.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function showVideoTutorial() {
            showToast('Video tutorial akan segera tersedia', 'info');
        }

        function closeModal() {
            document.getElementById('modalContainer').innerHTML = '';
        }

        async function generateAllDocuments() {
            showLoading();
            try {
                // Check prerequisites
                const kalenderSnap = await db.collection('users').doc(currentUser.uid).collection('kalender').doc('aktif').get();
                const jadwalSnap = await db.collection('users').doc(currentUser.uid).collection('jadwal').get();
                const atpSnap = await db.collection('users').doc(currentUser.uid).collection('atp').get();

                if (!kalenderSnap.exists) {
                    hideLoading();
                    showToast('Silakan lengkapi Kalender Pendidikan terlebih dahulu', 'error');
                    navigateTo('kalender');
                    return;
                }

                if (jadwalSnap.empty) {
                    hideLoading();
                    showToast('Silakan lengkapi Jadwal Pelajaran terlebih dahulu', 'error');
                    navigateTo('jadwal');
                    return;
                }

                if (atpSnap.empty) {
                    hideLoading();
                    showToast('Silakan buat ATP terlebih dahulu', 'error');
                    navigateTo('atp');
                    return;
                }

                // Generate documents (simulation)
                await new Promise(resolve => setTimeout(resolve, 2000));

                hideLoading();
                showToast('Semua dokumen berhasil di-generate!', 'success');
            } catch (error) {
                hideLoading();
                showToast('Gagal generate dokumen: ' + error.message, 'error');
            }
        }

        // ==========================================
        // PROFIL PAGE
        // ==========================================
        function getProfilHTML() {
            return `
                <div class="space-y-6 animate-slide-in">
                    <div class="card p-6">
                        <h3 class="text-lg font-bold text-gray-900 mb-6">Data Profil Guru</h3>
                        <form id="profilForm" class="space-y-6">
                            <div class="grid md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                                    <input type="text" id="namaLengkap" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl" placeholder="Ustadz/Ustadzah">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">NIP/NIK</label>
                                    <input type="text" id="nip" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl" placeholder="Nomor Induk">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                    <input type="email" id="email" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl bg-gray-50" readonly>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">No. HP/WhatsApp</label>
                                    <input type="tel" id="phone" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl" placeholder="08xxxxxxxxxx">
                                </div>
                            </div>

                            <div class="border-t border-gray-200 pt-6">
                                <h4 class="font-semibold text-gray-900 mb-4">Data Satuan Pendidikan</h4>
                                <div class="grid md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Nama Sekolah/Madrasah</label>
                                        <input type="text" id="namaSekolah" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl" placeholder="SDN/MIN/MTs">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">NPSN</label>
                                        <input type="text" id="npsn" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl" placeholder="NPSN Sekolah">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Jenjang Pendidikan</label>
                                        <select id="jenjangPendidikan" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl bg-white">
                                            <option value="">Pilih Jenjang</option>
                                            <option value="sd">SD/MI</option>
                                            <option value="smp">SMP/MTs</option>
                                            <option value="sma">SMA/MA/SMK</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tahun Pelajaran</label>
                                        <input type="text" id="tahunPelajaran" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl" placeholder="2024/2025">
                                    </div>
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Alamat Sekolah</label>
                                        <textarea id="alamatSekolah" rows="2" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl" placeholder="Alamat lengkap sekolah"></textarea>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Kabupaten/Kota</label>
                                        <input type="text" id="kabupaten" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl" placeholder="Kabupaten/Kota">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Provinsi</label>
                                        <input type="text" id="provinsi" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl" placeholder="Provinsi">
                                    </div>
                                </div>
                            </div>

                                                        <div class="border-t border-gray-200 pt-6">
                                <h4 class="font-semibold text-gray-900 mb-4">Data Kepala Sekolah</h4>
                                <div class="grid md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Nama Kepala Sekolah</label>
                                        <input type="text" id="namaKepsek" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl" placeholder="Nama Lengkap">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">NIP Kepala Sekolah</label>
                                        <input type="text" id="nipKepsek" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl" placeholder="NIP">
                                    </div>
                                </div>
                            </div>

                            <div class="flex justify-end space-x-3 pt-4">
                                <button type="button" onclick="resetProfilForm()" class="px-6 py-3 border-2 border-gray-200 rounded-xl text-gray-700 hover:bg-gray-50 transition">
                                    <i class="fas fa-undo mr-2"></i>Reset
                                </button>
                                <button type="submit" class="btn-primary text-white px-6 py-3 rounded-xl font-semibold">
                                    <i class="fas fa-save mr-2"></i>Simpan Profil
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        async function initProfil() {
            // Load existing data
            try {
                const doc = await db.collection('users').doc(currentUser.uid).get();
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById('namaLengkap').value = data.name || '';
                    document.getElementById('nip').value = data.nip || '';
                    document.getElementById('email').value = currentUser.email || '';
                    document.getElementById('phone').value = data.phone || '';
                    document.getElementById('namaSekolah').value = data.satuan_pendidikan || '';
                    document.getElementById('npsn').value = data.npsn || '';
                    document.getElementById('jenjangPendidikan').value = data.jenjang || '';
                    document.getElementById('tahunPelajaran').value = data.tahun_pelajaran || '';
                    document.getElementById('alamatSekolah').value = data.alamat_sekolah || '';
                    document.getElementById('kabupaten').value = data.kabupaten || '';
                    document.getElementById('provinsi').value = data.provinsi || '';
                    document.getElementById('namaKepsek').value = data.kepala_sekolah || '';
                    document.getElementById('nipKepsek').value = data.nip_kepsek || '';
                }
            } catch (error) {
                console.error('Error loading profil:', error);
            }

            // Form submit handler
            document.getElementById('profilForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoading();

                try {
                    await db.collection('users').doc(currentUser.uid).update({
                        name: document.getElementById('namaLengkap').value,
                        nip: document.getElementById('nip').value,
                        phone: document.getElementById('phone').value,
                        satuan_pendidikan: document.getElementById('namaSekolah').value,
                        npsn: document.getElementById('npsn').value,
                        jenjang: document.getElementById('jenjangPendidikan').value,
                        tahun_pelajaran: document.getElementById('tahunPelajaran').value,
                        alamat_sekolah: document.getElementById('alamatSekolah').value,
                        kabupaten: document.getElementById('kabupaten').value,
                        provinsi: document.getElementById('provinsi').value,
                        kepala_sekolah: document.getElementById('namaKepsek').value,
                        nip_kepsek: document.getElementById('nipKepsek').value,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    // Reload user data
                    await loadUserData();
                    updateUI();

                    hideLoading();
                    showToast('Profil berhasil disimpan!');
                } catch (error) {
                    hideLoading();
                    showToast('Gagal menyimpan: ' + error.message, 'error');
                }
            });
        }

        function resetProfilForm() {
            document.getElementById('profilForm').reset();
            initProfil();
        }

        // ==========================================
        // KALENDER PENDIDIKAN PAGE
        // ==========================================
        function getKalenderHTML() {
            return `
                <div class="space-y-6 animate-slide-in">
                    <!-- Info Banner -->
                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 flex items-start space-x-3">
                        <i class="fas fa-info-circle text-blue-500 mt-0.5"></i>
                        <div>
                            <p class="text-blue-800 font-medium">Kalender Pendidikan</p>
                            <p class="text-blue-600 text-sm">Data kalender akan otomatis sinkron dengan Prota dan Promes.</p>
                        </div>
                    </div>

                    <!-- Semester Selection -->
                    <div class="card p-6">
                        <div class="flex flex-col md:flex-row md:items-center justify-between mb-6">
                            <h3 class="text-lg font-bold text-gray-900 mb-4 md:mb-0">Pengaturan Kalender</h3>
                            <div class="flex space-x-3">
                                <select id="semesterSelect" class="px-4 py-2 border-2 border-gray-200 rounded-xl bg-white" onchange="loadKalenderSemester()">
                                    <option value="1">Semester 1 (Ganjil)</option>
                                    <option value="2">Semester 2 (Genap)</option>
                                </select>
                                <select id="tahunSelect" class="px-4 py-2 border-2 border-gray-200 rounded-xl bg-white" onchange="loadKalenderSemester()">
                                    <option value="2024">2024/2025</option>
                                    <option value="2025">2025/2026</option>
                                </select>
                            </div>
                        </div>

                        <form id="kalenderForm" class="space-y-6">
                            <!-- Tanggal Semester -->
                            <div class="grid md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Mulai Semester</label>
                                    <input type="date" id="tanggalMulai" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Selesai Semester</label>
                                    <input type="date" id="tanggalSelesai" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl">
                                </div>
                            </div>

                            <!-- Hari Efektif per Bulan -->
                            <div>
                                <h4 class="font-semibold text-gray-900 mb-4">Hari Efektif per Bulan</h4>
                                <div id="hariEfektifContainer" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>

                            <!-- Pekan Ujian -->
                            <div class="border-t border-gray-200 pt-6">
                                <h4 class="font-semibold text-gray-900 mb-4">Pekan Ujian & Penilaian</h4>
                                <div class="space-y-4">
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">PTS (Penilaian Tengah Semester)</label>
                                            <div class="flex space-x-2">
                                                <input type="date" id="ptsMulai" class="flex-1 px-3 py-2 border-2 border-gray-200 rounded-lg text-sm" placeholder="Mulai">
                                                <span class="flex items-center text-gray-400">s/d</span>
                                                <input type="date" id="ptsSelesai" class="flex-1 px-3 py-2 border-2 border-gray-200 rounded-lg text-sm" placeholder="Selesai">
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">PAS/PAT (Akhir Semester)</label>
                                            <div class="flex space-x-2">
                                                <input type="date" id="pasMulai" class="flex-1 px-3 py-2 border-2 border-gray-200 rounded-lg text-sm" placeholder="Mulai">
                                                <span class="flex items-center text-gray-400">s/d</span>
                                                <input type="date" id="pasSelesai" class="flex-1 px-3 py-2 border-2 border-gray-200 rounded-lg text-sm" placeholder="Selesai">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Hari Libur -->
                            <div class="border-t border-gray-200 pt-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h4 class="font-semibold text-gray-900">Hari Libur & Kegiatan Khusus</h4>
                                    <button type="button" onclick="addHariLibur()" class="text-primary-600 hover:text-primary-700 text-sm font-medium">
                                        <i class="fas fa-plus mr-1"></i>Tambah
                                    </button>
                                </div>
                                <div id="hariLiburContainer" class="space-y-3">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>

                            <!-- Summary -->
                            <div class="bg-gray-50 rounded-xl p-4">
                                <h4 class="font-semibold text-gray-900 mb-3">Ringkasan Kalender</h4>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                                    <div class="bg-white p-3 rounded-lg">
                                        <p id="totalHariEfektif" class="text-2xl font-bold text-primary-600">0</p>
                                        <p class="text-xs text-gray-500">Hari Efektif</p>
                                    </div>
                                    <div class="bg-white p-3 rounded-lg">
                                        <p id="totalMingguEfektif" class="text-2xl font-bold text-secondary-600">0</p>
                                        <p class="text-xs text-gray-500">Minggu Efektif</p>
                                    </div>
                                    <div class="bg-white p-3 rounded-lg">
                                        <p id="totalHariLibur" class="text-2xl font-bold text-orange-600">0</p>
                                        <p class="text-xs text-gray-500">Hari Libur</p>
                                    </div>
                                    <div class="bg-white p-3 rounded-lg">
                                        <p id="totalPekanUjian" class="text-2xl font-bold text-red-600">0</p>
                                        <p class="text-xs text-gray-500">Pekan Ujian</p>
                                    </div>
                                </div>
                            </div>

                            <div class="flex justify-end space-x-3 pt-4">
                                <button type="submit" class="btn-primary text-white px-6 py-3 rounded-xl font-semibold">
                                    <i class="fas fa-save mr-2"></i>Simpan Kalender
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function initKalender() {
            populateHariEfektifInputs();
            loadKalenderSemester();

            document.getElementById('kalenderForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await saveKalender();
            });
        }

        function populateHariEfektifInputs() {
            const container = document.getElementById('hariEfektifContainer');
            const semester = document.getElementById('semesterSelect').value;
            
            let months = [];
            if (semester === '1') {
                months = [
                    { name: 'Juli', value: 7 },
                    { name: 'Agustus', value: 8 },
                    { name: 'September', value: 9 },
                    { name: 'Oktober', value: 10 },
                    { name: 'November', value: 11 },
                    { name: 'Desember', value: 12 }
                ];
            } else {
                months = [
                    { name: 'Januari', value: 1 },
                    { name: 'Februari', value: 2 },
                    { name: 'Maret', value: 3 },
                    { name: 'April', value: 4 },
                    { name: 'Mei', value: 5 },
                    { name: 'Juni', value: 6 }
                ];
            }

            container.innerHTML = months.map(m => `
                <div class="bg-gray-50 p-3 rounded-lg">
                    <label class="block text-xs text-gray-500 mb-1">${m.name}</label>
                    <input type="number" id="hari_${m.value}" min="0" max="31" value="0" 
                           class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg text-center font-bold"
                           onchange="calculateTotals()">
                </div>
            `).join('');
        }

        function addHariLibur() {
            const container = document.getElementById('hariLiburContainer');
            const id = Date.now();
            const div = document.createElement('div');
            div.className = 'flex flex-col md:flex-row gap-3 items-start md:items-center bg-gray-50 p-3 rounded-lg';
            div.id = `libur_${id}`;
            div.innerHTML = `
                <input type="date" class="flex-1 px-3 py-2 border-2 border-gray-200 rounded-lg" data-field="tanggal">
                <input type="text" placeholder="Keterangan (misal: Hari Raya Idul Fitri)" 
                       class="flex-1 px-3 py-2 border-2 border-gray-200 rounded-lg" data-field="keterangan">
                <select class="px-3 py-2 border-2 border-gray-200 rounded-lg bg-white" data-field="tipe">
                    <option value="libur">Libur Nasional</option>
                    <option value="kegiatan">Kegiatan Sekolah</option>
                    <option value="cuti">Cuti Bersama</option>
                </select>
                <button type="button" onclick="removeHariLibur('${id}')" class="text-red-500 hover:text-red-700 p-2">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            container.appendChild(div);
        }

        function removeHariLibur(id) {
            document.getElementById(`libur_${id}`).remove();
            calculateTotals();
        }

        function calculateTotals() {
            let totalHari = 0;
            document.querySelectorAll('#hariEfektifContainer input').forEach(input => {
                totalHari += parseInt(input.value) || 0;
            });

            const totalMinggu = Math.ceil(totalHari / 6);
            const totalLibur = document.querySelectorAll('#hariLiburContainer > div').length;

            document.getElementById('totalHariEfektif').textContent = totalHari;
            document.getElementById('totalMingguEfektif').textContent = totalMinggu;
            document.getElementById('totalHariLibur').textContent = totalLibur;
            document.getElementById('totalPekanUjian').textContent = '2'; // PTS + PAS
        }

        async function loadKalenderSemester() {
            populateHariEfektifInputs();
            
            const semester = document.getElementById('semesterSelect').value;
            const tahun = document.getElementById('tahunSelect').value;

            try {
                const doc = await db.collection('users').doc(currentUser.uid)
                    .collection('kalender').doc(`${tahun}_${semester}`).get();

                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById('tanggalMulai').value = data.tanggalMulai || '';
                    document.getElementById('tanggalSelesai').value = data.tanggalSelesai || '';
                    document.getElementById('ptsMulai').value = data.ptsMulai || '';
                    document.getElementById('ptsSelesai').value = data.ptsSelesai || '';
                    document.getElementById('pasMulai').value = data.pasMulai || '';
                    document.getElementById('pasSelesai').value = data.pasSelesai || '';

                    // Load hari efektif
                    if (data.hariEfektif) {
                        Object.keys(data.hariEfektif).forEach(key => {
                            const input = document.getElementById(`hari_${key}`);
                            if (input) input.value = data.hariEfektif[key];
                        });
                    }

                    // Load hari libur
                    const container = document.getElementById('hariLiburContainer');
                    container.innerHTML = '';
                    if (data.hariLibur) {
                        data.hariLibur.forEach(libur => {
                            const id = Date.now() + Math.random();
                            const div = document.createElement('div');
                            div.className = 'flex flex-col md:flex-row gap-3 items-start md:items-center bg-gray-50 p-3 rounded-lg';
                            div.id = `libur_${id}`;
                            div.innerHTML = `
                                <input type="date" class="flex-1 px-3 py-2 border-2 border-gray-200 rounded-lg" data-field="tanggal" value="${libur.tanggal}">
                                <input type="text" placeholder="Keterangan" class="flex-1 px-3 py-2 border-2 border-gray-200 rounded-lg" data-field="keterangan" value="${libur.keterangan}">
                                <select class="px-3 py-2 border-2 border-gray-200 rounded-lg bg-white" data-field="tipe">
                                    <option value="libur" ${libur.tipe === 'libur' ? 'selected' : ''}>Libur Nasional</option>
                                    <option value="kegiatan" ${libur.tipe === 'kegiatan' ? 'selected' : ''}>Kegiatan Sekolah</option>
                                    <option value="cuti" ${libur.tipe === 'cuti' ? 'selected' : ''}>Cuti Bersama</option>
                                </select>
                                <button type="button" onclick="removeHariLibur('${id}')" class="text-red-500 hover:text-red-700 p-2">
                                    <i class="fas fa-trash"></i>
                                </button>
                            `;
                            container.appendChild(div);
                        });
                    }

                    calculateTotals();
                }
            } catch (error) {
                console.error('Error loading kalender:', error);
            }
        }

        async function saveKalender() {
            showLoading();

            const semester = document.getElementById('semesterSelect').value;
            const tahun = document.getElementById('tahunSelect').value;

            // Collect hari efektif
            const hariEfektif = {};
            document.querySelectorAll('#hariEfektifContainer input').forEach(input => {
                const bulan = input.id.replace('hari_', '');
                hariEfektif[bulan] = parseInt(input.value) || 0;
            });

            // Collect hari libur
            const hariLibur = [];
            document.querySelectorAll('#hariLiburContainer > div').forEach(div => {
                const tanggal = div.querySelector('[data-field="tanggal"]').value;
                const keterangan = div.querySelector('[data-field="keterangan"]').value;
                const tipe = div.querySelector('[data-field="tipe"]').value;
                if (tanggal) {
                    hariLibur.push({ tanggal, keterangan, tipe });
                }
            });

            // Calculate totals
            let totalHariEfektif = 0;
            Object.values(hariEfektif).forEach(v => totalHariEfektif += v);

            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('kalender').doc(`${tahun}_${semester}`).set({
                        semester,
                        tahun,
                        tanggalMulai: document.getElementById('tanggalMulai').value,
                        tanggalSelesai: document.getElementById('tanggalSelesai').value,
                        ptsMulai: document.getElementById('ptsMulai').value,
                        ptsSelesai: document.getElementById('ptsSelesai').value,
                        pasMulai: document.getElementById('pasMulai').value,
                        pasSelesai: document.getElementById('pasSelesai').value,
                        hariEfektif,
                        hariLibur,
                        totalHariEfektif,
                        totalMingguEfektif: Math.ceil(totalHariEfektif / 6),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                // Update active kalender
                await db.collection('users').doc(currentUser.uid)
                    .collection('kalender').doc('aktif').set({
                        semester,
                        tahun,
                        hariEfektif: totalHariEfektif,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                hideLoading();
                showToast('Kalender berhasil disimpan!');
            } catch (error) {
                hideLoading();
                showToast('Gagal menyimpan: ' + error.message, 'error');
            }
        }

        // ==========================================
        // JADWAL PELAJARAN PAGE
        // ==========================================
        function getJadwalHTML() {
            return `
                <div class="space-y-6 animate-slide-in">
                    <!-- Info Banner -->
                    <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 flex items-start space-x-3">
                        <i class="fas fa-exclamation-triangle text-yellow-500 mt-0.5"></i>
                        <div>
                            <p class="text-yellow-800 font-medium">Validasi Anti-Bentrok</p>
                            <p class="text-yellow-600 text-sm">Sistem akan otomatis mencegah jadwal bentrok untuk guru dan rombel yang sama.</p>
                        </div>
                    </div>

                    <!-- Tabs: Kelas & Jadwal -->
                    <div class="card">
                        <div class="border-b border-gray-200">
                            <nav class="flex space-x-4 px-6" aria-label="Tabs">
                                <button onclick="switchJadwalTab('kelas')" id="tabKelas" class="py-4 px-2 border-b-2 border-primary-500 text-primary-600 font-medium">
                                    <i class="fas fa-door-open mr-2"></i>Kelola Kelas
                                </button>
                                <button onclick="switchJadwalTab('jam')" id="tabJam" class="py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-clock mr-2"></i>Jam Pelajaran
                                </button>
                                <button onclick="switchJadwalTab('jadwal')" id="tabJadwal" class="py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-calendar-alt mr-2"></i>Jadwal Mengajar
                                </button>
                            </nav>
                        </div>

                        <!-- Tab Content: Kelas -->
                        <div id="contentKelas" class="p-6">
                            <div class="flex flex-col md:flex-row md:items-center justify-between mb-6">
                                <h3 class="text-lg font-bold text-gray-900 mb-4 md:mb-0">Daftar Kelas/Rombel</h3>
                                <button onclick="showAddKelasModal()" class="btn-primary text-white px-4 py-2 rounded-lg">
                                    <i class="fas fa-plus mr-2"></i>Tambah Kelas
                                </button>
                            </div>
                            <div id="daftarKelas" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <!-- Kelas cards will be loaded here -->
                                <div class="text-center py-8 text-gray-500">
                                    <i class="fas fa-door-open text-4xl mb-3 text-gray-300"></i>
                                    <p>Belum ada kelas. Klik tombol "Tambah Kelas" untuk memulai.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Tab Content: Jam Pelajaran -->
                        <div id="contentJam" class="p-6 hidden">
                            <div class="flex flex-col md:flex-row md:items-center justify-between mb-6">
                                <h3 class="text-lg font-bold text-gray-900 mb-4 md:mb-0">Pengaturan Jam Pelajaran</h3>
                                <button onclick="addJamPelajaran()" class="btn-primary text-white px-4 py-2 rounded-lg">
                                    <i class="fas fa-plus mr-2"></i>Tambah Jam
                                </button>
                            </div>
                            <div id="daftarJam" class="space-y-3">
                                <!-- Default jam pelajaran -->
                            </div>
                            <div class="mt-4 flex justify-end">
                                <button onclick="saveJamPelajaran()" class="btn-primary text-white px-6 py-2 rounded-lg">
                                    <i class="fas fa-save mr-2"></i>Simpan
                                </button>
                            </div>
                        </div>

                        <!-- Tab Content: Jadwal Mengajar -->
                        <div id="contentJadwal" class="p-6 hidden">
                            <div class="flex flex-col md:flex-row md:items-center justify-between mb-6">
                                <h3 class="text-lg font-bold text-gray-900 mb-4 md:mb-0">Jadwal Mengajar PAI</h3>
                                <div class="flex space-x-3">
                                    <select id="filterKelas" class="px-4 py-2 border-2 border-gray-200 rounded-xl bg-white" onchange="loadJadwalKelas()">
                                        <option value="">Semua Kelas</option>
                                    </select>
                                    <button onclick="showAddJadwalModal()" class="btn-primary text-white px-4 py-2 rounded-lg">
                                        <i class="fas fa-plus mr-2"></i>Tambah Jadwal
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Jadwal Table -->
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead>
                                        <tr class="bg-gray-50">
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Hari</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Jam</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Kelas</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Materi</th>
                                            <th class="px-4 py-3 text-center text-xs font-semibold text-gray-500 uppercase">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="jadwalTableBody">
                                        <tr>
                                            <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                                                Belum ada jadwal. Tambahkan jadwal mengajar Anda.
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function initJadwal() {
            loadKelasData();
            loadJamPelajaran();
            loadJadwalData();
        }

        function switchJadwalTab(tab) {
            // Hide all content
            document.getElementById('contentKelas').classList.add('hidden');
            document.getElementById('contentJam').classList.add('hidden');
            document.getElementById('contentJadwal').classList.add('hidden');

            // Reset all tabs
            document.getElementById('tabKelas').classList.remove('border-primary-500', 'text-primary-600');
            document.getElementById('tabKelas').classList.add('border-transparent', 'text-gray-500');
            document.getElementById('tabJam').classList.remove('border-primary-500', 'text-primary-600');
            document.getElementById('tabJam').classList.add('border-transparent', 'text-gray-500');
            document.getElementById('tabJadwal').classList.remove('border-primary-500', 'text-primary-600');
            document.getElementById('tabJadwal').classList.add('border-transparent', 'text-gray-500');

            // Show selected content
            if (tab === 'kelas') {
                document.getElementById('contentKelas').classList.remove('hidden');
                document.getElementById('tabKelas').classList.add('border-primary-500', 'text-primary-600');
                document.getElementById('tabKelas').classList.remove('border-transparent', 'text-gray-500');
            } else if (tab === 'jam') {
                document.getElementById('contentJam').classList.remove('hidden');
                document.getElementById('tabJam').classList.add('border-primary-500', 'text-primary-600');
                document.getElementById('tabJam').classList.remove('border-transparent', 'text-gray-500');
            } else if (tab === 'jadwal') {
                document.getElementById('contentJadwal').classList.remove('hidden');
                document.getElementById('tabJadwal').classList.add('border-primary-500', 'text-primary-600');
                document.getElementById('tabJadwal').classList.remove('border-transparent', 'text-gray-500');
                populateKelasFilter();
            }
        }

        async function loadKelasData() {
            try {
                const snapshot = await db.collection('users').doc(currentUser.uid)
                    .collection('kelas').orderBy('nama').get();

                const container = document.getElementById('daftarKelas');
                
                if (snapshot.empty) {
                    container.innerHTML = `
                        <div class="col-span-full text-center py-8 text-gray-500">
                            <i class="fas fa-door-open text-4xl mb-3 text-gray-300"></i>
                            <p>Belum ada kelas. Klik tombol "Tambah Kelas" untuk memulai.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = snapshot.docs.map(doc => {
                    const kelas = doc.data();
                    return `
                        <div class="bg-gray-50 hover:bg-gray-100 p-4 rounded-xl transition">
                            <div class="flex items-center justify-between mb-3">
                                <div class="w-12 h-12 bg-primary-100 text-primary-600 rounded-xl flex items-center justify-center font-bold text-lg">
                                    ${kelas.nama.charAt(0)}
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="editKelas('${doc.id}')" class="text-gray-400 hover:text-primary-600">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteKelas('${doc.id}')" class="text-gray-400 hover:text-red-600">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <h4 class="font-bold text-gray-900">${kelas.nama}</h4>
                            <p class="text-sm text-gray-500">Fase ${kelas.fase} â€¢ ${kelas.jumlahSiswa || 0} Siswa</p>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading kelas:', error);
            }
        }

        function showAddKelasModal() {
            const modal = document.getElementById('modalContainer');
            modal.innerHTML = `
                <div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
                    <div class="bg-white rounded-2xl w-full max-w-md p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xl font-bold text-gray-900">Tambah Kelas Baru</h3>
                            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <form id="addKelasForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nama Kelas</label>
                                <input type="text" id="namaKelas" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl" placeholder="Contoh: VII A, 4B, X IPA 1">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Fase</label>
                                <select id="faseKelas" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl bg-white">
                                    <option value="">Pilih Fase</option>
                                    <option value="A">Fase A (Kelas 1-2 SD)</option>
                                    <option value="B">Fase B (Kelas 3-4 SD)</option>
                                    <option value="C">Fase C (Kelas 5-6 SD)</option>
                                    <option value="D">Fase D (Kelas 7-9 SMP)</option>
                                    <option value="E">Fase E (Kelas 10 SMA)</option>
                                    <option value="F">Fase F (Kelas 11-12 SMA)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah Siswa</label>
                                <input type="number" id="jumlahSiswa" min="1" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl" placeholder="30">
                            </div>
                            <div class="flex justify-end space-x-3 pt-4">
                                <button type="button" onclick="closeModal()" class="px-4 py-2 border-2 border-gray-200 rounded-xl text-gray-700 hover:bg-gray-50">
                                    Batal
                                </button>
                                <button type="submit" class="btn-primary text-white px-4 py-2 rounded-xl">
                                    <i class="fas fa-save mr-2"></i>Simpan
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            document.getElementById('addKelasForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoading();

                try {
                    await db.collection('users').doc(currentUser.uid)
                        .collection('kelas').add({
                            nama: document.getElementById('namaKelas').value,
                            fase: document.getElementById('faseKelas').value,
                            jumlahSiswa: parseInt(document.getElementById('jumlahSiswa').value) || 0,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });

                    hideLoading();
                    closeModal();
                    showToast('Kelas berhasil ditambahkan!');
                    loadKelasData();
                } catch (error) {
                    hideLoading();
                    showToast('Gagal menambahkan kelas: ' + error.message, 'error');
                }
            });
        }

        async function deleteKelas(id) {
            if (!confirm('Hapus kelas ini? Data jadwal terkait juga akan terhapus.')) return;

            showLoading();
            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('kelas').doc(id).delete();
                hideLoading();
                showToast('Kelas berhasil dihapus!');
                loadKelasData();
            } catch (error) {
                hideLoading();
                showToast('Gagal menghapus: ' + error.message, 'error');
            }
        }

        function loadJamPelajaran() {
            const container = document.getElementById('daftarJam');
            // Default jam pelajaran
            const defaultJam = [
                { ke: 1, mulai: '07:00', selesai: '07:40' },
                { ke: 2, mulai: '07:40', selesai: '08:20' },
                { ke: 3, mulai: '08:20', selesai: '09:00' },
                { ke: 4, mulai: '09:15', selesai: '09:55' },
                { ke: 5, mulai: '09:55', selesai: '10:35' },
                { ke: 6, mulai: '10:35', selesai: '11:15' },
                { ke: 7, mulai: '12:30', selesai: '13:10' },
                { ke: 8, mulai: '13:10', selesai: '13:50' }
            ];

            container.innerHTML = defaultJam.map((jam, idx) => `
                <div class="flex items-center space-x-4 bg-gray-50 p-3 rounded-lg" id="jam_${idx}">
                    <span class="w-8 h-8 bg-primary-100 text-primary-600 rounded-full flex items-center justify-center font-bold text-sm">
                        ${jam.ke}
                    </span>
                    <div class="flex items-center space-x-2 flex-1">
                        <input type="time" value="${jam.mulai}" class="px-3 py-2 border-2 border-gray-200 rounded-lg" data-field="mulai">
                        <span class="text-gray-400">-</span>
                        <input type="time" value="${jam.selesai}" class="px-3 py-2 border-2 border-gray-200 rounded-lg" data-field="selesai">
                    </div>
                    <button type="button" onclick="removeJamPelajaran(${idx})" class="text-red-500 hover:text-red-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        function addJamPelajaran() {
            const container = document.getElementById('daftarJam');
            const count = container.children.length + 1;
            const div = document.createElement('div');
            div.className = 'flex items-center space-x-4 bg-gray-50 p-3 rounded-lg';
            div.id = `jam_${count}`;
            div.innerHTML = `
                <span class="w-8 h-8 bg-primary-100 text-primary-600 rounded-full flex items-center justify-center font-bold text-sm">
                    ${count}
                </span>
                <div class="flex items-center space-x-2 flex-1">
                    <input type="time" value="07:00" class="px-3 py-2 border-2 border-gray-200 rounded-lg" data-field="mulai">
                    <span class="text-gray-400">-</span>
                    <input type="time" value="07:40" class="px-3 py-2 border-2 border-gray-200 rounded-lg" data-field="selesai">
                </div>
                <button type="button" onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-700">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(div);
        }

        function removeJamPelajaran(idx) {
            const el = document.getElementById(`jam_${idx}`);
            if (el) el.remove();
        }

        async function saveJamPelajaran() {
            showLoading();
            const jamList = [];
            document.querySelectorAll('#daftarJam > div').forEach((div, idx) => {
                jamList.push({
                    ke: idx + 1,
                    mulai: div.querySelector('[data-field="mulai"]').value,
                    selesai: div.querySelector('[data-field="selesai"]').value
                });
            });

            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('settings').doc('jam_pelajaran').set({
                        data: jamList,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                hideLoading();
                showToast('Jam pelajaran berhasil disimpan!');
            } catch (error) {
                hideLoading();
                showToast('Gagal menyimpan: ' + error.message, 'error');
            }
        }

        async function populateKelasFilter() {
            const select = document.getElementById('filterKelas');
            try {
                const snapshot = await db.collection('users').doc(currentUser.uid)
                    .collection('kelas').orderBy('nama').get();
                
                select.innerHTML = '<option value="">Semua Kelas</option>';
                snapshot.forEach(doc => {
                    const kelas = doc.data();
                    select.innerHTML += `<option value="${doc.id}">${kelas.nama}</option>`;
                });
            } catch (error) {
                console.error('Error loading kelas filter:', error);
            }
        }

        async function loadJadwalData() {
            try {
                const snapshot = await db.collection('users').doc(currentUser.uid)
                    .collection('jadwal').orderBy('hari').get();

                const tbody = document.getElementById('jadwalTableBody');
                
                if (snapshot.empty) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                                Belum ada jadwal. Tambahkan jadwal mengajar Anda.
                            </td>
                        </tr>
                    `;
                    return;
                }

                const hariNames = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];

                tbody.innerHTML = snapshot.docs.map(doc => {
                    const jadwal = doc.data();
                    return `
                        <tr class="table-row border-b border-gray-100">
                            <td class="px-4 py-3 font-medium">${hariNames[jadwal.hari] || jadwal.hari}</td>
                            <td class="px-4 py-3">${jadwal.jamMulai} - ${jadwal.jamSelesai}</td>
                            <td class="px-4 py-3">${jadwal.namaKelas}</td>
                            <td class="px-4 py-3 text-gray-600">${jadwal.materi || 'PAI & BP'}</td>
                            <td class="px-4 py-3 text-center">
                                <button onclick="deleteJadwal('${doc.id}')" class="text-red-500 hover:text-red-700">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading jadwal:', error);
            }
        }

        function showAddJadwalModal() {
            const modal = document.getElementById('modalContainer');
            modal.innerHTML = `
                <div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
                    <div class="bg-white rounded-2xl w-full max-w-md p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xl font-bold text-gray-900">Tambah Jadwal Mengajar</h3>
                            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <form id="addJadwalForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Hari</label>
                                <select id="jadwalHari" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl bg-white">
                                    <option value="">Pilih Hari</option>
                                    <option value="0">Senin</option>
                                    <option value="1">Selasa</option>
                                    <option value="2">Rabu</option>
                                    <option value="3">Kamis</option>
                                    <option value="4">Jumat</option>
                                    <option value="5">Sabtu</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                                <select id="jadwalKelas" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl bg-white">
                                    <option value="">Pilih Kelas</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Jam Mulai</label>
                                    <input type="time" id="jadwalMulai" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Jam Selesai</label>
                                    <input type="time" id="jadwalSelesai" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl">
                                </div>
                            </div>
                            <div id="bentrokWarning" class="hidden bg-red-50 border border-red-200 rounded-xl p-3 text-red-700 text-sm">
                                <i class="fas fa-exclamation-triangle mr-2"></i>
                                <span>Jadwal bentrok dengan kelas lain!</span>
                            </div>
                            <div class="flex justify-end space-x-3 pt-4">
                                <button type="button" onclick="closeModal()" class="px-4 py-2 border-2 border-gray-200 rounded-xl text-gray-700 hover:bg-gray-50">
                                    Batal
                                </button>
                                <button type="submit" class="btn-primary text-white px-4 py-2 rounded-xl">
                                    <i class="fas fa-save mr-2"></i>Simpan
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            // Populate kelas dropdown
            db.collection('users').doc(currentUser.uid)
                .collection('kelas').orderBy('nama').get()
                .then(snapshot => {
                    const select = document.getElementById('jadwalKelas');
                    snapshot.forEach(doc => {
                        const kelas = doc.data();
                        select.innerHTML += `<option value="${doc.id}" data-nama="${kelas.nama}">${kelas.nama}</option>`;
                    });
                });

            document.getElementById('addJadwalForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const hari = parseInt(document.getElementById('jadwalHari').value);
                const kelasId = document.getElementById('jadwalKelas').value;
                const namaKelas = document.getElementById('jadwalKelas').selectedOptions[0].dataset.nama;
                const jamMulai = document.getElementById('jadwalMulai').value;
                const jamSelesai = document.getElementById('jadwalSelesai').value;

                // Check for conflicts
                const conflicts = await checkJadwalConflict(hari, jamMulai, jamSelesai, kelasId);
                if (conflicts) {
                    document.getElementById('bentrokWarning').classList.remove('hidden');
                    return;
                }

                showLoading();

                try {
                    await db.collection('users').doc(currentUser.uid)
                        .collection('jadwal').add({
                            hari,
                            kelasId,
                            namaKelas,
                            jamMulai,
                            jamSelesai,
                            materi: 'PAI & Budi Pekerti',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });

                    hideLoading();
                    closeModal();
                    showToast('Jadwal berhasil ditambahkan!');
                    loadJadwalData();
                } catch (error) {
                    hideLoading();
                    showToast('Gagal menambahkan jadwal: ' + error.message, 'error');
                }
            });
        }

        async function checkJadwalConflict(hari, jamMulai, jamSelesai, kelasId) {
            try {
                const snapshot = await db.collection('users').doc(currentUser.uid)
                    .collection('jadwal')
                    .where('hari', '==', hari)
                    .get();

                for (const doc of snapshot.docs) {
                    const jadwal = doc.data();
                    // Check time overlap
                    if ((jamMulai >= jadwal.jamMulai && jamMulai < jadwal.jamSelesai) ||
                        (jamSelesai > jadwal.jamMulai && jamSelesai <= jadwal.jamSelesai) ||
                        (jamMulai <= jadwal.jamMulai && jamSelesai >= jadwal.jamSelesai)) {
                        return true; // Conflict found
                    }
                }
                return false;
            } catch (error) {
                console.error('Error checking conflicts:', error);
                return false;
            }
        }

        async function deleteJadwal(id) {
            if (!confirm('Hapus jadwal ini?')) return;

            showLoading();
            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('jadwal').doc(id).delete();
                hideLoading();
                showToast('Jadwal berhasil dihapus!');
                loadJadwalData();
            } catch (error) {
                hideLoading();
                showToast('Gagal menghapus: ' + error.message, 'error');
            }
        }

        // ==========================================
        // ATP (ALUR TUJUAN PEMBELAJARAN) PAGE
        // ==========================================
        function getATPHTML() {
            return `
                <div class="space-y-6 animate-slide-in">
                    <!-- Info Banner -->
                    <div class="bg-gradient-to-r from-primary-500 to-secondary-500 rounded-xl p-6 text-white">
                        <div class="flex items-start space-x-4">
                            <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-route text-2xl"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg mb-1">Alur Tujuan Pembelajaran (ATP)</h3>
                                <p class="text-primary-100 text-sm">Berdasarkan Kepka BSKAP No. 046/H/KR/2025 - Kurikulum Merdeka PAI & Budi Pekerti</p>
                            </div>
                        </div>
                    </div>

                    <div class="card p-6">
                        <!-- Filter -->
                        <div class="flex flex-col md:flex-row gap-4 mb-6">
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Pilih Fase</label>
                                <select id="atpFase" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl bg-white" onchange="loadCPByFase()">
                                    <option value="">Pilih Fase</option>
                                    <option value="faseA">Fase A (Kelas 1-2 SD/MI)</option>
                                    <option value="faseB">Fase B (Kelas 3-4 SD/MI)</option>
                                    <option value="faseC">Fase C (Kelas 5-6 SD/MI)</option>
                                    <option value="faseD">Fase D (Kelas 7-9 SMP/MTs)</option>
                                    <option value="faseE">Fase E (Kelas 10 SMA/MA)</option>
                                    <option value="faseF">Fase F (Kelas 11-12 SMA/MA)</option>
                                </select>
                            </div>
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Pilih Elemen</label>
                                <select id="atpElemen" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl bg-white" onchange="loadTPByElemen()">
                                    <option value="">Pilih Elemen</option>
                                </select>
                            </div>
                        </div>

                        <!-- CP Display -->
                        <div id="cpDisplay" class="hidden mb-6">
                            <div class="bg-primary-50 border border-primary-200 rounded-xl p-4">
                                <h4 class="font-bold text-primary-800 mb-2">
                                    <i class="fas fa-graduation-cap mr-2"></i>Capaian Pembelajaran (CP)
                                </h4>
                                <p id="cpText" class="text-primary-700"></p>
                            </div>
                        </div>

                        <!-- TP List -->
                        <div id="tpContainer" class="hidden">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="font-bold text-gray-900">Tujuan Pembelajaran (TP)</h4>
                                <button onclick="addCustomTP()" class="text-primary-600 hover:text-primary-700 text-sm font-medium">
                                    <i class="fas fa-plus mr-1"></i>Tambah TP
                                </button>
                            </div>
                            <div id="tpList" class="space-y-3">
                                <!-- TP items will be loaded here -->
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div id="atpActions" class="hidden flex flex-col sm:flex-row justify-end space-y-3 sm:space-y-0 sm:space-x-3 mt-6 pt-6 border-t">
                            <button onclick="saveATP()" class="btn-primary text-white px-6 py-3 rounded-xl font-semibold">
                                <i class="fas fa-save mr-2"></i>Simpan ATP
                            </button>
                            <button onclick="generateProta()" class="bg-secondary-500 hover:bg-secondary-600 text-white px-6 py-3 rounded-xl font-semibold transition">
                                <i class="fas fa-magic mr-2"></i>Generate Prota
                            </button>
                        </div>
                    </div>

                    <!-- Saved ATP -->
                    <div class="card p-6">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">ATP Tersimpan</h3>
                        <div id="savedATPList" class="space-y-3">
                            <div class="text-center py-8 text-gray-500">
                                <i class="fas fa-folder-open text-4xl mb-3 text-gray-300"></i>
                                <p>Belum ada ATP tersimpan.</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function initATP() {
            loadSavedATP();
        }

        function loadCPByFase() {
            const fase = document.getElementById('atpFase').value;
            const elemenSelect = document.getElementById('atpElemen');
            
            elemenSelect.innerHTML = '<option value="">Pilih Elemen</option>';
            document.getElementById('cpDisplay').classList.add('hidden');
            document.getElementById('tpContainer').classList.add('hidden');
            document.getElementById('atpActions').classList.add('hidden');

            if (!fase || !CP_PAI_DATA[fase]) return;

            const elemen = CP_PAI_DATA[fase].elemen;
            Object.keys(elemen).forEach(key => {
                elemenSelect.innerHTML += `<option value="${key}">${elemen[key].nama}</option>`;
            });
        }

        function loadTPByElemen() {
            const fase = document.getElementById('atpFase').value;
            const elemen = document.getElementById('atpElemen').value;

            if (!fase || !elemen || !CP_PAI_DATA[fase]) return;

            const data = CP_PAI_DATA[fase].elemen[elemen];
            
            // Show CP
            document.getElementById('cpDisplay').classList.remove('hidden');
            document.getElementById('cpText').textContent = data.cp;

            // Show TP
            document.getElementById('tpContainer').classList.remove('hidden');
            document.getElementById('atpActions').classList.remove('hidden');

            const tpList = document.getElementById('tpList');
            tpList.innerHTML = data.tp.map((tp, idx) => `
                <div class="flex items-start space-x-3 bg-gray-50 p-4 rounded-xl" data-tp-index="${idx}">
                    <div class="flex items-center space-x-3 flex-shrink-0">
                        <input type="checkbox" checked class="w-5 h-5 text-primary-600 rounded" data-tp-check>
                        <span class="w-8 h-8 bg-primary-100 text-primary-600 rounded-lg flex items-center justify-center font-bold text-sm">
                            ${idx + 1}
                        </span>
                    </div>
                    <div class="flex-1">
                        <textarea class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg resize-none" rows="2" data-tp-text>${tp}</textarea>
                    </div>
                    <button onclick="this.closest('[data-tp-index]').remove()" class="text-red-500 hover:text-red-700 p-2">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        function addCustomTP() {
            const tpList = document.getElementById('tpList');
            const count = tpList.children.length + 1;
            const div = document.createElement('div');
            div.className = 'flex items-start space-x-3 bg-gray-50 p-4 rounded-xl';
            div.dataset.tpIndex = count;
            div.innerHTML = `
                <div class="flex items-center space-x-3 flex-shrink-0">
                    <input type="checkbox" checked class="w-5 h-5 text-primary-600 rounded" data-tp-check>
                    <span class="w-8 h-8 bg-primary-100 text-primary-600 rounded-lg flex items-center justify-center font-bold text-sm">
                        ${count}
                    </span>
                </div>
                <div class="flex-1">
                    <textarea class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg resize-none" rows="2" data-tp-text placeholder="Tuliskan Tujuan Pembelajaran..."></textarea>
                </div>
                <button onclick="this.closest('[data-tp-index]').remove()" class="text-red-500 hover:text-red-700 p-2">
                    <i class="fas fa-times"></i>
                </button>
            `;
            tpList.appendChild(div);
        }

        async function saveATP() {
            const fase = document.getElementById('atpFase').value;
            const elemen = document.getElementById('atpElemen').value;
            
            if (!fase || !elemen) {
                showToast('Pilih Fase dan Elemen terlebih dahulu', 'error');
                return;
            }

            // Collect selected TP
            const tpItems = [];
            document.querySelectorAll('#tpList > div').forEach((div, idx) => {
                const checked = div.querySelector('[data-tp-check]').checked;
                const text = div.querySelector('[data-tp-text]').value;
                if (checked && text.trim()) {
                    tpItems.push({
                        nomor: idx + 1,
                        tujuan: text.trim()
                    });
                }
            });

            if (tpItems.length === 0) {
                showToast('Pilih minimal satu Tujuan Pembelajaran', 'error');
                return;
            }

            showLoading();

            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('atp').add({
                        fase,
                        faseNama: CP_PAI_DATA[fase].nama,
                        elemen,
                        elemenNama: CP_PAI_DATA[fase].elemen[elemen].nama,
                        cp: CP_PAI_DATA[fase].elemen[elemen].cp,
                        tp: tpItems,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                hideLoading();
                showToast('ATP berhasil disimpan!');
                loadSavedATP();
            } catch (error) {
                hideLoading();
                showToast('Gagal menyimpan: ' + error.message, 'error');
            }
        }

        async function loadSavedATP() {
            try {
                const snapshot = await db.collection('users').doc(currentUser.uid)
                    .collection('atp').orderBy('createdAt', 'desc').get();

                const container = document.getElementById('savedATPList');
                
                if (snapshot.empty) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-folder-open text-4xl mb-3 text-gray-300"></i>
                            <p>Belum ada ATP tersimpan.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = snapshot.docs.map(doc => {
                    const atp = doc.data();
                    return `
                        <div class="bg-gray-50 rounded-xl p-4">
                            <div class="flex items-center justify-between mb-3">
                                <div>
                                    <h4 class="font-bold text-gray-900">${atp.faseNama}</h4>
                                    <p class="text-sm text-gray-500">${atp.elemenNama}</p>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="viewATP('${doc.id}')" class="text-primary-600 hover:text-primary-700 p-2">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button onclick="deleteATP('${doc.id}')" class="text-red-500 hover:text-red-700 p-2">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="text-sm text-gray-600">
                                <span class="bg-primary-100 text-primary-700 px-2 py-1 rounded-full text-xs font-medium">
                                    ${atp.tp.length} Tujuan Pembelajaran
                                </span>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading ATP:', error);
            }
        }

        async function deleteATP(id) {
            if (!confirm('Hapus ATP ini?')) return;

            showLoading();
            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('atp').doc(id).delete();
                hideLoading();
                showToast('ATP berhasil dihapus!');
                loadSavedATP();
            } catch (error) {
                hideLoading();
                showToast('Gagal menghapus: ' + error.message, 'error');
            }
        }

        // ==========================================
        // PROTA PAGE
        // ==========================================
        function getProtaHTML() {
            return `
                <div class="space-y-6 animate-slide-in">
                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 flex items-start space-x-3">
                        <i class="fas fa-info-circle text-blue-500 mt-0.5"></i>
                        <div>
                            <p class="text-blue-800 font-medium">Program Tahunan (Prota)</p>
                            <p class="text-blue-600 text-sm">Prota otomatis dibuat berdasarkan ATP dan Kalender Pendidikan yang telah disimpan.</p>
                        </div>
                    </div>

                    <div class="card p-6">
                        <div class="flex flex-col md:flex-row md:items-center justify-between mb-6">
                            <h3 class="text-lg font-bold text-gray-900 mb-4 md:mb-0">Generate Prota</h3>
                            <div class="flex space-x-3">
                                <select id="protaKelas" class="px-4 py-2 border-2 border-gray-200 rounded-xl bg-white">
                                    <option value="">Pilih Kelas</option>
                                </select>
                                <button onclick="generateProtaDocument()" class="btn-primary text-white px-4 py-2 rounded-lg">
                                    <i class="fas fa-magic mr-2"></i>Generate
                                </button>
                            </div>
                        </div>

                        <div id="protaPreview" class="hidden">
                            <!-- Prota preview will be shown here -->
                        </div>

                        <div id="protaEmpty" class="text-center py-12 text-gray-500">
                            <i class="fas fa-calendar-check text-5xl mb-4 text-gray-300"></i>
                            <p class="mb-2">Pilih kelas dan klik Generate untuk membuat Prota</p>
                            <p class="text-sm">Pastikan Anda sudah membuat ATP dan Kalender Pendidikan</p>
                        </div>
                    </div>

                    <!-- Saved Prota List -->
                    <div class="card p-6">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Prota Tersimpan</h3>
                        <div id="savedProtaList" class="space-y-3">
                            <div class="text-center py-8 text-gray-500">
                                <i class="fas fa-folder-open text-4xl mb-3 text-gray-300"></i>
                                <p>Belum ada Prota tersimpan.</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function initProta() {
            // Load kelas for dropdown
            const snapshot = await db.collection('users').doc(currentUser.uid)
                .collection('kelas').orderBy('nama').get();
            
            const select = document.getElementById('protaKelas');
            snapshot.forEach(doc => {
                const kelas = doc.data();
                select.innerHTML += `<option value="${doc.id}" data-fase="${kelas.fase}">${kelas.nama}</option>`;
            });

            loadSavedProta();
        }

        async function generateProtaDocument() {
            const kelasSelect = document.getElementById('protaKelas');
            const kelasId = kelasSelect.value;
            const fase = kelasSelect.selectedOptions[0]?.dataset.fase;
            const namaKelas = kelasSelect.selectedOptions[0]?.text;

            if (!kelasId) {
                showToast('Pilih kelas terlebih dahulu', 'error');
                return;
            }

            showLoading();

            try {
                // Get kalender
                const kalenderSnap = await db.collection('users').doc(currentUser.uid)
                    .collection('kalender').doc('aktif').get();
                
                if (!kalenderSnap.exists) {
                    hideLoading();
                    showToast('Lengkapi Kalender Pendidikan terlebih dahulu', 'error');
                    return;
                }

                // Get ATP for this fase
                const atpSnap = await db.collection('users').doc(currentUser.uid)
                    .collection('atp').where('fase', '==', 'fase' + fase).get();

                if (atpSnap.empty) {
                    hideLoading();
                    showToast('Buat ATP untuk fase ' + fase + ' terlebih dahulu', 'error');
                    return;
                }

                // Generate Prota
                const atpList = atpSnap.docs.map(doc => doc.data());
                const kalender = kalenderSnap.data();

                // Create Prota document
                const protaData = {
                    kelasId,
                    namaKelas,
                    fase,
                    tahunPelajaran: kalender.tahun,
                    totalMingguEfektif: kalender.totalMingguEfektif || 36,
                    semester1: generateSemesterProta(atpList, 1),
                    semester2: generateSemesterProta(atpList, 2),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                await db.collection('users').doc(currentUser.uid)
                    .collection('prota').doc(kelasId).set(protaData);

                // Show preview
                showProtaPreview(protaData);

                hideLoading();
                showToast('Prota berhasil di-generate!');
                loadSavedProta();

            } catch (error) {
                hideLoading();
                showToast('Gagal generate Prota: ' + error.message, 'error');
            }
        }

        function generateSemesterProta(atpList, semester) {
            const items = [];
            let bulanStart = semester === 1 ? 7 : 1;
            let mingguKe = 1;

            atpList.forEach((atp, atpIdx) => {
                atp.tp.forEach((tp, tpIdx) => {
                    items.push({
                        bulan: getBulanName(bulanStart + Math.floor((mingguKe - 1) / 4)),
                        mingguKe: mingguKe,
                        elemen: atp.elemenNama,
                        tp: tp.tujuan,
                        alokasi: 3 // JP per pertemuan
                    });
                    mingguKe++;
                });
            });

            return items;
        }

        function getBulanName(bulan) {
            const names = ['', 'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                          'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            return names[bulan] || names[((bulan - 1) % 12) + 1];
        }

        function showProtaPreview(prota) {
            document.getElementById('protaEmpty').classList.add('hidden');
            document.getElementById('protaPreview').classList.remove('hidden');
            
            document.getElementById('protaPreview').innerHTML = `
                <div class="bg-white border rounded-xl overflow-hidden">
                    <div class="bg-primary-50 px-6 py-4 border-b">
                        <h4 class="font-bold text-primary-800">PROGRAM TAHUNAN (PROTA)</h4>
                        <p class="text-sm text-primary-600">Kelas ${prota.namaKelas} - Tahun Pelajaran ${prota.tahunPelajaran}/${parseInt(prota.tahunPelajaran) + 1}</p>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left font-semibold">Bulan</th>
                                    <th class="px-4 py-3 text-left font-semibold">Minggu</th>
                                    <th class="px-4 py-3 text-left font-semibold">Elemen</th>
                                    <th class="px-4 py-3 text-left font-semibold">Tujuan Pembelajaran</th>
                                    <th class="px-4 py-3 text-center font-semibold">JP</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${(prota.semester1 || []).slice(0, 10).map(item => `
                                    <tr class="border-t">
                                        <td class="px-4 py-3">${item.bulan}</td>
                                        <td class="px-4 py-3">${item.mingguKe}</td>
                                        <td class="px-4 py-3">${item.elemen}</td>
                                        <td class="px-4 py-3">${item.tp}</td>
                                        <td class="px-4 py-3 text-center">${item.alokasi}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div class="px-6 py-4 bg-gray-50 border-t flex justify-end space-x-3">
                        <button onclick="printProta('${prota.kelasId}')" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition">
                            <i class="fas fa-print mr-2"></i>Cetak
                        </button>
                        <button onclick="exportProtaPDF('${prota.kelasId}')" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition">
                            <i class="fas fa-file-pdf mr-2"></i>Export PDF
                        </button>
                    </div>
                </div>
            `;
        }

        async function loadSavedProta() {
            try {
                const snapshot = await db.collection('users').doc(currentUser.uid)
                    .collection('prota').get();

                const container = document.getElementById('savedProtaList');
                
                if (snapshot.empty) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-folder-open text-4xl mb-3 text-gray-300"></i>
                            <p>Belum ada Prota tersimpan.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = snapshot.docs.map(doc => {
                    const prota = doc.data();
                    return `
                        <div class="bg-gray-50 rounded-xl p-4 flex items-center justify-between">
                            <div>
                                <h4 class="font-bold text-gray-900">Prota ${prota.namaKelas}</h4>
                                <p class="text-sm text-gray-500">Fase ${prota.fase} - TP ${prota.tahunPelajaran}</p>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="viewProta('${doc.id}')" class="text-primary-600 hover:text-primary-700 p-2">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="printProta('${doc.id}')" class="text-gray-600 hover:text-gray-700 p-2">
                                    <i class="fas fa-print"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading Prota:', error);
            }
        }

        // ==========================================
        // PROMES PAGE
        // ==========================================
        function getPromesHTML() {
            return checkPremiumAccess('Promes') || `
                <div class="space-y-6 animate-slide-in">
                    <div class="bg-purple-50 border border-purple-200 rounded-xl p-4 flex items-start space-x-3">
                        <i class="fas fa-info-circle text-purple-500 mt-0.5"></i>
                        <div>
                            <p class="text-purple-800 font-medium">Program Semester (Promes)</p>
                            <p class="text-purple-600 text-sm">Promes lebih detail dari Prota, mencakup alokasi waktu per minggu dan sinkronisasi dengan jadwal.</p>
                        </div>
                    </div>

                    <div class="card p-6">
                        <div class="flex flex-col md:flex-row md:items-center justify-between mb-6">
                            <h3 class="text-lg font-bold text-gray-900">Generate Promes</h3>
                            <div class="flex flex-wrap gap-3 mt-4 md:mt-0">
                                <select id="promesKelas" class="px-4 py-2 border-2 border-gray-200 rounded-xl bg-white">
                                    <option value="">Pilih Kelas</option>
                                </select>
                                <select id="promesSemester" class="px-4 py-2 border-2 border-gray-200 rounded-xl bg-white">
                                    <option value="1">Semester 1</option>
                                    <option value="2">Semester 2</option>
                                </select>
                                <button onclick="generatePromesDocument()" class="btn-primary text-white px-4 py-2 rounded-lg">
                                    <i class="fas fa-magic mr-2"></i>Generate
                                </button>
                            </div>
                        </div>

                        <div id="promesPreview" class="hidden">
                            <!-- Promes matrix preview -->
                        </div>

                        <div id="promesEmpty" class="text-center py-12 text-gray-500">
                            <i class="fas fa-calendar-week text-5xl mb-4 text-gray-300"></i>
                            <p>Pilih kelas dan semester untuk generate Promes</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function initPromes() {
            if (userData?.plan !== 'premium') return;

            // Load kelas
            db.collection('users').doc(currentUser.uid)
                .collection('kelas').orderBy('nama').get()
                .then(snapshot => {
                    const select = document.getElementById('promesKelas');
                    snapshot.forEach(doc => {
                        const kelas = doc.data();
                        select.innerHTML += `<option value="${doc.id}">${kelas.nama}</option>`;
                    });
                });
        }

        function checkPremiumAccess(featureName) {
            if (userData?.plan === 'premium') return null;
            
            return `
                <div class="flex items-center justify-center min-h-[60vh]">
                    <div class="text-center max-w-md">
                        <div class="w-20 h-20 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-6">
                            <i class="fas fa-crown text-4xl text-yellow-500"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-900 mb-3">Fitur Premium</h2>
                        <p class="text-gray-600 mb-6">
                            ${featureName} adalah fitur premium. Upgrade akun Anda untuk mengakses semua fitur lengkap.
                        </p>
                        <button onclick="showUpgradeModal()" class="btn-primary text-white px-8 py-3 rounded-xl font-semibold">
                            <i class="fas fa-rocket mr-2"></i>Upgrade ke Premium
                        </button>
                    </div>
                </div>
            `;
        }

        function showUpgradeModal() {
            const modal = document.getElementById('modalContainer');
            modal.innerHTML = `
                <div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
                    <div class="bg-white rounded-2xl w-full max-w-lg p-8 text-center">
                        <div class="w-16 h-16 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full flex items-center justify-center mx-auto mb-6">
                            <i class="fas fa-crown text-3xl text-white"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-900 mb-3">Upgrade ke Premium</h3>
                        <p class="text-gray-600 mb-6">
                            Dapatkan akses penuh ke semua fitur: Promes, Modul Ajar, LKPD, Bank Soal, Jurnal, dan AI Assistant.
                        </p>
                        <div class="bg-gray-50 rounded-xl p-6 mb-6">
                            <p class="text-4xl font-bold text-gray-900 mb-1">Rp 49.000<span class="text-lg text-gray-500 font-normal">/bulan</span></p>
                            <p class="text-sm text-gray-500">Atau Rp 299.000/tahun (hemat 50%)</p>
                        </div>
                        <div class="flex space-x-3">
                            <button onclick="closeModal()" class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl text-gray-700 hover:bg-gray-50">
                                Nanti
                            </button>
                            <button onclick="processUpgrade()" class="flex-1 btn-primary text-white px-4 py-3 rounded-xl font-semibold">
                                Upgrade Sekarang
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function processUpgrade() {
            showToast('Fitur pembayaran akan segera tersedia. Hubungi admin untuk upgrade.', 'info');
            closeModal();
        }

        // ==========================================
        // MODUL AJAR PAGE
        // ==========================================
        function getModulAjarHTML() {
            return checkPremiumAccess('Modul Ajar') || `
                <div class="space-y-6 animate-slide-in">
                    <div class="bg-gradient-to-r from-rose-500 to-pink-500 rounded-xl p-6 text-white">
                        <div class="flex items-start space-x-4">
                            <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-book-open text-2xl"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg mb-1">Modul Ajar</h3>
                                <p class="text-rose-100 text-sm">Dengan dukungan teks Arab (Right-to-Left) dan integrasi LKPD.</p>
                            </div>
                        </div>
                    </div>

                    <div class="card p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-lg font-bold text-gray-900">Daftar Modul Ajar</h3>
                            <button onclick="showAddModulModal()" class="btn-primary text-white px-4 py-2 rounded-lg">
                                <i class="fas fa-plus mr-2"></i>Buat Modul
                            </button>
                        </div>

                        <div id="modulList" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div class="col-span-full text-center py-12 text-gray-500">
                                <i class="fas fa-book-open text-5xl mb-4 text-gray-300"></i>
                                <p>Belum ada modul ajar. Klik "Buat Modul" untuk memulai.</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function initModulAjar() {
            if (userData?.plan !== 'premium') return;
            loadModulList();
        }

        async function loadModulList() {
            try {
                const snapshot = await db.collection('users').doc(currentUser.uid)
                    .collection('modul_ajar').orderBy('createdAt', 'desc').get();

                const container = document.getElementById('modulList');
                
                if (snapshot.empty) {
                    container.innerHTML = `
                        <div class="col-span-full text-center py-12 text-gray-500">
                            <i class="fas fa-book-open text-5xl mb-4 text-gray-300"></i>
                            <p>Belum ada modul ajar. Klik "Buat Modul" untuk memulai.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = snapshot.docs.map(doc => {
                    const modul = doc.data();
                    return `
                        <div class="bg-gray-50 hover:bg-gray-100 p-4 rounded-xl transition">
                            <div class="flex items-start justify-between mb-3">
                                <div class="w-10 h-10 bg-rose-100 text-rose-600 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-book"></i>
                                </div>
                                <div class="flex space-x-1">
                                    <button onclick="editModul('${doc.id}')" class="text-gray-400 hover:text-primary-600 p-1">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteModul('${doc.id}')" class="text-gray-400 hover:text-red-600 p-1">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <h4 class="font-bold text-gray-900 mb-1">${modul.judul}</h4>
                            <p class="text-sm text-gray-500 mb-3">${modul.kelas} â€¢ ${modul.elemen}</p>
                            <div class="flex items-center space-x-2">
                                ${modul.hasLKPD ? '<span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">LKPD</span>' : ''}
                                ${modul.hasArabic ? '<span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full">Teks Arab</span>' : ''}
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading modul:', error);
            }
        }

        function showAddModulModal() {
            const modal = document.getElementById('modalContainer');
            modal.innerHTML = `
                <div class="fixed inset-0 z-50 flex items-start justify-center p-4 bg-black/50 backdrop-blur-sm overflow-y-auto">
                    <div class="bg-white rounded-2xl w-full max-w-3xl my-8">
                        <div class="sticky top-0 bg-white border-b px-6 py-4 rounded-t-2xl flex items-center justify-between">
                            <h3 class="text-xl font-bold text-gray-900">Buat Modul Ajar Baru</h3>
                            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <form id="addModulForm" class="p-6 space-y-6 max-h-[70vh] overflow-y-auto">
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Judul Modul</label>
                                    <input type="text" id="modulJudul" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl" placeholder="Contoh: Surah Al-Fatihah">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                                    <select id="modulKelas" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl bg-white">
                                        <option value="">Pilih Kelas</option>
                                    </select>
                                </div>
                            </div>

                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Elemen</label>
                                    <select id="modulElemen" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl bg-white">
                                        <option value="">Pilih Elemen</option>
                                        <option value="Al-Qur'an dan Hadis">Al-Qur'an dan Hadis</option>
                                        <option value="Akidah">Akidah</option>
                                        <option value="Akhlak">Akhlak</option>
                                        <option value="Fikih">Fikih</option>
                                        <option value="Sejarah Peradaban Islam">Sejarah Peradaban Islam</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Alokasi Waktu</label>
                                    <input type="text" id="modulAlokasi" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl" placeholder="Contoh: 3 x 35 menit">
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tujuan Pembelajaran</label>
                                <textarea id="modulTP" rows="3" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl" placeholder="Tuliskan tujuan pembelajaran..."></textarea>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Materi Pokok</label>
                                <textarea id="modulMateri" rows="3" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl" placeholder="Tuliskan materi pokok..."></textarea>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-quran mr-1"></i>Teks Arab (opsional)
                                </label>
                                <textarea id="modulArabic" rows="2" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl arabic-text" dir="rtl" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ù‡Ù†Ø§..."></textarea>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Langkah Pembelajaran</label>
                                <div id="langkahContainer" class="space-y-3">
                                    <div class="bg-gray-50 p-4 rounded-xl">
                                        <p class="font-medium text-gray-700 mb-2">Pendahuluan (10 menit)</p>
                                        <textarea class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg" rows="2" data-langkah="pendahuluan">- Salam dan doa pembuka
- Apersepsi dan motivasi</textarea>
                                    </div>
                                    <div class="bg-gray-50 p-4 rounded-xl">
                                        <p class="font-medium text-gray-700 mb-2">Inti (50 menit)</p>
                                        <textarea class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg" rows="4" data-langkah="inti">- Kegiatan pembelajaran inti...</textarea>
                                    </div>
                                    <div class="bg-gray-50 p-4 rounded-xl">
                                        <p class="font-medium text-gray-700 mb-2">Penutup (10 menit)</p>
                                        <textarea class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg" rows="2" data-langkah="penutup">- Refleksi dan kesimpulan
- Doa penutup</textarea>
                                    </div>
                                </div>
                            </div>

                            <div class="flex items-center space-x-6">
                                <label class="flex items-center">
                                    <input type="checkbox" id="modulLKPD" class="mr-2 w-5 h-5 text-primary-600 rounded">
                                    <span class="text-sm">Sertakan LKPD</span>
                                </label>
                            </div>

                            <div class="flex justify-end space-x-3 pt-4 border-t">
                                <button type="button" onclick="closeModal()" class="px-4 py-2 border-2 border-gray-200 rounded-xl text-gray-700 hover:bg-gray-50">
                                    Batal
                                </button>
                                <button type="submit" class="btn-primary text-white px-6 py-2 rounded-xl">
                                    <i class="fas fa-save mr-2"></i>Simpan
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            // Load kelas dropdown
            db.collection('users').doc(currentUser.uid)
                .collection('kelas').orderBy('nama').get()
                .then(snapshot => {
                    const select = document.getElementById('modulKelas');
                    snapshot.forEach(doc => {
                        const kelas = doc.data();
                        select.innerHTML += `<option value="${kelas.nama}">${kelas.nama}</option>`;
                    });
                });

            // Form submit
            document.getElementById('addModulForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoading();

                const langkah = {};
                document.querySelectorAll('[data-langkah]').forEach(el => {
                    langkah[el.dataset.langkah] = el.value;
                });

                try {
                    await db.collection('users').doc(currentUser.uid)
                        .collection('modul_ajar').add({
                            judul: document.getElementById('modulJudul').value,
                            kelas: document.getElementById('modulKelas').value,
                            elemen: document.getElementById('modulElemen').value,
                            alokasi: document.getElementById('modulAlokasi').value,
                            tujuanPembelajaran: document.getElementById('modulTP').value,
                            materiPokok: document.getElementById('modulMateri').value,
                            teksArab: document.getElementById('modulArabic').value,
                            langkahPembelajaran: langkah,
                            hasLKPD: document.getElementById('modulLKPD').checked,
                            hasArabic: document.getElementById('modulArabic').value.trim() !== '',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });

                    hideLoading();
                    closeModal();
                    showToast('Modul Ajar berhasil disimpan!');
                    loadModulList();
                } catch (error) {
                    hideLoading();
                    showToast('Gagal menyimpan: ' + error.message, 'error');
                }
            });
        }

        // ==========================================
        // OTHER PAGES (LKPD, Bank Soal, Jurnal, etc)
        // ==========================================
        function getLKPDHTML() {
            return checkPremiumAccess('LKPD') || `
                <div class="space-y-6 animate-slide-in">
                    <div class="card p-6">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Lembar Kerja Peserta Didik (LKPD)</h3>
                        <p class="text-gray-600">LKPD akan otomatis tersedia saat Anda mengaktifkan opsi LKPD di Modul Ajar.</p>
                    </div>
                </div>
            `;
        }

        function initLKPD() {}

        function getBankSoalHTML() {
            return checkPremiumAccess('Bank Soal') || `
                <div class="space-y-6 animate-slide-in">
                    <div class="card p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-lg font-bold text-gray-900">Bank Soal PAI</h3>
                            <button onclick="showAddSoalModal()" class="btn-primary text-white px-4 py-2 rounded-lg">
                                <i class="fas fa-plus mr-2"></i>Tambah Soal
                            </button>
                        </div>
                        <div id="soalList" class="space-y-4">
                            <div class="text-center py-12 text-gray-500">
                                <i class="fas fa-question-circle text-5xl mb-4 text-gray-300"></i>
                                <p>Belum ada soal. Tambahkan soal untuk mulai membangun bank soal.</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function initBankSoal() {}

        function getJurnalHTML() {
            return checkPremiumAccess('Jurnal Pembelajaran') || `
                <div class="space-y-6 animate-slide-in">
                    <div class="card p-6">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Jurnal Pembelajaran</h3>
                        <p class="text-gray-600 mb-6">Jurnal otomatis dibuat berdasarkan jadwal dan modul ajar Anda.</p>
                        <div id="jurnalList" class="space-y-4">
                            <!-- Jurnal entries -->
                        </div>
                    </div>
                </div>
            `;
        }

        function initJurnal() {}

        function getAbsensiHTML() {
            return `
                <div class="space-y-6 animate-slide-in">
                    <div class="card p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-lg font-bold text-gray-900">Absensi Siswa</h3>
                            <select id="absensiKelas" class="px-4 py-2 border-2 border-gray-200 rounded-xl bg-white" onchange="loadAbsensi()">
                                <option value="">Pilih Kelas</option>
                            </select>
                        </div>
                        <div id="absensiContent" class="text-center py-12 text-gray-500">
                            <i class="fas fa-user-check text-5xl mb-4 text-gray-300"></i>
                            <p>Pilih kelas untuk melihat dan mengisi absensi</p>
                        </div>
                    </div>
                </div>
            `;
        }

        async function initAbsensi() {
            const snapshot = await db.collection('users').doc(currentUser.uid)
                .collection('kelas').orderBy('nama').get();
            
            const select = document.getElementById('absensiKelas');
            snapshot.forEach(doc => {
                const kelas = doc.data();
                select.innerHTML += `<option value="${doc.id}">${kelas.nama}</option>`;
            });
        }

        function getNilaiHTML() {
            return `
                <div class="space-y-6 animate-slide-in">
                    <div class="card p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-lg font-bold text-gray-900">Daftar Nilai</h3>
                            <div class="flex space-x-3">
                                <select id="nilaiKelas" class="px-4 py-2 border-2 border-gray-200 rounded-xl bg-white">
                                    <option value="">Pilih Kelas</option>
                                </select>
                                <select id="nilaiJenis" class="px-4 py-2 border-2 border-gray-200 rounded-xl bg-white">
                                    <option value="formatif">Formatif</option>
                                    <option value="sumatif">Sumatif</option>
                                </select>
                            </div>
                        </div>
                        <div id="nilaiContent" class="text-center py-12 text-gray-500">
                            <i class="fas fa-star text-5xl mb-4 text-gray-300"></i>
                            <p>Pilih kelas untuk input dan melihat nilai</p>
                        </div>
                    </div>
                </div>
            `;
        }

        async function initNilai() {
            const snapshot = await db.collection('users').doc(currentUser.uid)
                .collection('kelas').orderBy('nama').get();
            
            const select = document.getElementById('nilaiKelas');
            snapshot.forEach(doc => {
                const kelas = doc.data();
                select.innerHTML += `<option value="${doc.id}">${kelas.nama}</option>`;
            });
        }

        // ==========================================
        // AI ASSISTANT PAGE
        // ==========================================
        function getAIAssistantHTML() {
            return `
                <div class="space-y-6 animate-slide-in">
                    <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl p-6 text-white">
                        <div class="flex items-start space-x-4">
                            <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-robot text-2xl"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg mb-1">AI Assistant</h3>
                                <p class="text-indigo-100 text-sm">Generate Tujuan Pembelajaran dan Langkah Pembelajaran dengan bantuan AI.</p>
                            </div>
                        </div>
                    </div>

                    <div class="grid lg:grid-cols-2 gap-6">
                        <!-- Generate TP -->
                        <div class="card p-6">
                            <h4 class="font-bold text-gray-900 mb-4">
                                <i class="fas fa-bullseye text-primary-500 mr-2"></i>Generate Tujuan Pembelajaran
                            </h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Materi/Topik</label>
                                    <input type="text" id="aiMateri" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl" placeholder="Contoh: Shalat Fardhu">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Fase</label>
                                    <select id="aiFase" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl bg-white">
                                        <option value="A">Fase A (Kelas 1-2)</option>
                                        <option value="B">Fase B (Kelas 3-4)</option>
                                        <option value="C">Fase C (Kelas 5-6)</option>
                                        <option value="D">Fase D (Kelas 7-9)</option>
                                        <option value="E">Fase E (Kelas 10)</option>
                                        <option value="F">Fase F (Kelas 11-12)</option>
                                    </select>
                                </div>
                                <button onclick="generateTPWithAI()" class="w-full btn-primary text-white py-3 rounded-xl font-semibold">
                                    <i class="fas fa-magic mr-2"></i>Generate TP
                                </button>
                                <div id="aiTPResult" class="hidden bg-green-50 border border-green-200 rounded-xl p-4">
                                    <h5 class="font-medium text-green-800 mb-2">Hasil Generate:</h5>
                                    <div id="aiTPContent" class="text-green-700 text-sm space-y-2"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Generate CSV Template -->
                        <div class="card p-6">
                            <h4 class="font-bold text-gray-900 mb-4">
                                <i class="fas fa-file-csv text-secondary-500 mr-2"></i>Generate CSV Template
                            </h4>
                            <div class="space-y-4">
                                <p class="text-gray-600 text-sm">
                                    Dapatkan template CSV untuk import data TP yang sudah terstruktur sesuai Kurikulum Merdeka.
                                </p>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Pilih Fase</label>
                                    <select id="csvFase" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl bg-white">
                                        <option value="A">Fase A</option>
                                        <option value="B">Fase B</option>
                                        <option value="C">Fase C</option>
                                        <option value="D">Fase D</option>
                                        <option value="E">Fase E</option>
                                        <option value="F">Fase F</option>
                                    </select>
                                </div>
                                <button onclick="downloadCSVTemplate()" class="w-full bg-secondary-500 hover:bg-secondary-600 text-white py-3 rounded-xl font-semibold transition">
                                    <i class="fas fa-download mr-2"></i>Download Template CSV
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- AI Prompt Guide -->
                    <div class="card p-6">
                        <h4 class="font-bold text-gray-900 mb-4">
                            <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>Panduan Prompt AI
                        </h4>
                        <div class="bg-gray-50 rounded-xl p-4 text-sm text-gray-600 space-y-3">
                            <p><strong>Untuk ChatGPT/Claude:</strong></p>
                            <div class="bg-white p-3 rounded-lg border font-mono text-xs">
                                Buatkan 5 Tujuan Pembelajaran (TP) untuk materi [MATERI] pada mata pelajaran PAI Kurikulum Merdeka untuk [FASE/KELAS]. TP harus menggunakan kata kerja operasional yang terukur dan sesuai dengan Taksonomi Bloom revisi.
                            </div>
                            <p class="text-gray-500">Copy prompt di atas dan paste ke ChatGPT atau Claude untuk mendapatkan TP yang berkualitas.</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function initAIAssistant() {}

        function generateTPWithAI() {
            const materi = document.getElementById('aiMateri').value;
            const fase = document.getElementById('aiFase').value;

            if (!materi.trim()) {
                showToast('Masukkan materi/topik terlebih dahulu', 'error');
                return;
            }

            showLoading();

            // Simulate AI generation (in real app, connect to AI API)
            setTimeout(() => {
                const tpSuggestions = [
                    `Peserta didik dapat menjelaskan pengertian ${materi} dengan benar.`,
                    `Peserta didik dapat menyebutkan dalil tentang ${materi} dari Al-Qur'an dan Hadis.`,
                    `Peserta didik dapat mengidentifikasi syarat dan rukun ${materi}.`,
                    `Peserta didik dapat mempraktikkan ${materi} dengan tartib yang benar.`,
                    `Peserta didik dapat menganalisis hikmah ${materi} dalam kehidupan sehari-hari.`
                ];

                document.getElementById('aiTPResult').classList.remove('hidden');
                document.getElementById('aiTPContent').innerHTML = tpSuggestions.map((tp, idx) => `
                    <div class="flex items-start space-x-2">
                        <span class="font-bold">${idx + 1}.</span>
                        <span>${tp}</span>
                    </div>
                `).join('');

                hideLoading();
                showToast('TP berhasil di-generate!');
            }, 1500);
        }

        function downloadCSVTemplate() {
            const fase = document.getElementById('csvFase').value;
            const faseData = CP_PAI_DATA['fase' + fase];
            
            if (!faseData) {
                showToast('Fase tidak ditemukan', 'error');
                return;
            }

            let csvContent = "No,Elemen,Capaian Pembelajaran,Tujuan Pembelajaran,Alokasi Waktu\n";
            let no = 1;

            Object.keys(faseData.elemen).forEach(key => {
                const elemen = faseData.elemen[key];
                elemen.tp.forEach(tp => {
                    csvContent += `${no},"${elemen.nama}","${elemen.cp}","${tp}","3 JP"\n`;
                    no++;
                });
            });

            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `template_tp_fase_${fase}.csv`;
            link.click();

            showToast('Template CSV berhasil didownload!');
        }

        // ==========================================
        // IMPORT DATA PAGE
        // ==========================================
        function getImportHTML() {
            return `
                <div class="space-y-6 animate-slide-in">
                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 flex items-start space-x-3">
                        <i class="fas fa-info-circle text-blue-500 mt-0.5"></i>
                        <div>
                            <p class="text-blue-800 font-medium">Import Data dari CSV</p>
                            <p class="text-blue-600 text-sm">Upload file .csv dari Google Spreadsheet untuk import data siswa secara massal.</p>
                        </div>
                    </div>

                    <div class="card p-6">
                        <h3 class="text-lg font-bold text-gray-900 mb-6">Import Data Siswa</h3>
                        
                        <div class="grid md:grid-cols-2 gap-6">
                            <!-- Upload Area -->
                            <div>
                                <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-primary-500 transition cursor-pointer" onclick="document.getElementById('fileInput').click()">
                                    <input type="file" id="fileInput" accept=".csv" class="hidden" onchange="handleFileUpload(event)">
                                    <i class="fas fa-cloud-upload-alt text-5xl text-gray-300 mb-4"></i>
                                    <p class="text-gray-600 mb-2">Klik atau drag file CSV ke sini</p>
                                    <p class="text-sm text-gray-400">Format: .csv (max 5MB)</p>
                                </div>
                                <div id="uploadProgress" class="hidden mt-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-sm text-gray-600">Uploading...</span>
                                        <span id="progressPercent" class="text-sm font-medium">0%</span>
                                    </div>
                                    <div class="h-2 bg-gray-200 rounded-full">
                                        <div id="progressBar" class="h-2 bg-primary-500 rounded-full transition-all" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Template Download -->
                            <div class="bg-gray-50 rounded-xl p-6">
                                <h4 class="font-bold text-gray-900 mb-4">Download Template</h4>
                                <p class="text-gray-600 text-sm mb-4">
                                    Download template CSV untuk memudahkan input data. Pastikan format sesuai dengan template.
                                </p>
                                <div class="space-y-3">
                                    <button onclick="downloadTemplate('siswa')" class="w-full bg-white border-2 border-gray-200 text-gray-700 py-3 rounded-xl hover:border-primary-500 transition flex items-center justify-center">
                                        <i class="fas fa-users mr-2 text-primary-500"></i>Template Data Siswa
                                    </button>
                                    <button onclick="downloadTemplate('tp')" class="w-full bg-white border-2 border-gray-200 text-gray-700 py-3 rounded-xl hover:border-primary-500 transition flex items-center justify-center">
                                        <i class="fas fa-bullseye mr-2 text-secondary-500"></i>Template Tujuan Pembelajaran
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Preview Table -->
                        <div id="previewContainer" class="hidden mt-6">
                            <h4 class="font-bold text-gray-900 mb-4">Preview Data</h4>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead id="previewHeader" class="bg-gray-50"></thead>
                                    <tbody id="previewBody"></tbody>
                                </table>
                            </div>
                            <div class="mt-4 flex justify-end space-x-3">
                                <button onclick="cancelImport()" class="px-4 py-2 border-2 border-gray-200 rounded-xl text-gray-700 hover:bg-gray-50">
                                    Batal
                                </button>
                                <button onclick="confirmImport()" class="btn-primary text-white px-6 py-2 rounded-xl">
                                    <i class="fas fa-check mr-2"></i>Import Data
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function initImport() {}

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.endsWith('.csv')) {
                showToast('File harus berformat .csv', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                parseCSV(content);
            };
            reader.readAsText(file);
        }

        function parseCSV(content) {
            const lines = content.split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                    const row = {};
                    headers.forEach((h, idx) => {
                        row[h] = values[idx] || '';
                    });
                    data.push(row);
                }
            }

            showPreview(headers, data);
        }

        function showPreview(headers, data) {
            document.getElementById('previewContainer').classList.remove('hidden');
            
            document.getElementById('previewHeader').innerHTML = `
                <tr>
                    ${headers.map(h => `<th class="px-4 py-3 text-left font-semibold">${h}</th>`).join('')}
                </tr>
            `;

            document.getElementById('previewBody').innerHTML = data.slice(0, 10).map(row => `
                <tr class="border-t">
                    ${headers.map(h => `<td class="px-4 py-3">${row[h]}</td>`).join('')}
                </tr>
            `).join('');

            // Store for import
            window.importData = { headers, data };
        }

        function cancelImport() {
            document.getElementById('previewContainer').classList.add('hidden');
            document.getElementById('fileInput').value = '';
            window.importData = null;
        }

        async function confirmImport() {
            if (!window.importData) return;

            showLoading();

            try {
                const { data } = window.importData;
                const batch = db.batch();

                data.forEach(row => {
                    const docRef = db.collection('users').doc(currentUser.uid)
                        .collection('siswa').doc();
                    batch.set(docRef, {
                        ...row,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });

                await batch.commit();

                hideLoading();
                showToast(`${data.length} data berhasil diimport!`);
                cancelImport();
            } catch (error) {
                hideLoading();
                showToast('Gagal import: ' + error.message, 'error');
            }
        }

        function downloadTemplate(type) {
            let content = '';
            let filename = '';

            if (type === 'siswa') {
                content = 'No,NIS,Nama Lengkap,Jenis Kelamin,Kelas,Tanggal Lahir\n';
                content += '1,12345,Ahmad Fauzi,L,VII A,2012-05-15\n';
                content += '2,12346,Siti Aisyah,P,VII A,2012-08-20\n';
                filename = 'template_siswa.csv';
            } else if (type === 'tp') {
                content = 'No,Elemen,Tujuan Pembelajaran,Alokasi JP\n';
                content += '1,Al-Quran dan Hadis,Membaca surah Al-Fatihah dengan tartil,3\n';
                filename = 'template_tp.csv';
            }

            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();

            showToast('Template berhasil didownload!');
        }

        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Admin Guru Super App initialized');
        });
    </script>
</body>
</html>
