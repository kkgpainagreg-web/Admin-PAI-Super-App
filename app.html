<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Guru Super App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { 50: '#ecfdf5', 100: '#d1fae5', 200: '#a7f3d0', 300: '#6ee7b7', 400: '#34d399', 500: '#10b981', 600: '#059669', 700: '#047857', 800: '#065f46', 900: '#064e3b' },
                        secondary: { 50: '#f0f9ff', 100: '#e0f2fe', 200: '#bae6fd', 300: '#7dd3fc', 400: '#38bdf8', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1', 800: '#075985', 900: '#0c4a6e' },
                        accent: { 50: '#fdf4ff', 100: '#fae8ff', 200: '#f5d0fe', 300: '#f0abfc', 400: '#e879f9', 500: '#d946ef', 600: '#c026d3', 700: '#a21caf', 800: '#86198f', 900: '#701a75' }
                    },
                    fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'], arabic: ['Amiri', 'serif'] }
                }
            }
        }
    </script>
    <style>
        * { font-family: 'Plus Jakarta Sans', sans-serif; }
        .arabic-text { font-family: 'Amiri', serif; direction: rtl; text-align: right; font-size: 1.5em; line-height: 2; }
        .sidebar-link { transition: all 0.2s ease; }
        .sidebar-link:hover, .sidebar-link.active { background: linear-gradient(90deg, rgba(16, 185, 129, 0.1) 0%, transparent 100%); border-left: 3px solid #10b981; }
        .card { background: white; border-radius: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .btn-primary { background: linear-gradient(135deg, #059669 0%, #10b981 100%); }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); }
        .gradient-bg { background: linear-gradient(135deg, #059669 0%, #0ea5e9 100%); }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        .animate-slide-in { animation: slideIn 0.3s ease forwards; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #10b981; box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1); }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app" class="flex min-h-screen">
        <!-- Sidebar -->
        <aside id="sidebar" class="fixed lg:static inset-y-0 left-0 z-40 w-72 bg-white border-r border-gray-200 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 flex flex-col">
            <div class="p-6 border-b border-gray-100">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 gradient-bg rounded-xl flex items-center justify-center shadow-lg">
                        <i class="fas fa-chalkboard-teacher text-white"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-gray-900">Admin Guru</h1>
                        <p class="text-xs text-gray-500">Super App</p>
                    </div>
                </div>
            </div>

            <nav class="flex-1 p-4 space-y-1 overflow-y-auto scrollbar-thin">
                <a href="#dashboard" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 active" data-page="dashboard">
                    <i class="fas fa-home w-5 text-center"></i><span>Dashboard</span>
                </a>

                <div class="pt-4">
                    <p class="px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Profil & Dasar</p>
                    <a href="#profil" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700" data-page="profil">
                        <i class="fas fa-user w-5 text-center"></i><span>Profil Guru</span>
                    </a>
                    <a href="#kalender" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700" data-page="kalender">
                        <i class="fas fa-calendar-alt w-5 text-center"></i><span>Kalender Pendidikan</span>
                    </a>
                    <a href="#jadwal" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700" data-page="jadwal">
                        <i class="fas fa-clock w-5 text-center"></i><span>Jadwal Pelajaran</span>
                    </a>
                </div>

                <div class="pt-4">
                    <p class="px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Perencanaan</p>
                    <a href="#atp" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700" data-page="atp">
                        <i class="fas fa-route w-5 text-center"></i><span>ATP</span>
                    </a>
                    <a href="#prota" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700" data-page="prota">
                        <i class="fas fa-calendar-check w-5 text-center"></i><span>Prota</span>
                    </a>
                    <a href="#promes" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700" data-page="promes">
                        <i class="fas fa-calendar-week w-5 text-center"></i><span>Promes</span>
                        <span class="premium-badge ml-auto text-xs bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded-full">Pro</span>
                    </a>
                </div>

                <div class="pt-4">
                    <p class="px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Pembelajaran</p>
                    <a href="#modul-ajar" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700" data-page="modul-ajar">
                        <i class="fas fa-book-open w-5 text-center"></i><span>Modul Ajar</span>
                        <span class="premium-badge ml-auto text-xs bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded-full">Pro</span>
                    </a>
                    <a href="#lkpd" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700" data-page="lkpd">
                        <i class="fas fa-file-alt w-5 text-center"></i><span>LKPD</span>
                        <span class="premium-badge ml-auto text-xs bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded-full">Pro</span>
                    </a>
                    <a href="#bank-soal" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700" data-page="bank-soal">
                        <i class="fas fa-question-circle w-5 text-center"></i><span>Bank Soal</span>
                        <span class="premium-badge ml-auto text-xs bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded-full">Pro</span>
                    </a>
                </div>

                <div class="pt-4">
                    <p class="px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Pelaksanaan</p>
                    <a href="#jurnal" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700" data-page="jurnal">
                        <i class="fas fa-book w-5 text-center"></i><span>Jurnal</span>
                        <span class="premium-badge ml-auto text-xs bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded-full">Pro</span>
                    </a>
                    <a href="#absensi" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700" data-page="absensi">
                        <i class="fas fa-user-check w-5 text-center"></i><span>Absensi</span>
                    </a>
                    <a href="#nilai" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700" data-page="nilai">
                        <i class="fas fa-star w-5 text-center"></i><span>Daftar Nilai</span>
                    </a>
                </div>

                <div class="pt-4">
                    <p class="px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Tools</p>
                    <a href="#ai-assistant" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700" data-page="ai-assistant">
                        <i class="fas fa-robot w-5 text-center"></i><span>AI Assistant</span>
                    </a>
                    <a href="#import" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700" data-page="import">
                        <i class="fas fa-file-import w-5 text-center"></i><span>Import Data</span>
                    </a>
                </div>

                <div id="adminMenu" class="pt-4 hidden">
                    <p class="px-4 text-xs font-semibold text-red-400 uppercase tracking-wider mb-2">Super Admin</p>
                    <a href="#admin" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700" data-page="admin">
                        <i class="fas fa-shield-alt w-5 text-center text-red-500"></i><span>Admin Panel</span>
                    </a>
                    <a href="#pricing-settings" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700" data-page="pricing-settings">
                        <i class="fas fa-tags w-5 text-center text-red-500"></i><span>Pengaturan Harga</span>
                    </a>
                    <a href="#payments" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700" data-page="payments">
                        <i class="fas fa-credit-card w-5 text-center text-red-500"></i><span>Kelola Pembayaran</span>
                    </a>
                </div>
            </nav>

            <div class="p-4 border-t border-gray-100">
                <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-xl">
                    <div id="sidebarUserPhoto" class="w-10 h-10 bg-primary-500 rounded-full flex items-center justify-center text-white font-bold">G</div>
                    <div class="flex-1 min-w-0">
                        <p id="sidebarUserName" class="text-sm font-semibold text-gray-900 truncate">Loading...</p>
                        <p id="sidebarUserPlan" class="text-xs text-gray-500">Free Plan</p>
                    </div>
                    <button onclick="logout()" class="text-gray-400 hover:text-red-500"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </div>
        </aside>

        <div id="sidebarOverlay" class="fixed inset-0 bg-black/50 z-30 hidden lg:hidden" onclick="toggleSidebar()"></div>

        <main class="flex-1 flex flex-col min-h-screen">
            <header class="bg-white border-b border-gray-200 sticky top-0 z-20 no-print">
                <div class="flex items-center justify-between px-4 lg:px-8 h-16">
                    <button onclick="toggleSidebar()" class="lg:hidden text-gray-600"><i class="fas fa-bars text-xl"></i></button>
                    <h2 id="pageTitle" class="hidden lg:block text-xl font-bold text-gray-900">Dashboard</h2>
                    <div class="flex items-center space-x-4">
                        <div id="subscriptionBadge" class="hidden sm:flex items-center space-x-2 bg-yellow-50 text-yellow-700 px-3 py-1.5 rounded-full text-sm font-medium cursor-pointer" onclick="navigateTo('subscription')">
                            <i class="fas fa-crown"></i><span>Upgrade</span>
                        </div>
                        <div class="relative">
                            <button onclick="toggleUserMenu()" class="flex items-center">
                                <div id="headerUserPhoto" class="w-9 h-9 bg-primary-500 rounded-full flex items-center justify-center text-white text-sm font-bold">G</div>
                            </button>
                            <div id="userMenu" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-xl shadow-lg border py-2 z-50">
                                <div class="px-4 py-3 border-b">
                                    <p id="menuUserName" class="font-semibold text-gray-900">Loading...</p>
                                    <p id="menuUserEmail" class="text-sm text-gray-500"></p>
                                </div>
                                <a href="#" onclick="navigateTo('profil')" class="flex items-center space-x-3 px-4 py-2 text-gray-700 hover:bg-gray-50">
                                    <i class="fas fa-user-cog w-5"></i><span>Profil</span>
                                </a>
                                <a href="#" onclick="navigateTo('subscription')" class="flex items-center space-x-3 px-4 py-2 text-gray-700 hover:bg-gray-50">
                                    <i class="fas fa-crown w-5 text-yellow-500"></i><span>Langganan</span>
                                </a>
                                <div class="border-t mt-2 pt-2">
                                    <button onclick="logout()" class="flex items-center space-x-3 px-4 py-2 text-red-600 hover:bg-red-50 w-full">
                                        <i class="fas fa-sign-out-alt w-5"></i><span>Keluar</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>
            <div id="mainContent" class="flex-1 p-4 lg:p-8 overflow-y-auto"></div>
        </main>
    </div>

    <div id="modalContainer"></div>
    
    <div id="toast" class="fixed bottom-6 right-6 z-[100] hidden">
        <div class="bg-gray-900 text-white px-6 py-4 rounded-xl shadow-lg flex items-center space-x-3">
            <i id="toastIcon" class="fas fa-check-circle text-xl text-green-400"></i>
            <span id="toastMessage">Notification</span>
        </div>
    </div>

    <div id="loadingOverlay" class="fixed inset-0 z-[100] hidden items-center justify-center bg-white/90">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-primary-200 border-t-primary-600 rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-gray-600">Memproses...</p>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <script>
    // ==========================================
    // FIREBASE & GLOBAL CONFIG
    // ==========================================
   const firebaseConfig = {
   apiKey: "AIzaSyDpiK4F4ilnDDNEwO0djGY-ClwgwBl1eFk",
  authDomain: "asap-1d653.firebaseapp.com",
  projectId: "asap-1d653",
  storageBucket: "asap-1d653.firebasestorage.app",
  messagingSenderId: "143263188364",
  appId: "1:143263188364:web:47b4c003972b3503e882a9",
};

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    let currentUser = null;
    let userData = null;
    let currentPage = 'dashboard';

    const SUPER_ADMIN_EMAIL = 'afifaro@gmail.com';

    let PRICING = {
        free: { name: 'Free', price: 0, priceYearly: 0, features: ['Kalender Pendidikan', 'Jadwal Pelajaran', 'ATP Generator', 'Prota Generator'] },
        premium: { name: 'Premium', price: 49000, priceYearly: 490000, features: ['Semua fitur Free', 'Promes Generator', 'Modul Ajar + LKPD', 'Bank Soal', 'Jurnal Pembelajaran', 'AI Assistant', 'Export PDF'] },
        school: { name: 'Paket Sekolah', price: 299000, priceYearly: 2990000, maxUsers: 50, features: ['Hingga 50 Guru', 'Semua fitur Premium', 'Dashboard Admin', 'Support Prioritas'] }
    };

    // CP PAI DATA
    const CP_PAI_DATA = {
        faseA: {
            nama: "Fase A (Kelas 1-2 SD/MI)",
            elemen: {
                alquran_hadis: { nama: "Al-Qur'an dan Hadis", cp: "Peserta didik mengenal huruf hijaiah, harakat, dan membaca surah-surah pendek.", tp: ["Mengenal huruf hijaiah dari Alif sampai Ya", "Membedakan huruf hijaiah yang mirip bentuknya", "Mengenal harakat fathah, kasrah, dan dhammah", "Membaca surah Al-Fatihah dengan benar", "Menghafal surah Al-Fatihah dan An-Nas"] },
                akidah: { nama: "Akidah", cp: "Peserta didik mengenal rukun iman dan sifat-sifat Allah.", tp: ["Menyebutkan rukun iman yang enam", "Mengenal Allah sebagai Tuhan Yang Maha Esa", "Menyebutkan bukti keberadaan Allah", "Mengenal malaikat dan tugasnya"] },
                akhlak: { nama: "Akhlak", cp: "Peserta didik menunjukkan akhlak terpuji dalam kehidupan sehari-hari.", tp: ["Membiasakan mengucap salam", "Berdoa sebelum dan sesudah makan", "Menunjukkan sikap jujur", "Menunjukkan sikap hormat kepada orang tua"] },
                fikih: { nama: "Fikih", cp: "Peserta didik mengenal rukun Islam dan praktik ibadah sederhana.", tp: ["Menyebutkan rukun Islam yang lima", "Mengenal syahadat dan artinya", "Mengenal gerakan shalat", "Praktik wudhu dengan bimbingan"] },
                sejarah: { nama: "Sejarah Peradaban Islam", cp: "Peserta didik mengenal kisah para nabi.", tp: ["Menceritakan kisah Nabi Adam AS", "Menceritakan kisah Nabi Nuh AS", "Menceritakan kisah Nabi Ibrahim AS", "Menceritakan kisah Nabi Muhammad SAW"] }
            }
        },
        faseB: {
            nama: "Fase B (Kelas 3-4 SD/MI)",
            elemen: {
                alquran_hadis: { nama: "Al-Qur'an dan Hadis", cp: "Peserta didik membaca Al-Qur'an dengan tajwid dasar.", tp: ["Membaca Al-Qur'an dengan makhraj yang benar", "Menerapkan hukum nun mati dan tanwin", "Menghafal surah Al-Kautsar", "Menghafal surah Al-Ikhlas"] },
                akidah: { nama: "Akidah", cp: "Peserta didik memahami sifat-sifat Allah.", tp: ["Menjelaskan sifat wajib Allah", "Menyebutkan nama malaikat beserta tugasnya", "Mengimani adanya hari akhir"] },
                akhlak: { nama: "Akhlak", cp: "Peserta didik menunjukkan akhlak terpuji kepada orang tua dan guru.", tp: ["Menjelaskan adab kepada orang tua", "Mempraktikkan sikap patuh", "Menunjukkan sikap hormat kepada guru"] },
                fikih: { nama: "Fikih", cp: "Peserta didik memahami dan mempraktikkan shalat dan puasa.", tp: ["Menjelaskan syarat dan rukun shalat", "Mempraktikkan shalat lima waktu", "Menjelaskan puasa Ramadhan"] },
                sejarah: { nama: "Sejarah Peradaban Islam", cp: "Peserta didik mengenal sejarah dakwah Nabi di Makkah.", tp: ["Menceritakan masa muda Nabi Muhammad SAW", "Menjelaskan dakwah Nabi di Makkah", "Mengenal peristiwa Isra Mi'raj"] }
            }
        },
        faseC: {
            nama: "Fase C (Kelas 5-6 SD/MI)",
            elemen: {
                alquran_hadis: { nama: "Al-Qur'an dan Hadis", cp: "Peserta didik membaca Al-Qur'an dengan lancar.", tp: ["Membaca Al-Qur'an dengan tartil", "Menerapkan hukum bacaan mad", "Menghafal surah Al-Qadr", "Menghafal surah At-Tin"] },
                akidah: { nama: "Akidah", cp: "Peserta didik memahami hari akhir.", tp: ["Menjelaskan tanda-tanda kiamat", "Mengimani adanya hari pembalasan", "Menjelaskan hikmah beriman kepada hari akhir"] },
                akhlak: { nama: "Akhlak", cp: "Peserta didik menunjukkan akhlak terpuji dalam kehidupan sosial.", tp: ["Menjelaskan sikap toleransi", "Menunjukkan sikap menghargai perbedaan", "Membiasakan tolong-menolong"] },
                fikih: { nama: "Fikih", cp: "Peserta didik memahami zakat dan infak.", tp: ["Menjelaskan ketentuan zakat fitrah", "Menjelaskan ketentuan zakat mal", "Mempraktikkan pembayaran zakat"] },
                sejarah: { nama: "Sejarah Peradaban Islam", cp: "Peserta didik mengenal sejarah dakwah Nabi di Madinah.", tp: ["Menjelaskan peristiwa hijrah", "Menceritakan pembentukan masyarakat Madinah", "Mengenal Piagam Madinah"] }
            }
        },
        faseD: {
            nama: "Fase D (Kelas 7-9 SMP/MTs)",
            elemen: {
                alquran_hadis: { nama: "Al-Qur'an dan Hadis", cp: "Peserta didik membaca dan memahami Al-Qur'an dengan tajwid lengkap.", tp: ["Menerapkan hukum tajwid secara lengkap", "Menganalisis kandungan ayat tentang toleransi", "Menghafal ayat-ayat pilihan"] },
                akidah: { nama: "Akidah", cp: "Peserta didik memahami rukun iman secara mendalam.", tp: ["Menganalisis dalil keberadaan Allah", "Menjelaskan tugas dan sifat malaikat", "Memahami kitab-kitab Allah"] },
                akhlak: { nama: "Akhlak", cp: "Peserta didik menunjukkan akhlak mahmudah.", tp: ["Menganalisis akhlak terpuji dan tercela", "Membiasakan sikap tawadhu", "Menunjukkan etika digital yang baik"] },
                fikih: { nama: "Fikih", cp: "Peserta didik memahami sujud, haji, dan muamalah.", tp: ["Menjelaskan macam-macam sujud", "Mempraktikkan sujud sahwi dan tilawah", "Memahami manasik haji dan umrah"] },
                sejarah: { nama: "Sejarah Peradaban Islam", cp: "Peserta didik memahami peradaban Islam.", tp: ["Menjelaskan perkembangan Dinasti Umayyah", "Menganalisis kemajuan Dinasti Abbasiyah", "Mengenal tokoh cendekiawan Muslim"] }
            }
        },
        faseE: {
            nama: "Fase E (Kelas 10 SMA/MA)",
            elemen: {
                alquran_hadis: { nama: "Al-Qur'an dan Hadis", cp: "Peserta didik mengkaji ayat tentang kompetisi dalam kebaikan.", tp: ["Menganalisis QS. Al-Baqarah: 148", "Memahami hadis tentang berlomba dalam kebaikan", "Mengimplementasikan semangat berkompetisi positif"] },
                akidah: { nama: "Akidah", cp: "Peserta didik memahami Syu'ab al-Iman.", tp: ["Menjelaskan konsep Syu'ab al-Iman", "Menganalisis hubungan iman, Islam, dan ihsan", "Menerapkan nilai-nilai keimanan"] },
                akhlak: { nama: "Akhlak", cp: "Peserta didik memiliki karakter mulia.", tp: ["Menganalisis akhlak dalam pergaulan", "Memahami etika berkomunikasi", "Menerapkan akhlak dalam media sosial"] },
                fikih: { nama: "Fikih", cp: "Peserta didik memahami sumber hukum Islam.", tp: ["Menjelaskan sumber hukum Islam", "Memahami metode ijtihad", "Menganalisis kaidah-kaidah fikih"] },
                sejarah: { nama: "Sejarah Peradaban Islam", cp: "Peserta didik memahami sejarah Islam di Indonesia.", tp: ["Menganalisis teori masuknya Islam ke Nusantara", "Menjelaskan peran Walisongo", "Memahami kerajaan Islam di Indonesia"] }
            }
        },
        faseF: {
            nama: "Fase F (Kelas 11-12 SMA/MA)",
            elemen: {
                alquran_hadis: { nama: "Al-Qur'an dan Hadis", cp: "Peserta didik mengkaji ayat dengan pendekatan tematik.", tp: ["Menganalisis ayat tentang berpikir kritis", "Memahami hadis tentang mencari ilmu", "Mengintegrasikan nilai Al-Qur'an dalam kehidupan"] },
                akidah: { nama: "Akidah", cp: "Peserta didik memiliki pemahaman akidah yang kokoh.", tp: ["Menganalisis problematika akidah kontemporer", "Memahami respons Islam terhadap ateisme", "Mengembangkan worldview Islam"] },
                akhlak: { nama: "Akhlak", cp: "Peserta didik memiliki etika profesional.", tp: ["Menganalisis etika digital", "Memahami akhlak dalam dunia kerja", "Mengembangkan soft skills Islami"] },
                fikih: { nama: "Fikih", cp: "Peserta didik memahami fikih mawaris.", tp: ["Menjelaskan ketentuan waris dalam Islam", "Menghitung pembagian waris", "Memahami hukum pernikahan"] },
                sejarah: { nama: "Sejarah Peradaban Islam", cp: "Peserta didik memahami organisasi Islam dunia.", tp: ["Menganalisis organisasi Islam internasional", "Memahami gerakan pembaharuan Islam", "Merumuskan peran generasi muda Muslim"] }
            }
        }
    };

    // ==========================================
    // UTILITY FUNCTIONS
    // ==========================================
    function showLoading() {
        document.getElementById('loadingOverlay').classList.remove('hidden');
        document.getElementById('loadingOverlay').classList.add('flex');
    }

    function hideLoading() {
        document.getElementById('loadingOverlay').classList.add('hidden');
        document.getElementById('loadingOverlay').classList.remove('flex');
    }

    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        const icon = document.getElementById('toastIcon');
        const msg = document.getElementById('toastMessage');
        msg.textContent = message;
        icon.className = type === 'success' ? 'fas fa-check-circle text-xl text-green-400' : 
                        type === 'error' ? 'fas fa-exclamation-circle text-xl text-red-400' : 
                        'fas fa-info-circle text-xl text-blue-400';
        toast.classList.remove('hidden');
        setTimeout(() => toast.classList.add('hidden'), 3000);
    }

    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('-translate-x-full');
        document.getElementById('sidebarOverlay').classList.toggle('hidden');
    }

    function toggleUserMenu() {
        document.getElementById('userMenu').classList.toggle('hidden');
    }

    document.addEventListener('click', (e) => {
        if (!e.target.closest('#userMenu') && !e.target.closest('[onclick="toggleUserMenu()"]')) {
            document.getElementById('userMenu').classList.add('hidden');
        }
    });

    function formatCurrency(num) {
        return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(num);
    }

    function formatDate(date) {
        if (!date) return '-';
        const d = date.toDate ? date.toDate() : new Date(date);
        return d.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
    }

    function closeModal() {
        document.getElementById('modalContainer').innerHTML = '';
    }

    function isSuperAdmin() {
        return currentUser?.email === SUPER_ADMIN_EMAIL;
    }

    function isPremium() {
        return userData?.plan === 'premium' || userData?.plan === 'school' || isSuperAdmin();
    }

    // ==========================================
    // AUTHENTICATION
    // ==========================================
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            currentUser = user;
            await loadUserData();
            await loadAppSettings();
            updateUI();
            initializeRouter();
        } else {
            window.location.href = 'index.html';
        }
    });

    async function loadUserData() {
        try {
            const doc = await db.collection('users').doc(currentUser.uid).get();
            if (doc.exists) {
                userData = doc.data();
            } else {
                userData = {
                    name: currentUser.displayName || 'Guru',
                    email: currentUser.email,
                    role: currentUser.email === SUPER_ADMIN_EMAIL ? 'admin' : 'guru',
                    plan: currentUser.email === SUPER_ADMIN_EMAIL ? 'premium' : 'free',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                await db.collection('users').doc(currentUser.uid).set(userData);
            }
        } catch (error) {
            console.error('Error loading user data:', error);
        }
    }

    async function loadAppSettings() {
        try {
            const doc = await db.collection('settings').doc('pricing').get();
            if (doc.exists) {
                PRICING = { ...PRICING, ...doc.data() };
            }
        } catch (error) {
            console.log('Using default pricing');
        }
    }

    function updateUI() {
        document.getElementById('sidebarUserName').textContent = userData?.name || 'Guru';
        const planText = isSuperAdmin() ? 'Super Admin' : userData?.plan === 'premium' ? 'Premium' : userData?.plan === 'school' ? 'Sekolah' : 'Free';
        const planColor = isSuperAdmin() ? 'bg-red-500' : userData?.plan === 'premium' ? 'bg-yellow-500' : 'bg-green-500';
        document.getElementById('sidebarUserPlan').innerHTML = `<span class="w-2 h-2 ${planColor} rounded-full mr-1 inline-block"></span>${planText}`;

        document.getElementById('menuUserName').textContent = userData?.name || 'Guru';
        document.getElementById('menuUserEmail').textContent = currentUser?.email || '';

        const initial = (userData?.name || 'G').charAt(0).toUpperCase();
        if (currentUser?.photoURL) {
            document.getElementById('sidebarUserPhoto').innerHTML = `<img src="${currentUser.photoURL}" class="w-full h-full rounded-full object-cover">`;
            document.getElementById('headerUserPhoto').innerHTML = `<img src="${currentUser.photoURL}" class="w-full h-full rounded-full object-cover">`;
        } else {
            document.getElementById('sidebarUserPhoto').textContent = initial;
            document.getElementById('headerUserPhoto').textContent = initial;
        }

        if (isSuperAdmin()) {
            document.getElementById('adminMenu').classList.remove('hidden');
        }

        if (!isPremium()) {
            document.getElementById('subscriptionBadge').classList.remove('hidden');
        } else {
            document.getElementById('subscriptionBadge').classList.add('hidden');
            document.querySelectorAll('.premium-badge').forEach(el => el.classList.add('hidden'));
        }
    }

    async function logout() {
        await auth.signOut();
        window.location.href = 'index.html';
    }

    // ==========================================
    // ROUTER
    // ==========================================
    function initializeRouter() {
        window.addEventListener('hashchange', handleRouteChange);
        document.querySelectorAll('.sidebar-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                window.location.hash = link.dataset.page;
            });
        });
        handleRouteChange();
    }

    function handleRouteChange() {
        const hash = window.location.hash.slice(1) || 'dashboard';
        navigateTo(hash);
    }

    function navigateTo(page) {
        currentPage = page;
        document.querySelectorAll('.sidebar-link').forEach(link => {
            link.classList.toggle('active', link.dataset.page === page);
        });

        const titles = {
            'dashboard': 'Dashboard', 'profil': 'Profil Guru', 'kalender': 'Kalender Pendidikan',
            'jadwal': 'Jadwal Pelajaran', 'atp': 'ATP', 'prota': 'Prota', 'promes': 'Promes',
            'modul-ajar': 'Modul Ajar', 'lkpd': 'LKPD', 'bank-soal': 'Bank Soal',
            'jurnal': 'Jurnal', 'absensi': 'Absensi', 'nilai': 'Nilai',
            'ai-assistant': 'AI Assistant', 'import': 'Import Data', 'subscription': 'Langganan',
            'admin': 'Admin Panel', 'pricing-settings': 'Pengaturan Harga', 'payments': 'Pembayaran'
        };
        document.getElementById('pageTitle').textContent = titles[page] || 'Dashboard';

        loadPageContent(page);

        if (window.innerWidth < 1024) {
            document.getElementById('sidebar').classList.add('-translate-x-full');
            document.getElementById('sidebarOverlay').classList.add('hidden');
        }
    }

    function checkPremiumAccess(featureName) {
        if (isPremium()) return null;
        return `
            <div class="flex items-center justify-center min-h-[60vh]">
                <div class="text-center max-w-md">
                    <div class="w-20 h-20 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-crown text-4xl text-yellow-500"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-3">Fitur Premium</h2>
                    <p class="text-gray-600 mb-6"><strong>${featureName}</strong> adalah fitur premium. Upgrade untuk akses penuh.</p>
                    <button onclick="navigateTo('subscription')" class="btn-primary text-white px-8 py-3 rounded-xl font-semibold">
                        <i class="fas fa-rocket mr-2"></i>Upgrade Sekarang
                    </button>
                </div>
            </div>
        `;
    }

    // ==========================================
    // PAGE CONTENT LOADER
    // ==========================================
    function loadPageContent(page) {
        const content = document.getElementById('mainContent');
        
        const pageHandlers = {
            'dashboard': [getDashboardHTML, initDashboard],
            'profil': [getProfilHTML, initProfil],
            'kalender': [getKalenderHTML, initKalender],
            'jadwal': [getJadwalHTML, initJadwal],
            'atp': [getATPHTML, initATP],
            'prota': [getProtaHTML, initProta],
            'promes': [getPromesHTML, initPromes],
            'modul-ajar': [getModulAjarHTML, initModulAjar],
            'lkpd': [getLKPDHTML, initLKPD],
            'bank-soal': [getBankSoalHTML, initBankSoal],
            'jurnal': [getJurnalHTML, initJurnal],
            'absensi': [getAbsensiHTML, initAbsensi],
            'nilai': [getNilaiHTML, initNilai],
            'ai-assistant': [getAIAssistantHTML, initAIAssistant],
            'import': [getImportHTML, initImport],
            'subscription': [getSubscriptionHTML, initSubscription],
            'admin': [getAdminHTML, initAdmin],
            'pricing-settings': [getPricingSettingsHTML, initPricingSettings],
            'payments': [getPaymentsHTML, initPayments]
        };

        const handler = pageHandlers[page] || pageHandlers['dashboard'];
        content.innerHTML = handler[0]();
        if (handler[1]) handler[1]();
    }

    // ==========================================
    // DASHBOARD PAGE
    // ==========================================
    function getDashboardHTML() {
        return `
            <div class="space-y-6 animate-slide-in">
                <div class="bg-gradient-to-r from-primary-600 to-secondary-600 rounded-2xl p-6 lg:p-8 text-white">
                    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between">
                        <div>
                            <h2 class="text-2xl lg:text-3xl font-bold mb-2">Assalamu'alaikum, ${userData?.name || 'Guru'}! ðŸ‘‹</h2>
                            <p class="text-primary-100">Selamat datang di Admin Guru Super App.</p>
                        </div>
                        ${!isPremium() ? `
                            <button onclick="navigateTo('subscription')" class="mt-4 lg:mt-0 bg-white text-primary-600 px-6 py-3 rounded-xl font-semibold hover:bg-primary-50 transition">
                                <i class="fas fa-crown mr-2"></i>Upgrade Premium
                            </button>
                        ` : ''}
                    </div>
                </div>

                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="bg-gradient-to-br from-primary-500 to-primary-600 text-white p-5 rounded-2xl">
                        <i class="fas fa-users text-2xl mb-3"></i>
                        <p id="totalSiswa" class="text-3xl font-bold">0</p>
                        <p class="text-primary-100 text-sm">Siswa</p>
                    </div>
                    <div class="bg-gradient-to-br from-secondary-500 to-secondary-600 text-white p-5 rounded-2xl">
                        <i class="fas fa-door-open text-2xl mb-3"></i>
                        <p id="totalKelas" class="text-3xl font-bold">0</p>
                        <p class="text-secondary-100 text-sm">Kelas</p>
                    </div>
                    <div class="bg-gradient-to-br from-accent-500 to-accent-600 text-white p-5 rounded-2xl">
                        <i class="fas fa-book text-2xl mb-3"></i>
                        <p id="totalModul" class="text-3xl font-bold">0</p>
                        <p class="text-accent-100 text-sm">Modul Ajar</p>
                    </div>
                    <div class="bg-gradient-to-br from-orange-500 to-orange-600 text-white p-5 rounded-2xl">
                        <i class="fas fa-calendar-check text-2xl mb-3"></i>
                        <p id="hariEfektif" class="text-3xl font-bold">0</p>
                        <p class="text-orange-100 text-sm">Hari Efektif</p>
                    </div>
                </div>

                <div class="card p-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">Aksi Cepat</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <button onclick="navigateTo('kalender')" class="p-4 bg-gray-50 hover:bg-primary-50 rounded-xl text-center transition">
                            <div class="w-12 h-12 mx-auto mb-3 bg-primary-100 text-primary-600 rounded-xl flex items-center justify-center">
                                <i class="fas fa-calendar-alt text-xl"></i>
                            </div>
                            <p class="font-medium text-gray-700 text-sm">Atur Kalender</p>
                        </button>
                        <button onclick="navigateTo('jadwal')" class="p-4 bg-gray-50 hover:bg-secondary-50 rounded-xl text-center transition">
                            <div class="w-12 h-12 mx-auto mb-3 bg-secondary-100 text-secondary-600 rounded-xl flex items-center justify-center">
                                <i class="fas fa-clock text-xl"></i>
                            </div>
                            <p class="font-medium text-gray-700 text-sm">Atur Jadwal</p>
                        </button>
                        <button onclick="navigateTo('atp')" class="p-4 bg-gray-50 hover:bg-accent-50 rounded-xl text-center transition">
                            <div class="w-12 h-12 mx-auto mb-3 bg-accent-100 text-accent-600 rounded-xl flex items-center justify-center">
                                <i class="fas fa-route text-xl"></i>
                            </div>
                            <p class="font-medium text-gray-700 text-sm">Buat ATP</p>
                        </button>
                        <button onclick="navigateTo('ai-assistant')" class="p-4 bg-gray-50 hover:bg-orange-50 rounded-xl text-center transition">
                            <div class="w-12 h-12 mx-auto mb-3 bg-orange-100 text-orange-600 rounded-xl flex items-center justify-center">
                                <i class="fas fa-robot text-xl"></i>
                            </div>
                            <p class="font-medium text-gray-700 text-sm">AI Assistant</p>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    async function initDashboard() {
        try {
            const [siswaSnap, kelasSnap, modulSnap, kalenderSnap] = await Promise.all([
                db.collection('users').doc(currentUser.uid).collection('siswa').get(),
                db.collection('users').doc(currentUser.uid).collection('kelas').get(),
                db.collection('users').doc(currentUser.uid).collection('modul_ajar').get(),
                db.collection('users').doc(currentUser.uid).collection('kalender').doc('aktif').get()
            ]);
            document.getElementById('totalSiswa').textContent = siswaSnap.size;
            document.getElementById('totalKelas').textContent = kelasSnap.size;
            document.getElementById('totalModul').textContent = modulSnap.size;
            if (kalenderSnap.exists) {
                document.getElementById('hariEfektif').textContent = kalenderSnap.data().hariEfektif || 0;
            }
        } catch (error) {
            console.error('Error loading dashboard:', error);
        }
    }

    // ==========================================
    // PROFIL PAGE
    // ==========================================
    function getProfilHTML() {
        return `
            <div class="space-y-6 animate-slide-in">
                <div class="card p-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-6">Data Profil Guru</h3>
                    <form id="profilForm" class="space-y-6">
                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                                <input type="text" id="namaLengkap" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl" placeholder="Nama Lengkap">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">NIP/NIK</label>
                                <input type="text" id="nip" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl" placeholder="Nomor Induk">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                <input type="email" id="email" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl bg-gray-50" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">No. HP/WhatsApp</label>
                                <input type="tel" id="phone" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl" placeholder="08xxxxxxxxxx">
                            </div>
                        </div>

                        <div class="border-t pt-6">
                            <h4 class="font-semibold text-gray-900 mb-4">Data Satuan Pendidikan</h4>
                            <div class="grid md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nama Sekolah</label>
                                    <input type="text" id="namaSekolah" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl" placeholder="SDN/MIN/MTs">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">NPSN</label>
                                    <input type="text" id="npsn" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl" placeholder="NPSN">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Jenjang</label>
                                    <select id="jenjangPendidikan" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl bg-white">
                                        <option value="">Pilih Jenjang</option>
                                        <option value="sd">SD/MI</option>
                                        <option value="smp">SMP/MTs</option>
                                        <option value="sma">SMA/MA/SMK</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tahun Pelajaran</label>
                                    <input type="text" id="tahunPelajaran" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl" placeholder="2024/2025">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Alamat Sekolah</label>
                                    <textarea id="alamatSekolah" rows="2" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl" placeholder="Alamat lengkap"></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="border-t pt-6">
                            <h4 class="font-semibold text-gray-900 mb-4">Data Kepala Sekolah</h4>
                            <div class="grid md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nama Kepala Sekolah</label>
                                    <input type="text" id="namaKepsek" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">NIP Kepala Sekolah</label>
                                    <input type="text" id="nipKepsek" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl">
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-end pt-4">
                            <button type="submit" class="btn-primary text-white px-6 py-3 rounded-xl font-semibold">
                                <i class="fas fa-save mr-2"></i>Simpan Profil
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;
    }

    async function initProfil() {
        try {
            const doc = await db.collection('users').doc(currentUser.uid).get();
            if (doc.exists) {
                const data = doc.data();
                document.getElementById('namaLengkap').value = data.name || '';
                document.getElementById('nip').value = data.nip || '';
                document.getElementById('email').value = currentUser.email || '';
                document.getElementById('phone').value = data.phone || '';
                document.getElementById('namaSekolah').value = data.satuan_pendidikan || '';
                document.getElementById('npsn').value = data.npsn || '';
                document.getElementById('jenjangPendidikan').value = data.jenjang || '';
                document.getElementById('tahunPelajaran').value = data.tahun_pelajaran || '';
                document.getElementById('alamatSekolah').value = data.alamat_sekolah || '';
                document.getElementById('namaKepsek').value = data.kepala_sekolah || '';
                document.getElementById('nipKepsek').value = data.nip_kepsek || '';
            }
        } catch (error) {
            console.error('Error loading profil:', error);
        }

        document.getElementById('profilForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();
            try {
                await db.collection('users').doc(currentUser.uid).update({
                    name: document.getElementById('namaLengkap').value,
                    nip: document.getElementById('nip').value,
                    phone: document.getElementById('phone').value,
                    satuan_pendidikan: document.getElementById('namaSekolah').value,
                    npsn: document.getElementById('npsn').value,
                    jenjang: document.getElementById('jenjangPendidikan').value,
                    tahun_pelajaran: document.getElementById('tahunPelajaran').value,
                    alamat_sekolah: document.getElementById('alamatSekolah').value,
                    kepala_sekolah: document.getElementById('namaKepsek').value,
                    nip_kepsek: document.getElementById('nipKepsek').value,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                await loadUserData();
                updateUI();
                hideLoading();
                showToast('Profil berhasil disimpan!');
            } catch (error) {
                hideLoading();
                showToast('Gagal menyimpan: ' + error.message, 'error');
            }
        });
    }

    // ==========================================
    // KALENDER PAGE
    // ==========================================
    function getKalenderHTML() {
        return `
            <div class="space-y-6 animate-slide-in">
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                    <p class="text-blue-800 font-medium"><i class="fas fa-info-circle mr-2"></i>Kalender Pendidikan</p>
                    <p class="text-blue-600 text-sm">Data kalender otomatis sinkron dengan Prota dan Promes.</p>
                </div>

                <div class="card p-6">
                    <div class="flex flex-col md:flex-row md:items-center justify-between mb-6">
                        <h3 class="text-lg font-bold text-gray-900 mb-4 md:mb-0">Pengaturan Kalender</h3>
                        <div class="flex space-x-3">
                            <select id="semesterSelect" class="px-4 py-2 border-2 border-gray-200 rounded-xl bg-white" onchange="loadKalenderSemester()">
                                <option value="1">Semester 1 (Ganjil)</option>
                                <option value="2">Semester 2 (Genap)</option>
                            </select>
                        </div>
                    </div>

                    <form id="kalenderForm" class="space-y-6">
                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Mulai Semester</label>
                                <input type="date" id="tanggalMulai" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Selesai Semester</label>
                                <input type="date" id="tanggalSelesai" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl">
                            </div>
                        </div>

                        <div>
                            <h4 class="font-semibold text-gray-900 mb-4">Hari Efektif per Bulan</h4>
                            <div id="hariEfektifContainer" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4"></div>
                        </div>

                        <div class="border-t pt-6">
                            <h4 class="font-semibold text-gray-900 mb-4">Pekan Ujian</h4>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">PTS</label>
                                    <div class="flex space-x-2">
                                        <input type="date" id="ptsMulai" class="flex-1 px-3 py-2 border-2 border-gray-200 rounded-lg">
                                        <span class="flex items-center text-gray-400">s/d</span>
                                        <input type="date" id="ptsSelesai" class="flex-1 px-3 py-2 border-2 border-gray-200 rounded-lg">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">PAS/PAT</label>
                                    <div class="flex space-x-2">
                                        <input type="date" id="pasMulai" class="flex-1 px-3 py-2 border-2 border-gray-200 rounded-lg">
                                        <span class="flex items-center text-gray-400">s/d</span>
                                        <input type="date" id="pasSelesai" class="flex-1 px-3 py-2 border-2 border-gray-200 rounded-lg">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gray-50 rounded-xl p-4">
                            <h4 class="font-semibold text-gray-900 mb-3">Ringkasan</h4>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                                <div class="bg-white p-3 rounded-lg">
                                    <p id="totalHariEfektif" class="text-2xl font-bold text-primary-600">0</p>
                                    <p class="text-xs text-gray-500">Hari Efektif</p>
                                </div>
                                <div class="bg-white p-3 rounded-lg">
                                    <p id="totalMingguEfektif" class="text-2xl font-bold text-secondary-600">0</p>
                                    <p class="text-xs text-gray-500">Minggu Efektif</p>
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-end pt-4">
                            <button type="submit" class="btn-primary text-white px-6 py-3 rounded-xl font-semibold">
                                <i class="fas fa-save mr-2"></i>Simpan Kalender
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;
    }

    function initKalender() {
        populateHariEfektifInputs();
        loadKalenderSemester();
        document.getElementById('kalenderForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await saveKalender();
        });
    }

    function populateHariEfektifInputs() {
        const semester = document.getElementById('semesterSelect').value;
        let months = semester === '1' ? 
            [{name:'Juli',v:7},{name:'Agustus',v:8},{name:'September',v:9},{name:'Oktober',v:10},{name:'November',v:11},{name:'Desember',v:12}] :
            [{name:'Januari',v:1},{name:'Februari',v:2},{name:'Maret',v:3},{name:'April',v:4},{name:'Mei',v:5},{name:'Juni',v:6}];

        document.getElementById('hariEfektifContainer').innerHTML = months.map(m => `
            <div class="bg-gray-50 p-3 rounded-lg">
                <label class="block text-xs text-gray-500 mb-1">${m.name}</label>
                <input type="number" id="hari_${m.v}" min="0" max="31" value="0" class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg text-center font-bold" onchange="calculateTotals()">
            </div>
        `).join('');
    }

    function calculateTotals() {
        let total = 0;
        document.querySelectorAll('#hariEfektifContainer input').forEach(input => {
            total += parseInt(input.value) || 0;
        });
        document.getElementById('totalHariEfektif').textContent = total;
        document.getElementById('totalMingguEfektif').textContent = Math.ceil(total / 6);
    }

    async function loadKalenderSemester() {
        populateHariEfektifInputs();
        const semester = document.getElementById('semesterSelect').value;
        try {
            const doc = await db.collection('users').doc(currentUser.uid).collection('kalender').doc(`2024_${semester}`).get();
            if (doc.exists) {
                const data = doc.data();
                document.getElementById('tanggalMulai').value = data.tanggalMulai || '';
                document.getElementById('tanggalSelesai').value = data.tanggalSelesai || '';
                document.getElementById('ptsMulai').value = data.ptsMulai || '';
                document.getElementById('ptsSelesai').value = data.ptsSelesai || '';
                document.getElementById('pasMulai').value = data.pasMulai || '';
                document.getElementById('pasSelesai').value = data.pasSelesai || '';
                if (data.hariEfektif) {
                    Object.keys(data.hariEfektif).forEach(key => {
                        const input = document.getElementById(`hari_${key}`);
                        if (input) input.value = data.hariEfektif[key];
                    });
                }
                calculateTotals();
            }
        } catch (error) {
            console.error('Error loading kalender:', error);
        }
    }

    async function saveKalender() {
        showLoading();
        const semester = document.getElementById('semesterSelect').value;
        const hariEfektif = {};
        document.querySelectorAll('#hariEfektifContainer input').forEach(input => {
            const bulan = input.id.replace('hari_', '');
            hariEfektif[bulan] = parseInt(input.value) || 0;
        });
        let totalHariEfektif = Object.values(hariEfektif).reduce((a, b) => a + b, 0);

        try {
            await db.collection('users').doc(currentUser.uid).collection('kalender').doc(`2024_${semester}`).set({
                semester, tahun: '2024',
                tanggalMulai: document.getElementById('tanggalMulai').value,
                tanggalSelesai: document.getElementById('tanggalSelesai').value,
                ptsMulai: document.getElementById('ptsMulai').value,
                ptsSelesai: document.getElementById('ptsSelesai').value,
                pasMulai: document.getElementById('pasMulai').value,
                pasSelesai: document.getElementById('pasSelesai').value,
                hariEfektif, totalHariEfektif,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            await db.collection('users').doc(currentUser.uid).collection('kalender').doc('aktif').set({
                semester, tahun: '2024', hariEfektif: totalHariEfektif,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            hideLoading();
            showToast('Kalender berhasil disimpan!');
        } catch (error) {
            hideLoading();
            showToast('Gagal menyimpan: ' + error.message, 'error');
        }
    }

    // Karena file sangat panjang, saya akan melanjutkan di Part 2...
    </script>
</body>
</html>
