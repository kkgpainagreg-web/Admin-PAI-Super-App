
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - ADMIN GURU SUPER APP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        secondary: '#1e40af',
                        accent: '#3b82f6',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                        dark: '#1f2937',
                        sidebar: '#0f172a',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        arabic: ['Amiri', 'serif'],
                    }
                }
            }
        }
    </script>
    <style>
        * { font-family: 'Inter', sans-serif; }
        .arabic-text { font-family: 'Amiri', serif; direction: rtl; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #a1a1a1; }
        
        /* Sidebar */
        .sidebar { transition: transform 0.3s ease, width 0.3s ease; }
        .sidebar-collapsed { transform: translateX(-100%); }
        @media (min-width: 1024px) {
            .sidebar-collapsed { transform: translateX(0); width: 80px; }
            .sidebar-collapsed .sidebar-text { display: none; }
            .sidebar-collapsed .sidebar-logo-text { display: none; }
        }
        
        /* Menu item active */
        .menu-item.active { background: rgba(59, 130, 246, 0.2); border-left: 3px solid #3b82f6; }
        .menu-item:hover { background: rgba(255, 255, 255, 0.1); }
        
        /* Card hover effect */
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0,0,0,0.15); }
        
        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e5e7eb;
            border-top-color: #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Premium badge */
        .premium-badge {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        /* RTL support for Arabic */
        [dir="rtl"] { direction: rtl; text-align: right; }
        
        /* Print styles */
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
        }
        
        /* Modal animation */
        .modal-enter { animation: modalEnter 0.3s ease; }
        @keyframes modalEnter {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        /* Tab indicator */
        .tab-indicator {
            position: absolute;
            bottom: 0;
            height: 3px;
            background: #2563eb;
            transition: all 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="text-center">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-gray-600">Memuat aplikasi...</p>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar fixed lg:relative z-40 h-full w-72 bg-sidebar text-white flex flex-col">
            <!-- Logo -->
            <div class="p-5 border-b border-white/10">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-primary rounded-xl flex items-center justify-center">
                        <i class="fas fa-chalkboard-teacher text-lg"></i>
                    </div>
                    <div class="sidebar-logo-text">
                        <h1 class="font-bold text-lg">ADMIN GURU</h1>
                        <p class="text-xs text-gray-400">Super App v1.0</p>
                    </div>
                </div>
            </div>

            <!-- User Info -->
            <div class="p-4 border-b border-white/10">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-gradient-to-br from-primary to-purple-600 rounded-full flex items-center justify-center">
                        <span id="userInitial" class="text-lg font-bold">G</span>
                    </div>
                    <div class="sidebar-text flex-1 min-w-0">
                        <p id="userName" class="font-semibold truncate">Guru</p>
                        <div class="flex items-center gap-2">
                            <span id="userSubscription" class="text-xs px-2 py-0.5 bg-gray-600 rounded-full">Free</span>
                            <span id="userRole" class="text-xs text-gray-400">Guru</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <nav class="flex-1 overflow-y-auto p-3">
                <!-- Main Menu -->
                <div class="mb-6">
                    <p class="sidebar-text text-xs text-gray-500 uppercase tracking-wider mb-3 px-3">Menu Utama</p>
                    <ul class="space-y-1">
                        <li>
                            <a href="#" onclick="loadPage('dashboard')" data-page="dashboard" class="menu-item flex items-center gap-3 px-3 py-3 rounded-lg transition-all active">
                                <i class="fas fa-home w-5 text-center"></i>
                                <span class="sidebar-text">Dashboard</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" onclick="loadPage('profile')" data-page="profile" class="menu-item flex items-center gap-3 px-3 py-3 rounded-lg transition-all">
                                <i class="fas fa-user w-5 text-center"></i>
                                <span class="sidebar-text">Profil</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- Data Dasar -->
                <div class="mb-6">
                    <p class="sidebar-text text-xs text-gray-500 uppercase tracking-wider mb-3 px-3">Data Dasar</p>
                    <ul class="space-y-1">
                        <li>
                            <a href="#" onclick="loadPage('calendar')" data-page="calendar" class="menu-item flex items-center gap-3 px-3 py-3 rounded-lg transition-all">
                                <i class="fas fa-calendar-alt w-5 text-center"></i>
                                <span class="sidebar-text">Kalender Pendidikan</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" onclick="loadPage('schedule')" data-page="schedule" class="menu-item flex items-center gap-3 px-3 py-3 rounded-lg transition-all">
                                <i class="fas fa-clock w-5 text-center"></i>
                                <span class="sidebar-text">Jadwal Pelajaran</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" onclick="loadPage('students')" data-page="students" class="menu-item flex items-center gap-3 px-3 py-3 rounded-lg transition-all">
                                <i class="fas fa-users w-5 text-center"></i>
                                <span class="sidebar-text">Data Siswa</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" onclick="loadPage('cp')" data-page="cp" class="menu-item flex items-center gap-3 px-3 py-3 rounded-lg transition-all">
                                <i class="fas fa-book w-5 text-center"></i>
                                <span class="sidebar-text">Capaian Pembelajaran</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- Dokumen Administrasi -->
                <div class="mb-6">
                    <p class="sidebar-text text-xs text-gray-500 uppercase tracking-wider mb-3 px-3">Dokumen</p>
                    <ul class="space-y-1">
                        <li>
                            <a href="#" onclick="loadPage('atp')" data-page="atp" class="menu-item flex items-center gap-3 px-3 py-3 rounded-lg transition-all">
                                <i class="fas fa-route w-5 text-center"></i>
                                <span class="sidebar-text">ATP</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" onclick="loadPage('prota')" data-page="prota" class="menu-item flex items-center gap-3 px-3 py-3 rounded-lg transition-all">
                                <i class="fas fa-calendar-check w-5 text-center"></i>
                                <span class="sidebar-text">Prota</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" onclick="loadPage('promes')" data-page="promes" class="menu-item flex items-center gap-3 px-3 py-3 rounded-lg transition-all">
                                <i class="fas fa-calendar-week w-5 text-center"></i>
                                <span class="sidebar-text">Promes</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" onclick="loadPage('modul')" data-page="modul" class="menu-item premium-feature flex items-center gap-3 px-3 py-3 rounded-lg transition-all">
                                <i class="fas fa-file-alt w-5 text-center"></i>
                                <span class="sidebar-text">Modul Ajar</span>
                                <span class="premium-badge text-xs px-2 py-0.5 rounded-full text-white ml-auto">PRO</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- Pembelajaran -->
                <div class="mb-6">
                    <p class="sidebar-text text-xs text-gray-500 uppercase tracking-wider mb-3 px-3">Pembelajaran</p>
                    <ul class="space-y-1">
                        <li>
                            <a href="#" onclick="loadPage('journal')" data-page="journal" class="menu-item flex items-center gap-3 px-3 py-3 rounded-lg transition-all">
                                <i class="fas fa-book-open w-5 text-center"></i>
                                <span class="sidebar-text">Jurnal Mengajar</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" onclick="loadPage('attendance')" data-page="attendance" class="menu-item flex items-center gap-3 px-3 py-3 rounded-lg transition-all">
                                <i class="fas fa-clipboard-check w-5 text-center"></i>
                                <span class="sidebar-text">Absensi</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" onclick="loadPage('grades')" data-page="grades" class="menu-item flex items-center gap-3 px-3 py-3 rounded-lg transition-all">
                                <i class="fas fa-star w-5 text-center"></i>
                                <span class="sidebar-text">Daftar Nilai</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" onclick="loadPage('lkpd')" data-page="lkpd" class="menu-item premium-feature flex items-center gap-3 px-3 py-3 rounded-lg transition-all">
                                <i class="fas fa-tasks w-5 text-center"></i>
                                <span class="sidebar-text">LKPD</span>
                                <span class="premium-badge text-xs px-2 py-0.5 rounded-full text-white ml-auto">PRO</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" onclick="loadPage('banksoal')" data-page="banksoal" class="menu-item premium-feature flex items-center gap-3 px-3 py-3 rounded-lg transition-all">
                                <i class="fas fa-question-circle w-5 text-center"></i>
                                <span class="sidebar-text">Bank Soal</span>
                                <span class="premium-badge text-xs px-2 py-0.5 rounded-full text-white ml-auto">PRO</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- Admin Menu (Super Admin Only) -->
                <div id="adminMenu" class="mb-6 hidden">
                    <p class="sidebar-text text-xs text-gray-500 uppercase tracking-wider mb-3 px-3">Admin</p>
                    <ul class="space-y-1">
                        <li>
                            <a href="#" onclick="loadPage('admin-users')" data-page="admin-users" class="menu-item flex items-center gap-3 px-3 py-3 rounded-lg transition-all">
                                <i class="fas fa-users-cog w-5 text-center"></i>
                                <span class="sidebar-text">Kelola User</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" onclick="loadPage('admin-subscriptions')" data-page="admin-subscriptions" class="menu-item flex items-center gap-3 px-3 py-3 rounded-lg transition-all">
                                <i class="fas fa-credit-card w-5 text-center"></i>
                                <span class="sidebar-text">Langganan</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- Tools -->
                <div class="mb-6">
                    <p class="sidebar-text text-xs text-gray-500 uppercase tracking-wider mb-3 px-3">Tools</p>
                    <ul class="space-y-1">
                        <li>
                            <a href="#" onclick="loadPage('ai-assistant')" data-page="ai-assistant" class="menu-item flex items-center gap-3 px-3 py-3 rounded-lg transition-all">
                                <i class="fas fa-robot w-5 text-center"></i>
                                <span class="sidebar-text">AI Assistant</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" onclick="loadPage('guide')" data-page="guide" class="menu-item flex items-center gap-3 px-3 py-3 rounded-lg transition-all">
                                <i class="fas fa-book-reader w-5 text-center"></i>
                                <span class="sidebar-text">Panduan</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Sidebar Footer -->
            <div class="p-4 border-t border-white/10">
                <button onclick="logout()" class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded-lg transition-all">
                    <i class="fas fa-sign-out-alt"></i>
                    <span class="sidebar-text">Keluar</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Top Header -->
            <header class="bg-white border-b border-gray-200 px-4 lg:px-6 py-4 flex items-center justify-between no-print">
                <div class="flex items-center gap-4">
                    <button onclick="toggleSidebar()" class="lg:hidden p-2 hover:bg-gray-100 rounded-lg">
                        <i class="fas fa-bars text-gray-600"></i>
                    </button>
                    <div>
                        <h2 id="pageTitle" class="text-xl font-bold text-gray-800">Dashboard</h2>
                        <p id="pageSubtitle" class="text-sm text-gray-500">Selamat datang di Admin Guru Super App</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <!-- Quick Actions -->
                    <button onclick="showQuickGenerate()" class="hidden md:flex items-center gap-2 px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-all">
                        <i class="fas fa-magic"></i>
                        <span>Generate Dokumen</span>
                    </button>
                    
                    <!-- Notifications -->
                    <button class="relative p-2 hover:bg-gray-100 rounded-lg">
                        <i class="fas fa-bell text-gray-600"></i>
                        <span class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span>
                    </button>
                    
                    <!-- User Menu -->
                    <div class="relative">
                        <button onclick="toggleUserMenu()" class="flex items-center gap-2 p-2 hover:bg-gray-100 rounded-lg">
                            <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center">
                                <span id="headerUserInitial" class="text-white text-sm font-semibold">G</span>
                            </div>
                            <i class="fas fa-chevron-down text-gray-400 text-xs"></i>
                        </button>
                        <div id="userMenuDropdown" class="absolute right-0 top-full mt-2 w-48 bg-white rounded-xl shadow-lg border border-gray-100 py-2 hidden z-50">
                            <a href="#" onclick="loadPage('profile')" class="flex items-center gap-3 px-4 py-2 hover:bg-gray-50">
                                <i class="fas fa-user text-gray-400"></i>
                                <span>Profil Saya</span>
                            </a>
                            <a href="#" onclick="loadPage('guide')" class="flex items-center gap-3 px-4 py-2 hover:bg-gray-50">
                                <i class="fas fa-question-circle text-gray-400"></i>
                                <span>Bantuan</span>
                            </a>
                            <hr class="my-2">
                            <a href="#" onclick="logout()" class="flex items-center gap-3 px-4 py-2 hover:bg-gray-50 text-red-500">
                                <i class="fas fa-sign-out-alt"></i>
                                <span>Keluar</span>
                            </a>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Page Content -->
            <main id="mainContent" class="flex-1 overflow-y-auto p-4 lg:p-6">
                <!-- Dynamic Content Will Be Loaded Here -->
            </main>
        </div>
    </div>

    <!-- Mobile Sidebar Overlay -->
    <div id="sidebarOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-30 hidden lg:hidden"></div>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <!-- Modal Container -->
    <div id="modalContainer"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <!-- Main Application Script -->
    <script>
        // ==========================================
        // FIREBASE CONFIGURATION
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyDpiK4F4ilnDDNEwO0djGY-ClwgwBl1eFk",
            authDomain: "asap-1d653.firebaseapp.com",
            projectId: "asap-1d653",
            storageBucket: "asap-1d653.firebasestorage.app",
            messagingSenderId: "143263188364",
            appId: "1:143263188364:web:47b4c003972b3503e882a9",
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // ==========================================
    // GLOBAL CONSTANTS
    // ==========================================
    const SUPER_ADMIN_EMAIL = 'afifaro@gmail.com';
    
    // 8 Dimensi Profil Lulusan (Kepka BSKAP No. 046/H/KR/2025)
    const DIMENSI_LULUSAN = [
        {
            id: 1,
            nama: 'Keimanan',
            deskripsi: 'Beriman dan bertakwa kepada Tuhan Yang Maha Esa',
            icon: 'fa-pray',
            color: 'bg-emerald-100 text-emerald-700'
        },
        {
            id: 2,
            nama: 'Kewargaan',
            deskripsi: 'Berkewarganegaraan yang baik dan cinta tanah air',
            icon: 'fa-flag',
            color: 'bg-red-100 text-red-700'
        },
        {
            id: 3,
            nama: 'Penalaran Kritis',
            deskripsi: 'Bernalar kritis dalam memecahkan masalah',
            icon: 'fa-brain',
            color: 'bg-purple-100 text-purple-700'
        },
        {
            id: 4,
            nama: 'Kreativitas',
            deskripsi: 'Kreatif dan inovatif dalam berkarya',
            icon: 'fa-lightbulb',
            color: 'bg-yellow-100 text-yellow-700'
        },
        {
            id: 5,
            nama: 'Kolaborasi',
            deskripsi: 'Bergotong royong dan mampu bekerja sama',
            icon: 'fa-users',
            color: 'bg-blue-100 text-blue-700'
        },
        {
            id: 6,
            nama: 'Kemandirian',
            deskripsi: 'Mandiri dan bertanggung jawab',
            icon: 'fa-user-check',
            color: 'bg-indigo-100 text-indigo-700'
        },
        {
            id: 7,
            nama: 'Kesehatan',
            deskripsi: 'Sehat jasmani dan rohani',
            icon: 'fa-heartbeat',
            color: 'bg-pink-100 text-pink-700'
        },
        {
            id: 8,
            nama: 'Komunikasi',
            deskripsi: 'Berkomunikasi efektif dan santun',
            icon: 'fa-comments',
            color: 'bg-cyan-100 text-cyan-700'
        }
    ];

    // CP PAI Default Data per Fase (Kepka BSKAP No. 046/H/KR/2025)
    const CP_PAI_DEFAULT = {
        'A': {
            fase: 'A',
            jenjang: 'SD/MI Kelas 1-2',
            dimensi_fokus: ['Keimanan', 'Kemandirian', 'Komunikasi'],
            elemen: [
                { 
                    id: 'A1', 
                    nama: 'Al-Quran Hadis', 
                    materi: 'Mengenal huruf Hijaiah, tanda baca, dan membaca surah pendek (Al-Fatihah, An-Nas, Al-Falaq, Al-Ikhlas)',
                    dimensi: ['Keimanan', 'Komunikasi']
                },
                { 
                    id: 'A2', 
                    nama: 'Akidah', 
                    materi: 'Mengenal Rukun Iman (Iman kepada Allah SWT)',
                    dimensi: ['Keimanan']
                },
                { 
                    id: 'A3', 
                    nama: 'Akhlak', 
                    materi: 'Akhlak kepada diri sendiri dan keluarga (jujur, disiplin, hormat kepada orang tua)',
                    dimensi: ['Kemandirian', 'Komunikasi']
                },
                { 
                    id: 'A4', 
                    nama: 'Fikih', 
                    materi: 'Mengenal Rukun Islam, thaharah (bersuci), dan gerakan shalat',
                    dimensi: ['Keimanan', 'Kemandirian']
                },
                { 
                    id: 'A5', 
                    nama: 'Sejarah Islam', 
                    materi: 'Kisah teladan Nabi Adam AS, Nuh AS, dan Ibrahim AS',
                    dimensi: ['Keimanan', 'Penalaran Kritis']
                }
            ]
        },
        'B': {
            fase: 'B',
            jenjang: 'SD/MI Kelas 3-4',
            dimensi_fokus: ['Keimanan', 'Kolaborasi', 'Penalaran Kritis'],
            elemen: [
                { 
                    id: 'B1', 
                    nama: 'Al-Quran Hadis', 
                    materi: 'Membaca ayat-ayat tentang perintah shalat dan berbuat baik (Q.S. Al-Kautsar, Al-Maun)',
                    dimensi: ['Keimanan', 'Komunikasi']
                },
                { 
                    id: 'B2', 
                    nama: 'Akidah', 
                    materi: 'Mengenal sifat-sifat Allah (Asmaul Husna) dan iman kepada Malaikat',
                    dimensi: ['Keimanan', 'Penalaran Kritis']
                },
                { 
                    id: 'B3', 
                    nama: 'Akhlak', 
                    materi: 'Adab kepada orang tua, guru, dan teman (birrul walidain, ta\'dzim)',
                    dimensi: ['Kolaborasi', 'Komunikasi']
                },
                { 
                    id: 'B4', 
                    nama: 'Fikih', 
                    materi: 'Puasa Ramadhan, tanda-tanda baligh, shalat berjamaah',
                    dimensi: ['Keimanan', 'Kemandirian', 'Kolaborasi']
                },
                { 
                    id: 'B5', 
                    nama: 'Sejarah Islam', 
                    materi: 'Sirah Nabawiyah periode Makkah (kelahiran hingga hijrah)',
                    dimensi: ['Keimanan', 'Penalaran Kritis']
                }
            ]
        },
        'C': {
            fase: 'C',
            jenjang: 'SD/MI Kelas 5-6',
            dimensi_fokus: ['Keimanan', 'Kewargaan', 'Kolaborasi', 'Penalaran Kritis'],
            elemen: [
                { 
                    id: 'C1', 
                    nama: 'Al-Quran Hadis', 
                    materi: 'Ayat tentang keragaman, toleransi, dan persatuan (Q.S. Al-Hujurat: 13, Q.S. Al-Kafirun)',
                    dimensi: ['Keimanan', 'Kewargaan', 'Kolaborasi']
                },
                { 
                    id: 'C2', 
                    nama: 'Akidah', 
                    materi: 'Iman kepada Hari Akhir dan Qada Qadar',
                    dimensi: ['Keimanan', 'Penalaran Kritis']
                },
                { 
                    id: 'C3', 
                    nama: 'Akhlak', 
                    materi: 'Adab sosial dan bermasyarakat (toleransi, menghormati perbedaan)',
                    dimensi: ['Kewargaan', 'Kolaborasi', 'Komunikasi']
                },
                { 
                    id: 'C4', 
                    nama: 'Fikih', 
                    materi: 'Zakat fitrah, infaq, sedekah, dan ibadah kurban',
                    dimensi: ['Keimanan', 'Kolaborasi', 'Kewargaan']
                },
                { 
                    id: 'C5', 
                    nama: 'Sejarah Islam', 
                    materi: 'Sirah Nabawiyah periode Madinah dan Khulafaur Rasyidin',
                    dimensi: ['Keimanan', 'Kewargaan', 'Penalaran Kritis']
                }
            ]
        },
        'D': {
            fase: 'D',
            jenjang: 'SMP/MTs Kelas 7-9',
            dimensi_fokus: ['Keimanan', 'Kewargaan', 'Penalaran Kritis', 'Kreativitas', 'Kolaborasi'],
            elemen: [
                { 
                    id: 'D1', 
                    nama: 'Al-Quran Hadis', 
                    materi: 'Ayat tentang toleransi, kerukunan, dan larangan ekstremisme',
                    dimensi: ['Keimanan', 'Kewargaan', 'Penalaran Kritis']
                },
                { 
                    id: 'D2', 
                    nama: 'Akidah', 
                    materi: 'Pendalaman Rukun Iman (6 Rukun), iman kepada Rasul dan Kitab',
                    dimensi: ['Keimanan', 'Penalaran Kritis']
                },
                { 
                    id: 'D3', 
                    nama: 'Akhlak', 
                    materi: 'Akhlak terpuji dan tercela, etika pergaulan remaja',
                    dimensi: ['Kemandirian', 'Kolaborasi', 'Komunikasi']
                },
                { 
                    id: 'D4', 
                    nama: 'Fikih', 
                    materi: 'Sujud (syukur, sahwi, tilawah), haji, umrah, muamalah dasar',
                    dimensi: ['Keimanan', 'Kemandirian', 'Kolaborasi']
                },
                { 
                    id: 'D5', 
                    nama: 'Sejarah Islam', 
                    materi: 'Peradaban Islam: Bani Umayyah, Abbasiyah, hingga Mughal',
                    dimensi: ['Penalaran Kritis', 'Kewargaan', 'Kreativitas']
                }
            ]
        },
        'E': {
            fase: 'E',
            jenjang: 'SMA/MA/SMK Kelas 10',
            dimensi_fokus: ['Keimanan', 'Penalaran Kritis', 'Kreativitas', 'Kemandirian', 'Kewargaan'],
            elemen: [
                { 
                    id: 'E1', 
                    nama: 'Al-Quran Hadis', 
                    materi: 'Kompetisi dalam kebaikan (Fastabiqul Khairat), Q.S. Al-Maidah: 48',
                    dimensi: ['Keimanan', 'Kreativitas', 'Kolaborasi']
                },
                { 
                    id: 'E2', 
                    nama: 'Akidah', 
                    materi: 'Syu\'ab al-Iman (Cabang-cabang Iman), penguatan akidah',
                    dimensi: ['Keimanan', 'Penalaran Kritis']
                },
                { 
                    id: 'E3', 
                    nama: 'Akhlak', 
                    materi: 'Etika dalam kehidupan modern, akhlak bermedia sosial',
                    dimensi: ['Komunikasi', 'Kemandirian', 'Penalaran Kritis']
                },
                { 
                    id: 'E4', 
                    nama: 'Fikih', 
                    materi: 'Sumber hukum Islam (Al-Quran, Hadis, Ijma, Qiyas), ijtihad',
                    dimensi: ['Keimanan', 'Penalaran Kritis', 'Kemandirian']
                },
                { 
                    id: 'E5', 
                    nama: 'Sejarah Islam', 
                    materi: 'Perkembangan Islam di Indonesia (Walisongo, kerajaan Islam)',
                    dimensi: ['Kewargaan', 'Penalaran Kritis', 'Keimanan']
                }
            ]
        },
        'F': {
            fase: 'F',
            jenjang: 'SMA/MA/SMK Kelas 11-12',
            dimensi_fokus: ['Keimanan', 'Penalaran Kritis', 'Kreativitas', 'Komunikasi', 'Kewargaan', 'Kemandirian'],
            elemen: [
                { 
                    id: 'F1', 
                    nama: 'Al-Quran Hadis', 
                    materi: 'Ayat tentang berpikir kritis, ilmu pengetahuan, dan moderasi beragama',
                    dimensi: ['Keimanan', 'Penalaran Kritis', 'Kreativitas']
                },
                { 
                    id: 'F2', 
                    nama: 'Akidah', 
                    materi: 'Moderasi beragama (wasathiyah), anti radikalisme dan ekstremisme',
                    dimensi: ['Keimanan', 'Kewargaan', 'Penalaran Kritis']
                },
                { 
                    id: 'F3', 
                    nama: 'Akhlak', 
                    materi: 'Etika digital, literasi media, akhlak dalam dunia kerja',
                    dimensi: ['Komunikasi', 'Kemandirian', 'Kreativitas']
                },
                { 
                    id: 'F4', 
                    nama: 'Fikih', 
                    materi: 'Mawaris (waris Islam), munakahat (pernikahan), ekonomi syariah',
                    dimensi: ['Keimanan', 'Penalaran Kritis', 'Kemandirian']
                },
                { 
                    id: 'F5', 
                    nama: 'Sejarah Islam', 
                    materi: 'Organisasi Islam di Indonesia dan dunia (NU, Muhammadiyah, OKI)',
                    dimensi: ['Kewargaan', 'Kolaborasi', 'Penalaran Kritis']
                }
            ]
        }
    };

        // ==========================================
        // GLOBAL STATE
        // ==========================================
        let currentUser = null;
        let userData = null;
        let currentPage = 'dashboard';

        // ==========================================
        // UTILITY FUNCTIONS
        // ==========================================
        
        // Show Toast Notification
        function showToast(type, title, message, duration = 5000) {
            const container = document.getElementById('toastContainer');
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-times-circle',
                warning: 'fa-exclamation-circle',
                info: 'fa-info-circle'
            };
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };

            const toast = document.createElement('div');
            toast.className = 'bg-white rounded-xl shadow-lg p-4 flex items-start gap-3 max-w-sm transform translate-x-full transition-transform duration-300';
            toast.innerHTML = `
                <div class="w-8 h-8 ${colors[type]} rounded-full flex items-center justify-center flex-shrink-0">
                    <i class="fas ${icons[type]} text-white"></i>
                </div>
                <div class="flex-1">
                    <p class="font-semibold text-gray-800">${title}</p>
                    <p class="text-sm text-gray-600">${message}</p>
                </div>
                <button onclick="this.parentElement.remove()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(toast);
            
            // Animate in
            setTimeout(() => toast.classList.remove('translate-x-full'), 10);
            
            // Auto remove
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // Show Modal
        function showModal(content, options = {}) {
            const container = document.getElementById('modalContainer');
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl w-full ${options.size || 'max-w-lg'} max-h-[90vh] overflow-hidden modal-enter">
                    ${options.title ? `
                        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                            <h3 class="text-xl font-bold text-gray-800">${options.title}</h3>
                            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 p-1">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                    ` : ''}
                    <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
                        ${content}
                    </div>
                </div>
            `;
            modal.onclick = (e) => {
                if (e.target === modal) closeModal();
            };
            container.innerHTML = '';
            container.appendChild(modal);
        }

        function closeModal() {
            document.getElementById('modalContainer').innerHTML = '';
        }

        // Format Date
        function formatDate(date, format = 'long') {
            const d = new Date(date);
            const options = format === 'long' 
                ? { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }
                : { year: 'numeric', month: '2-digit', day: '2-digit' };
            return d.toLocaleDateString('id-ID', options);
        }

        // Generate UUID
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Parse CSV
        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                data.push(row);
            }
            
            return data;
        }

        // Check Premium Access
        function checkPremiumAccess() {
            if (!userData) return false;
            if (userData.role === 'superadmin') return true;
            if (userData.subscription === 'premium' || userData.subscription === 'school') {
                if (userData.subscriptionExpiry) {
                    return new Date(userData.subscriptionExpiry.toDate()) > new Date();
                }
            }
            return false;
        }

        // ==========================================
        // UI FUNCTIONS
        // ==========================================
        
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('sidebar-collapsed');
            overlay.classList.toggle('hidden');
        }

        function toggleUserMenu() {
            document.getElementById('userMenuDropdown').classList.toggle('hidden');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('userMenuDropdown');
            if (!e.target.closest('[onclick="toggleUserMenu()"]') && !dropdown.contains(e.target)) {
                dropdown.classList.add('hidden');
            }
        });

        // ==========================================
        // PAGE TEMPLATES
        // ==========================================
        
        const pageTemplates = {
            // Dashboard Page
            dashboard: () => `
                <div class="space-y-6">
                    <!-- Welcome Card -->
                    <div class="bg-gradient-to-r from-primary to-purple-600 rounded-2xl p-6 text-white">
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div>
                                <h2 class="text-2xl font-bold mb-2">Selamat Datang, ${userData?.name || 'Guru'}! ðŸ‘‹</h2>
                                <p class="text-white/80">Kelola administrasi mengajar Anda dengan mudah dan efisien.</p>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="loadPage('calendar')" class="px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg transition-all">
                                    <i class="fas fa-calendar-plus mr-2"></i>Atur Kalender
                                </button>
                                <button onclick="showQuickGenerate()" class="px-4 py-2 bg-white text-primary rounded-lg hover:bg-gray-100 transition-all font-semibold">
                                    <i class="fas fa-magic mr-2"></i>Generate
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Stats -->
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-white rounded-xl p-5 shadow-sm card-hover">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-users text-blue-600 text-xl"></i>
                                </div>
                                <div>
                                    <p class="text-2xl font-bold text-gray-800" id="statStudents">0</p>
                                    <p class="text-sm text-gray-500">Total Siswa</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl p-5 shadow-sm card-hover">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-chalkboard text-green-600 text-xl"></i>
                                </div>
                                <div>
                                    <p class="text-2xl font-bold text-gray-800" id="statClasses">0</p>
                                    <p class="text-sm text-gray-500">Kelas Diampu</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl p-5 shadow-sm card-hover">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-file-alt text-purple-600 text-xl"></i>
                                </div>
                                <div>
                                    <p class="text-2xl font-bold text-gray-800" id="statDocs">0</p>
                                    <p class="text-sm text-gray-500">Dokumen</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl p-5 shadow-sm card-hover">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-calendar-check text-orange-600 text-xl"></i>
                                </div>
                                <div>
                                    <p class="text-2xl font-bold text-gray-800" id="statEffectiveDays">0</p>
                                    <p class="text-sm text-gray-500">Hari Efektif</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Main Grid -->
                    <div class="grid lg:grid-cols-3 gap-6">
                        <!-- Quick Actions -->
                        <div class="lg:col-span-2 bg-white rounded-xl shadow-sm p-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">
                                <i class="fas fa-bolt text-primary mr-2"></i>Aksi Cepat
                            </h3>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                <button onclick="loadPage('calendar')" class="p-4 border-2 border-dashed border-gray-200 rounded-xl hover:border-primary hover:bg-primary/5 transition-all group">
                                    <i class="fas fa-calendar-alt text-3xl text-gray-400 group-hover:text-primary mb-2"></i>
                                    <p class="font-medium text-gray-700">Kalender</p>
                                </button>
                                <button onclick="loadPage('schedule')" class="p-4 border-2 border-dashed border-gray-200 rounded-xl hover:border-primary hover:bg-primary/5 transition-all group">
                                    <i class="fas fa-clock text-3xl text-gray-400 group-hover:text-primary mb-2"></i>
                                    <p class="font-medium text-gray-700">Jadwal</p>
                                </button>
                                <button onclick="loadPage('cp')" class="p-4 border-2 border-dashed border-gray-200 rounded-xl hover:border-primary hover:bg-primary/5 transition-all group">
                                    <i class="fas fa-book text-3xl text-gray-400 group-hover:text-primary mb-2"></i>
                                    <p class="font-medium text-gray-700">CP/TP</p>
                                </button>
                                <button onclick="loadPage('atp')" class="p-4 border-2 border-dashed border-gray-200 rounded-xl hover:border-primary hover:bg-primary/5 transition-all group">
                                    <i class="fas fa-route text-3xl text-gray-400 group-hover:text-primary mb-2"></i>
                                    <p class="font-medium text-gray-700">ATP</p>
                                </button>
                                <button onclick="loadPage('prota')" class="p-4 border-2 border-dashed border-gray-200 rounded-xl hover:border-primary hover:bg-primary/5 transition-all group">
                                    <i class="fas fa-calendar-check text-3xl text-gray-400 group-hover:text-primary mb-2"></i>
                                    <p class="font-medium text-gray-700">Prota</p>
                                </button>
                                <button onclick="loadPage('promes')" class="p-4 border-2 border-dashed border-gray-200 rounded-xl hover:border-primary hover:bg-primary/5 transition-all group">
                                    <i class="fas fa-calendar-week text-3xl text-gray-400 group-hover:text-primary mb-2"></i>
                                    <p class="font-medium text-gray-700">Promes</p>
                                </button>
                            </div>
                        </div>

                        <!-- Subscription Status -->
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">
                                <i class="fas fa-crown text-warning mr-2"></i>Status Langganan
                            </h3>
                            <div class="text-center py-4">
                                ${userData?.subscription === 'premium' || userData?.subscription === 'school' ? `
                                    <div class="w-16 h-16 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full flex items-center justify-center mx-auto mb-3">
                                        <i class="fas fa-crown text-white text-2xl"></i>
                                    </div>
                                    <p class="text-xl font-bold text-gray-800 mb-1">${userData.subscription === 'school' ? 'Paket Sekolah' : 'Premium'}</p>
                                    <p class="text-sm text-gray-500">Aktif hingga: ${userData.subscriptionExpiry ? formatDate(userData.subscriptionExpiry.toDate()) : '-'}</p>
                                ` : `
                                    <div class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center mx-auto mb-3">
                                        <i class="fas fa-user text-gray-400 text-2xl"></i>
                                    </div>
                                    <p class="text-xl font-bold text-gray-800 mb-1">Free</p>
                                    <p class="text-sm text-gray-500 mb-4">Upgrade untuk fitur lengkap</p>
                                    <button onclick="showUpgradeModal()" class="w-full py-3 bg-gradient-to-r from-yellow-400 to-orange-500 text-white font-semibold rounded-xl hover:shadow-lg transition-all">
                                        <i class="fas fa-arrow-up mr-2"></i>Upgrade Sekarang
                                    </button>
                                `}
                            </div>
                            <div class="mt-4 pt-4 border-t border-gray-100">
                                <p class="text-sm font-medium text-gray-700 mb-2">Fitur yang tersedia:</p>
                                <ul class="space-y-2 text-sm">
                                    <li class="flex items-center gap-2 text-green-600">
                                        <i class="fas fa-check"></i>Kalender Pendidikan
                                    </li>
                                    <li class="flex items-center gap-2 text-green-600">
                                        <i class="fas fa-check"></i>Jadwal Pelajaran
                                    </li>
                                    <li class="flex items-center gap-2 text-green-600">
                                        <i class="fas fa-check"></i>ATP & Prota
                                    </li>
                                    <li class="flex items-center gap-2 ${checkPremiumAccess() ? 'text-green-600' : 'text-gray-400'}">
                                        <i class="fas fa-${checkPremiumAccess() ? 'check' : 'lock'}"></i>Modul Ajar
                                    </li>
                                    <li class="flex items-center gap-2 ${checkPremiumAccess() ? 'text-green-600' : 'text-gray-400'}">
                                        <i class="fas fa-${checkPremiumAccess() ? 'check' : 'lock'}"></i>Bank Soal
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity & Schedule -->
                    <div class="grid lg:grid-cols-2 gap-6">
                        <!-- Today's Schedule -->
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-bold text-gray-800">
                                    <i class="fas fa-calendar-day text-primary mr-2"></i>Jadwal Hari Ini
                                </h3>
                                <span class="text-sm text-gray-500">${formatDate(new Date())}</span>
                            </div>
                            <div id="todaySchedule" class="space-y-3">
                                <div class="text-center py-8 text-gray-400">
                                    <i class="fas fa-calendar-times text-4xl mb-2"></i>
                                    <p>Belum ada jadwal hari ini</p>
                                    <button onclick="loadPage('schedule')" class="mt-2 text-primary hover:underline text-sm">Atur Jadwal</button>
                                </div>
                            </div>
                        </div>

                        <!-- Workflow Guide -->
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">
                                <i class="fas fa-tasks text-primary mr-2"></i>Alur Kerja Single Input
                            </h3>
                            <div class="space-y-4">
                                <div class="flex items-start gap-3">
                                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
                                        <span class="text-blue-600 font-bold">1</span>
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-800">Input Kalender Pendidikan</p>
                                        <p class="text-sm text-gray-500">Atur hari efektif, libur, dan pekan ujian</p>
                                    </div>
                                </div>
                                <div class="flex items-start gap-3">
                                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
                                        <span class="text-blue-600 font-bold">2</span>
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-800">Atur Jadwal Pelajaran</p>
                                        <p class="text-sm text-gray-500">Tentukan kelas, hari, dan jam mengajar</p>
                                    </div>
                                </div>
                                <div class="flex items-start gap-3">
                                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
                                        <span class="text-blue-600 font-bold">3</span>
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-800">Input Tujuan Pembelajaran (TP)</p>
                                        <p class="text-sm text-gray-500">Berdasarkan CP yang dipilih</p>
                                    </div>
                                </div>
                                <div class="flex items-start gap-3">
                                    <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0">
                                        <i class="fas fa-magic text-green-600"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-800">Generate Otomatis!</p>
                                        <p class="text-sm text-gray-500">ATP, Prota, Promes, Modul Ajar tersinkronisasi</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `,

            // Profile Page
            profile: () => `
                <div class="max-w-4xl mx-auto space-y-6">
                    <!-- Profile Header -->
                    <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
                        <div class="h-32 bg-gradient-to-r from-primary to-purple-600"></div>
                        <div class="px-6 pb-6">
                            <div class="flex flex-col md:flex-row md:items-end gap-4 -mt-16">
                                <div class="w-32 h-32 bg-white rounded-2xl shadow-lg flex items-center justify-center border-4 border-white">
                                    <span class="text-5xl font-bold text-primary">${userData?.name?.charAt(0) || 'G'}</span>
                                </div>
                                <div class="flex-1">
                                    <h2 class="text-2xl font-bold text-gray-800">${userData?.name || 'Nama Guru'}</h2>
                                    <p class="text-gray-500">${userData?.email}</p>
                                    <div class="flex flex-wrap gap-2 mt-2">
                                        <span class="px-3 py-1 bg-primary/10 text-primary rounded-full text-sm font-medium">
                                            ${userData?.profile?.mata_pelajaran || 'PAI & Budi Pekerti'}
                                        </span>
                                        <span class="px-3 py-1 bg-gray-100 text-gray-600 rounded-full text-sm">
                                            ${userData?.profile?.jenjang || 'Belum diatur'}
                                        </span>
                                    </div>
                                </div>
                                <button onclick="editProfile()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-all">
                                    <i class="fas fa-edit mr-2"></i>Edit Profil
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Profile Form -->
                    <div class="bg-white rounded-2xl shadow-sm p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-6">
                            <i class="fas fa-user-circle text-primary mr-2"></i>Informasi Profil
                        </h3>
                        <form id="profileForm" class="grid md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                                <input type="text" id="profileName" value="${userData?.name || ''}" 
                                    class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">NIP</label>
                                <input type="text" id="profileNip" value="${userData?.profile?.nip || ''}"
                                    class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent"
                                    placeholder="Nomor Induk Pegawai">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">NUPTK</label>
                                <input type="text" id="profileNuptk" value="${userData?.profile?.nuptk || ''}"
                                    class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent"
                                    placeholder="Nomor Unik Pendidik dan Tenaga Kependidikan">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label>
                                <select id="profileMapel" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent">
                                    <option value="PAI & Budi Pekerti" ${userData?.profile?.mata_pelajaran === 'PAI & Budi Pekerti' ? 'selected' : ''}>PAI & Budi Pekerti</option>
                                    <option value="Matematika" ${userData?.profile?.mata_pelajaran === 'Matematika' ? 'selected' : ''}>Matematika</option>
                                    <option value="Bahasa Indonesia" ${userData?.profile?.mata_pelajaran === 'Bahasa Indonesia' ? 'selected' : ''}>Bahasa Indonesia</option>
                                    <option value="Bahasa Inggris" ${userData?.profile?.mata_pelajaran === 'Bahasa Inggris' ? 'selected' : ''}>Bahasa Inggris</option>
                                    <option value="IPA" ${userData?.profile?.mata_pelajaran === 'IPA' ? 'selected' : ''}>IPA</option>
                                    <option value="IPS" ${userData?.profile?.mata_pelajaran === 'IPS' ? 'selected' : ''}>IPS</option>
                                    <option value="Lainnya" ${userData?.profile?.mata_pelajaran === 'Lainnya' ? 'selected' : ''}>Lainnya</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Jenjang Pendidikan</label>
                                <select id="profileJenjang" onchange="updateFaseOptions()" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent">
                                    <option value="">Pilih Jenjang</option>
                                    <option value="SD/MI" ${userData?.profile?.jenjang === 'SD/MI' ? 'selected' : ''}>SD/MI</option>
                                    <option value="SMP/MTs" ${userData?.profile?.jenjang === 'SMP/MTs' ? 'selected' : ''}>SMP/MTs</option>
                                    <option value="SMA/MA" ${userData?.profile?.jenjang === 'SMA/MA' ? 'selected' : ''}>SMA/MA</option>
                                    <option value="SMK" ${userData?.profile?.jenjang === 'SMK' ? 'selected' : ''}>SMK</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Fase</label>
                                <select id="profileFase" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent">
                                    <option value="">Pilih Fase</option>
                                    <option value="A" ${userData?.profile?.fase === 'A' ? 'selected' : ''}>Fase A (Kelas 1-2 SD)</option>
                                    <option value="B" ${userData?.profile?.fase === 'B' ? 'selected' : ''}>Fase B (Kelas 3-4 SD)</option>
                                    <option value="C" ${userData?.profile?.fase === 'C' ? 'selected' : ''}>Fase C (Kelas 5-6 SD)</option>
                                    <option value="D" ${userData?.profile?.fase === 'D' ? 'selected' : ''}>Fase D (Kelas 7-9 SMP)</option>
                                    <option value="E" ${userData?.profile?.fase === 'E' ? 'selected' : ''}>Fase E (Kelas 10 SMA)</option>
                                    <option value="F" ${userData?.profile?.fase === 'F' ? 'selected' : ''}>Fase F (Kelas 11-12 SMA)</option>
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Satuan Pendidikan</label>
                                <input type="text" id="profileSekolah" value="${userData?.profile?.satuan_pendidikan || ''}"
                                    class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent"
                                    placeholder="Nama Sekolah/Madrasah">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nama Kepala Sekolah</label>
                                <input type="text" id="profileKepsek" value="${userData?.profile?.nama_kepala_sekolah || ''}"
                                    class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent"
                                    placeholder="Nama lengkap Kepala Sekolah">
                            </div>
                            <div class="md:col-span-2">
                                <button type="submit" class="w-full py-3 bg-primary text-white font-semibold rounded-xl hover:bg-secondary transition-all">
                                    <i class="fas fa-save mr-2"></i>Simpan Perubahan
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `,

            // Calendar Page
            calendar: () => `
                <div class="space-y-6">
                    <!-- Page Header -->
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">Kalender Pendidikan</h2>
                            <p class="text-gray-500">Atur hari efektif, libur, dan kegiatan akademik</p>
                        </div>
                        <div class="flex gap-3">
                            <select id="calendarYear" onchange="loadCalendarData()" class="px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary">
                                <option value="2024">2024/2025</option>
                                <option value="2025" selected>2025/2026</option>
                                <option value="2026">2026/2027</option>
                            </select>
                            <button onclick="showAddEventModal()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-all">
                                <i class="fas fa-plus mr-2"></i>Tambah Kegiatan
                            </button>
                        </div>
                    </div>

                    <!-- Calendar Summary -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-white rounded-xl p-4 shadow-sm">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-check-circle text-green-600"></i>
                                </div>
                                <div>
                                    <p class="text-2xl font-bold text-gray-800" id="totalEffective">0</p>
                                    <p class="text-sm text-gray-500">Hari Efektif</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl p-4 shadow-sm">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-calendar-times text-red-600"></i>
                                </div>
                                <div>
                                    <p class="text-2xl font-bold text-gray-800" id="totalHoliday">0</p>
                                    <p class="text-sm text-gray-500">Hari Libur</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl p-4 shadow-sm">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-book-reader text-blue-600"></i>
                                </div>
                                <div>
                                    <p class="text-2xl font-bold text-gray-800" id="totalExam">0</p>
                                    <p class="text-sm text-gray-500">Hari Ujian</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl p-4 shadow-sm">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-graduation-cap text-purple-600"></i>
                                </div>
                                <div>
                                    <p class="text-2xl font-bold text-gray-800" id="totalWeeks">0</p>
                                    <p class="text-sm text-gray-500">Minggu Efektif</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Semester Tabs -->
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                        <div class="border-b border-gray-200">
                            <div class="flex">
                                <button onclick="switchSemester(1)" id="sem1Tab" class="flex-1 py-4 text-center font-semibold border-b-2 border-primary text-primary">
                                    Semester 1 (Ganjil)
                                </button>
                                <button onclick="switchSemester(2)" id="sem2Tab" class="flex-1 py-4 text-center font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                                    Semester 2 (Genap)
                                </button>
                            </div>
                        </div>
                        
                        <!-- Calendar Grid -->
                        <div class="p-6">
                            <div id="calendarGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <!-- Calendar months will be rendered here -->
                            </div>
                        </div>
                    </div>

                    <!-- Events List -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">
                            <i class="fas fa-list text-primary mr-2"></i>Daftar Kegiatan
                        </h3>
                        <div id="eventsList" class="space-y-3">
                            <!-- Events will be loaded here -->
                        </div>
                    </div>
                </div>
            `,

            // Schedule Page  
            schedule: () => `
                <div class="space-y-6">
                    <!-- Page Header -->
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">Jadwal Pelajaran</h2>
                            <p class="text-gray-500">Atur jadwal mengajar dengan validasi anti-bentrok</p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="showTimeSettingsModal()" class="px-4 py-2 border border-gray-200 rounded-lg hover:bg-gray-50 transition-all">
                                <i class="fas fa-cog mr-2"></i>Atur Jam
                            </button>
                            <button onclick="showAddScheduleModal()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-all">
                                <i class="fas fa-plus mr-2"></i>Tambah Jadwal
                            </button>
                        </div>
                    </div>

                    <!-- Classes Selection -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">
                            <i class="fas fa-school text-primary mr-2"></i>Kelas yang Diampu
                        </h3>
                        <div id="classesGrid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
                            <!-- Classes will be rendered here -->
                        </div>
                        <button onclick="showAddClassModal()" class="mt-4 px-4 py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-primary hover:text-primary transition-all w-full">
                            <i class="fas fa-plus mr-2"></i>Tambah Kelas/Rombel
                        </button>
                    </div>

                    <!-- Weekly Schedule -->
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                        <div class="p-6 border-b border-gray-200">
                            <h3 class="text-lg font-bold text-gray-800">
                                <i class="fas fa-calendar-week text-primary mr-2"></i>Jadwal Mingguan
                            </h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 w-24">Jam</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Senin</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Selasa</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Rabu</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Kamis</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Jumat</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Sabtu</th>
                                    </tr>
                                </thead>
                                <tbody id="scheduleTableBody">
                                    <!-- Schedule rows will be rendered here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Conflict Warnings -->
                    <div id="conflictWarnings" class="hidden bg-red-50 border border-red-200 rounded-xl p-4">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-exclamation-triangle text-red-500 mt-1"></i>
                            <div>
                                <h4 class="font-semibold text-red-800">Peringatan Konflik Jadwal</h4>
                                <ul id="conflictList" class="mt-2 text-sm text-red-700 list-disc list-inside">
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `,

            // Students Page
            students: () => `
                <div class="space-y-6">
                    <!-- Page Header -->
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">Data Siswa</h2>
                            <p class="text-gray-500">Kelola data siswa dengan import CSV</p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="showImportStudentsModal()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all">
                                <i class="fas fa-file-csv mr-2"></i>Import CSV
                            </button>
                            <button onclick="showAddStudentModal()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-all">
                                <i class="fas fa-plus mr-2"></i>Tambah Siswa
                            </button>
                        </div>
                    </div>

                    <!-- Filter & Search -->
                    <div class="bg-white rounded-xl shadow-sm p-4">
                        <div class="flex flex-col md:flex-row gap-4">
                            <div class="flex-1">
                                <div class="relative">
                                    <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                    <input type="text" id="searchStudent" onkeyup="filterStudents()" placeholder="Cari nama atau NISN..."
                                        class="w-full pl-12 pr-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent">
                                </div>
                            </div>
                            <select id="filterClass" onchange="filterStudents()" class="px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary">
                                <option value="">Semua Kelas</option>
                            </select>
                            <select id="filterRombel" onchange="filterStudents()" class="px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary">
                                <option value="">Semua Rombel</option>
                            </select>
                        </div>
                    </div>

                    <!-- Students Table -->
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">No</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">NISN</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Nama Siswa</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">L/P</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Kelas</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Rombel</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="studentsTableBody">
                                    <!-- Students will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                        <div class="px-6 py-4 border-t border-gray-200 flex items-center justify-between">
                            <p class="text-sm text-gray-500">Menampilkan <span id="showingCount">0</span> dari <span id="totalCount">0</span> siswa</p>
                            <div id="pagination" class="flex gap-2">
                                <!-- Pagination buttons -->
                            </div>
                        </div>
                    </div>
                </div>
            `,

            // CP (Capaian Pembelajaran) Page
cp: () => `
    <div class="space-y-6">
        <!-- Page Header -->
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
                <h2 class="text-2xl font-bold text-gray-800">Capaian Pembelajaran (CP)</h2>
                <p class="text-gray-500">Kelola CP dan Tujuan Pembelajaran berdasarkan Kepka BSKAP 046/H/KR/2025</p>
            </div>
            <div class="flex gap-3">
                <button onclick="loadDefaultCP()" class="px-4 py-2 border border-gray-200 rounded-lg hover:bg-gray-50 transition-all">
                    <i class="fas fa-sync mr-2"></i>Load CP Default PAI
                </button>
                <button onclick="showAddCPModal()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-all">
                    <i class="fas fa-plus mr-2"></i>Tambah CP
                </button>
            </div>
        </div>

        <!-- 8 Dimensi Profil Lulusan -->
        <div class="bg-gradient-to-r from-emerald-500 to-teal-600 rounded-2xl p-6 text-white">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                    <i class="fas fa-star text-2xl"></i>
                </div>
                <div>
                    <h3 class="text-xl font-bold">8 Dimensi Profil Lulusan</h3>
                    <p class="text-white/80 text-sm">Kepka BSKAP No. 046/H/KR/2025</p>
                </div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                ${DIMENSI_LULUSAN.map(d => `
                    <div class="bg-white/10 backdrop-blur rounded-xl p-3 flex items-center gap-3 hover:bg-white/20 transition-all cursor-pointer" onclick="showDimensiDetail('${d.nama}')">
                        <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center">
                            <i class="fas ${d.icon}"></i>
                        </div>
                        <div>
                            <p class="font-semibold text-sm">${d.nama}</p>
                            <p class="text-xs text-white/70 hidden md:block">${d.deskripsi.substring(0, 25)}...</p>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>

        <!-- Info Alert -->
        <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
            <div class="flex items-start gap-3">
                <i class="fas fa-info-circle text-blue-500 mt-1"></i>
                <div>
                    <h4 class="font-semibold text-blue-800">Tentang Capaian Pembelajaran</h4>
                    <p class="text-sm text-blue-700 mt-1">
                        CP PAI & Budi Pekerti sudah tersedia secara default dan terintegrasi dengan 
                        <strong>8 Dimensi Profil Lulusan</strong>. Setiap elemen CP dihubungkan dengan dimensi yang relevan
                        untuk memastikan pembelajaran yang holistik dan terukur.
                        Guru mata pelajaran lain dapat menambahkan CP secara manual.
                    </p>
                </div>
            </div>
        </div>

        <!-- Phase Selection -->
        <div class="bg-white rounded-xl shadow-sm p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">
                <i class="fas fa-layer-group text-primary mr-2"></i>Pilih Fase
            </h3>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                ${Object.keys(CP_PAI_DEFAULT).map(fase => `
                    <button onclick="selectPhase('${fase}')" class="phase-btn p-4 border-2 border-gray-200 rounded-xl hover:border-primary transition-all text-center group" data-fase="${fase}">
                        <div class="text-3xl font-bold text-primary mb-2 group-hover:scale-110 transition-transform">Fase ${fase}</div>
                        <p class="text-sm text-gray-500">${CP_PAI_DEFAULT[fase].jenjang}</p>
                        <div class="flex flex-wrap justify-center gap-1 mt-2">
                            ${CP_PAI_DEFAULT[fase].dimensi_fokus.slice(0, 3).map(d => `
                                <span class="text-xs px-1.5 py-0.5 bg-gray-100 text-gray-600 rounded">${d.substring(0, 4)}.</span>
                            `).join('')}
                        </div>
                    </button>
                `).join('')}
            </div>
        </div>

        <!-- CP Content -->
        <div id="cpContent" class="bg-white rounded-xl shadow-sm p-6">
            <div class="text-center py-12 text-gray-400">
                <i class="fas fa-book-open text-6xl mb-4"></i>
                <p class="text-lg">Pilih Fase untuk melihat Capaian Pembelajaran</p>
            </div>
        </div>

        <!-- Tujuan Pembelajaran Section -->
        <div id="tpSection" class="hidden">
            <div class="bg-white rounded-xl shadow-sm p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-800">
                        <i class="fas fa-bullseye text-primary mr-2"></i>Tujuan Pembelajaran (TP)
                    </h3>
                    <button onclick="showAddTPModal()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-all">
                        <i class="fas fa-plus mr-2"></i>Tambah TP
                    </button>
                </div>
                <div id="tpList" class="space-y-4">
                    <!-- TP items will be loaded here -->
                </div>
            </div>
        </div>
    </div>
`,

            // ATP Page
            atp: () => `
                <div class="space-y-6">
                    <!-- Page Header -->
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">Alur Tujuan Pembelajaran (ATP)</h2>
                            <p class="text-gray-500">Generate ATP otomatis dari CP dan TP yang telah diatur</p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="generateATP()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all">
                                <i class="fas fa-magic mr-2"></i>Generate ATP
                            </button>
                            <button onclick="exportATP('pdf')" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-all">
                                <i class="fas fa-file-pdf mr-2"></i>Export PDF
                            </button>
                        </div>
                    </div>

                    <!-- ATP Filter -->
                    <div class="bg-white rounded-xl shadow-sm p-4">
                        <div class="flex flex-wrap gap-4">
                            <select id="atpFase" class="px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary">
                                <option value="">Pilih Fase</option>
                                ${Object.keys(CP_PAI_DEFAULT).map(fase => `
                                    <option value="${fase}">Fase ${fase} - ${CP_PAI_DEFAULT[fase].jenjang}</option>
                                `).join('')}
                            </select>
                            <select id="atpSemester" class="px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary">
                                <option value="">Pilih Semester</option>
                                <option value="1">Semester 1 (Ganjil)</option>
                                <option value="2">Semester 2 (Genap)</option>
                            </select>
                        </div>
                    </div>

                    <!-- ATP Table -->
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">No</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Elemen</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Capaian Pembelajaran</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Tujuan Pembelajaran</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Alokasi Waktu</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Minggu</th>
                                    </tr>
                                </thead>
                                <tbody id="atpTableBody">
                                    <tr>
                                        <td colspan="6" class="px-4 py-12 text-center text-gray-400">
                                            <i class="fas fa-route text-4xl mb-2"></i>
                                            <p>Pilih Fase dan Semester, lalu klik Generate ATP</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `,

            // Prota Page
            prota: () => `
                <div class="space-y-6">
                    <!-- Page Header -->
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">Program Tahunan (Prota)</h2>
                            <p class="text-gray-500">Sinkronisasi otomatis dengan Kalender dan Jadwal</p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="generateProta()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all">
                                <i class="fas fa-magic mr-2"></i>Generate Prota
                            </button>
                            <button onclick="exportProta('pdf')" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-all">
                                <i class="fas fa-file-pdf mr-2"></i>Export PDF
                            </button>
                        </div>
                    </div>

                    <!-- Prota Info -->
                    <div class="grid md:grid-cols-3 gap-4">
                        <div class="bg-white rounded-xl p-4 shadow-sm">
                            <p class="text-sm text-gray-500 mb-1">Tahun Pelajaran</p>
                            <p class="text-xl font-bold text-gray-800" id="protaTahun">2025/2026</p>
                        </div>
                        <div class="bg-white rounded-xl p-4 shadow-sm">
                            <p class="text-sm text-gray-500 mb-1">Total Minggu Efektif</p>
                            <p class="text-xl font-bold text-gray-800" id="protaMinggu">0</p>
                        </div>
                        <div class="bg-white rounded-xl p-4 shadow-sm">
                            <p class="text-sm text-gray-500 mb-1">Total Jam Pelajaran</p>
                            <p class="text-xl font-bold text-gray-800" id="protaJP">0</p>
                        </div>
                    </div>

                    <!-- Prota Table -->
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th rowspan="2" class="px-4 py-3 text-left text-sm font-semibold text-gray-700 border-r">Semester</th>
                                        <th rowspan="2" class="px-4 py-3 text-left text-sm font-semibold text-gray-700 border-r">Materi/Tujuan Pembelajaran</th>
                                        <th colspan="6" class="px-4 py-3 text-center text-sm font-semibold text-gray-700 border-b">Alokasi Waktu (Bulan)</th>
                                        <th rowspan="2" class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Ket</th>
                                    </tr>
                                    <tr class="bg-gray-50">
                                        <th class="px-3 py-2 text-center text-xs font-medium text-gray-600">Jul</th>
                                        <th class="px-3 py-2 text-center text-xs font-medium text-gray-600">Ags</th>
                                        <th class="px-3 py-2 text-center text-xs font-medium text-gray-600">Sep</th>
                                        <th class="px-3 py-2 text-center text-xs font-medium text-gray-600">Okt</th>
                                        <th class="px-3 py-2 text-center text-xs font-medium text-gray-600">Nov</th>
                                        <th class="px-3 py-2 text-center text-xs font-medium text-gray-600">Des</th>
                                    </tr>
                                </thead>
                                <tbody id="protaTableBody">
                                    <tr>
                                        <td colspan="9" class="px-4 py-12 text-center text-gray-400">
                                            <i class="fas fa-calendar-check text-4xl mb-2"></i>
                                            <p>Klik Generate Prota untuk membuat Program Tahunan</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `,

            // Promes Page
            promes: () => `
                <div class="space-y-6">
                    <!-- Page Header -->
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">Program Semester (Promes)</h2>
                            <p class="text-gray-500">Detail perencanaan pembelajaran per semester</p>
                        </div>
                        <div class="flex gap-3">
                            <select id="promesSemester" onchange="loadPromesData()" class="px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary">
                                <option value="1">Semester 1 (Ganjil)</option>
                                <option value="2">Semester 2 (Genap)</option>
                            </select>
                            <button onclick="generatePromes()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all">
                                <i class="fas fa-magic mr-2"></i>Generate Promes
                            </button>
                            <button onclick="exportPromes('pdf')" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-all">
                                <i class="fas fa-file-pdf mr-2"></i>Export PDF
                            </button>
                        </div>
                    </div>

                    <!-- Promes Summary -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Ringkasan Semester</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="text-center p-4 bg-blue-50 rounded-xl">
                                <p class="text-3xl font-bold text-blue-600" id="promesMinggu">0</p>
                                <p class="text-sm text-gray-600">Minggu Efektif</p>
                            </div>
                            <div class="text-center p-4 bg-green-50 rounded-xl">
                                <p class="text-3xl font-bold text-green-600" id="promesJP">0</p>
                                <p class="text-sm text-gray-600">Jam Pelajaran</p>
                            </div>
                            <div class="text-center p-4 bg-purple-50 rounded-xl">
                                <p class="text-3xl font-bold text-purple-600" id="promesTP">0</p>
                                <p class="text-sm text-gray-600">Tujuan Pembelajaran</p>
                            </div>
                            <div class="text-center p-4 bg-orange-50 rounded-xl">
                                <p class="text-3xl font-bold text-orange-600" id="promesPertemuan">0</p>
                                <p class="text-sm text-gray-600">Pertemuan</p>
                            </div>
                        </div>
                    </div>

                    <!-- Promes Detail Table -->
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-3 text-left font-semibold text-gray-700">Minggu</th>
                                        <th class="px-3 py-3 text-left font-semibold text-gray-700">Tanggal</th>
                                        <th class="px-3 py-3 text-left font-semibold text-gray-700">Tujuan Pembelajaran</th>
                                        <th class="px-3 py-3 text-center font-semibold text-gray-700">JP</th>
                                        <th class="px-3 py-3 text-left font-semibold text-gray-700">Kegiatan</th>
                                        <th class="px-3 py-3 text-left font-semibold text-gray-700">Keterangan</th>
                                    </tr>
                                </thead>
                                <tbody id="promesTableBody">
                                    <tr>
                                        <td colspan="6" class="px-4 py-12 text-center text-gray-400">
                                            <i class="fas fa-calendar-week text-4xl mb-2"></i>
                                            <p>Klik Generate Promes untuk membuat Program Semester</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `,

            // Modul Ajar Page (Premium)
            modul: () => `
                <div class="space-y-6">
                    ${!checkPremiumAccess() ? `
                        <div class="bg-gradient-to-r from-yellow-400 to-orange-500 rounded-2xl p-8 text-center text-white">
                            <i class="fas fa-crown text-6xl mb-4"></i>
                            <h2 class="text-2xl font-bold mb-2">Fitur Premium</h2>
                            <p class="mb-4">Modul Ajar tersedia untuk pengguna Premium dan Paket Sekolah</p>
                            <button onclick="showUpgradeModal()" class="px-6 py-3 bg-white text-orange-500 font-semibold rounded-xl hover:bg-gray-100 transition-all">
                                <i class="fas fa-arrow-up mr-2"></i>Upgrade Sekarang
                            </button>
                        </div>
                    ` : `
                        <!-- Page Header -->
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800">Modul Ajar</h2>
                                <p class="text-gray-500">Buat modul ajar yang terintegrasi dengan Promes dan Jurnal</p>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="showCreateModulModal()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-all">
                                    <i class="fas fa-plus mr-2"></i>Buat Modul Ajar
                                </button>
                            </div>
                        </div>

                        <!-- Modul List -->
                        <div id="modulList" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div class="bg-white rounded-xl shadow-sm p-6 border-2 border-dashed border-gray-200 flex flex-col items-center justify-center min-h-[200px] cursor-pointer hover:border-primary transition-all" onclick="showCreateModulModal()">
                                <i class="fas fa-plus text-4xl text-gray-300 mb-3"></i>
                                <p class="text-gray-500">Buat Modul Ajar Baru</p>
                            </div>
                        </div>
                    `}
                </div>
            `,

            // Journal Page
            journal: () => `
                <div class="space-y-6">
                    <!-- Page Header -->
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">Jurnal Mengajar</h2>
                            <p class="text-gray-500">Catat kegiatan pembelajaran harian (auto-sync dengan Jadwal & Promes)</p>
                        </div>
                        <div class="flex gap-3">
                            <input type="date" id="journalDate" value="${new Date().toISOString().split('T')[0]}" 
                                onchange="loadJournalByDate()" class="px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary">
                            <button onclick="showAddJournalModal()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-all">
                                <i class="fas fa-plus mr-2"></i>Tambah Jurnal
                            </button>
                        </div>
                    </div>

                    <!-- Today's Journals -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">
                            <i class="fas fa-book-open text-primary mr-2"></i>Jurnal Tanggal: <span id="journalDateDisplay">${formatDate(new Date())}</span>
                        </h3>
                        <div id="journalList" class="space-y-4">
                            <div class="text-center py-8 text-gray-400">
                                <i class="fas fa-journal-whills text-4xl mb-2"></i>
                                <p>Belum ada jurnal untuk tanggal ini</p>
                            </div>
                        </div>
                    </div>
                </div>
            `,

            // Grades Page
            grades: () => `
                <div class="space-y-6">
                    <!-- Page Header -->
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">Daftar Nilai</h2>
                            <p class="text-gray-500">Kelola nilai PH, PTS, PAS, dan Nilai Raport</p>
                        </div>
                        <div class="flex gap-3">
                            <select id="gradesClass" onchange="loadGrades()" class="px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary">
                                <option value="">Pilih Kelas</option>
                            </select>
                            <button onclick="showGradeSettingsModal()" class="px-4 py-2 border border-gray-200 rounded-lg hover:bg-gray-50 transition-all">
                                <i class="fas fa-cog mr-2"></i>Pengaturan Nilai
                            </button>
                            <button onclick="exportGrades()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-all">
                                <i class="fas fa-file-excel mr-2"></i>Export Excel
                            </button>
                        </div>
                    </div>

                    <!-- Grade Components -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Komponen Penilaian</h3>
                        <div id="gradeComponents" class="flex flex-wrap gap-2">
                            <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm">PH 1</span>
                            <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm">PH 2</span>
                            <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm">PTS</span>
                            <span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm">PAS</span>
                            <span class="px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-sm">NR</span>
                            <button onclick="addGradeComponent()" class="px-3 py-1 border border-dashed border-gray-300 text-gray-500 rounded-full text-sm hover:border-primary hover:text-primary">
                                <i class="fas fa-plus mr-1"></i>Tambah
                            </button>
                        </div>
                    </div>

                    <!-- Grades Table -->
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-3 text-left font-semibold text-gray-700">No</th>
                                        <th class="px-3 py-3 text-left font-semibold text-gray-700">Nama Siswa</th>
                                        <th class="px-3 py-3 text-center font-semibold text-gray-700">PH 1</th>
                                        <th class="px-3 py-3 text-center font-semibold text-gray-700">PH 2</th>
                                        <th class="px-3 py-3 text-center font-semibold text-gray-700">PTS</th>
                                        <th class="px-3 py-3 text-center font-semibold text-gray-700">PAS</th>
                                        <th class="px-3 py-3 text-center font-semibold text-gray-700 bg-orange-50">NR</th>
                                        <th class="px-3 py-3 text-center font-semibold text-gray-700">Ket</th>
                                    </tr>
                                </thead>
                                <tbody id="gradesTableBody">
                                    <tr>
                                        <td colspan="8" class="px-4 py-12 text-center text-gray-400">
                                            <i class="fas fa-star text-4xl mb-2"></i>
                                            <p>Pilih kelas untuk melihat daftar nilai</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `,

            // AI Assistant Page
            'ai-assistant': () => `
                <div class="max-w-4xl mx-auto space-y-6">
                    <!-- Page Header -->
                    <div class="text-center">
                        <div class="w-20 h-20 bg-gradient-to-br from-primary to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-robot text-white text-3xl"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800">AI Assistant</h2>
                        <p class="text-gray-500">Bantuan membuat file CSV dan dokumen pembelajaran</p>
                    </div>

                    <!-- Prompt Templates -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">
                            <i class="fas fa-lightbulb text-warning mr-2"></i>Template Prompt AI
                        </h3>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div class="border border-gray-200 rounded-xl p-4 hover:border-primary transition-all cursor-pointer" onclick="usePromptTemplate('csv-students')">
                                <h4 class="font-semibold text-gray-800 mb-2">
                                    <i class="fas fa-file-csv text-green-500 mr-2"></i>CSV Data Siswa
                                </h4>
                                <p class="text-sm text-gray-600">Generate file CSV format data siswa untuk import massal</p>
                            </div>
                            <div class="border border-gray-200 rounded-xl p-4 hover:border-primary transition-all cursor-pointer" onclick="usePromptTemplate('modul-ajar')">
                                <h4 class="font-semibold text-gray-800 mb-2">
                                    <i class="fas fa-file-alt text-blue-500 mr-2"></i>Modul Ajar
                                </h4>
                                <p class="text-sm text-gray-600">Buat konten modul ajar berdasarkan TP dan materi</p>
                            </div>
                            <div class="border border-gray-200 rounded-xl p-4 hover:border-primary transition-all cursor-pointer" onclick="usePromptTemplate('soal')">
                                <h4 class="font-semibold text-gray-800 mb-2">
                                    <i class="fas fa-question-circle text-purple-500 mr-2"></i>Bank Soal
                                </h4>
                                <p class="text-sm text-gray-600">Generate soal-soal untuk evaluasi pembelajaran</p>
                            </div>
                                                        <div class="border border-gray-200 rounded-xl p-4 hover:border-primary transition-all cursor-pointer" onclick="usePromptTemplate('lkpd')">
                                <h4 class="font-semibold text-gray-800 mb-2">
                                    <i class="fas fa-tasks text-orange-500 mr-2"></i>LKPD
                                </h4>
                                <p class="text-sm text-gray-600">Buat Lembar Kerja Peserta Didik</p>
                            </div>
                        </div>
                    </div>

                    <!-- Prompt Output -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">
                            <i class="fas fa-code text-primary mr-2"></i>Prompt yang Dihasilkan
                        </h3>
                        <div id="promptOutput" class="bg-gray-50 rounded-xl p-4 min-h-[200px] font-mono text-sm text-gray-700 whitespace-pre-wrap">
                            Pilih template di atas untuk melihat prompt yang dapat digunakan dengan AI (ChatGPT, Claude, dll).
                        </div>
                        <div class="flex gap-3 mt-4">
                            <button onclick="copyPrompt()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-all">
                                <i class="fas fa-copy mr-2"></i>Salin Prompt
                            </button>
                            <button onclick="clearPrompt()" class="px-4 py-2 border border-gray-200 rounded-lg hover:bg-gray-50 transition-all">
                                <i class="fas fa-eraser mr-2"></i>Bersihkan
                            </button>
                        </div>
                    </div>

                    <!-- CSV Format Guide -->
                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-6">
                        <h3 class="text-lg font-bold text-blue-800 mb-4">
                            <i class="fas fa-info-circle mr-2"></i>Format CSV yang Didukung
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <h4 class="font-semibold text-blue-700">Data Siswa:</h4>
                                <code class="block bg-white p-3 rounded-lg mt-2 text-sm overflow-x-auto">
                                    nisn,nama_siswa,jenis_kelamin,kelas,rombel
                                </code>
                                <p class="text-sm text-blue-600 mt-1">Contoh: 0012345678,Ahmad Fauzi,L,7,A</p>
                            </div>
                            <div>
                                <h4 class="font-semibold text-blue-700">URL Google Spreadsheet:</h4>
                                <p class="text-sm text-blue-600">Publish spreadsheet Anda sebagai CSV dan gunakan URL publikasi.</p>
                            </div>
                        </div>
                    </div>
                </div>
            `,

            // Guide Page
            guide: () => `
                <div class="max-w-4xl mx-auto space-y-6">
                    <!-- Page Header -->
                    <div class="text-center mb-8">
                        <h2 class="text-3xl font-bold text-gray-800 mb-2">Panduan Penggunaan</h2>
                        <p class="text-gray-500">Pelajari cara menggunakan Admin Guru Super App dengan mudah</p>
                    </div>

                    <!-- Quick Start -->
                    <div class="bg-gradient-to-r from-primary to-purple-600 rounded-2xl p-6 text-white">
                        <h3 class="text-xl font-bold mb-4">
                            <i class="fas fa-rocket mr-2"></i>Quick Start Guide
                        </h3>
                        <div class="grid md:grid-cols-4 gap-4">
                            <div class="text-center">
                                <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-2">
                                    <span class="text-xl font-bold">1</span>
                                </div>
                                <p class="text-sm">Lengkapi Profil</p>
                            </div>
                            <div class="text-center">
                                <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-2">
                                    <span class="text-xl font-bold">2</span>
                                </div>
                                <p class="text-sm">Atur Kalender</p>
                            </div>
                            <div class="text-center">
                                <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-2">
                                    <span class="text-xl font-bold">3</span>
                                </div>
                                <p class="text-sm">Input Jadwal</p>
                            </div>
                            <div class="text-center">
                                <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-2">
                                    <span class="text-xl font-bold">4</span>
                                </div>
                                <p class="text-sm">Generate Dokumen</p>
                            </div>
                        </div>
                    </div>

                    <!-- Guide Sections -->
                    <div class="space-y-4">
                        <!-- Section 1 -->
                        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                            <button onclick="toggleGuideSection(1)" class="w-full px-6 py-4 flex items-center justify-between hover:bg-gray-50 transition-all">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-calendar-alt text-blue-600"></i>
                                    </div>
                                    <span class="font-semibold text-gray-800">Mengatur Kalender Pendidikan</span>
                                </div>
                                <i class="fas fa-chevron-down text-gray-400 guide-chevron-1 transition-transform"></i>
                            </button>
                            <div id="guideContent1" class="hidden px-6 pb-6">
                                <div class="pl-13 space-y-3 text-gray-600">
                                    <p><strong>Langkah 1:</strong> Buka menu "Kalender Pendidikan" di sidebar.</p>
                                    <p><strong>Langkah 2:</strong> Pilih tahun pelajaran yang akan diatur.</p>
                                    <p><strong>Langkah 3:</strong> Klik "Tambah Kegiatan" untuk menambahkan:</p>
                                    <ul class="list-disc list-inside ml-4 space-y-1">
                                        <li>Hari libur nasional dan keagamaan</li>
                                        <li>Pekan ulangan (PTS/PAS)</li>
                                        <li>Kegiatan sekolah (MPLS, classmeeting, dll)</li>
                                    </ul>
                                    <p><strong>Langkah 4:</strong> Sistem akan otomatis menghitung hari efektif.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Section 2 -->
                        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                            <button onclick="toggleGuideSection(2)" class="w-full px-6 py-4 flex items-center justify-between hover:bg-gray-50 transition-all">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-clock text-green-600"></i>
                                    </div>
                                    <span class="font-semibold text-gray-800">Mengatur Jadwal Pelajaran</span>
                                </div>
                                <i class="fas fa-chevron-down text-gray-400 guide-chevron-2 transition-transform"></i>
                            </button>
                            <div id="guideContent2" class="hidden px-6 pb-6">
                                <div class="pl-13 space-y-3 text-gray-600">
                                    <p><strong>Langkah 1:</strong> Tambahkan kelas/rombel yang Anda ampu.</p>
                                    <p><strong>Langkah 2:</strong> Atur jam pelajaran sesuai jadwal sekolah.</p>
                                    <p><strong>Langkah 3:</strong> Tambahkan jadwal untuk setiap kelas.</p>
                                    <p><strong>Penting:</strong> Sistem akan memvalidasi agar tidak terjadi bentrok:</p>
                                    <ul class="list-disc list-inside ml-4 space-y-1">
                                        <li>Guru tidak bisa di 2 kelas berbeda di jam yang sama</li>
                                        <li>Satu rombel tidak bisa diisi >1 guru PAI di jam yang sama</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Section 3 -->
                        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                            <button onclick="toggleGuideSection(3)" class="w-full px-6 py-4 flex items-center justify-between hover:bg-gray-50 transition-all">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-file-csv text-purple-600"></i>
                                    </div>
                                    <span class="font-semibold text-gray-800">Import Data Siswa via CSV</span>
                                </div>
                                <i class="fas fa-chevron-down text-gray-400 guide-chevron-3 transition-transform"></i>
                            </button>
                            <div id="guideContent3" class="hidden px-6 pb-6">
                                <div class="pl-13 space-y-3 text-gray-600">
                                    <p><strong>Format CSV:</strong></p>
                                    <code class="block bg-gray-100 p-3 rounded-lg">nisn,nama_siswa,jenis_kelamin,kelas,rombel</code>
                                    <p><strong>Cara Import:</strong></p>
                                    <ol class="list-decimal list-inside ml-4 space-y-1">
                                        <li>Siapkan file CSV dengan format di atas</li>
                                        <li>Atau gunakan Google Spreadsheet dan publish sebagai CSV</li>
                                        <li>Buka menu "Data Siswa" â†’ "Import CSV"</li>
                                        <li>Upload file atau paste URL Google Spreadsheet</li>
                                        <li>Preview dan konfirmasi data</li>
                                    </ol>
                                </div>
                            </div>
                        </div>

                        <!-- Section 4 -->
                        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                            <button onclick="toggleGuideSection(4)" class="w-full px-6 py-4 flex items-center justify-between hover:bg-gray-50 transition-all">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-magic text-orange-600"></i>
                                    </div>
                                    <span class="font-semibold text-gray-800">Generate Dokumen Otomatis</span>
                                </div>
                                <i class="fas fa-chevron-down text-gray-400 guide-chevron-4 transition-transform"></i>
                            </button>
                            <div id="guideContent4" class="hidden px-6 pb-6">
                                <div class="pl-13 space-y-3 text-gray-600">
                                    <p>Setelah Kalender, Jadwal, dan CP/TP diatur, sistem dapat menghasilkan:</p>
                                    <ul class="list-disc list-inside ml-4 space-y-1">
                                        <li><strong>ATP:</strong> Alur Tujuan Pembelajaran</li>
                                        <li><strong>Prota:</strong> Program Tahunan (sinkron dengan kalender)</li>
                                        <li><strong>Promes:</strong> Program Semester (detail per minggu)</li>
                                        <li><strong>Modul Ajar:</strong> Terintegrasi dengan Jurnal dan LKPD (Premium)</li>
                                    </ul>
                                    <p class="mt-3">Semua dokumen saling tersinkronisasi secara otomatis!</p>
                                </div>
                            </div>
                        </div>

                        <!-- Section 5 - Arabic Text -->
                        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                            <button onclick="toggleGuideSection(5)" class="w-full px-6 py-4 flex items-center justify-between hover:bg-gray-50 transition-all">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-teal-100 rounded-lg flex items-center justify-center">
                                        <span class="font-arabic text-teal-600 text-lg">Ø¹</span>
                                    </div>
                                    <span class="font-semibold text-gray-800">Dukungan Teks Arab (RTL)</span>
                                </div>
                                <i class="fas fa-chevron-down text-gray-400 guide-chevron-5 transition-transform"></i>
                            </button>
                            <div id="guideContent5" class="hidden px-6 pb-6">
                                <div class="pl-13 space-y-3 text-gray-600">
                                    <p>Aplikasi mendukung penulisan teks Arab dengan fitur:</p>
                                    <ul class="list-disc list-inside ml-4 space-y-1">
                                        <li>Right-to-Left (RTL) text direction</li>
                                        <li>Font Arabic (Amiri) untuk tampilan yang baik</li>
                                        <li>Support di Modul Ajar, LKPD, dan Bank Soal</li>
                                    </ul>
                                    <p class="mt-3"><strong>Contoh:</strong></p>
                                    <p class="arabic-text text-2xl bg-gray-100 p-4 rounded-lg text-center">Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„ÙŽÙ‘Ù‡Ù Ø§Ù„Ø±ÙŽÙ‘Ø­Ù’Ù…ÙŽÙ°Ù†Ù Ø§Ù„Ø±ÙŽÙ‘Ø­ÙÙŠÙ…Ù</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Contact Support -->
                    <div class="bg-gray-100 rounded-xl p-6 text-center">
                        <h3 class="text-lg font-bold text-gray-800 mb-2">Butuh Bantuan?</h3>
                        <p class="text-gray-600 mb-4">Hubungi tim support kami jika mengalami kendala</p>
                        <a href="mailto:support@adminguru.app" class="inline-flex items-center gap-2 px-6 py-3 bg-primary text-white rounded-lg hover:bg-secondary transition-all">
                            <i class="fas fa-envelope"></i>
                            <span>support@adminguru.app</span>
                        </a>
                    </div>
                </div>
            `,

            // Admin Users Page (Super Admin Only)
            'admin-users': () => `
                <div class="space-y-6">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">Kelola User</h2>
                            <p class="text-gray-500">Manajemen pengguna aplikasi (Super Admin)</p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="exportUsers()" class="px-4 py-2 border border-gray-200 rounded-lg hover:bg-gray-50">
                                <i class="fas fa-download mr-2"></i>Export
                            </button>
                        </div>
                    </div>

                    <!-- Stats -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-white rounded-xl p-4 shadow-sm">
                            <p class="text-2xl font-bold text-gray-800" id="adminTotalUsers">0</p>
                            <p class="text-sm text-gray-500">Total User</p>
                        </div>
                        <div class="bg-white rounded-xl p-4 shadow-sm">
                            <p class="text-2xl font-bold text-green-600" id="adminPremiumUsers">0</p>
                            <p class="text-sm text-gray-500">Premium</p>
                        </div>
                        <div class="bg-white rounded-xl p-4 shadow-sm">
                            <p class="text-2xl font-bold text-blue-600" id="adminSchoolUsers">0</p>
                            <p class="text-sm text-gray-500">Paket Sekolah</p>
                        </div>
                        <div class="bg-white rounded-xl p-4 shadow-sm">
                            <p class="text-2xl font-bold text-gray-600" id="adminFreeUsers">0</p>
                            <p class="text-sm text-gray-500">Free</p>
                        </div>
                    </div>

                    <!-- Users Table -->
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                        <div class="p-4 border-b border-gray-200">
                            <input type="text" id="searchUsers" onkeyup="filterUsers()" placeholder="Cari user..."
                                class="w-full md:w-80 px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary">
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">User</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Email</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Role</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Langganan</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Bergabung</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="adminUsersTableBody">
                                    <!-- Users will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `,

            // Admin Subscriptions Page
            'admin-subscriptions': () => `
                <div class="space-y-6">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">Kelola Langganan</h2>
                            <p class="text-gray-500">Atur paket langganan pengguna</p>
                        </div>
                        <button onclick="showAddSubscriptionModal()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-all">
                            <i class="fas fa-plus mr-2"></i>Tambah Langganan
                        </button>
                    </div>

                    <!-- Subscription Plans -->
                    <div class="grid md:grid-cols-3 gap-6">
                        <div class="bg-white rounded-xl shadow-sm p-6 border-2 border-gray-200">
                            <div class="text-center mb-4">
                                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-user text-gray-400 text-2xl"></i>
                                </div>
                                <h3 class="text-xl font-bold text-gray-800">Free</h3>
                                <p class="text-3xl font-bold text-gray-800 mt-2">Rp 0</p>
                            </div>
                            <ul class="space-y-2 text-sm text-gray-600">
                                <li class="flex items-center gap-2"><i class="fas fa-check text-green-500"></i>Kalender Pendidikan</li>
                                <li class="flex items-center gap-2"><i class="fas fa-check text-green-500"></i>Jadwal Pelajaran</li>
                                <li class="flex items-center gap-2"><i class="fas fa-check text-green-500"></i>ATP & Prota</li>
                                <li class="flex items-center gap-2 text-gray-400"><i class="fas fa-times"></i>Modul Ajar</li>
                                <li class="flex items-center gap-2 text-gray-400"><i class="fas fa-times"></i>Bank Soal</li>
                            </ul>
                        </div>

                        <div class="bg-white rounded-xl shadow-sm p-6 border-2 border-primary relative">
                            <div class="absolute -top-3 left-1/2 -translate-x-1/2 px-4 py-1 bg-primary text-white text-sm font-semibold rounded-full">
                                Populer
                            </div>
                            <div class="text-center mb-4">
                                <div class="w-16 h-16 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-crown text-white text-2xl"></i>
                                </div>
                                <h3 class="text-xl font-bold text-gray-800">Premium</h3>
                                <p class="text-3xl font-bold text-primary mt-2">Rp 99.000<span class="text-sm text-gray-500">/tahun</span></p>
                            </div>
                            <ul class="space-y-2 text-sm text-gray-600">
                                <li class="flex items-center gap-2"><i class="fas fa-check text-green-500"></i>Semua fitur Free</li>
                                <li class="flex items-center gap-2"><i class="fas fa-check text-green-500"></i>Promes lengkap</li>
                                <li class="flex items-center gap-2"><i class="fas fa-check text-green-500"></i>Modul Ajar</li>
                                <li class="flex items-center gap-2"><i class="fas fa-check text-green-500"></i>LKPD</li>
                                <li class="flex items-center gap-2"><i class="fas fa-check text-green-500"></i>Bank Soal</li>
                            </ul>
                        </div>

                        <div class="bg-white rounded-xl shadow-sm p-6 border-2 border-purple-500">
                            <div class="text-center mb-4">
                                <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-school text-white text-2xl"></i>
                                </div>
                                <h3 class="text-xl font-bold text-gray-800">Paket Sekolah</h3>
                                <p class="text-3xl font-bold text-purple-600 mt-2">Rp 999.000<span class="text-sm text-gray-500">/tahun</span></p>
                            </div>
                            <ul class="space-y-2 text-sm text-gray-600">
                                <li class="flex items-center gap-2"><i class="fas fa-check text-green-500"></i>Semua fitur Premium</li>
                                <li class="flex items-center gap-2"><i class="fas fa-check text-green-500"></i>Hingga 50 guru</li>
                                <li class="flex items-center gap-2"><i class="fas fa-check text-green-500"></i>Dashboard sekolah</li>
                                <li class="flex items-center gap-2"><i class="fas fa-check text-green-500"></i>Export batch</li>
                                <li class="flex items-center gap-2"><i class="fas fa-check text-green-500"></i>Priority support</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Recent Subscriptions -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Langganan Terbaru</h3>
                        <div id="recentSubscriptions" class="space-y-3">
                            <!-- Subscriptions will be loaded here -->
                        </div>
                    </div>
                </div>
            `,

            // Attendance Page
            attendance: () => `
                <div class="space-y-6">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">Absensi Siswa</h2>
                            <p class="text-gray-500">Rekap kehadiran siswa per kelas</p>
                        </div>
                        <div class="flex gap-3">
                            <input type="date" id="attendanceDate" value="${new Date().toISOString().split('T')[0]}"
                                onchange="loadAttendance()" class="px-4 py-2 border border-gray-200 rounded-lg">
                            <select id="attendanceClass" onchange="loadAttendance()" class="px-4 py-2 border border-gray-200 rounded-lg">
                                <option value="">Pilih Kelas</option>
                            </select>
                        </div>
                    </div>

                    <!-- Attendance Summary -->
                    <div class="grid grid-cols-4 gap-4">
                        <div class="bg-green-50 rounded-xl p-4 text-center">
                            <p class="text-3xl font-bold text-green-600" id="attendHadir">0</p>
                            <p class="text-sm text-gray-600">Hadir</p>
                        </div>
                        <div class="bg-yellow-50 rounded-xl p-4 text-center">
                            <p class="text-3xl font-bold text-yellow-600" id="attendIzin">0</p>
                            <p class="text-sm text-gray-600">Izin</p>
                        </div>
                        <div class="bg-blue-50 rounded-xl p-4 text-center">
                            <p class="text-3xl font-bold text-blue-600" id="attendSakit">0</p>
                            <p class="text-sm text-gray-600">Sakit</p>
                        </div>
                        <div class="bg-red-50 rounded-xl p-4 text-center">
                            <p class="text-3xl font-bold text-red-600" id="attendAlpa">0</p>
                            <p class="text-sm text-gray-600">Alpa</p>
                        </div>
                    </div>

                    <!-- Attendance Table -->
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">No</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Nama Siswa</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">L/P</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Kehadiran</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Keterangan</th>
                                    </tr>
                                </thead>
                                <tbody id="attendanceTableBody">
                                    <tr>
                                        <td colspan="5" class="px-4 py-12 text-center text-gray-400">
                                            <i class="fas fa-clipboard-check text-4xl mb-2"></i>
                                            <p>Pilih tanggal dan kelas untuk input absensi</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="px-6 py-4 border-t border-gray-200">
                            <button onclick="saveAttendance()" class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-all">
                                <i class="fas fa-save mr-2"></i>Simpan Absensi
                            </button>
                        </div>
                    </div>
                </div>
            `,

            // Bank Soal Page (Premium)
            banksoal: () => `
                <div class="space-y-6">
                    ${!checkPremiumAccess() ? `
                        <div class="bg-gradient-to-r from-yellow-400 to-orange-500 rounded-2xl p-8 text-center text-white">
                            <i class="fas fa-crown text-6xl mb-4"></i>
                            <h2 class="text-2xl font-bold mb-2">Fitur Premium</h2>
                            <p class="mb-4">Bank Soal tersedia untuk pengguna Premium dan Paket Sekolah</p>
                            <button onclick="showUpgradeModal()" class="px-6 py-3 bg-white text-orange-500 font-semibold rounded-xl hover:bg-gray-100 transition-all">
                                <i class="fas fa-arrow-up mr-2"></i>Upgrade Sekarang
                            </button>
                        </div>
                    ` : `
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800">Bank Soal</h2>
                                <p class="text-gray-500">Kelola soal-soal pembelajaran dengan dukungan teks Arab</p>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="showImportSoalModal()" class="px-4 py-2 border border-gray-200 rounded-lg hover:bg-gray-50">
                                    <i class="fas fa-file-import mr-2"></i>Import
                                </button>
                                <button onclick="showAddSoalModal()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-all">
                                    <i class="fas fa-plus mr-2"></i>Tambah Soal
                                </button>
                            </div>
                        </div>

                        <!-- Filter -->
                        <div class="bg-white rounded-xl shadow-sm p-4">
                            <div class="flex flex-wrap gap-4">
                                <select id="filterElemen" class="px-4 py-2 border border-gray-200 rounded-lg">
                                    <option value="">Semua Elemen</option>
                                    <option value="alquran">Al-Quran Hadis</option>
                                    <option value="akidah">Akidah</option>
                                    <option value="akhlak">Akhlak</option>
                                    <option value="fikih">Fikih</option>
                                    <option value="sejarah">Sejarah Islam</option>
                                </select>
                                <select id="filterTipe" class="px-4 py-2 border border-gray-200 rounded-lg">
                                    <option value="">Semua Tipe</option>
                                    <option value="pg">Pilihan Ganda</option>
                                    <option value="essay">Essay</option>
                                    <option value="isian">Isian Singkat</option>
                                </select>
                                <select id="filterKesulitan" class="px-4 py-2 border border-gray-200 rounded-lg">
                                    <option value="">Semua Tingkat</option>
                                    <option value="mudah">Mudah</option>
                                    <option value="sedang">Sedang</option>
                                    <option value="sulit">Sulit</option>
                                </select>
                            </div>
                        </div>

                        <!-- Soal List -->
                        <div id="bankSoalList" class="space-y-4">
                            <div class="bg-white rounded-xl shadow-sm p-6">
                                <div class="flex items-start gap-4">
                                    <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                        <span class="font-bold text-blue-600">1</span>
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs">Pilihan Ganda</span>
                                            <span class="px-2 py-0.5 bg-green-100 text-green-700 rounded text-xs">Mudah</span>
                                            <span class="px-2 py-0.5 bg-purple-100 text-purple-700 rounded text-xs">Al-Quran</span>
                                        </div>
                                        <p class="text-gray-800 mb-3">Bacalah ayat berikut:</p>
                                        <p class="arabic-text text-2xl mb-3 text-right">Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„ÙŽÙ‘Ù‡Ù Ø§Ù„Ø±ÙŽÙ‘Ø­Ù’Ù…ÙŽÙ°Ù†Ù Ø§Ù„Ø±ÙŽÙ‘Ø­ÙÙŠÙ…Ù</p>
                                        <p class="text-gray-800">Ayat di atas merupakan ayat pertama dari surah...</p>
                                        <div class="mt-3 space-y-2">
                                            <div class="flex items-center gap-2">
                                                <span class="w-6 h-6 bg-gray-200 rounded-full flex items-center justify-center text-xs">A</span>
                                                <span>Al-Fatihah</span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <span class="w-6 h-6 bg-green-500 text-white rounded-full flex items-center justify-center text-xs">B</span>
                                                <span>Al-Fatihah (Jawaban Benar)</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="p-2 text-red-600 hover:bg-red-50 rounded-lg">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `}
                </div>
            `,

            // LKPD Page (Premium)
            lkpd: () => `
                <div class="space-y-6">
                    ${!checkPremiumAccess() ? `
                        <div class="bg-gradient-to-r from-yellow-400 to-orange-500 rounded-2xl p-8 text-center text-white">
                            <i class="fas fa-crown text-6xl mb-4"></i>
                            <h2 class="text-2xl font-bold mb-2">Fitur Premium</h2>
                            <p class="mb-4">LKPD tersedia untuk pengguna Premium dan Paket Sekolah</p>
                            <button onclick="showUpgradeModal()" class="px-6 py-3 bg-white text-orange-500 font-semibold rounded-xl hover:bg-gray-100 transition-all">
                                <i class="fas fa-arrow-up mr-2"></i>Upgrade Sekarang
                            </button>
                        </div>
                    ` : `
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800">Lembar Kerja Peserta Didik (LKPD)</h2>
                                <p class="text-gray-500">Buat LKPD yang terintegrasi dengan Modul Ajar</p>
                            </div>
                            <button onclick="showCreateLKPDModal()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-all">
                                <i class="fas fa-plus mr-2"></i>Buat LKPD
                            </button>
                        </div>

                        <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                            <div class="flex items-start gap-3">
                                <i class="fas fa-info-circle text-blue-500 mt-1"></i>
                                <div>
                                    <h4 class="font-semibold text-blue-800">Tips LKPD</h4>
                                    <p class="text-sm text-blue-700">LKPD menggunakan bahasa yang mudah dipahami siswa, berbeda dengan Modul Ajar yang menggunakan bahasa guru.</p>
                                </div>
                            </div>
                        </div>

                        <!-- LKPD List -->
                        <div id="lkpdList" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div class="bg-white rounded-xl shadow-sm p-6 border-2 border-dashed border-gray-200 flex flex-col items-center justify-center min-h-[200px] cursor-pointer hover:border-primary transition-all" onclick="showCreateLKPDModal()">
                                <i class="fas fa-plus text-4xl text-gray-300 mb-3"></i>
                                <p class="text-gray-500">Buat LKPD Baru</p>
                            </div>
                        </div>
                    `}
                </div>
            `
        };

        // ==========================================
        // PAGE LOADING & NAVIGATION
        // ==========================================
        
        function loadPage(pageName) {
            currentPage = pageName;
            
            // Update active menu
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.page === pageName) {
                    item.classList.add('active');
                }
            });

            // Update page title
            const titles = {
                'dashboard': { title: 'Dashboard', subtitle: 'Selamat datang di Admin Guru Super App' },
                'profile': { title: 'Profil', subtitle: 'Kelola informasi profil Anda' },
                'calendar': { title: 'Kalender Pendidikan', subtitle: 'Atur hari efektif dan kegiatan akademik' },
                'schedule': { title: 'Jadwal Pelajaran', subtitle: 'Atur jadwal mengajar' },
                'students': { title: 'Data Siswa', subtitle: 'Kelola data siswa' },
                'cp': { title: 'Capaian Pembelajaran', subtitle: 'Kelola CP dan Tujuan Pembelajaran' },
                'atp': { title: 'ATP', subtitle: 'Alur Tujuan Pembelajaran' },
                'prota': { title: 'Prota', subtitle: 'Program Tahunan' },
                'promes': { title: 'Promes', subtitle: 'Program Semester' },
                'modul': { title: 'Modul Ajar', subtitle: 'Buat dan kelola modul ajar' },
                'journal': { title: 'Jurnal Mengajar', subtitle: 'Catat kegiatan pembelajaran' },
                'attendance': { title: 'Absensi', subtitle: 'Rekap kehadiran siswa' },
                'grades': { title: 'Daftar Nilai', subtitle: 'Kelola nilai siswa' },
                'lkpd': { title: 'LKPD', subtitle: 'Lembar Kerja Peserta Didik' },
                'banksoal': { title: 'Bank Soal', subtitle: 'Kelola soal pembelajaran' },
                'ai-assistant': { title: 'AI Assistant', subtitle: 'Bantuan pembuatan dokumen' },
                'guide': { title: 'Panduan', subtitle: 'Cara menggunakan aplikasi' },
                'admin-users': { title: 'Kelola User', subtitle: 'Manajemen pengguna (Admin)' },
                'admin-subscriptions': { title: 'Kelola Langganan', subtitle: 'Manajemen paket langganan' }
            };

            const pageInfo = titles[pageName] || { title: pageName, subtitle: '' };
            document.getElementById('pageTitle').textContent = pageInfo.title;
            document.getElementById('pageSubtitle').textContent = pageInfo.subtitle;

            // Load page template
            const mainContent = document.getElementById('mainContent');
            if (pageTemplates[pageName]) {
                mainContent.innerHTML = pageTemplates[pageName]();
                initializePage(pageName);
            } else {
                mainContent.innerHTML = `
                    <div class="text-center py-20">
                        <i class="fas fa-hard-hat text-6xl text-gray-300 mb-4"></i>
                        <h3 class="text-xl font-bold text-gray-800">Halaman dalam pengembangan</h3>
                        <p class="text-gray-500">Fitur ini akan segera tersedia</p>
                    </div>
                `;
            }

            // Close sidebar on mobile
            if (window.innerWidth < 1024) {
                document.getElementById('sidebar').classList.add('sidebar-collapsed');
                document.getElementById('sidebarOverlay').classList.add('hidden');
            }
        }

        // Initialize page-specific functions
        function initializePage(pageName) {
            switch (pageName) {
                case 'dashboard':
                    loadDashboardStats();
                    loadTodaySchedule();
                    break;
                case 'profile':
                    initProfileForm();
                    break;
                case 'calendar':
                    initCalendar();
                    break;
                case 'schedule':
                    initSchedule();
                    break;
                case 'students':
                    loadStudents();
                    break;
                case 'cp':
                    initCP();
                    break;
                case 'grades':
                    initGrades();
                    break;
                case 'admin-users':
                    if (userData?.role === 'superadmin') loadAdminUsers();
                    break;
            }
        }

        // ==========================================
        // DASHBOARD FUNCTIONS
        // ==========================================
        
        async function loadDashboardStats() {
            if (!currentUser) return;
            
            try {
                // Load students count
                const studentsSnap = await db.collection('users').doc(currentUser.uid)
                    .collection('students').get();
                document.getElementById('statStudents').textContent = studentsSnap.size;

                // Load classes count
                const classesSnap = await db.collection('users').doc(currentUser.uid)
                    .collection('classes').get();
                document.getElementById('statClasses').textContent = classesSnap.size;

                // Load documents count
                let docsCount = 0;
                const collections = ['atp', 'prota', 'promes', 'modul'];
                for (const col of collections) {
                    const snap = await db.collection('users').doc(currentUser.uid)
                        .collection(col).get();
                    docsCount += snap.size;
                }
                document.getElementById('statDocs').textContent = docsCount;

                // Load effective days from calendar
                const calendarSnap = await db.collection('users').doc(currentUser.uid)
                    .collection('calendar').doc('settings').get();
                if (calendarSnap.exists) {
                    document.getElementById('statEffectiveDays').textContent = 
                        calendarSnap.data().effectiveDays || 0;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadTodaySchedule() {
            if (!currentUser) return;
            
            const today = new Date();
            const dayNames = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
            const todayName = dayNames[today.getDay()];

            try {
                const scheduleSnap = await db.collection('users').doc(currentUser.uid)
                    .collection('schedules')
                    .where('day', '==', todayName)
                    .orderBy('startTime')
                    .get();

                const container = document.getElementById('todaySchedule');
                
                if (scheduleSnap.empty) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-400">
                            <i class="fas fa-calendar-times text-4xl mb-2"></i>
                            <p>Tidak ada jadwal hari ini</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = scheduleSnap.docs.map(doc => {
                    const data = doc.data();
                    return `
                        <div class="flex items-center gap-4 p-3 bg-gray-50 rounded-xl">
                            <div class="w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center">
                                <i class="fas fa-clock text-primary"></i>
                            </div>
                            <div class="flex-1">
                                <p class="font-semibold text-gray-800">${data.className}</p>
                                <p class="text-sm text-gray-500">${data.startTime} - ${data.endTime}</p>
                            </div>
                            <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm">
                                ${data.room || 'Ruang -'}
                            </span>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading schedule:', error);
            }
        }

        // ==========================================
        // PROFILE FUNCTIONS
        // ==========================================
        
        function initProfileForm() {
            document.getElementById('profileForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await saveProfile();
            });
        }

        async function saveProfile() {
            if (!currentUser) return;

            const profileData = {
                name: document.getElementById('profileName').value,
                profile: {
                    nip: document.getElementById('profileNip').value,
                    nuptk: document.getElementById('profileNuptk').value,
                    mata_pelajaran: document.getElementById('profileMapel').value,
                    jenjang: document.getElementById('profileJenjang').value,
                    fase: document.getElementById('profileFase').value,
                    satuan_pendidikan: document.getElementById('profileSekolah').value,
                    nama_kepala_sekolah: document.getElementById('profileKepsek').value
                },
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection('users').doc(currentUser.uid).update(profileData);
                userData = { ...userData, ...profileData };
                
                // Update display
                document.getElementById('userName').textContent = profileData.name;
                document.getElementById('userInitial').textContent = profileData.name.charAt(0);
                document.getElementById('headerUserInitial').textContent = profileData.name.charAt(0);
                
                showToast('success', 'Berhasil', 'Profil berhasil disimpan');
            } catch (error) {
                showToast('error', 'Gagal', 'Tidak dapat menyimpan profil');
                console.error(error);
            }
        }

        function updateFaseOptions() {
            const jenjang = document.getElementById('profileJenjang').value;
            const faseSelect = document.getElementById('profileFase');
            
            const faseOptions = {
                'SD/MI': ['A', 'B', 'C'],
                'SMP/MTs': ['D'],
                'SMA/MA': ['E', 'F'],
                'SMK': ['E', 'F']
            };

            const options = faseOptions[jenjang] || [];
            faseSelect.innerHTML = '<option value="">Pilih Fase</option>';
            options.forEach(fase => {
                const label = {
                    'A': 'Fase A (Kelas 1-2)',
                    'B': 'Fase B (Kelas 3-4)',
                    'C': 'Fase C (Kelas 5-6)',
                    'D': 'Fase D (Kelas 7-9)',
                    'E': 'Fase E (Kelas 10)',
                    'F': 'Fase F (Kelas 11-12)'
                }[fase];
                faseSelect.innerHTML += `<option value="${fase}">${label}</option>`;
            });
        }

        // ==========================================
        // CALENDAR FUNCTIONS
        // ==========================================
        
        let currentSemester = 1;
        let calendarEvents = [];

        function initCalendar() {
            loadCalendarData();
        }

        async function loadCalendarData() {
            if (!currentUser) return;
            
            const year = document.getElementById('calendarYear').value;
            
            try {
                const eventsSnap = await db.collection('users').doc(currentUser.uid)
                    .collection('calendar')
                    .where('year', '==', year)
                    .get();
                
                calendarEvents = eventsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCalendarGrid();
                renderEventsList();
                updateCalendarSummary();
            } catch (error) {
                console.error('Error loading calendar:', error);
            }
        }

        function switchSemester(sem) {
            currentSemester = sem;
            
            // Update tab styles
            document.getElementById('sem1Tab').classList.toggle('border-primary', sem === 1);
            document.getElementById('sem1Tab').classList.toggle('text-primary', sem === 1);
            document.getElementById('sem1Tab').classList.toggle('border-transparent', sem !== 1);
            document.getElementById('sem1Tab').classList.toggle('text-gray-500', sem !== 1);
            
            document.getElementById('sem2Tab').classList.toggle('border-primary', sem === 2);
            document.getElementById('sem2Tab').classList.toggle('text-primary', sem === 2);
            document.getElementById('sem2Tab').classList.toggle('border-transparent', sem !== 2);
            document.getElementById('sem2Tab').classList.toggle('text-gray-500', sem !== 2);
            
            renderCalendarGrid();
        }

        function renderCalendarGrid() {
            const year = parseInt(document.getElementById('calendarYear').value);
            const months = currentSemester === 1 
                ? [{ m: 6, y: year }, { m: 7, y: year }, { m: 8, y: year }, { m: 9, y: year }, { m: 10, y: year }, { m: 11, y: year }]
                : [{ m: 0, y: year + 1 }, { m: 1, y: year + 1 }, { m: 2, y: year + 1 }, { m: 3, y: year + 1 }, { m: 4, y: year + 1 }, { m: 5, y: year + 1 }];

            const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                               'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            const dayNames = ['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab'];

            const container = document.getElementById('calendarGrid');
            container.innerHTML = months.map(({ m, y }) => {
                const firstDay = new Date(y, m, 1).getDay();
                const daysInMonth = new Date(y, m + 1, 0).getDate();
                
                let daysHtml = '';
                // Empty cells for days before first day
                for (let i = 0; i < firstDay; i++) {
                    daysHtml += '<div class="h-8"></div>';
                }
                // Day cells
                for (let d = 1; d <= daysInMonth; d++) {
                    const dateStr = `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                    const event = calendarEvents.find(e => e.date === dateStr);
                    const isWeekend = new Date(y, m, d).getDay() === 0;
                    
                    let bgClass = 'bg-white hover:bg-gray-100';
                    let textClass = isWeekend ? 'text-red-500' : 'text-gray-700';
                    
                    if (event) {
                        switch (event.type) {
                            case 'holiday':
                                bgClass = 'bg-red-100';
                                textClass = 'text-red-700';
                                break;
                            case 'exam':
                                bgClass = 'bg-blue-100';
                                textClass = 'text-blue-700';
                                break;
                            case 'activity':
                                bgClass = 'bg-purple-100';
                                textClass = 'text-purple-700';
                                break;
                        }
                    }
                    
                    daysHtml += `
                        <div onclick="showDayDetail('${dateStr}')" 
                             class="h-8 flex items-center justify-center rounded cursor-pointer text-sm font-medium ${bgClass} ${textClass} transition-all"
                             title="${event ? event.name : ''}">
                            ${d}
                        </div>
                    `;
                }
                
                return `
                    <div class="bg-gray-50 rounded-xl p-4">
                        <h4 class="font-semibold text-gray-800 mb-3 text-center">${monthNames[m]} ${y}</h4>
                        <div class="grid grid-cols-7 gap-1 text-center text-xs text-gray-500 mb-2">
                            ${dayNames.map(d => `<div>${d}</div>`).join('')}
                        </div>
                        <div class="grid grid-cols-7 gap-1">
                            ${daysHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderEventsList() {
            const container = document.getElementById('eventsList');
            
            if (calendarEvents.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        <i class="fas fa-calendar-plus text-4xl mb-2"></i>
                        <p>Belum ada kegiatan</p>
                    </div>
                `;
                return;
            }

            const sortedEvents = [...calendarEvents].sort((a, b) => a.date.localeCompare(b.date));
            
            container.innerHTML = sortedEvents.map(event => {
                const typeColors = {
                    'holiday': 'bg-red-100 text-red-700',
                    'exam': 'bg-blue-100 text-blue-700',
                    'activity': 'bg-purple-100 text-purple-700'
                };
                const typeLabels = {
                    'holiday': 'Libur',
                    'exam': 'Ujian',
                    'activity': 'Kegiatan'
                };
                
                return `
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                        <div class="flex items-center gap-4">
                            <div class="text-center">
                                <p class="text-2xl font-bold text-gray-800">${new Date(event.date).getDate()}</p>
                                <p class="text-xs text-gray-500">${new Date(event.date).toLocaleDateString('id-ID', { month: 'short' })}</p>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-800">${event.name}</p>
                                <span class="inline-block px-2 py-0.5 text-xs rounded ${typeColors[event.type]}">${typeLabels[event.type]}</span>
                            </div>
                        </div>
                        <button onclick="deleteEvent('${event.id}')" class="text-red-500 hover:bg-red-50 p-2 rounded-lg">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }

        function updateCalendarSummary() {
            const year = document.getElementById('calendarYear').value;
            
            // Calculate effective days (rough estimate)
            let totalDays = 0;
            let holidays = calendarEvents.filter(e => e.type === 'holiday').length;
            let exams = calendarEvents.filter(e => e.type === 'exam').length;
            
            // Assume ~200 school days per year, minus weekends already excluded
            const effectiveDays = 200 - holidays;
            const effectiveWeeks = Math.floor(effectiveDays / 5);
            
            document.getElementById('totalEffective').textContent = effectiveDays;
            document.getElementById('totalHoliday').textContent = holidays;
            document.getElementById('totalExam').textContent = exams;
            document.getElementById('totalWeeks').textContent = effectiveWeeks;
        }

        function showAddEventModal() {
            const content = `
                <form id="addEventForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nama Kegiatan</label>
                        <input type="text" id="eventName" required
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary"
                            placeholder="Contoh: Libur Hari Raya">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                        <input type="date" id="eventDate" required
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Selesai (Opsional)</label>
                        <input type="date" id="eventEndDate"
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Jenis</label>
                        <select id="eventType" required
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary">
                            <option value="holiday">Libur</option>
                            <option value="exam">Ujian</option>
                            <option value="activity">Kegiatan</option>
                        </select>
                    </div>
                    <div class="flex gap-3 pt-4">
                        <button type="button" onclick="closeModal()" class="flex-1 py-3 border border-gray-200 rounded-xl font-medium hover:bg-gray-50">
                            Batal
                        </button>
                        <button type="submit" class="flex-1 py-3 bg-primary text-white rounded-xl font-medium hover:bg-secondary">
                            Simpan
                        </button>
                    </div>
                </form>
            `;
            
            showModal(content, { title: 'Tambah Kegiatan' });
            
            document.getElementById('addEventForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await saveEvent();
            });
        }

        async function saveEvent() {
            if (!currentUser) return;
            
            const name = document.getElementById('eventName').value;
            const startDate = document.getElementById('eventDate').value;
            const endDate = document.getElementById('eventEndDate').value;
            const type = document.getElementById('eventType').value;
            const year = document.getElementById('calendarYear').value;

            try {
                // If date range, create multiple events
                if (endDate && endDate > startDate) {
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    const batch = db.batch();
                    
                    for (let d = start; d <= end; d.setDate(d.getDate() + 1)) {
                        const dateStr = d.toISOString().split('T')[0];
                        const ref = db.collection('users').doc(currentUser.uid)
                            .collection('calendar').doc();
                        batch.set(ref, {
                            name,
                            date: dateStr,
                            type,
                            year,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                    await batch.commit();
                } else {
                    await db.collection('users').doc(currentUser.uid)
                        .collection('calendar').add({
                            name,
                            date: startDate,
                            type,
                            year,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                }
                
                closeModal();
                showToast('success', 'Berhasil', 'Kegiatan berhasil ditambahkan');
                loadCalendarData();
            } catch (error) {
                showToast('error', 'Gagal', 'Tidak dapat menyimpan kegiatan');
                console.error(error);
            }
        }

        async function deleteEvent(eventId) {
            if (!confirm('Hapus kegiatan ini?')) return;
            
            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('calendar').doc(eventId).delete();
                showToast('success', 'Berhasil', 'Kegiatan dihapus');
                loadCalendarData();
            } catch (error) {
                showToast('error', 'Gagal', 'Tidak dapat menghapus kegiatan');
            }
        }

        // ==========================================
        // SCHEDULE FUNCTIONS
        // ==========================================
        
        let timeSlots = [
            { id: 1, start: '07:00', end: '07:40' },
            { id: 2, start: '07:40', end: '08:20' },
            { id: 3, start: '08:20', end: '09:00' },
            { id: 4, start: '09:15', end: '09:55' },
            { id: 5, start: '09:55', end: '10:35' },
            { id: 6, start: '10:35', end: '11:15' },
            { id: 7, start: '11:15', end: '11:55' },
            { id: 8, start: '12:30', end: '13:10' }
        ];
        let classes = [];
        let schedules = [];

        async function initSchedule() {
            await loadClasses();
            await loadSchedules();
            renderClassesGrid();
            renderScheduleTable();
        }

        async function loadClasses() {
            if (!currentUser) return;
            
            try {
                const snap = await db.collection('users').doc(currentUser.uid)
                    .collection('classes').orderBy('name').get();
                classes = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error('Error loading classes:', error);
            }
        }

        async function loadSchedules() {
            if (!currentUser) return;
            
            try {
                const snap = await db.collection('users').doc(currentUser.uid)
                    .collection('schedules').get();
                schedules = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error('Error loading schedules:', error);
            }
        }

        function renderClassesGrid() {
            const container = document.getElementById('classesGrid');
            
            if (classes.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-4 text-gray-400">
                        <p>Belum ada kelas. Klik tombol di bawah untuk menambahkan.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = classes.map(cls => `
                <div class="relative group">
                    <div class="p-4 bg-primary/10 border-2 border-primary/20 rounded-xl text-center">
                        <p class="font-bold text-primary">${cls.name}</p>
                        <p class="text-xs text-gray-500">${cls.studentCount || 0} siswa</p>
                    </div>
                    <button onclick="deleteClass('${cls.id}')" 
                        class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full text-xs hidden group-hover:flex items-center justify-center">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        function renderScheduleTable() {
            const days = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
            const tbody = document.getElementById('scheduleTableBody');
            
            tbody.innerHTML = timeSlots.map(slot => {
                return `
                    <tr class="border-b border-gray-100">
                        <td class="px-4 py-3 text-sm font-medium text-gray-700">
                            ${slot.start}<br>
                            <span class="text-gray-400">${slot.end}</span>
                        </td>
                        ${days.map(day => {
                            const schedule = schedules.find(s => s.day === day && s.slotId === slot.id);
                            if (schedule) {
                                return `
                                    <td class="px-2 py-2 text-center">
                                        <div class="p-2 bg-primary/10 rounded-lg cursor-pointer hover:bg-primary/20" 
                                             onclick="editSchedule('${schedule.id}')">
                                            <p class="font-semibold text-primary text-sm">${schedule.className}</p>
                                            <p class="text-xs text-gray-500">${schedule.room || ''}</p>
                                        </div>
                                    </td>
                                `;
                            }
                            return `
                                <td class="px-2 py-2 text-center">
                                    <button onclick="quickAddSchedule('${day}', ${slot.id})" 
                                        class="w-full p-2 border border-dashed border-gray-200 rounded-lg text-gray-400 hover:border-primary hover:text-primary transition-all">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </td>
                            `;
                        }).join('')}
                    </tr>
                `;
            }).join('');
        }

        function showAddClassModal() {
            const content = `
                <form id="addClassForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nama Kelas/Rombel</label>
                        <input type="text" id="className" required
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary"
                            placeholder="Contoh: VII A, X IPA 1">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah Siswa (Opsional)</label>
                        <input type="number" id="classStudentCount" min="0"
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary"
                            placeholder="0">
                    </div>
                    <div class="flex gap-3 pt-4">
                        <button type="button" onclick="closeModal()" class="flex-1 py-3 border border-gray-200 rounded-xl font-medium hover:bg-gray-50">
                            Batal
                        </button>
                        <button type="submit" class="flex-1 py-3 bg-primary text-white rounded-xl font-medium hover:bg-secondary">
                            Simpan
                        </button>
                    </div>
                </form>
            `;
            
            showModal(content, { title: 'Tambah Kelas' });
            
            document.getElementById('addClassForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await addClass();
            });
        }

        async function addClass() {
            if (!currentUser) return;
            
            const name = document.getElementById('className').value.trim();
            const studentCount = parseInt(document.getElementById('classStudentCount').value) || 0;

            // Check for duplicate
            if (classes.find(c => c.name.toLowerCase() === name.toLowerCase())) {
                showToast('warning', 'Perhatian', 'Kelas dengan nama tersebut sudah ada');
                return;
            }

            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('classes').add({
                        name,
                        studentCount,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                
                closeModal();
                showToast('success', 'Berhasil', 'Kelas berhasil ditambahkan');
                await loadClasses();
                renderClassesGrid();
            } catch (error) {
                showToast('error', 'Gagal', 'Tidak dapat menyimpan kelas');
            }
        }

        function quickAddSchedule(day, slotId) {
            if (classes.length === 0) {
                showToast('warning', 'Perhatian', 'Tambahkan kelas terlebih dahulu');
                return;
            }

            const slot = timeSlots.find(s => s.id === slotId);
            const content = `
                <form id="quickScheduleForm" class="space-y-4">
                    <div class="bg-gray-50 p-4 rounded-xl">
                        <p class="font-semibold text-gray-800">${day}</p>
                        <p class="text-gray-500">${slot.start} - ${slot.end}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                        <select id="scheduleClass" required
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary">
                            <option value="">Pilih Kelas</option>
                            ${classes.map(c => `<option value="${c.name}">${c.name}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ruangan (Opsional)</label>
                        <input type="text" id="scheduleRoom"
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary"
                            placeholder="Contoh: Ruang 101">
                    </div>
                    <div class="flex gap-3 pt-4">
                        <button type="button" onclick="closeModal()" class="flex-1 py-3 border border-gray-200 rounded-xl font-medium hover:bg-gray-50">
                            Batal
                        </button>
                        <button type="submit" class="flex-1 py-3 bg-primary text-white rounded-xl font-medium hover:bg-secondary">
                            Simpan
                        </button>
                    </div>
                </form>
            `;
            
            showModal(content, { title: 'Tambah Jadwal' });
            
            document.getElementById('quickScheduleForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await saveSchedule(day, slotId);
            });
        }

        async function saveSchedule(day, slotId) {
            if (!currentUser) return;
            
            const className = document.getElementById('scheduleClass').value;
            const room = document.getElementById('scheduleRoom').value;
            const slot = timeSlots.find(s => s.id === slotId);

            // Validate no conflict
            const conflict = schedules.find(s => 
                s.day === day && s.slotId === slotId
            );
            
            if (conflict) {
                showToast('error', 'Konflik', 'Jam tersebut sudah terisi');
                return;
            }

            // Validate teacher not in two places
            const teacherConflict = schedules.find(s =>
                s.day === day && s.slotId === slotId && s.className !== className
            );

            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('schedules').add({
                        day,
                        slotId,
                        className,
                        room,
                        startTime: slot.start,
                        endTime: slot.end,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                
                closeModal();
                showToast('success', 'Berhasil', 'Jadwal berhasil ditambahkan');
                await loadSchedules();
                renderScheduleTable();
            } catch (error) {
                showToast('error', 'Gagal', 'Tidak dapat menyimpan jadwal');
            }
        }

        // ==========================================
        // STUDENTS FUNCTIONS
        // ==========================================
        
        let students = [];
        let currentStudentPage = 1;
        const studentsPerPage = 20;

        async function loadStudents() {
            if (!currentUser) return;
            
            try {
                const snap = await db.collection('users').doc(currentUser.uid)
                    .collection('students').orderBy('nama_siswa').get();
                students = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Populate filter dropdowns
                const uniqueClasses = [...new Set(students.map(s => s.kelas))].sort();
                const uniqueRombel = [...new Set(students.map(s => s.rombel))].sort();
                
                document.getElementById('filterClass').innerHTML = 
                    '<option value="">Semua Kelas</option>' +
                    uniqueClasses.map(c => `<option value="${c}">${c}</option>`).join('');
                
                document.getElementById('filterRombel').innerHTML = 
                    '<option value="">Semua Rombel</option>' +
                    uniqueRombel.map(r => `<option value="${r}">${r}</option>`).join('');
                
                renderStudentsTable();
            } catch (error) {
                console.error('Error loading students:', error);
            }
        }

        function filterStudents() {
            currentStudentPage = 1;
            renderStudentsTable();
        }

        function renderStudentsTable() {
            const search = document.getElementById('searchStudent').value.toLowerCase();
            const filterClass = document.getElementById('filterClass').value;
            const filterRombel = document.getElementById('filterRombel').value;
            
            let filtered = students.filter(s => {
                const matchSearch = s.nama_siswa.toLowerCase().includes(search) || 
                                   s.nisn.includes(search);
                const matchClass = !filterClass || s.kelas === filterClass;
                const matchRombel = !filterRombel || s.rombel === filterRombel;
                return matchSearch && matchClass && matchRombel;
            });

            const totalPages = Math.ceil(filtered.length / studentsPerPage);
            const start = (currentStudentPage - 1) * studentsPerPage;
            const paginated = filtered.slice(start, start + studentsPerPage);

            const tbody = document.getElementById('studentsTableBody');
            
            if (paginated.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-4 py-12 text-center text-gray-400">
                            <i class="fas fa-users text-4xl mb-2"></i>
                            <p>Tidak ada data siswa</p>
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = paginated.map((s, i) => `
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm">${start + i + 1}</td>
                        <td class="px-4 py-3 text-sm font-mono">${s.nisn}</td>
                        <td class="px-4 py-3 text-sm font-medium">${s.nama_siswa}</td>
                        <td class="px-4 py-3 text-sm text-center">
                            <span class="px-2 py-1 rounded ${s.jenis_kelamin === 'L' ? 'bg-blue-100 text-blue-700' : 'bg-pink-100 text-pink-700'}">
                                ${s.jenis_kelamin}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm text-center">${s.kelas}</td>
                        <td class="px-4 py-3 text-sm text-center">${s.rombel}</td>
                        <td class="px-4 py-3 text-center">
                            <button onclick="editStudent('${s.id}')" class="p-1 text-blue-600 hover:bg-blue-50 rounded">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteStudent('${s.id}')" class="p-1 text-red-600 hover:bg-red-50 rounded ml-1">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            }

            document.getElementById('showingCount').textContent = paginated.length;
            document.getElementById('totalCount').textContent = filtered.length;
        }

        function showImportStudentsModal() {
            const content = `
                <div class="space-y-6">
                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                        <h4 class="font-semibold text-blue-800 mb-2">Format CSV:</h4>
                        <code class="text-sm text-blue-700">nisn,nama_siswa,jenis_kelamin,kelas,rombel</code>
                        <p class="text-sm text-blue-600 mt-2">Contoh: 0012345678,Ahmad Fauzi,L,7,A</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">URL Google Spreadsheet (Publish as CSV)</label>
                        <input type="url" id="csvUrl" placeholder="https://docs.google.com/spreadsheets/..."
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary">
                    </div>
                    
                    <div class="text-center text-gray-500">- ATAU -</div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Upload File CSV</label>
                        <div class="border-2 border-dashed border-gray-200 rounded-xl p-8 text-center">
                            <input type="file" id="csvFile" accept=".csv" class="hidden" onchange="previewCSV(this.files[0])">
                            <label for="csvFile" class="cursor-pointer">
                                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i>
                                <p class="text-gray-600">Klik untuk upload atau drag & drop</p>
                                <p class="text-sm text-gray-400">Format: .csv</p>
                            </label>
                        </div>
                    </div>
                    
                    <div id="csvPreview" class="hidden">
                        <h4 class="font-semibold text-gray-800 mb-2">Preview Data:</h4>
                        <div class="max-h-48 overflow-y-auto border border-gray-200 rounded-xl">
                            <table class="w-full text-sm" id="csvPreviewTable"></table>
                        </div>
                        <p id="csvPreviewCount" class="text-sm text-gray-500 mt-2"></p>
                    </div>
                    
                    <div class="flex gap-3">
                        <button type="button" onclick="closeModal()" class="flex-1 py-3 border border-gray-200 rounded-xl font-medium hover:bg-gray-50">
                            Batal
                        </button>
                        <button type="button" onclick="importStudentsFromCSV()" id="importBtn" disabled
                            class="flex-1 py-3 bg-primary text-white rounded-xl font-medium hover:bg-secondary disabled:opacity-50 disabled:cursor-not-allowed">
                            Import Data
                        </button>
                    </div>
                </div>
            `;
            
            showModal(content, { title: 'Import Data Siswa', size: 'max-w-2xl' });
        }

        let csvData = [];

        function previewCSV(file) {
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                csvData = parseCSV(text);
                
                if (csvData.length === 0) {
                    showToast('error', 'Error', 'File CSV kosong atau format salah');
                    return;
                }
                
                // Show preview
                document.getElementById('csvPreview').classList.remove('hidden');
                const previewTable = document.getElementById('csvPreviewTable');
                
                const headers = Object.keys(csvData[0]);
                previewTable.innerHTML = `
                    <thead class="bg-gray-50">
                        <tr>${headers.map(h => `<th class="px-3 py-2 text-left">${h}</th>`).join('')}</tr>
                    </thead>
                    <tbody>
                        ${csvData.slice(0, 5).map(row => `
                            <tr class="border-b">${headers.map(h => `<td class="px-3 py-2">${row[h]}</td>`).join('')}</tr>
                        `).join('')}
                    </tbody>
                `;
                
                document.getElementById('csvPreviewCount').textContent = `Total: ${csvData.length} data siswa`;
                document.getElementById('importBtn').disabled = false;
            };
            reader.readAsText(file);
        }

        async function importStudentsFromCSV() {
            if (!currentUser || csvData.length === 0) return;
            
            const btn = document.getElementById('importBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Importing...';
            
            try {
                const batch = db.batch();
                
                for (const row of csvData) {
                    const ref = db.collection('users').doc(currentUser.uid)
                        .collection('students').doc();
                    batch.set(ref, {
                        nisn: row.nisn || '',
                        nama_siswa: row.nama_siswa || row['nama siswa'] || '',
                        jenis_kelamin: (row.jenis_kelamin || row['jenis kelamin'] || 'L').toUpperCase(),
                        kelas: row.kelas || '',
                        rombel: row.rombel || '',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                await batch.commit();
                closeModal();
                showToast('success', 'Berhasil', `${csvData.length} data siswa berhasil diimport`);
                csvData = [];
                await loadStudents();
            } catch (error) {
                showToast('error', 'Gagal', 'Tidak dapat mengimport data');
                console.error(error);
            }
        }

        // ==========================================
        // CP (CAPAIAN PEMBELAJARAN) FUNCTIONS
        // ==========================================
        
        let selectedPhase = null;
        let tujuanPembelajaran = [];

        function initCP() {
            // Nothing to initialize yet
        }

function selectPhase(fase) {
    selectedPhase = fase;
    
    // Update button styles
    document.querySelectorAll('.phase-btn').forEach(btn => {
        btn.classList.remove('border-primary', 'bg-primary/5');
        btn.classList.add('border-gray-200');
    });
    document.querySelector(`[data-fase="${fase}"]`).classList.add('border-primary', 'bg-primary/5');
    document.querySelector(`[data-fase="${fase}"]`).classList.remove('border-gray-200');
    
    // Show CP content
    const cpData = CP_PAI_DEFAULT[fase];
    const container = document.getElementById('cpContent');
    
    container.innerHTML = `
        <div class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
            <div>
                <h3 class="text-xl font-bold text-gray-800">Fase ${fase} - ${cpData.jenjang}</h3>
                <p class="text-gray-500">Capaian Pembelajaran PAI & Budi Pekerti</p>
            </div>
            <div class="flex flex-wrap gap-2">
                ${cpData.dimensi_fokus.map(d => {
                    const dimensi = DIMENSI_LULUSAN.find(dim => dim.nama === d);
                    return `
                        <span class="px-3 py-1.5 ${dimensi?.color || 'bg-gray-100 text-gray-700'} rounded-full text-sm font-medium flex items-center gap-1">
                            <i class="fas ${dimensi?.icon || 'fa-circle'} text-xs"></i>
                            ${d}
                        </span>
                    `;
                }).join('')}
            </div>
        </div>
        
        <!-- Dimensi Fokus Explanation -->
        <div class="bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl p-4 mb-6">
            <h4 class="font-semibold text-gray-700 mb-2">
                <i class="fas fa-crosshairs mr-2"></i>Dimensi Fokus Fase ${fase}
            </h4>
            <p class="text-sm text-gray-600">
                Pembelajaran pada fase ini difokuskan untuk mengembangkan dimensi: 
                <strong>${cpData.dimensi_fokus.join(', ')}</strong>
            </p>
        </div>

        <div class="space-y-4">
            ${cpData.elemen.map(el => `
                <div class="border border-gray-200 rounded-xl p-4 hover:shadow-md transition-all">
                    <div class="flex items-start gap-4">
                        <div class="w-12 h-12 bg-primary/10 rounded-xl flex items-center justify-center flex-shrink-0">
                            <span class="font-bold text-primary">${el.id}</span>
                        </div>
                        <div class="flex-1">
                            <div class="flex flex-col md:flex-row md:items-center justify-between gap-2 mb-2">
                                <h4 class="font-semibold text-gray-800 text-lg">${el.nama}</h4>
                                <div class="flex flex-wrap gap-1">
                                    ${el.dimensi.map(d => {
                                        const dimensi = DIMENSI_LULUSAN.find(dim => dim.nama === d);
                                        return `
                                            <span class="px-2 py-0.5 ${dimensi?.color || 'bg-gray-100 text-gray-600'} rounded text-xs font-medium" title="${dimensi?.deskripsi || ''}">
                                                <i class="fas ${dimensi?.icon || 'fa-circle'} mr-1"></i>${d}
                                            </span>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                            <p class="text-gray-600">${el.materi}</p>
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
    
    // Show TP section
    document.getElementById('tpSection').classList.remove('hidden');
    loadTujuanPembelajaran(fase);
}

// Function to show Dimensi Detail Modal
function showDimensiDetail(nama) {
    const dimensi = DIMENSI_LULUSAN.find(d => d.nama === nama);
    if (!dimensi) return;
    
    // Find related CP elements across all phases
    const relatedElements = [];
    Object.keys(CP_PAI_DEFAULT).forEach(fase => {
        CP_PAI_DEFAULT[fase].elemen.forEach(el => {
            if (el.dimensi.includes(nama)) {
                relatedElements.push({
                    fase,
                    jenjang: CP_PAI_DEFAULT[fase].jenjang,
                    elemen: el.nama,
                    materi: el.materi
                });
            }
        });
    });
    
    const content = `
        <div class="space-y-6">
            <!-- Header -->
            <div class="flex items-center gap-4">
                <div class="w-16 h-16 ${dimensi.color} rounded-2xl flex items-center justify-center">
                    <i class="fas ${dimensi.icon} text-3xl"></i>
                </div>
                <div>
                    <h3 class="text-2xl font-bold text-gray-800">${dimensi.nama}</h3>
                    <p class="text-gray-600">${dimensi.deskripsi}</p>
                </div>
            </div>
            
            <!-- Description -->
            <div class="bg-gray-50 rounded-xl p-4">
                <h4 class="font-semibold text-gray-700 mb-2">Tentang Dimensi Ini</h4>
                <p class="text-gray-600 text-sm">
                    ${getDimensiDescription(dimensi.nama)}
                </p>
            </div>
            
            <!-- Related CP Elements -->
            <div>
                <h4 class="font-semibold text-gray-800 mb-3">
                    <i class="fas fa-link mr-2 text-primary"></i>Elemen CP Terkait
                </h4>
                <div class="space-y-2 max-h-64 overflow-y-auto">
                    ${relatedElements.map(rel => `
                        <div class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg">
                            <span class="px-2 py-1 bg-primary text-white text-xs font-bold rounded">Fase ${rel.fase}</span>
                            <div>
                                <p class="font-medium text-gray-800">${rel.elemen}</p>
                                <p class="text-sm text-gray-500">${rel.jenjang}</p>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
            
            <button onclick="closeModal()" class="w-full py-3 bg-primary text-white rounded-xl font-medium hover:bg-secondary">
                Tutup
            </button>
        </div>
    `;
    
    showModal(content, { title: `Dimensi: ${dimensi.nama}`, size: 'max-w-lg' });
}

// Helper function for dimensi descriptions
function getDimensiDescription(nama) {
    const descriptions = {
        'Keimanan': 'Dimensi keimanan mencakup penguatan iman dan takwa kepada Allah SWT, pemahaman akidah yang benar, serta pengamalan ibadah dalam kehidupan sehari-hari. Peserta didik diharapkan memiliki keyakinan yang kuat dan mampu mengamalkan ajaran Islam dengan baik.',
        'Kewargaan': 'Dimensi kewargaan meliputi sikap cinta tanah air, menghargai keragaman, toleransi antar umat beragama, dan berpartisipasi aktif dalam kehidupan bermasyarakat. Peserta didik diharapkan menjadi warga negara yang baik dan berkontribusi positif.',
        'Penalaran Kritis': 'Dimensi penalaran kritis mencakup kemampuan berpikir logis, analitis, dan reflektif dalam memahami ajaran Islam dan menghadapi berbagai permasalahan. Peserta didik diharapkan mampu mengambil keputusan berdasarkan pertimbangan yang matang.',
        'Kreativitas': 'Dimensi kreativitas meliputi kemampuan menghasilkan ide-ide baru, inovasi dalam dakwah dan pembelajaran, serta mengekspresikan pemahaman keagamaan melalui berbagai karya. Peserta didik diharapkan mampu berkreasi secara positif.',
        'Kolaborasi': 'Dimensi kolaborasi mencakup kemampuan bekerja sama, bergotong royong, dan membangun hubungan yang harmonis dengan orang lain. Peserta didik diharapkan mampu berkontribusi dalam tim dan menghargai perbedaan.',
        'Kemandirian': 'Dimensi kemandirian meliputi sikap bertanggung jawab, disiplin, dan mampu mengambil inisiatif dalam menjalankan tugas dan ibadah. Peserta didik diharapkan dapat mandiri dalam menjalankan ajaran agama.',
        'Kesehatan': 'Dimensi kesehatan mencakup pemeliharaan kesehatan jasmani dan rohani sesuai ajaran Islam, termasuk menjaga kebersihan, pola hidup sehat, dan kesehatan mental. Peserta didik diharapkan sehat secara holistik.',
        'Komunikasi': 'Dimensi komunikasi meliputi kemampuan menyampaikan pesan dengan baik, santun dalam berbicara, dan efektif dalam dakwah. Peserta didik diharapkan mampu berkomunikasi dengan berbagai kalangan secara positif.'
    };
    return descriptions[nama] || 'Deskripsi tidak tersedia.';
}

        // ==========================================
        // GRADES FUNCTIONS
        // ==========================================
        
        function initGrades() {
            loadClassesForGrades();
        }

        async function loadClassesForGrades() {
            if (!currentUser) return;
            
            try {
                const snap = await db.collection('users').doc(currentUser.uid)
                    .collection('classes').orderBy('name').get();
                const classList = snap.docs.map(doc => doc.data().name);
                
                document.getElementById('gradesClass').innerHTML = 
                    '<option value="">Pilih Kelas</option>' +
                    classList.map(c => `<option value="${c}">${c}</option>`).join('');
            } catch (error) {
                console.error('Error loading classes:', error);
            }
        }
function renderTujuanPembelajaran() {
    const container = document.getElementById('tpList');
    
    if (tujuanPembelajaran.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8 text-gray-400">
                <i class="fas fa-bullseye text-4xl mb-2"></i>
                <p>Belum ada Tujuan Pembelajaran untuk fase ini</p>
                <button onclick="showAddTPModal()" class="mt-2 text-primary hover:underline">Tambah TP</button>
            </div>
        `;
        return;
    }

    // Sort by urutan
    const sortedTP = [...tujuanPembelajaran].sort((a, b) => (a.urutan || 0) - (b.urutan || 0));

    container.innerHTML = sortedTP.map((tp, i) => `
        <div class="border border-gray-200 rounded-xl p-4 hover:shadow-md transition-all">
            <div class="flex items-start gap-4">
                <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0">
                    <span class="font-bold text-green-600 text-sm">${tp.urutan || i + 1}</span>
                </div>
                <div class="flex-1">
                    <div class="flex flex-wrap items-center gap-2 mb-2">
                        <span class="text-xs px-2 py-0.5 bg-blue-100 text-blue-700 rounded font-medium">${tp.elemen}</span>
                        <span class="text-xs px-2 py-0.5 bg-purple-100 text-purple-700 rounded">${tp.alokasi} JP</span>
                        <!-- Dimensi Tags -->
                        ${(tp.dimensi || []).map(d => {
                            const dimensi = DIMENSI_LULUSAN.find(dim => dim.nama === d);
                            return `
                                <span class="text-xs px-2 py-0.5 ${dimensi?.color || 'bg-gray-100 text-gray-600'} rounded flex items-center gap-1" title="${dimensi?.deskripsi || ''}">
                                    <i class="fas ${dimensi?.icon || 'fa-circle'}"></i>
                                    ${d}
                                </span>
                            `;
                        }).join('')}
                    </div>
                    <p class="text-gray-800">${tp.deskripsi}</p>
                </div>
                <div class="flex gap-1">
                    <button onclick="editTP('${tp.id}')" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteTP('${tp.id}')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg" title="Hapus">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}

        // ==========================================
        // GUIDE FUNCTIONS
        // ==========================================
        
        function toggleGuideSection(num) {
            const content = document.getElementById(`guideContent${num}`);
            const chevron = document.querySelector(`.guide-chevron-${num}`);
            
            content.classList.toggle('hidden');
            chevron.classList.toggle('rotate-180');
        }
// Tambahkan section ini di template guide
<!-- Section 8 Dimensi -->
<div class="bg-white rounded-xl shadow-sm overflow-hidden">
    <button onclick="toggleGuideSection(6)" class="w-full px-6 py-4 flex items-center justify-between hover:bg-gray-50 transition-all">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-emerald-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-star text-emerald-600"></i>
            </div>
            <span class="font-semibold text-gray-800">8 Dimensi Profil Lulusan</span>
        </div>
        <i class="fas fa-chevron-down text-gray-400 guide-chevron-6 transition-transform"></i>
    </button>
    <div id="guideContent6" class="hidden px-6 pb-6">
        <div class="pl-13 space-y-4">
            <p class="text-gray-600">
                Berdasarkan <strong>Kepka BSKAP No. 046/H/KR/2025</strong>, pembelajaran PAI terintegrasi dengan 8 Dimensi Profil Lulusan:
            </p>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                ${DIMENSI_LULUSAN.map(d => `
                    <div class="p-3 ${d.color} rounded-lg">
                        <div class="flex items-center gap-2 mb-1">
                            <i class="fas ${d.icon}"></i>
                            <span class="font-semibold text-sm">${d.nama}</span>
                        </div>
                        <p class="text-xs opacity-80">${d.deskripsi}</p>
                    </div>
                `).join('')}
            </div>
            <p class="text-gray-600 text-sm mt-4">
                Setiap Tujuan Pembelajaran (TP) harus dikaitkan dengan minimal satu dimensi profil lulusan 
                untuk memastikan pembelajaran yang holistik dan terukur.
            </p>
        </div>
    </div>
</div>
        // ==========================================
        // AI ASSISTANT FUNCTIONS
        // ==========================================
        
        function usePromptTemplate(type) {
            const templates = {
                'csv-students': `Buatlah file CSV dengan format berikut untuk data siswa:
                
Kolom: nisn,nama_siswa,jenis_kelamin,kelas,rombel

Contoh:
nisn,nama_siswa,jenis_kelamin,kelas,rombel
0012345678,Ahmad Fauzi,L,7,A
0012345679,Siti Aisyah,P,7,A

Tolong buatkan data siswa untuk kelas [SEBUTKAN KELAS] dengan [JUMLAH] siswa.`,

                'modul-ajar': `Buatlah Modul Ajar untuk mata pelajaran PAI & Budi Pekerti dengan format berikut:

1. INFORMASI UMUM
- Identitas Modul (Satuan Pendidikan, Kelas, Fase, Tahun)
- Kompetensi Awal
- 8 Dimensi Profil Lulusan yang dikembangkan:
  â–¡ Keimanan    â–¡ Kreativitas    â–¡ Kesehatan
  â–¡ Kewargaan   â–¡ Kolaborasi     â–¡ Komunikasi
  â–¡ Penalaran Kritis   â–¡ Kemandirian
- Sarana dan Prasarana
- Target Peserta Didik
- Model Pembelajaran

2. KOMPONEN INTI
- Tujuan Pembelajaran: [SEBUTKAN TP]
- Dimensi Lulusan yang Difokuskan: [PILIH DARI 8 DIMENSI]
- Pemahaman Bermakna
- Pertanyaan Pemantik
- Kegiatan Pembelajaran:
  * Pendahuluan
  * Inti (dengan integrasi dimensi lulusan)
  * Penutup
- Asesmen (formatif & sumatif)
- Refleksi Peserta Didik
- Refleksi Guru

Materi: [SEBUTKAN MATERI]
Fase: [SEBUTKAN FASE]
Alokasi Waktu: [SEBUTKAN JP]

Catatan: Pastikan kegiatan pembelajaran mengintegrasikan minimal 2-3 dimensi profil lulusan yang relevan.`,

                'soal': `Buatlah soal-soal untuk mata pelajaran PAI & Budi Pekerti dengan format CSV:

no,tipe,pertanyaan,pilihan_a,pilihan_b,pilihan_c,pilihan_d,jawaban,tingkat_kesulitan,elemen

Keterangan:
- tipe: pg (pilihan ganda), essay, isian
- tingkat_kesulitan: mudah, sedang, sulit
- elemen: alquran, akidah, akhlak, fikih, sejarah

Materi: [SEBUTKAN MATERI]
Jumlah soal: [SEBUTKAN JUMLAH]
Tingkat: [SEBUTKAN TINGKAT]`,

                'lkpd': `Buatlah LKPD (Lembar Kerja Peserta Didik) untuk mata pelajaran PAI dengan format:

1. IDENTITAS
- Nama LKPD
- Kelas/Semester
- Tujuan Pembelajaran

2. PETUNJUK
- Petunjuk umum
- Alat dan bahan

3. KEGIATAN
- Kegiatan 1: [Mengamati/Membaca]
- Kegiatan 2: [Menganalisis]
- Kegiatan 3: [Menyimpulkan]

4. REFLEKSI
- Pertanyaan refleksi

Catatan: Gunakan bahasa yang mudah dipahami siswa.

Materi: [SEBUTKAN MATERI]
Kelas: [SEBUTKAN KELAS]`
            };

            const output = document.getElementById('promptOutput');
            output.textContent = templates[type] || 'Template tidak ditemukan';
        }

        function copyPrompt() {
            const text = document.getElementById('promptOutput').textContent;
            navigator.clipboard.writeText(text).then(() => {
                showToast('success', 'Berhasil', 'Prompt berhasil disalin');
            });
        }

        function clearPrompt() {
            document.getElementById('promptOutput').textContent = 
                'Pilih template di atas untuk melihat prompt yang dapat digunakan dengan AI (ChatGPT, Claude, dll).';
        }

        // ==========================================
        // ADMIN FUNCTIONS (Super Admin)
        // ==========================================
        
        async function loadAdminUsers() {
            try {
                const snap = await db.collection('users').orderBy('createdAt', 'desc').get();
                const users = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Update stats
                document.getElementById('adminTotalUsers').textContent = users.length;
                document.getElementById('adminPremiumUsers').textContent = 
                    users.filter(u => u.subscription === 'premium').length;
                document.getElementById('adminSchoolUsers').textContent = 
                    users.filter(u => u.subscription === 'school').length;
                document.getElementById('adminFreeUsers').textContent = 
                    users.filter(u => u.subscription === 'free' || !u.subscription).length;
                
                // Render table
                const tbody = document.getElementById('adminUsersTableBody');
                tbody.innerHTML = users.map(user => `
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="px-4 py-3">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-primary/10 rounded-full flex items-center justify-center">
                                    <span class="font-semibold text-primary">${(user.name || 'U').charAt(0)}</span>
                                </div>
                                <span class="font-medium text-gray-800">${user.name || '-'}</span>
                            </div>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600">${user.email}</td>
                        <td class="px-4 py-3 text-center">
                            <span class="px-2 py-1 rounded text-xs ${user.role === 'superadmin' ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-700'}">
                                ${user.role || 'guru'}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <span class="px-2 py-1 rounded text-xs ${
                                user.subscription === 'premium' ? 'bg-yellow-100 text-yellow-700' :
                                user.subscription === 'school' ? 'bg-purple-100 text-purple-700' :
                                'bg-gray-100 text-gray-700'
                            }">
                                ${user.subscription || 'free'}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-center text-sm text-gray-500">
                            ${user.createdAt ? formatDate(user.createdAt.toDate(), 'short') : '-'}
                        </td>
                        <td class="px-4 py-3 text-center">
                            <button onclick="manageUserSubscription('${user.id}')" class="p-2 text-primary hover:bg-primary/10 rounded-lg" title="Kelola Langganan">
                                <i class="fas fa-crown"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        function manageUserSubscription(userId) {
            const content = `
                <form id="manageSubForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipe Langganan</label>
                        <select id="subType" required
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary">
                            <option value="free">Free</option>
                            <option value="premium">Premium</option>
                            <option value="school">Paket Sekolah</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Berlaku Hingga</label>
                        <input type="date" id="subExpiry"
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary">
                    </div>
                    <div class="flex gap-3 pt-4">
                        <button type="button" onclick="closeModal()" class="flex-1 py-3 border border-gray-200 rounded-xl font-medium hover:bg-gray-50">
                            Batal
                        </button>
                        <button type="submit" class="flex-1 py-3 bg-primary text-white rounded-xl font-medium hover:bg-secondary">
                            Simpan
                        </button>
                    </div>
                </form>
            `;
            
            showModal(content, { title: 'Kelola Langganan User' });
            
            document.getElementById('manageSubForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const type = document.getElementById('subType').value;
                const expiry = document.getElementById('subExpiry').value;
                
                try {
                    await db.collection('users').doc(userId).update({
                        subscription: type,
                        subscriptionExpiry: expiry ? firebase.firestore.Timestamp.fromDate(new Date(expiry)) : null,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    closeModal();
                    showToast('success', 'Berhasil', 'Langganan user berhasil diupdate');
                    loadAdminUsers();
                } catch (error) {
                    showToast('error', 'Gagal', 'Tidak dapat mengupdate langganan');
                }
            });
        }

        // ==========================================
        // UTILITY MODALS
        // ==========================================
        
        function showUpgradeModal() {
            const content = `
                <div class="text-center py-4">
                    <div class="w-20 h-20 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-crown text-white text-3xl"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Upgrade ke Premium</h3>
                    <p class="text-gray-600 mb-6">Dapatkan akses ke semua fitur lengkap</p>
                    
                    <div class="space-y-3 mb-6 text-left">
                        <div class="flex items-center gap-3 p-3 bg-green-50 rounded-lg">
                            <i class="fas fa-check-circle text-green-500"></i>
                            <span>Modul Ajar Lengkap</span>
                        </div>
                        <div class="flex items-center gap-3 p-3 bg-green-50 rounded-lg">
                            <i class="fas fa-check-circle text-green-500"></i>
                            <span>LKPD dengan Dukungan Teks Arab</span>
                        </div>
                        <div class="flex items-center gap-3 p-3 bg-green-50 rounded-lg">
                            <i class="fas fa-check-circle text-green-500"></i>
                            <span>Bank Soal Terintegrasi ATP</span>
                        </div>
                        <div class="flex items-center gap-3 p-3 bg-green-50 rounded-lg">
                            <i class="fas fa-check-circle text-green-500"></i>
                            <span>Export ke PDF & Excel</span>
                        </div>
                    </div>
                    
                    <div class="bg-gray-100 rounded-xl p-4 mb-6">
                        <p class="text-3xl font-bold text-primary">Rp 99.000<span class="text-sm text-gray-500 font-normal">/tahun</span></p>
                    </div>
                    
                    <p class="text-sm text-gray-500 mb-4">Hubungi admin untuk proses pembayaran:</p>
                    <a href="mailto:afifaro@gmail.com" class="inline-flex items-center gap-2 px-6 py-3 bg-primary text-white rounded-xl hover:bg-secondary transition-all">
                        <i class="fas fa-envelope"></i>
                        <span>afifaro@gmail.com</span>
                    </a>
                </div>
            `;
            
            showModal(content, { title: '' });
        }

        function showQuickGenerate() {
            const content = `
                <div class="space-y-4">
                    <p class="text-gray-600">Pilih dokumen yang ingin di-generate:</p>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="closeModal(); loadPage('atp')" class="p-4 border border-gray-200 rounded-xl hover:border-primary hover:bg-primary/5 transition-all text-left">
                            <i class="fas fa-route text-primary text-xl mb-2"></i>
                            <p class="font-semibold text-gray-800">ATP</p>
                            <p class="text-xs text-gray-500">Alur Tujuan Pembelajaran</p>
                        </button>
                        <button onclick="closeModal(); loadPage('prota')" class="p-4 border border-gray-200 rounded-xl hover:border-primary hover:bg-primary/5 transition-all text-left">
                            <i class="fas fa-calendar-check text-primary text-xl mb-2"></i>
                            <p class="font-semibold text-gray-800">Prota</p>
                            <p class="text-xs text-gray-500">Program Tahunan</p>
                        </button>
                        <button onclick="closeModal(); loadPage('promes')" class="p-4 border border-gray-200 rounded-xl hover:border-primary hover:bg-primary/5 transition-all text-left">
                            <i class="fas fa-calendar-week text-primary text-xl mb-2"></i>
                            <p class="font-semibold text-gray-800">Promes</p>
                            <p class="text-xs text-gray-500">Program Semester</p>
                        </button>
                        <button onclick="closeModal(); loadPage('modul')" class="p-4 border border-gray-200 rounded-xl hover:border-primary hover:bg-primary/5 transition-all text-left relative">
                            <i class="fas fa-file-alt text-primary text-xl mb-2"></i>
                            <p class="font-semibold text-gray-800">Modul Ajar</p>
                            <p class="text-xs text-gray-500">Rencana Pembelajaran</p>
                            ${!checkPremiumAccess() ? '<span class="absolute top-2 right-2 px-2 py-0.5 bg-yellow-100 text-yellow-700 text-xs rounded">PRO</span>' : ''}
                        </button>
                    </div>
                </div>
            `;
            
            showModal(content, { title: 'Generate Dokumen' });
        }

        // ==========================================
        // GENERATE FUNCTIONS
        // ==========================================
        
        async function generateATP() {
            const fase = document.getElementById('atpFase').value;
            const semester = document.getElementById('atpSemester').value;
            
            if (!fase || !semester) {
                showToast('warning', 'Perhatian', 'Pilih Fase dan Semester terlebih dahulu');
                return;
            }
            
            // Load TP for this phase
            const tpSnap = await db.collection('users').doc(currentUser.uid)
                .collection('tp')
                .where('fase', '==', fase)
                .get();
            
            if (tpSnap.empty) {
                showToast('warning', 'Perhatian', 'Belum ada Tujuan Pembelajaran untuk fase ini. Silakan tambahkan TP terlebih dahulu.');
                return;
            }
            
            const tpList = tpSnap.docs.map(doc => doc.data());
            const tbody = document.getElementById('atpTableBody');
            
            let totalWeeks = 0;
            tbody.innerHTML = tpList.map((tp, i) => {
                const weeks = Math.ceil(tp.alokasi / 2); // Assume 2 JP per meeting
                totalWeeks += weeks;
                return `
                    <tr class="border-b border-gray-100">
                        <td class="px-4 py-3 text-center">${i + 1}</td>
                        <td class="px-4 py-3">${tp.elemen}</td>
                        <td class="px-4 py-3">${CP_PAI_DEFAULT[fase].elemen.find(e => e.nama === tp.elemen)?.materi || '-'}</td>
                        <td class="px-4 py-3">${tp.deskripsi}</td>
                        <td class="px-4 py-3 text-center">${tp.alokasi} JP</td>
                        <td class="px-4 py-3 text-center">${weeks}</td>
                    </tr>
                `;
            }).join('');
            
            showToast('success', 'Berhasil', `ATP berhasil di-generate dengan ${tpList.length} tujuan pembelajaran`);
        }

        async function generateProta() {
            showToast('info', 'Info', 'Fitur generate Prota akan menggunakan data dari Kalender dan ATP');
            // Implementation would sync with calendar and ATP data
        }

        async function generatePromes() {
            showToast('info', 'Info', 'Fitur generate Promes akan menggunakan data dari Prota dan Jadwal');
            // Implementation would sync with prota and schedule data
        }
function showAddTPModal() {
    if (!selectedPhase) {
        showToast('warning', 'Perhatian', 'Pilih fase terlebih dahulu');
        return;
    }
    
    const cpData = CP_PAI_DEFAULT[selectedPhase];
    
    const content = `
        <form id="addTPForm" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Elemen CP</label>
                <select id="tpElemen" required onchange="updateDimensiSuggestion()"
                    class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary">
                    ${cpData.elemen.map(el => `
                        <option value="${el.nama}" data-dimensi="${el.dimensi.join(',')}">${el.id} - ${el.nama}</option>
                    `).join('')}
                </select>
            </div>
            
            <!-- Dimensi Lulusan yang Dikembangkan -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Dimensi Lulusan yang Dikembangkan
                    <span class="text-xs text-gray-400 ml-1">(pilih minimal 1)</span>
                </label>
                <div id="dimensiCheckboxes" class="grid grid-cols-2 gap-2">
                    ${DIMENSI_LULUSAN.map(d => `
                        <label class="flex items-center gap-2 p-2 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" name="dimensi" value="${d.nama}" class="w-4 h-4 text-primary rounded">
                            <i class="fas ${d.icon} text-gray-400 text-sm"></i>
                            <span class="text-sm text-gray-700">${d.nama}</span>
                        </label>
                    `).join('')}
                </div>
                <p id="dimensiSuggestion" class="text-xs text-blue-600 mt-2"></p>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi Tujuan Pembelajaran</label>
                <textarea id="tpDeskripsi" required rows="4"
                    class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary"
                    placeholder="Peserta didik mampu..."></textarea>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Alokasi Waktu (JP)</label>
                    <input type="number" id="tpAlokasi" required min="1" value="2"
                        class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Urutan</label>
                    <input type="number" id="tpUrutan" required min="1" value="1"
                        class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary">
                </div>
            </div>
            <div class="flex gap-3 pt-4">
                <button type="button" onclick="closeModal()" class="flex-1 py-3 border border-gray-200 rounded-xl font-medium hover:bg-gray-50">
                    Batal
                </button>
                <button type="submit" class="flex-1 py-3 bg-primary text-white rounded-xl font-medium hover:bg-secondary">
                    Simpan
                </button>
            </div>
        </form>
    `;
    
    showModal(content, { title: 'Tambah Tujuan Pembelajaran', size: 'max-w-xl' });
    
    // Initial dimensi suggestion
    updateDimensiSuggestion();
    
    document.getElementById('addTPForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        await saveTP();
    });
}

function updateDimensiSuggestion() {
    const select = document.getElementById('tpElemen');
    const selectedOption = select.options[select.selectedIndex];
    const dimensiStr = selectedOption.dataset.dimensi || '';
    const dimensiArr = dimensiStr.split(',').filter(d => d);
    
    const suggestion = document.getElementById('dimensiSuggestion');
    suggestion.innerHTML = dimensiArr.length > 0 
        ? `<i class="fas fa-lightbulb mr-1"></i>Dimensi yang disarankan: <strong>${dimensiArr.join(', ')}</strong>`
        : '';
    
    // Auto-check suggested dimensi
    document.querySelectorAll('input[name="dimensi"]').forEach(cb => {
        cb.checked = dimensiArr.includes(cb.value);
    });
}

async function saveTP() {
    if (!currentUser || !selectedPhase) return;
    
    const elemen = document.getElementById('tpElemen').value;
    const deskripsi = document.getElementById('tpDeskripsi').value;
    const alokasi = parseInt(document.getElementById('tpAlokasi').value);
    const urutan = parseInt(document.getElementById('tpUrutan').value);
    
    // Get selected dimensi
    const selectedDimensi = [];
    document.querySelectorAll('input[name="dimensi"]:checked').forEach(cb => {
        selectedDimensi.push(cb.value);
    });
    
    if (selectedDimensi.length === 0) {
        showToast('warning', 'Perhatian', 'Pilih minimal 1 dimensi lulusan');
        return;
    }

    try {
        await db.collection('users').doc(currentUser.uid)
            .collection('tp').add({
                fase: selectedPhase,
                elemen,
                deskripsi,
                alokasi,
                urutan,
                dimensi: selectedDimensi,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        
        closeModal();
        showToast('success', 'Berhasil', 'Tujuan Pembelajaran berhasil ditambahkan');
        loadTujuanPembelajaran(selectedPhase);
    } catch (error) {
        showToast('error', 'Gagal', 'Tidak dapat menyimpan TP');
        console.error(error);
    }
}

        // ==========================================
        // LOGOUT FUNCTION
        // ==========================================
        
        async function logout() {
            try {
                await auth.signOut();
                localStorage.clear();
                window.location.href = 'index.html';
            } catch (error) {
                showToast('error', 'Gagal', 'Tidak dapat keluar');
            }
        }

        // ==========================================
        // INITIALIZATION
        // ==========================================
        
        // Auth State Observer
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                
                // Load user data
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists) {
                        userData = userDoc.data();
                        
                        // Update UI
                        document.getElementById('userName').textContent = userData.name || user.displayName || 'Guru';
                        document.getElementById('userInitial').textContent = (userData.name || user.displayName || 'G').charAt(0);
                        document.getElementById('headerUserInitial').textContent = (userData.name || user.displayName || 'G').charAt(0);
                        document.getElementById('userSubscription').textContent = userData.subscription || 'Free';
                        document.getElementById('userRole').textContent = userData.role === 'superadmin' ? 'Admin' : 'Guru';
                        
                        // Show admin menu if super admin
                        if (userData.role === 'superadmin' || user.email === SUPER_ADMIN_EMAIL) {
                            document.getElementById('adminMenu').classList.remove('hidden');
                            userData.role = 'superadmin';
                        }
                        
                        // Hide loading and load dashboard
                        document.getElementById('loadingOverlay').classList.add('hidden');
                        loadPage('dashboard');
                    } else {
                        // Create user document if doesn't exist
                        await db.collection('users').doc(user.uid).set({
                            name: user.displayName || '',
                            email: user.email,
                            role: user.email === SUPER_ADMIN_EMAIL ? 'superadmin' : 'guru',
                            subscription: 'free',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        window.location.reload();
                    }
                } catch (error) {
                    console.error('Error loading user data:', error);
                    document.getElementById('loadingOverlay').classList.add('hidden');
                    showToast('error', 'Error', 'Gagal memuat data pengguna');
                }
            } else {
                // Not logged in, redirect to login
                window.location.href = 'index.html';
            }
        });
    </script>
</body>
</html>
