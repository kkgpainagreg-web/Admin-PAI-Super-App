<!DOCTYPE html>
<html lang="id" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - ADMIN GURU SUPER APP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { 50: '#f0fdf4', 100: '#dcfce7', 200: '#bbf7d0', 300: '#86efac', 400: '#4ade80', 500: '#22c55e', 600: '#16a34a', 700: '#15803d', 800: '#166534', 900: '#14532d' },
                        secondary: { 50: '#f8fafc', 100: '#f1f5f9', 200: '#e2e8f0', 300: '#cbd5e1', 400: '#94a3b8', 500: '#64748b', 600: '#475569', 700: '#334155', 800: '#1e293b', 900: '#0f172a' },
                        islamic: { 50: '#ecfdf5', 100: '#d1fae5', 200: '#a7f3d0', 300: '#6ee7b7', 400: '#34d399', 500: '#10b981', 600: '#059669', 700: '#047857', 800: '#065f46', 900: '#064e3b' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'], arabic: ['Amiri', 'serif'] }
                }
            }
        }
    </script>
    <style>
        .sidebar-item { transition: all 0.2s ease; }
        .sidebar-item:hover { background: rgba(16, 185, 129, 0.1); }
        .sidebar-item.active { background: linear-gradient(135deg, #059669 0%, #10b981 100%); color: white; }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-4px); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); }
        .gradient-text { background: linear-gradient(135deg, #059669 0%, #10b981 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .loader { width: 48px; height: 48px; border: 5px solid #FFF; border-bottom-color: #10b981; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .rtl-text { direction: rtl; font-family: 'Amiri', serif; }
        .premium-badge { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .free-badge { background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); transition: transform 0.3s ease; }
            .sidebar.open { transform: translateX(0); }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-[100] flex items-center justify-center hidden">
        <div class="text-center"><span class="loader"></span><p class="text-white mt-4 font-medium">Memproses...</p></div>
    </div>

    <!-- Mobile Header -->
    <header class="lg:hidden fixed top-0 left-0 right-0 bg-white shadow-sm z-40 px-4 py-3">
        <div class="flex items-center justify-between">
            <button id="menuBtn" onclick="toggleSidebar()" class="p-2 rounded-lg hover:bg-gray-100">
                <i class="fas fa-bars text-xl text-gray-700"></i>
            </button>
            <div class="flex items-center gap-2">
                <i class="fas fa-graduation-cap text-xl text-islamic-600"></i>
                <span class="font-bold text-gray-800">ADMIN GURU</span>
            </div>
            <button onclick="toggleNotifications()" class="p-2 rounded-lg hover:bg-gray-100 relative">
                <i class="fas fa-bell text-xl text-gray-700"></i>
                <span class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center">3</span>
            </button>
        </div>
    </header>

    <!-- Sidebar Overlay (Mobile) -->
    <div id="sidebarOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden lg:hidden"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar fixed left-0 top-0 h-full w-72 bg-white shadow-xl z-50 flex flex-col lg:translate-x-0">
        <!-- Logo -->
        <div class="p-6 border-b border-gray-100">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-gradient-to-br from-islamic-500 to-islamic-600 rounded-xl flex items-center justify-center shadow-lg">
                    <i class="fas fa-graduation-cap text-2xl text-white"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-gray-800">ADMIN GURU</h1>
                    <p class="text-xs text-gray-500">SUPER APP v1.0</p>
                </div>
            </div>
        </div>

        <!-- User Profile Mini -->
        <div class="p-4 border-b border-gray-100">
            <div class="flex items-center gap-3">
                <img id="userAvatar" src="https://ui-avatars.com/api/?name=User&background=10b981&color=fff" alt="Avatar" class="w-10 h-10 rounded-full">
                <div class="flex-1 min-w-0">
                    <p id="userName" class="text-sm font-semibold text-gray-800 truncate">Loading...</p>
                    <p id="userEmail" class="text-xs text-gray-500 truncate">loading...</p>
                </div>
                <span id="subscriptionBadge" class="px-2 py-1 text-xs font-bold text-white rounded-full free-badge">FREE</span>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 overflow-y-auto p-4">
            <div class="space-y-1">
                <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider px-3 mb-2">Menu Utama</p>
                
                <button onclick="loadPage('dashboard')" class="sidebar-item active w-full flex items-center gap-3 px-3 py-3 rounded-xl text-sm font-medium" data-page="dashboard">
                    <i class="fas fa-home w-5 text-center"></i>
                    <span>Dashboard</span>
                </button>
                
                <button onclick="loadPage('profile')" class="sidebar-item w-full flex items-center gap-3 px-3 py-3 rounded-xl text-sm font-medium text-gray-700" data-page="profile">
                    <i class="fas fa-user w-5 text-center"></i>
                    <span>Profil</span>
                </button>

                <button onclick="loadPage('panduan')" class="sidebar-item w-full flex items-center gap-3 px-3 py-3 rounded-xl text-sm font-medium text-gray-700" data-page="panduan">
                    <i class="fas fa-book-open w-5 text-center"></i>
                    <span>Panduan</span>
                </button>
            </div>

            <div class="space-y-1 mt-6">
                <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider px-3 mb-2">Input Data</p>
                
                <button onclick="loadPage('calendar')" class="sidebar-item w-full flex items-center gap-3 px-3 py-3 rounded-xl text-sm font-medium text-gray-700" data-page="calendar">
                    <i class="fas fa-calendar-alt w-5 text-center"></i>
                    <span>Kalender Pendidikan</span>
                </button>
                
                <button onclick="loadPage('schedule')" class="sidebar-item w-full flex items-center gap-3 px-3 py-3 rounded-xl text-sm font-medium text-gray-700" data-page="schedule">
                    <i class="fas fa-clock w-5 text-center"></i>
                    <span>Jadwal Pelajaran</span>
                </button>
                
                <button onclick="loadPage('cp-tp')" class="sidebar-item w-full flex items-center gap-3 px-3 py-3 rounded-xl text-sm font-medium text-gray-700" data-page="cp-tp">
                    <i class="fas fa-bullseye w-5 text-center"></i>
                    <span>CP & TP</span>
                </button>

                <button onclick="loadPage('students')" class="sidebar-item w-full flex items-center gap-3 px-3 py-3 rounded-xl text-sm font-medium text-gray-700" data-page="students">
                    <i class="fas fa-users w-5 text-center"></i>
                    <span>Data Siswa</span>
                </button>
            </div>

            <div class="space-y-1 mt-6">
                <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider px-3 mb-2">Output Dokumen</p>
                
                <button onclick="loadPage('atp')" class="sidebar-item w-full flex items-center gap-3 px-3 py-3 rounded-xl text-sm font-medium text-gray-700" data-page="atp">
                    <i class="fas fa-route w-5 text-center"></i>
                    <span>ATP</span>
                </button>
                
                <button onclick="loadPage('prota')" class="sidebar-item w-full flex items-center gap-3 px-3 py-3 rounded-xl text-sm font-medium text-gray-700" data-page="prota">
                    <i class="fas fa-calendar-check w-5 text-center"></i>
                    <span>Prota</span>
                </button>
                
                <button onclick="loadPage('promes')" class="sidebar-item w-full flex items-center gap-3 px-3 py-3 rounded-xl text-sm font-medium text-gray-700" data-page="promes">
                    <i class="fas fa-calendar-week w-5 text-center"></i>
                    <span>Promes</span>
                </button>
                
                <button onclick="loadPage('modul-ajar')" class="sidebar-item w-full flex items-center gap-3 px-3 py-3 rounded-xl text-sm font-medium text-gray-700 premium-only" data-page="modul-ajar">
                    <i class="fas fa-book w-5 text-center"></i>
                    <span>Modul Ajar</span>
                    <i class="fas fa-crown text-yellow-500 ml-auto text-xs"></i>
                </button>
            </div>

            <div class="space-y-1 mt-6">
                <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider px-3 mb-2">Administrasi</p>
                
                <button onclick="loadPage('jurnal')" class="sidebar-item w-full flex items-center gap-3 px-3 py-3 rounded-xl text-sm font-medium text-gray-700" data-page="jurnal">
                    <i class="fas fa-pen-fancy w-5 text-center"></i>
                    <span>Jurnal Pembelajaran</span>
                </button>
                
                <button onclick="loadPage('nilai')" class="sidebar-item w-full flex items-center gap-3 px-3 py-3 rounded-xl text-sm font-medium text-gray-700" data-page="nilai">
                    <i class="fas fa-chart-bar w-5 text-center"></i>
                    <span>Daftar Nilai</span>
                </button>
                
                <button onclick="loadPage('lkpd')" class="sidebar-item w-full flex items-center gap-3 px-3 py-3 rounded-xl text-sm font-medium text-gray-700 premium-only" data-page="lkpd">
                    <i class="fas fa-file-alt w-5 text-center"></i>
                    <span>LKPD</span>
                    <i class="fas fa-crown text-yellow-500 ml-auto text-xs"></i>
                </button>
                
                <button onclick="loadPage('bank-soal')" class="sidebar-item w-full flex items-center gap-3 px-3 py-3 rounded-xl text-sm font-medium text-gray-700 premium-only" data-page="bank-soal">
                    <i class="fas fa-question-circle w-5 text-center"></i>
                    <span>Bank Soal</span>
                    <i class="fas fa-crown text-yellow-500 ml-auto text-xs"></i>
                </button>
            </div>

            <!-- Admin Menu (Hidden by default) -->
            <div id="adminMenu" class="space-y-1 mt-6 hidden">
                <p class="text-xs font-semibold text-red-400 uppercase tracking-wider px-3 mb-2">Super Admin</p>
                
                <button onclick="loadPage('admin-users')" class="sidebar-item w-full flex items-center gap-3 px-3 py-3 rounded-xl text-sm font-medium text-gray-700" data-page="admin-users">
                    <i class="fas fa-users-cog w-5 text-center"></i>
                    <span>Kelola User</span>
                </button>
                
                <button onclick="loadPage('admin-subscription')" class="sidebar-item w-full flex items-center gap-3 px-3 py-3 rounded-xl text-sm font-medium text-gray-700" data-page="admin-subscription">
                    <i class="fas fa-credit-card w-5 text-center"></i>
                    <span>Langganan</span>
                </button>
            </div>
        </nav>

        <!-- Upgrade Banner -->
        <div id="upgradeBanner" class="p-4 border-t border-gray-100">
            <div class="bg-gradient-to-r from-yellow-400 to-orange-500 rounded-xl p-4 text-white">
                <div class="flex items-center gap-2 mb-2">
                    <i class="fas fa-crown"></i>
                    <span class="font-bold">Upgrade Premium</span>
                </div>
                <p class="text-xs opacity-90 mb-3">Akses semua fitur tanpa batas!</p>
                <button onclick="showUpgradeModal()" class="w-full py-2 bg-white text-orange-600 rounded-lg font-semibold text-sm hover:bg-orange-50 transition">
                    Upgrade Sekarang
                </button>
            </div>
        </div>

        <!-- Logout -->
        <div class="p-4 border-t border-gray-100">
            <button onclick="logout()" class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-red-50 text-red-600 rounded-xl font-medium hover:bg-red-100 transition">
                <i class="fas fa-sign-out-alt"></i>
                <span>Keluar</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main id="mainContent" class="lg:ml-72 min-h-screen pt-16 lg:pt-0">
        <!-- Content will be loaded here -->
    </main>

    <!-- Notification Panel -->
    <div id="notificationPanel" class="fixed right-0 top-0 h-full w-80 bg-white shadow-2xl z-50 transform translate-x-full transition-transform duration-300">
        <div class="p-4 border-b border-gray-100 flex items-center justify-between">
            <h3 class="font-bold text-gray-800">Notifikasi</h3>
            <button onclick="toggleNotifications()" class="p-2 rounded-lg hover:bg-gray-100">
                <i class="fas fa-times text-gray-500"></i>
            </button>
        </div>
        <div class="p-4 space-y-3">
            <div class="p-3 bg-islamic-50 rounded-xl border-l-4 border-islamic-500">
                <p class="text-sm font-medium text-gray-800">Selamat datang!</p>
                <p class="text-xs text-gray-500 mt-1">Lengkapi profil Anda untuk memulai</p>
            </div>
            <div class="p-3 bg-yellow-50 rounded-xl border-l-4 border-yellow-500">
                <p class="text-sm font-medium text-gray-800">Fitur Premium</p>
                <p class="text-xs text-gray-500 mt-1">Upgrade untuk akses Modul Ajar & Bank Soal</p>
            </div>
        </div>
    </div>

    <!-- Upgrade Modal -->
    <div id="upgradeModal" class="fixed inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-100">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold text-gray-800">Pilih Paket Langganan</h3>
                    <button onclick="closeUpgradeModal()" class="p-2 rounded-lg hover:bg-gray-100">
                        <i class="fas fa-times text-gray-500"></i>
                    </button>
                </div>
            </div>
            <div class="p-6 space-y-4">
                <!-- Personal Plan -->
                <div class="border-2 border-gray-200 rounded-xl p-4 hover:border-islamic-500 cursor-pointer transition" onclick="selectPlan('personal')">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <h4 class="font-bold text-gray-800">Perorangan</h4>
                            <p class="text-sm text-gray-500">Untuk guru individu</p>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-bold text-islamic-600">Rp 99.000</p>
                            <p class="text-xs text-gray-500">/tahun</p>
                        </div>
                    </div>
                    <ul class="space-y-2 text-sm text-gray-600">
                        <li><i class="fas fa-check text-islamic-500 mr-2"></i>Semua fitur premium</li>
                        <li><i class="fas fa-check text-islamic-500 mr-2"></i>Modul Ajar & LKPD</li>
                        <li><i class="fas fa-check text-islamic-500 mr-2"></i>Bank Soal lengkap</li>
                        <li><i class="fas fa-check text-islamic-500 mr-2"></i>Export PDF</li>
                    </ul>
                </div>

                <!-- School Plan -->
                <div class="border-2 border-yellow-400 rounded-xl p-4 bg-yellow-50 cursor-pointer" onclick="selectPlan('school')">
                    <div class="absolute -mt-8 ml-2">
                        <span class="px-3 py-1 bg-yellow-400 text-yellow-900 text-xs font-bold rounded-full">HEMAT</span>
                    </div>
                    <div class="flex items-center justify-between mb-3 mt-2">
                        <div>
                            <h4 class="font-bold text-gray-800">Paket Sekolah</h4>
                            <p class="text-sm text-gray-500">Untuk 10+ guru</p>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-bold text-islamic-600">Rp 599.000</p>
                            <p class="text-xs text-gray-500">/tahun (max 20 guru)</p>
                        </div>
                    </div>
                    <ul class="space-y-2 text-sm text-gray-600">
                        <li><i class="fas fa-check text-islamic-500 mr-2"></i>Semua fitur premium</li>
                        <li><i class="fas fa-check text-islamic-500 mr-2"></i>Dashboard sekolah</li>
                        <li><i class="fas fa-check text-islamic-500 mr-2"></i>Manajemen guru</li>
                        <li><i class="fas fa-check text-islamic-500 mr-2"></i>Support prioritas</li>
                    </ul>
                </div>

                <p class="text-center text-sm text-gray-500">
                    Pembayaran via Transfer Bank / E-Wallet<br>
                    Hubungi: <a href="https://wa.me/6281234567890" class="text-islamic-600 font-medium">WhatsApp Admin</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 z-[70] hidden">
        <div class="flex items-center gap-3 px-6 py-4 rounded-xl shadow-lg bg-green-500 text-white">
            <i id="toastIcon" class="fas fa-check-circle text-xl"></i>
            <span id="toastMessage" class="font-medium"></span>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-storage-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDpiK4F4ilnDDNEwO0djGY-ClwgwBl1eFk",
            authDomain: "asap-1d653.firebaseapp.com",
            projectId: "asap-1d653",
            storageBucket: "asap-1d653.firebasestorage.app",
            messagingSenderId: "143263188364",
            appId: "1:143263188364:web:47b4c003972b3503e882a9",
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Constants
        const SUPER_ADMIN_EMAIL = 'afifaro@gmail.com';

        // Global State
        let currentUser = null;
        let userData = null;
        let currentPage = 'dashboard';

        // CP Default untuk PAI
        const CP_PAI_DEFAULT = {
            A: {
                fase: 'A',
                jenjang: 'Kelas 1-2 SD/MI',
                elemen: [
                    { kode: 'A.1', nama: 'Al-Quran & Hadis', deskripsi: 'Membaca huruf Hijaiah dengan harakat, menghafal surah pendek' },
                    { kode: 'A.2', nama: 'Akidah', deskripsi: 'Mengenal Rukun Iman, mengenal Allah melalui asmaul husna sederhana' },
                    { kode: 'A.3', nama: 'Akhlak', deskripsi: 'Akhlak terhadap diri sendiri (jujur, disiplin, tanggung jawab)' },
                    { kode: 'A.4', nama: 'Fikih', deskripsi: 'Mengenal Rukun Islam, tata cara bersuci dan shalat' },
                    { kode: 'A.5', nama: 'Sejarah Peradaban Islam', deskripsi: 'Kisah Nabi Muhammad SAW masa kecil' }
                ]
            },
            B: {
                fase: 'B',
                jenjang: 'Kelas 3-4 SD/MI',
                elemen: [
                    { kode: 'B.1', nama: 'Al-Quran & Hadis', deskripsi: 'Membaca Al-Quran dengan tajwid dasar, menghafal ayat tentang shalat' },
                    { kode: 'B.2', nama: 'Akidah', deskripsi: 'Memahami sifat-sifat Allah (Asmaul Husna)' },
                    { kode: 'B.3', nama: 'Akhlak', deskripsi: 'Adab kepada orang tua dan guru, akhlak pergaulan' },
                    { kode: 'B.4', nama: 'Fikih', deskripsi: 'Puasa Ramadhan, tanda-tanda baligh' },
                    { kode: 'B.5', nama: 'Sejarah Peradaban Islam', deskripsi: 'Sirah Nabawiyah periode Makkah' }
                ]
            },
            C: {
                fase: 'C',
                jenjang: 'Kelas 5-6 SD/MI',
                elemen: [
                    { kode: 'C.1', nama: 'Al-Quran & Hadis', deskripsi: 'Membaca Al-Quran dengan tajwid, memahami kandungan surah' },
                    { kode: 'C.2', nama: 'Akidah', deskripsi: 'Iman kepada Hari Akhir, keragaman dalam Islam' },
                    { kode: 'C.3', nama: 'Akhlak', deskripsi: 'Adab sosial, toleransi, menghargai perbedaan' },
                    { kode: 'C.4', nama: 'Fikih', deskripsi: 'Zakat, infaq, shadaqah' },
                    { kode: 'C.5', nama: 'Sejarah Peradaban Islam', deskripsi: 'Sirah Nabawiyah periode Madinah' }
                ]
            },
            D: {
                fase: 'D',
                jenjang: 'Kelas 7-9 SMP/MTs',
                elemen: [
                    { kode: 'D.1', nama: 'Al-Quran & Hadis', deskripsi: 'Memahami Al-Quran tematik, hafalan surah pilihan' },
                    { kode: 'D.2', nama: 'Akidah', deskripsi: 'Pendalaman Rukun Iman, toleransi antar umat beragama' },
                    { kode: 'D.3', nama: 'Akhlak', deskripsi: 'Akhlak pergaulan remaja, etika digital' },
                    { kode: 'D.4', nama: 'Fikih', deskripsi: 'Sujud syukur, sujud tilawah, haji dan umrah' },
                    { kode: 'D.5', nama: 'Sejarah Peradaban Islam', deskripsi: 'Peradaban Islam: Bani Umayyah, Abbasiyah, Mughal' }
                ]
            },
            E: {
                fase: 'E',
                jenjang: 'Kelas 10 SMA/MA/SMK',
                elemen: [
                    { kode: 'E.1', nama: 'Al-Quran & Hadis', deskripsi: 'Tafsir tematik, kompetisi dalam kebaikan' },
                    { kode: 'E.2', nama: 'Akidah', deskripsi: "Syu'ab al-Iman, cabang-cabang keimanan" },
                    { kode: 'E.3', nama: 'Akhlak', deskripsi: 'Etika bermedia sosial, akhlak kepemimpinan' },
                    { kode: 'E.4', nama: 'Fikih', deskripsi: 'Sumber hukum Islam, ijtihad' },
                    { kode: 'E.5', nama: 'Sejarah Peradaban Islam', deskripsi: 'Islam di Indonesia, kerajaan Islam Nusantara' }
                ]
            },
            F: {
                fase: 'F',
                jenjang: 'Kelas 11-12 SMA/MA/SMK',
                elemen: [
                    { kode: 'F.1', nama: 'Al-Quran & Hadis', deskripsi: 'Kajian tematik mendalam, berpikir kritis' },
                    { kode: 'F.2', nama: 'Akidah', deskripsi: 'Moderasi beragama, Islam rahmatan lil alamin' },
                    { kode: 'F.3', nama: 'Akhlak', deskripsi: 'Etika profesi, tanggung jawab sosial' },
                    { kode: 'F.4', nama: 'Fikih', deskripsi: 'Mawaris (warisan), muamalah kontemporer' },
                    { kode: 'F.5', nama: 'Sejarah Peradaban Islam', deskripsi: 'Organisasi Islam dunia, peran umat Islam global' }
                ]
            }
        };

        // 8 Dimensi Profil Lulusan
        const DIMENSI_PROFIL = [
            { kode: 'P1', nama: 'Keimanan', deskripsi: 'Beriman dan bertakwa kepada Tuhan Yang Maha Esa' },
            { kode: 'P2', nama: 'Kewargaan', deskripsi: 'Berkebinekaan global dan cinta tanah air' },
            { kode: 'P3', nama: 'Penalaran Kritis', deskripsi: 'Bernalar kritis dalam memecahkan masalah' },
            { kode: 'P4', nama: 'Kreativitas', deskripsi: 'Kreatif dan inovatif' },
            { kode: 'P5', nama: 'Kolaborasi', deskripsi: 'Bergotong royong dan bekerja sama' },
            { kode: 'P6', nama: 'Kemandirian', deskripsi: 'Mandiri dan bertanggung jawab' },
            { kode: 'P7', nama: 'Kesehatan', deskripsi: 'Menjaga kesehatan jasmani dan rohani' },
            { kode: 'P8', nama: 'Komunikasi', deskripsi: 'Berkomunikasi secara efektif' }
        ];

        // Utility Functions
        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            const toastIcon = document.getElementById('toastIcon');
            
            toastMessage.textContent = message;
            
            const types = {
                success: { bg: 'bg-green-500', icon: 'fa-check-circle' },
                error: { bg: 'bg-red-500', icon: 'fa-exclamation-circle' },
                warning: { bg: 'bg-yellow-500', icon: 'fa-exclamation-triangle' },
                info: { bg: 'bg-blue-500', icon: 'fa-info-circle' }
            };
            
            const config = types[type] || types.success;
            toast.firstElementChild.className = `flex items-center gap-3 px-6 py-4 rounded-xl shadow-lg ${config.bg} text-white`;
            toastIcon.className = `fas ${config.icon} text-xl`;
            
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('hidden');
        }

        function toggleNotifications() {
            const panel = document.getElementById('notificationPanel');
            panel.classList.toggle('translate-x-full');
        }

        function showUpgradeModal() {
            document.getElementById('upgradeModal').classList.remove('hidden');
        }

        function closeUpgradeModal() {
            document.getElementById('upgradeModal').classList.add('hidden');
        }

        function selectPlan(plan) {
            showToast('Hubungi admin via WhatsApp untuk upgrade', 'info');
            // Implementasi payment gateway di sini
        }

        // Logout Function
        async function logout() {
            showLoading();
            try {
                await auth.signOut();
                window.location.href = 'index.html';
            } catch (error) {
                hideLoading();
                showToast('Gagal logout', 'error');
            }
        }

        // Update sidebar active state
        function updateSidebarActive(page) {
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.page === page) {
                    item.classList.add('active');
                }
            });
        }

        // Load Page Content
        function loadPage(page) {
            currentPage = page;
            updateSidebarActive(page);
            
            // Close sidebar on mobile
            if (window.innerWidth < 1024) {
                toggleSidebar();
            }

            const mainContent = document.getElementById('mainContent');
            
            switch(page) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'profile':
                    loadProfile();
                    break;
                case 'panduan':
                    loadPanduan();
                    break;
                case 'calendar':
                    loadCalendar();
                    break;
                case 'schedule':
                    loadSchedule();
                    break;
                case 'cp-tp':
                    loadCPTP();
                    break;
                case 'students':
                    loadStudents();
                    break;
                case 'atp':
                    loadATP();
                    break;
                case 'prota':
                    loadProta();
                    break;
                case 'promes':
                    loadPromes();
                    break;
                case 'modul-ajar':
                    checkPremiumAndLoad(loadModulAjar);
                    break;
                case 'jurnal':
                    loadJurnal();
                    break;
                case 'nilai':
                    loadNilai();
                    break;
                case 'lkpd':
                    checkPremiumAndLoad(loadLKPD);
                    break;
                case 'bank-soal':
                    checkPremiumAndLoad(loadBankSoal);
                    break;
                case 'admin-users':
                    loadAdminUsers();
                    break;
                case 'admin-subscription':
                    loadAdminSubscription();
                    break;
                default:
                    loadDashboard();
            }
        }

        // Check Premium Access
        function checkPremiumAndLoad(loadFunction) {
            if (userData && (userData.subscription === 'premium' || userData.role === 'super_admin')) {
                loadFunction();
            } else {
                showUpgradeModal();
            }
        }

        // Dashboard Page
        function loadDashboard() {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="p-4 lg:p-8">
                    <!-- Header -->
                    <div class="mb-8">
                        <h1 class="text-2xl lg:text-3xl font-bold text-gray-800">Selamat Datang, <span id="dashboardName" class="gradient-text">${userData?.name || 'Guru'}</span>!</h1>
                        <p class="text-gray-500 mt-1">Kelola administrasi mengajar Anda dengan mudah</p>
                    </div>

                    <!-- Quick Stats -->
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                        <div class="bg-white rounded-2xl shadow-sm p-5 card-hover">
                            <div class="flex items-center justify-between mb-3">
                                <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-users text-xl text-blue-600"></i>
                                </div>
                                <span class="text-xs font-medium text-blue-600 bg-blue-50 px-2 py-1 rounded-full">Siswa</span>
                            </div>
                            <p id="totalSiswa" class="text-2xl font-bold text-gray-800">0</p>
                            <p class="text-sm text-gray-500">Total Siswa</p>
                        </div>

                        <div class="bg-white rounded-2xl shadow-sm p-5 card-hover">
                            <div class="flex items-center justify-between mb-3">
                                <div class="w-12 h-12 bg-islamic-100 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-chalkboard text-xl text-islamic-600"></i>
                                </div>
                                <span class="text-xs font-medium text-islamic-600 bg-islamic-50 px-2 py-1 rounded-full">Kelas</span>
                            </div>
                            <p id="totalKelas" class="text-2xl font-bold text-gray-800">0</p>
                            <p class="text-sm text-gray-500">Total Kelas</p>
                        </div>

                        <div class="bg-white rounded-2xl shadow-sm p-5 card-hover">
                            <div class="flex items-center justify-between mb-3">
                                <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-book text-xl text-purple-600"></i>
                                </div>
                                <span class="text-xs font-medium text-purple-600 bg-purple-50 px-2 py-1 rounded-full">Modul</span>
                            </div>
                            <p id="totalModul" class="text-2xl font-bold text-gray-800">0</p>
                            <p class="text-sm text-gray-500">Modul Ajar</p>
                        </div>

                        <div class="bg-white rounded-2xl shadow-sm p-5 card-hover">
                            <div class="flex items-center justify-between mb-3">
                                <div class="w-12 h-12 bg-yellow-100 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-calendar-check text-xl text-yellow-600"></i>
                                </div>
                                <span class="text-xs font-medium text-yellow-600 bg-yellow-50 px-2 py-1 rounded-full">Hari Ini</span>
                            </div>
                            <p id="jadwalHariIni" class="text-2xl font-bold text-gray-800">0</p>
                            <p class="text-sm text-gray-500">Jadwal Mengajar</p>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="bg-white rounded-2xl shadow-sm p-6 mb-8">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Aksi Cepat</h3>
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                            <button onclick="loadPage('calendar')" class="flex flex-col items-center p-4 bg-gray-50 rounded-xl hover:bg-islamic-50 transition group">
                                <div class="w-14 h-14 bg-white rounded-xl flex items-center justify-center mb-3 shadow-sm group-hover:shadow-md transition">
                                    <i class="fas fa-calendar-alt text-2xl text-islamic-600"></i>
                                </div>
                                <span class="text-sm font-medium text-gray-700">Kalender</span>
                            </button>
                            <button onclick="loadPage('schedule')" class="flex flex-col items-center p-4 bg-gray-50 rounded-xl hover:bg-islamic-50 transition group">
                                <div class="w-14 h-14 bg-white rounded-xl flex items-center justify-center mb-3 shadow-sm group-hover:shadow-md transition">
                                    <i class="fas fa-clock text-2xl text-islamic-600"></i>
                                </div>
                                <span class="text-sm font-medium text-gray-700">Jadwal</span>
                            </button>
                            <button onclick="loadPage('cp-tp')" class="flex flex-col items-center p-4 bg-gray-50 rounded-xl hover:bg-islamic-50 transition group">
                                <div class="w-14 h-14 bg-white rounded-xl flex items-center justify-center mb-3 shadow-sm group-hover:shadow-md transition">
                                    <i class="fas fa-bullseye text-2xl text-islamic-600"></i>
                                </div>
                                <span class="text-sm font-medium text-gray-700">CP & TP</span>
                            </button>
                            <button onclick="loadPage('jurnal')" class="flex flex-col items-center p-4 bg-gray-50 rounded-xl hover:bg-islamic-50 transition group">
                                <div class="w-14 h-14 bg-white rounded-xl flex items-center justify-center mb-3 shadow-sm group-hover:shadow-md transition">
                                    <i class="fas fa-pen-fancy text-2xl text-islamic-600"></i>
                                </div>
                                <span class="text-sm font-medium text-gray-700">Jurnal</span>
                            </button>
                        </div>
                    </div>

                    <!-- Two Column Layout -->
                    <div class="grid lg:grid-cols-2 gap-8">
                        <!-- Flow Chart -->
                        <div class="bg-white rounded-2xl shadow-sm p-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">Alur Kerja Aplikasi</h3>
                            <div class="space-y-4">
                                <div class="flex items-center gap-4">
                                    <div class="w-10 h-10 bg-islamic-500 text-white rounded-full flex items-center justify-center font-bold">1</div>
                                    <div class="flex-1">
                                        <p class="font-medium text-gray-800">Input Kalender Pendidikan</p>
                                        <p class="text-sm text-gray-500">Atur hari efektif, libur, dan pekan ujian</p>
                                    </div>
                                    <i class="fas fa-chevron-right text-gray-300"></i>
                                </div>
                                <div class="flex items-center gap-4">
                                    <div class="w-10 h-10 bg-islamic-500 text-white rounded-full flex items-center justify-center font-bold">2</div>
                                    <div class="flex-1">
                                        <p class="font-medium text-gray-800">Input Jadwal Pelajaran</p>
                                        <p class="text-sm text-gray-500">Atur jadwal per kelas & validasi anti-bentrok</p>
                                    </div>
                                    <i class="fas fa-chevron-right text-gray-300"></i>
                                </div>
                                <div class="flex items-center gap-4">
                                    <div class="w-10 h-10 bg-islamic-500 text-white rounded-full flex items-center justify-center font-bold">3</div>
                                    <div class="flex-1">
                                        <p class="font-medium text-gray-800">Input CP & Tujuan Pembelajaran</p>
                                        <p class="text-sm text-gray-500">Gunakan CP default PAI atau input manual</p>
                                    </div>
                                    <i class="fas fa-chevron-right text-gray-300"></i>
                                </div>
                                <div class="flex items-center gap-4">
                                    <div class="w-10 h-10 bg-yellow-500 text-white rounded-full flex items-center justify-center font-bold">
                                        <i class="fas fa-magic"></i>
                                    </div>
                                    <div class="flex-1">
                                        <p class="font-medium text-gray-800">Generate Otomatis</p>
                                        <p class="text-sm text-gray-500">ATP, Prota, Promes, Modul Ajar tersinkron</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Recent Activity -->
                        <div class="bg-white rounded-2xl shadow-sm p-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">Aktivitas Terakhir</h3>
                            <div id="recentActivity" class="space-y-4">
                                <div class="flex items-center gap-4 p-3 bg-gray-50 rounded-xl">
                                    <div class="w-10 h-10 bg-islamic-100 rounded-full flex items-center justify-center">
                                        <i class="fas fa-user-plus text-islamic-600"></i>
                                    </div>
                                    <div class="flex-1">
                                        <p class="text-sm font-medium text-gray-800">Akun berhasil dibuat</p>
                                        <p class="text-xs text-gray-500">Selamat datang di Admin Guru Super App</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Assistant Banner -->
                    <div class="mt-8 bg-gradient-to-r from-islamic-600 to-islamic-500 rounded-2xl p-6 text-white">
                        <div class="flex items-start gap-4">
                            <div class="w-14 h-14 bg-white bg-opacity-20 rounded-xl flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-robot text-2xl"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-bold mb-2">AI Assistant - Import Data</h3>
                                <p class="text-sm opacity-90 mb-4">
                                    Gunakan AI untuk membuat file CSV dengan format yang sesuai. Salin prompt berikut ke ChatGPT/Claude:
                                </p>
                                <div class="bg-black bg-opacity-20 rounded-xl p-4 font-mono text-xs">
                                    <p class="mb-2"><strong>Prompt untuk Data Siswa:</strong></p>
                                    <code>"Buatlah file CSV dengan format: nisn,nama_siswa,jenis_kelamin,kelas,rombel. Isi dengan 30 data siswa untuk kelas 7A SMP. Jenis kelamin gunakan L atau P."</code>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Load dashboard stats
            loadDashboardStats();
        }

        async function loadDashboardStats() {
            try {
                // Count students
                const studentsSnap = await db.collection('users').doc(currentUser.uid).collection('students').get();
                document.getElementById('totalSiswa').textContent = studentsSnap.size;

                // Count unique classes
                const classes = new Set();
                studentsSnap.forEach(doc => {
                    const data = doc.data();
                    if (data.kelas && data.rombel) {
                        classes.add(`${data.kelas}-${data.rombel}`);
                    }
                });
                document.getElementById('totalKelas').textContent = classes.size;

                // Count modul ajar
                const modulSnap = await db.collection('users').doc(currentUser.uid).collection('modul_ajar').get();
                document.getElementById('totalModul').textContent = modulSnap.size;

                // Today's schedule
                const today = new Date().toLocaleDateString('id-ID', { weekday: 'long' });
                const scheduleSnap = await db.collection('users').doc(currentUser.uid).collection('jadwal')
                    .where('hari', '==', today).get();
                document.getElementById('jadwalHariIni').textContent = scheduleSnap.size;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Profile Page
        function loadProfile() {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="p-4 lg:p-8 max-w-4xl mx-auto">
                    <div class="mb-8">
                        <h1 class="text-2xl lg:text-3xl font-bold text-gray-800">Profil Saya</h1>
                        <p class="text-gray-500 mt-1">Kelola informasi profil dan satuan pendidikan</p>
                    </div>

                    <form id="profileForm" class="space-y-6">
                        <!-- Personal Info -->
                        <div class="bg-white rounded-2xl shadow-sm p-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">
                                <i class="fas fa-user mr-2 text-islamic-600"></i>Informasi Pribadi
                            </h3>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap</label>
                                    <input type="text" id="profileName" value="${userData?.name || ''}" required
                                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-islamic-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                    <input type="email" value="${userData?.email || ''}" disabled
                                           class="w-full px-4 py-3 border border-gray-200 rounded-xl bg-gray-50 text-gray-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">NIP</label>
                                    <input type="text" id="profileNIP" value="${userData?.profile?.nip || ''}"
                                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-islamic-500 focus:border-transparent"
                                           placeholder="198501012010011001">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Pangkat/Golongan</label>
                                    <input type="text" id="profilePangkat" value="${userData?.profile?.pangkat || ''}"
                                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-islamic-500 focus:border-transparent"
                                           placeholder="Penata / III.c">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Jenjang</label>
                                    <select id="profileJenjang" required
                                            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-islamic-500 focus:border-transparent">
                                        <option value="">Pilih Jenjang</option>
                                        <option value="SD" ${userData?.jenjang === 'SD' ? 'selected' : ''}>SD/MI</option>
                                        <option value="SMP" ${userData?.jenjang === 'SMP' ? 'selected' : ''}>SMP/MTs</option>
                                        <option value="SMA" ${userData?.jenjang === 'SMA' ? 'selected' : ''}>SMA/MA</option>
                                        <option value="SMK" ${userData?.jenjang === 'SMK' ? 'selected' : ''}>SMK</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Mata Pelajaran</label>
                                    <select id="profileMapel" required
                                            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-islamic-500 focus:border-transparent">
                                        <option value="">Pilih Mata Pelajaran</option>
                                        <option value="PAI" ${userData?.mapel === 'PAI' ? 'selected' : ''}>PAI & Budi Pekerti</option>
                                        <option value="Matematika" ${userData?.mapel === 'Matematika' ? 'selected' : ''}>Matematika</option>
                                        <option value="Bahasa Indonesia" ${userData?.mapel === 'Bahasa Indonesia' ? 'selected' : ''}>Bahasa Indonesia</option>
                                        <option value="Bahasa Inggris" ${userData?.mapel === 'Bahasa Inggris' ? 'selected' : ''}>Bahasa Inggris</option>
                                        <option value="IPA" ${userData?.mapel === 'IPA' ? 'selected' : ''}>IPA</option>
                                        <option value="IPS" ${userData?.mapel === 'IPS' ? 'selected' : ''}>IPS</option>
                                        <option value="Lainnya" ${userData?.mapel === 'Lainnya' ? 'selected' : ''}>Lainnya</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- School Info -->
                        <div class="bg-white rounded-2xl shadow-sm p-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">
                                <i class="fas fa-school mr-2 text-islamic-600"></i>Satuan Pendidikan
                            </h3>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Sekolah</label>
                                    <input type="text" id="profileSekolah" value="${userData?.profile?.namaSekolah || ''}"
                                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-islamic-500 focus:border-transparent"
                                           placeholder="SMP Negeri 1 Contoh">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">NPSN</label>
                                    <input type="text" id="profileNPSN" value="${userData?.profile?.npsn || ''}"
                                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-islamic-500 focus:border-transparent"
                                           placeholder="20123456">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Tahun Pelajaran</label>
                                    <input type="text" id="profileTahunAjar" value="${userData?.profile?.tahunAjar || ''}"
                                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-islamic-500 focus:border-transparent"
                                           placeholder="2024/2025">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Alamat Sekolah</label>
                                    <textarea id="profileAlamat" rows="2"
                                              class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-islamic-500 focus:border-transparent"
                                              placeholder="Jl. Contoh No. 123, Kecamatan, Kota">${userData?.profile?.alamatSekolah || ''}</textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Kepala Sekolah</label>
                                    <input type="text" id="profileKepsek" value="${userData?.profile?.kepalaSekolah || ''}"
                                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-islamic-500 focus:border-transparent"
                                           placeholder="Drs. Nama Kepala Sekolah, M.Pd">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">NIP Kepala Sekolah</label>
                                    <input type="text" id="profileNIPKepsek" value="${userData?.profile?.nipKepala || ''}"
                                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-islamic-500 focus:border-transparent"
                                           placeholder="196501011990011001">
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="w-full py-4 bg-gradient-to-r from-islamic-600 to-islamic-500 text-white rounded-xl font-semibold text-lg hover:shadow-lg transition">
                            <i class="fas fa-save mr-2"></i>Simpan Profil
                        </button>
                    </form>
                </div>
            `;

            // Handle form submit
            document.getElementById('profileForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoading();

                try {
                    const updateData = {
                        name: document.getElementById('profileName').value,
                        jenjang: document.getElementById('profileJenjang').value,
                        mapel: document.getElementById('profileMapel').value,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        profile: {
                            nip: document.getElementById('profileNIP').value,
                            pangkat: document.getElementById('profilePangkat').value,
                            namaSekolah: document.getElementById('profileSekolah').value,
                            npsn: document.getElementById('profileNPSN').value,
                            tahunAjar: document.getElementById('profileTahunAjar').value,
                            alamatSekolah: document.getElementById('profileAlamat').value,
                            kepalaSekolah: document.getElementById('profileKepsek').value,
                            nipKepala: document.getElementById('profileNIPKepsek').value
                        }
                    };

                    await db.collection('users').doc(currentUser.uid).update(updateData);
                    
                    // Update local userData
                    userData = { ...userData, ...updateData };
                    document.getElementById('userName').textContent = updateData.name;

                    hideLoading();
                    showToast('Profil berhasil disimpan', 'success');
                } catch (error) {
                    hideLoading();
                    showToast('Gagal menyimpan profil', 'error');
                    console.error(error);
                }
            });
        }

        // Panduan Page
        function loadPanduan() {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="p-4 lg:p-8 max-w-4xl mx-auto">
                    <div class="mb-8">
                        <h1 class="text-2xl lg:text-3xl font-bold text-gray-800">Panduan Penggunaan</h1>
                        <p class="text-gray-500 mt-1">Petunjuk lengkap menggunakan Admin Guru Super App</p>
                    </div>

                    <div class="space-y-6">
                        <!-- Introduction -->
                        <div class="bg-white rounded-2xl shadow-sm p-6">
                            <h2 class="text-lg font-bold text-gray-800 mb-4">
                                <i class="fas fa-info-circle mr-2 text-islamic-600"></i>Tentang Aplikasi
                            </h2>
                            <p class="text-gray-600 leading-relaxed">
                                <strong>Admin Guru Super App</strong> adalah aplikasi yang membantu guru mengotomatisasi administrasi mengajar 
                                dengan konsep <em>Single Input - Multi Output</em>. Anda cukup memasukkan data dasar (Kalender, Jadwal, CP/TP), 
                                dan sistem akan menghasilkan dokumen-dokumen yang saling sinkron.
                            </p>
                        </div>

                        <!-- Step by Step -->
                        <div class="bg-white rounded-2xl shadow-sm p-6">
                            <h2 class="text-lg font-bold text-gray-800 mb-4">
                                <i class="fas fa-list-ol mr-2 text-islamic-600"></i>Langkah Penggunaan
                            </h2>
                            
                            <div class="space-y-6">
                                <div class="border-l-4 border-islamic-500 pl-4">
                                    <h3 class="font-bold text-gray-800">1. Lengkapi Profil</h3>
                                    <p class="text-sm text-gray-600 mt-1">
                                        Isi data diri dan satuan pendidikan Anda. Data ini akan otomatis muncul di semua dokumen yang dihasilkan.
                                    </p>
                                </div>

                                <div class="border-l-4 border-islamic-500 pl-4">
                                    <h3 class="font-bold text-gray-800">2. Atur Kalender Pendidikan</h3>
                                    <p class="text-sm text-gray-600 mt-1">
                                        Input hari efektif, hari libur, dan pekan ujian. Data ini menjadi dasar perhitungan alokasi waktu di Prota dan Promes.
                                    </p>
                                    <div class="mt-2 p-3 bg-yellow-50 rounded-lg">
                                        <p class="text-xs text-yellow-800">
                                            <i class="fas fa-lightbulb mr-1"></i>
                                            <strong>Tips:</strong> Gunakan kalender dinas pendidikan setempat sebagai acuan.
                                        </p>
                                    </div>
                                </div>

                                <div class="border-l-4 border-islamic-500 pl-4">
                                    <h3 class="font-bold text-gray-800">3. Buat Jadwal Pelajaran</h3>
                                    <p class="text-sm text-gray-600 mt-1">
                                        Atur jadwal per kelas dengan validasi anti-bentrok. Sistem akan mencegah jadwal yang bertabrakan.
                                    </p>
                                </div>

                                <div class="border-l-4 border-islamic-500 pl-4">
                                    <h3 class="font-bold text-gray-800">4. Input CP & Tujuan Pembelajaran</h3>
                                    <p class="text-sm text-gray-600 mt-1">
                                        Untuk guru PAI, CP sudah tersedia berdasarkan Kepka BSKAP No. 046/H/KR/2025. 
                                        Guru mapel lain perlu input CP secara manual.
                                    </p>
                                </div>

                                <div class="border-l-4 border-islamic-500 pl-4">
                                    <h3 class="font-bold text-gray-800">5. Import Data Siswa</h3>
                                    <p class="text-sm text-gray-600 mt-1">
                                        Import data siswa via file CSV dengan format: NISN, Nama, Jenis Kelamin (L/P), Kelas, Rombel.
                                    </p>
                                </div>

                                <div class="border-l-4 border-yellow-500 pl-4">
                                    <h3 class="font-bold text-gray-800">6. Generate Dokumen Otomatis</h3>
                                    <p class="text-sm text-gray-600 mt-1">
                                        Setelah data dasar lengkap, sistem akan menghasilkan ATP, Prota, Promes, dan Modul Ajar secara otomatis dan sinkron.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- AI Assistant Guide -->
                        <div class="bg-gradient-to-r from-islamic-600 to-islamic-500 rounded-2xl p-6 text-white">
                            <h2 class="text-lg font-bold mb-4">
                                <i class="fas fa-robot mr-2"></i>Panduan AI Assistant
                            </h2>
                            <p class="text-sm opacity-90 mb-4">
                                Gunakan prompt AI berikut untuk membuat file CSV yang diperlukan:
                            </p>
                            
                            <div class="space-y-4">
                                <div class="bg-black bg-opacity-20 rounded-xl p-4">
                                    <p class="font-medium mb-2"> Import Data Siswa:</p>
                                    <code class="text-xs block">
                                        "Buatlah file CSV dengan kolom: nisn,nama_siswa,jenis_kelamin,kelas,rombel. 
                                        Isi dengan [jumlah] data siswa untuk kelas [X] [Jenjang]. 
                                        Gunakan L atau P untuk jenis kelamin."
                                    </code>
                                </div>

                                <div class="bg-black bg-opacity-20 rounded-xl p-4">
                                    <p class="font-medium mb-2"> Import Tujuan Pembelajaran:</p>
                                    <code class="text-xs block">
                                        "Buatlah file CSV dengan kolom: kode_tp,elemen,tujuan_pembelajaran,alokasi_waktu. 
                                        Berdasarkan CP [Mata Pelajaran] Fase [X] untuk [Jenjang]. 
                                        Buat [jumlah] TP per elemen."
                                    </code>
                                </div>
                            </div>
                        </div>

                        <!-- FAQ -->
                        <div class="bg-white rounded-2xl shadow-sm p-6">
                            <h2 class="text-lg font-bold text-gray-800 mb-4">
                                <i class="fas fa-question-circle mr-2 text-islamic-600"></i>FAQ
                            </h2>
                            
                            <div class="space-y-4">
                                <details class="group">
                                    <summary class="flex items-center justify-between cursor-pointer p-3 bg-gray-50 rounded-xl">
                                        <span class="font-medium text-gray-800">Apa perbedaan akun Free dan Premium?</span>
                                        <i class="fas fa-chevron-down text-gray-400 group-open:rotate-180 transition"></i>
                                    </summary>
                                    <div class="p-4 text-sm text-gray-600">
                                        <strong>Free:</strong> Akses Kalender, Jadwal, ATP, dan Prota.<br>
                                        <strong>Premium:</strong> Semua fitur + Modul Ajar, LKPD, Bank Soal, dan Export PDF.
                                    </div>
                                </details>

                                <details class="group">
                                    <summary class="flex items-center justify-between cursor-pointer p-3 bg-gray-50 rounded-xl">
                                        <span class="font-medium text-gray-800">Bagaimana cara import data siswa?</span>
                                        <i class="fas fa-chevron-down text-gray-400 group-open:rotate-180 transition"></i>
                                    </summary>
                                    <div class="p-4 text-sm text-gray-600">
                                        Buka menu Data Siswa, klik "Import CSV", lalu masukkan URL Google Spreadsheet 
                                        yang sudah dipublish atau upload file CSV langsung.
                                    </div>
                                </details>

                                <details class="group">
                                    <summary class="flex items-center justify-between cursor-pointer p-3 bg-gray-50 rounded-xl">
                                        <span class="font-medium text-gray-800">Apakah mendukung teks Arab?</span>
                                        <i class="fas fa-chevron-down text-gray-400 group-open:rotate-180 transition"></i>
                                    </summary>
                                    <div class="p-4 text-sm text-gray-600">
                                        Ya! Aplikasi ini mendukung teks Arab (Right-to-Left) untuk LKPD, Modul Ajar, dan Bank Soal.
                                    </div>
                                </details>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Calendar Page
        function loadCalendar() {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="p-4 lg:p-8">
                    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between mb-8">
                        <div>
                            <h1 class="text-2xl lg:text-3xl font-bold text-gray-800">Kalender Pendidikan</h1>
                            <p class="text-gray-500 mt-1">Atur hari efektif, libur, dan kegiatan akademik</p>
                        </div>
                        <div class="mt-4 lg:mt-0 flex gap-2">
                            <button onclick="showAddEventModal()" class="px-4 py-2 bg-islamic-600 text-white rounded-xl font-medium hover:bg-islamic-700 transition">
                                <i class="fas fa-plus mr-2"></i>Tambah Kegiatan
                            </button>
                        </div>
                    </div>

                    <!-- Calendar Settings -->
                    <div class="bg-white rounded-2xl shadow-sm p-6 mb-6">
                        <h3 class="font-bold text-gray-800 mb-4">Pengaturan Kalender</h3>
                        <div class="grid md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tahun Pelajaran</label>
                                <select id="calendarYear" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-islamic-500">
                                    <option value="2024/2025" selected>2024/2025</option>
                                    <option value="2025/2026">2025/2026</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Semester</label>
                                <select id="calendarSemester" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-islamic-500">
                                    <option value="1">Semester 1 (Ganjil)</option>
                                    <option value="2">Semester 2 (Genap)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Bulan</label>
                                <select id="calendarMonth" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-islamic-500">
                                    <option value="0">Januari</option>
                                    <option value="1">Februari</option>
                                    <option value="2">Maret</option>
                                    <option value="3">April</option>
                                    <option value="4">Mei</option>
                                    <option value="5">Juni</option>
                                    <option value="6" selected>Juli</option>
                                    <option value="7">Agustus</option>
                                    <option value="8">September</option>
                                    <option value="9">Oktober</option>
                                    <option value="10">November</option>
                                    <option value="11">Desember</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Calendar Grid -->
                    <div class="bg-white rounded-2xl shadow-sm p-6 mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <button onclick="prevMonth()" class="p-2 hover:bg-gray-100 rounded-lg">
                                <i class="fas fa-chevron-left text-gray-600"></i>
                            </button>
                            <h3 id="currentMonthYear" class="font-bold text-lg text-gray-800">Juli 2024</h3>
                            <button onclick="nextMonth()" class="p-2 hover:bg-gray-100 rounded-lg">
                                <i class="fas fa-chevron-right text-gray-600"></i>
                            </button>
                        </div>

                        <!-- Days Header -->
                        <div class="grid grid-cols-7 gap-1 mb-2">
                            <div class="text-center py-2 text-sm font-semibold text-red-500">Min</div>
                            <div class="text-center py-2 text-sm font-semibold text-gray-600">Sen</div>
                            <div class="text-center py-2 text-sm font-semibold text-gray-600">Sel</div>
                            <div class="text-center py-2 text-sm font-semibold text-gray-600">Rab</div>
                            <div class="text-center py-2 text-sm font-semibold text-gray-600">Kam</div>
                            <div class="text-center py-2 text-sm font-semibold text-gray-600">Jum</div>
                            <div class="text-center py-2 text-sm font-semibold text-gray-600">Sab</div>
                        </div>

                        <!-- Calendar Days -->
                        <div id="calendarDays" class="grid grid-cols-7 gap-1">
                            <!-- Days will be rendered here -->
                        </div>
                    </div>

                    <!-- Legend -->
                    <div class="bg-white rounded-2xl shadow-sm p-6 mb-6">
                        <h3 class="font-bold text-gray-800 mb-4">Keterangan</h3>
                        <div class="flex flex-wrap gap-4">
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded bg-green-500"></div>
                                <span class="text-sm text-gray-600">Hari Efektif</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded bg-red-500"></div>
                                <span class="text-sm text-gray-600">Libur</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded bg-yellow-500"></div>
                                <span class="text-sm text-gray-600">Pekan Ujian</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded bg-blue-500"></div>
                                <span class="text-sm text-gray-600">Kegiatan Sekolah</span>
                            </div>
                        </div>
                    </div>

                    <!-- Events List -->
                    <div class="bg-white rounded-2xl shadow-sm p-6">
                        <h3 class="font-bold text-gray-800 mb-4">Daftar Kegiatan</h3>
                        <div id="eventsList" class="space-y-3">
                            <p class="text-gray-500 text-center py-8">Belum ada kegiatan</p>
                        </div>
                    </div>
                </div>
            `;

            renderCalendar();
            loadEvents();
        }

        let currentCalendarDate = new Date();

        function renderCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            document.getElementById('currentMonthYear').textContent = 
                new Date(year, month).toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDay = firstDay.getDay();
            const totalDays = lastDay.getDate();

            const calendarDays = document.getElementById('calendarDays');
            calendarDays.innerHTML = '';

            // Empty cells before first day
            for (let i = 0; i < startDay; i++) {
                calendarDays.innerHTML += '<div class="aspect-square"></div>';
            }

            // Days of month
            for (let day = 1; day <= totalDays; day++) {
                const date = new Date(year, month, day);
                const isToday = date.toDateString() === new Date().toDateString();
                const isSunday = date.getDay() === 0;
                
                calendarDays.innerHTML += `
                    <div onclick="selectDate(${year}, ${month}, ${day})" 
                         class="aspect-square flex items-center justify-center rounded-lg cursor-pointer hover:bg-gray-100 transition
                                ${isToday ? 'bg-islamic-500 text-white hover:bg-islamic-600' : ''}
                                ${isSunday && !isToday ? 'text-red-500' : ''}">
                        <span class="text-sm font-medium">${day}</span>
                    </div>
                `;
            }
        }

        function prevMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderCalendar();
        }

        function selectDate(year, month, day) {
            showAddEventModal(new Date(year, month, day));
        }

        async function loadEvents() {
            try {
                const snapshot = await db.collection('users').doc(currentUser.uid)
                    .collection('calendar_events').orderBy('date').get();
                
                const eventsList = document.getElementById('eventsList');
                
                if (snapshot.empty) {
                    eventsList.innerHTML = '<p class="text-gray-500 text-center py-8">Belum ada kegiatan</p>';
                    return;
                }

                eventsList.innerHTML = snapshot.docs.map(doc => {
                    const data = doc.data();
                    const date = data.date.toDate();
                    const typeColors = {
                        'efektif': 'bg-green-100 text-green-700',
                        'libur': 'bg-red-100 text-red-700',
                        'ujian': 'bg-yellow-100 text-yellow-700',
                        'kegiatan': 'bg-blue-100 text-blue-700'
                    };
                    return `
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 ${typeColors[data.type] || 'bg-gray-100'} rounded-xl flex items-center justify-center">
                                    <span class="text-sm font-bold">${date.getDate()}</span>
                                </div>
                                <div>
                                    <p class="font-medium text-gray-800">${data.title}</p>
                                    <p class="text-sm text-gray-500">${date.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}</p>
                                </div>
                            </div>
                            <button onclick="deleteEvent('${doc.id}')" class="p-2 text-red-500 hover:bg-red-50 rounded-lg">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading events:', error);
            }
        }

        function showAddEventModal(selectedDate = null) {
            const date = selectedDate || new Date();
            const dateStr = date.toISOString().split('T')[0];
            
            const modal = document.createElement('div');
            modal.id = 'eventModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md">
                    <div class="p-6 border-b border-gray-100">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-bold text-gray-800">Tambah Kegiatan</h3>
                            <button onclick="closeEventModal()" class="p-2 hover:bg-gray-100 rounded-lg">
                                <i class="fas fa-times text-gray-500"></i>
                            </button>
                        </div>
                    </div>
                    <form id="eventForm" class="p-6 space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                            <input type="date" id="eventDate" value="${dateStr}" required
                                   class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Judul Kegiatan</label>
                            <input type="text" id="eventTitle" required
                                   class="w-full px-4 py-3 border border-gray-200 rounded-xl"
                                   placeholder="Contoh: Libur Hari Raya">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Jenis</label>
                            <select id="eventType" required
                                    class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                                <option value="efektif">Hari Efektif</option>
                                <option value="libur">Libur</option>
                                <option value="ujian">Pekan Ujian</option>
                                <option value="kegiatan">Kegiatan Sekolah</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Keterangan</label>
                            <textarea id="eventDesc" rows="2"
                                      class="w-full px-4 py-3 border border-gray-200 rounded-xl"
                                      placeholder="Opsional"></textarea>
                        </div>
                        <button type="submit" class="w-full py-3 bg-islamic-600 text-white rounded-xl font-semibold hover:bg-islamic-700">
                            <i class="fas fa-save mr-2"></i>Simpan
                        </button>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);

            document.getElementById('eventForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoading();

                try {
                    await db.collection('users').doc(currentUser.uid).collection('calendar_events').add({
                        date: firebase.firestore.Timestamp.fromDate(new Date(document.getElementById('eventDate').value)),
                        title: document.getElementById('eventTitle').value,
                        type: document.getElementById('eventType').value,
                        description: document.getElementById('eventDesc').value,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    hideLoading();
                    closeEventModal();
                    loadEvents();
                    showToast('Kegiatan berhasil ditambahkan', 'success');
                } catch (error) {
                    hideLoading();
                    showToast('Gagal menambah kegiatan', 'error');
                }
            });
        }

        function closeEventModal() {
            document.getElementById('eventModal')?.remove();
        }

        async function deleteEvent(eventId) {
            if (!confirm('Hapus kegiatan ini?')) return;
            
            showLoading();
            try {
                await db.collection('users').doc(currentUser.uid).collection('calendar_events').doc(eventId).delete();
                hideLoading();
                loadEvents();
                showToast('Kegiatan dihapus', 'success');
            } catch (error) {
                hideLoading();
                showToast('Gagal menghapus kegiatan', 'error');
            }
        }

        // Schedule Page (Jadwal)
        function loadSchedule() {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="p-4 lg:p-8">
                    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between mb-8">
                        <div>
                            <h1 class="text-2xl lg:text-3xl font-bold text-gray-800">Jadwal Pelajaran</h1>
                            <p class="text-gray-500 mt-1">Kelola jadwal mengajar dengan validasi anti-bentrok</p>
                        </div>
                        <div class="mt-4 lg:mt-0">
                            <button onclick="showAddScheduleModal()" class="px-4 py-2 bg-islamic-600 text-white rounded-xl font-medium hover:bg-islamic-700 transition">
                                <i class="fas fa-plus mr-2"></i>Tambah Jadwal
                            </button>
                        </div>
                    </div>

                    <!-- Jam Pelajaran Settings -->
                    <div class="bg-white rounded-2xl shadow-sm p-6 mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-bold text-gray-800">Pengaturan Jam Pelajaran</h3>
                            <button onclick="saveJamPelajaran()" class="px-4 py-2 bg-islamic-100 text-islamic-700 rounded-xl font-medium hover:bg-islamic-200 transition">
                                <i class="fas fa-save mr-2"></i>Simpan
                            </button>
                        </div>
                        <div id="jamPelajaranContainer" class="grid md:grid-cols-2 lg:grid-cols-4 gap-3">
                            <!-- Jam pelajaran will be rendered here -->
                        </div>
                        <button onclick="addJamPelajaran()" class="mt-4 px-4 py-2 border-2 border-dashed border-gray-300 text-gray-500 rounded-xl w-full hover:border-islamic-500 hover:text-islamic-600 transition">
                            <i class="fas fa-plus mr-2"></i>Tambah Jam Pelajaran
                        </button>
                    </div>

                    <!-- Schedule Table -->
                    <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Jam Ke</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Senin</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Selasa</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Rabu</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Kamis</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Jumat</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Sabtu</th>
                                    </tr>
                                </thead>
                                <tbody id="scheduleTableBody">
                                    <!-- Schedule will be rendered here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Schedule List (Alternative View) -->
                    <div class="bg-white rounded-2xl shadow-sm p-6 mt-6">
                        <h3 class="font-bold text-gray-800 mb-4">Daftar Jadwal</h3>
                        <div id="scheduleList" class="space-y-3">
                            <p class="text-gray-500 text-center py-8">Belum ada jadwal</p>
                        </div>
                    </div>
                </div>
            `;

            loadJamPelajaran();
            loadScheduleData();
        }

        let jamPelajaranData = [
            { jam: 1, mulai: '07:00', selesai: '07:40' },
            { jam: 2, mulai: '07:40', selesai: '08:20' },
            { jam: 3, mulai: '08:20', selesai: '09:00' },
            { jam: 4, mulai: '09:15', selesai: '09:55' },
            { jam: 5, mulai: '09:55', selesai: '10:35' },
            { jam: 6, mulai: '10:35', selesai: '11:15' },
            { jam: 7, mulai: '11:30', selesai: '12:10' },
            { jam: 8, mulai: '12:10', selesai: '12:50' }
        ];

        function loadJamPelajaran() {
            const container = document.getElementById('jamPelajaranContainer');
            container.innerHTML = jamPelajaranData.map((jp, idx) => `
                <div class="flex items-center gap-2 p-3 bg-gray-50 rounded-xl">
                    <span class="w-12 text-sm font-medium text-gray-700">Jam ${jp.jam}</span>
                    <input type="time" value="${jp.mulai}" onchange="updateJamPelajaran(${idx}, 'mulai', this.value)"
                           class="flex-1 px-2 py-1 border border-gray-200 rounded-lg text-sm">
                    <span class="text-gray-400">-</span>
                    <input type="time" value="${jp.selesai}" onchange="updateJamPelajaran(${idx}, 'selesai', this.value)"
                           class="flex-1 px-2 py-1 border border-gray-200 rounded-lg text-sm">
                    <button onclick="removeJamPelajaran(${idx})" class="p-1 text-red-500 hover:bg-red-50 rounded">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </div>
            `).join('');
        }

        function addJamPelajaran() {
            const lastJam = jamPelajaranData[jamPelajaranData.length - 1];
            jamPelajaranData.push({
                jam: lastJam.jam + 1,
                mulai: lastJam.selesai,
                selesai: addMinutes(lastJam.selesai, 40)
            });
            loadJamPelajaran();
        }

        function addMinutes(time, minutes) {
            const [h, m] = time.split(':').map(Number);
            const date = new Date(0, 0, 0, h, m + minutes);
            return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        }

        function updateJamPelajaran(idx, field, value) {
            jamPelajaranData[idx][field] = value;
        }

        function removeJamPelajaran(idx) {
            jamPelajaranData.splice(idx, 1);
            jamPelajaranData = jamPelajaranData.map((jp, i) => ({ ...jp, jam: i + 1 }));
            loadJamPelajaran();
        }

        async function saveJamPelajaran() {
            showLoading();
            try {
                await db.collection('users').doc(currentUser.uid).collection('settings').doc('jam_pelajaran').set({
                    data: jamPelajaranData,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                hideLoading();
                showToast('Jam pelajaran disimpan', 'success');
            } catch (error) {
                hideLoading();
                showToast('Gagal menyimpan', 'error');
            }
        }

        async function loadScheduleData() {
            try {
                const snapshot = await db.collection('users').doc(currentUser.uid)
                    .collection('jadwal').orderBy('hari').orderBy('jamKe').get();
                
                const scheduleList = document.getElementById('scheduleList');
                
                if (snapshot.empty) {
                    scheduleList.innerHTML = '<p class="text-gray-500 text-center py-8">Belum ada jadwal</p>';
                    return;
                }

                scheduleList.innerHTML = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return `
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 bg-islamic-100 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-clock text-islamic-600"></i>
                                </div>
                                <div>
                                    <p class="font-medium text-gray-800">${data.hari} - Jam ke ${data.jamKe}</p>
                                    <p class="text-sm text-gray-500">Kelas ${data.kelas}${data.rombel} (${data.waktu})</p>
                                </div>
                            </div>
                            <button onclick="deleteSchedule('${doc.id}')" class="p-2 text-red-500 hover:bg-red-50 rounded-lg">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading schedule:', error);
            }
        }

        function showAddScheduleModal() {
            const modal = document.createElement('div');
            modal.id = 'scheduleModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto">
                    <div class="p-6 border-b border-gray-100">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-bold text-gray-800">Tambah Jadwal</h3>
                            <button onclick="closeScheduleModal()" class="p-2 hover:bg-gray-100 rounded-lg">
                                <i class="fas fa-times text-gray-500"></i>
                            </button>
                        </div>
                    </div>
                    <form id="scheduleForm" class="p-6 space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Hari</label>
                            <select id="scheduleDay" required class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                                <option value="Senin">Senin</option>
                                <option value="Selasa">Selasa</option>
                                <option value="Rabu">Rabu</option>
                                <option value="Kamis">Kamis</option>
                                <option value="Jumat">Jumat</option>
                                <option value="Sabtu">Sabtu</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Jam Ke</label>
                                <select id="scheduleJam" required class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                                    ${jamPelajaranData.map(jp => `<option value="${jp.jam}">${jp.jam} (${jp.mulai}-${jp.selesai})</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Durasi (JP)</label>
                                <select id="scheduleDurasi" required class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                                    <option value="1">1 JP</option>
                                    <option value="2">2 JP</option>
                                    <option value="3">3 JP</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                                <select id="scheduleKelas" required class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                                    <option value="7">Kelas 7</option>
                                    <option value="8">Kelas 8</option>
                                    <option value="9">Kelas 9</option>
                                    <option value="10">Kelas 10</option>
                                    <option value="11">Kelas 11</option>
                                    <option value="12">Kelas 12</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Rombel</label>
                                <select id="scheduleRombel" required class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                                    <option value="A">A</option>
                                    <option value="B">B</option>
                                    <option value="C">C</option>
                                    <option value="D">D</option>
                                    <option value="E">E</option>
                                    <option value="F">F</option>
                                </select>
                            </div>
                        </div>
                        <div id="conflictWarning" class="hidden p-3 bg-red-50 border border-red-200 rounded-xl">
                            <p class="text-sm text-red-600"><i class="fas fa-exclamation-triangle mr-2"></i>Jadwal bentrok!</p>
                        </div>
                        <button type="submit" class="w-full py-3 bg-islamic-600 text-white rounded-xl font-semibold hover:bg-islamic-700">
                            <i class="fas fa-save mr-2"></i>Simpan Jadwal
                        </button>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);

            // Add validation listeners
            ['scheduleDay', 'scheduleJam', 'scheduleKelas', 'scheduleRombel'].forEach(id => {
                document.getElementById(id).addEventListener('change', checkScheduleConflict);
            });

            document.getElementById('scheduleForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const hasConflict = await checkScheduleConflict();
                if (hasConflict) {
                    showToast('Tidak dapat menyimpan - jadwal bentrok!', 'error');
                    return;
                }

                showLoading();

                const hari = document.getElementById('scheduleDay').value;
                const jamKe = parseInt(document.getElementById('scheduleJam').value);
                const durasi = parseInt(document.getElementById('scheduleDurasi').value);
                const kelas = document.getElementById('scheduleKelas').value;
                const rombel = document.getElementById('scheduleRombel').value;
                const jamData = jamPelajaranData.find(jp => jp.jam === jamKe);

                try {
                    await db.collection('users').doc(currentUser.uid).collection('jadwal').add({
                        hari: hari,
                        jamKe: jamKe,
                        durasi: durasi,
                        kelas: kelas,
                        rombel: rombel,
                        waktu: `${jamData.mulai} - ${jamPelajaranData[jamKe + durasi - 2]?.selesai || jamData.selesai}`,
                        mapel: userData.mapel,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    hideLoading();
                    closeScheduleModal();
                    loadScheduleData();
                    showToast('Jadwal berhasil ditambahkan', 'success');
                } catch (error) {
                    hideLoading();
                    showToast('Gagal menambah jadwal', 'error');
                    console.error(error);
                }
            });
        }

        async function checkScheduleConflict() {
            const hari = document.getElementById('scheduleDay').value;
            const jamKe = parseInt(document.getElementById('scheduleJam').value);
            const kelas = document.getElementById('scheduleKelas').value;
            const rombel = document.getElementById('scheduleRombel').value;
            const warning = document.getElementById('conflictWarning');

            try {
                // Check if teacher already has class at this time
                const teacherConflict = await db.collection('users').doc(currentUser.uid)
                    .collection('jadwal')
                    .where('hari', '==', hari)
                    .where('jamKe', '==', jamKe)
                    .get();

                // Check if rombel already has PAI teacher at this time
                const rombelConflict = await db.collection('users').doc(currentUser.uid)
                    .collection('jadwal')
                    .where('hari', '==', hari)
                    .where('jamKe', '==', jamKe)
                    .where('kelas', '==', kelas)
                    .where('rombel', '==', rombel)
                    .get();

                if (!teacherConflict.empty || !rombelConflict.empty) {
                    warning.classList.remove('hidden');
                    if (!teacherConflict.empty) {
                        warning.innerHTML = '<p class="text-sm text-red-600"><i class="fas fa-exclamation-triangle mr-2"></i>Anda sudah memiliki jadwal di jam ini!</p>';
                    } else {
                        warning.innerHTML = '<p class="text-sm text-red-600"><i class="fas fa-exclamation-triangle mr-2"></i>Rombel ini sudah ada jadwal di jam tersebut!</p>';
                    }
                    return true;
                } else {
                    warning.classList.add('hidden');
                    return false;
                }
            } catch (error) {
                console.error('Error checking conflict:', error);
                return false;
            }
        }

        function closeScheduleModal() {
            document.getElementById('scheduleModal')?.remove();
        }

        async function deleteSchedule(scheduleId) {
            if (!confirm('Hapus jadwal ini?')) return;
            
            showLoading();
            try {
                await db.collection('users').doc(currentUser.uid).collection('jadwal').doc(scheduleId).delete();
                hideLoading();
                loadScheduleData();
                showToast('Jadwal dihapus', 'success');
            } catch (error) {
                hideLoading();
                showToast('Gagal menghapus jadwal', 'error');
            }
        }

        // CP & TP Page
        function loadCPTP() {
            const fase = getFaseByJenjang(userData?.jenjang);
            const isPAI = userData?.mapel === 'PAI';
            
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="p-4 lg:p-8">
                    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between mb-8">
                        <div>
                            <h1 class="text-2xl lg:text-3xl font-bold text-gray-800">Capaian & Tujuan Pembelajaran</h1>
                            <p class="text-gray-500 mt-1">Kelola CP dan TP untuk ${userData?.mapel || 'Mata Pelajaran'}</p>
                        </div>
                        <div class="mt-4 lg:mt-0 flex gap-2">
                            ${isPAI ? `
                            <button onclick="loadDefaultCP()" class="px-4 py-2 bg-yellow-500 text-white rounded-xl font-medium hover:bg-yellow-600 transition">
                                <i class="fas fa-magic mr-2"></i>Load CP Default PAI
                            </button>
                            ` : ''}
                            <button onclick="showAddTPModal()" class="px-4 py-2 bg-islamic-600 text-white rounded-xl font-medium hover:bg-islamic-700 transition">
                                <i class="fas fa-plus mr-2"></i>Tambah TP
                            </button>
                        </div>
                    </div>

                    <!-- Fase Info -->
                    <div class="bg-gradient-to-r from-islamic-600 to-islamic-500 rounded-2xl p-6 text-white mb-6">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 bg-white bg-opacity-20 rounded-2xl flex items-center justify-center">
                                <span class="text-3xl font-bold">${fase}</span>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold">Fase ${fase}</h3>
                                <p class="opacity-90">${userData?.jenjang || ''} - ${userData?.mapel || ''}</p>
                                <p class="text-sm opacity-75 mt-1">Berdasarkan Kepka BSKAP No. 046/H/KR/2025</p>
                            </div>
                        </div>
                    </div>

                    <!-- Filter -->
                    <div class="bg-white rounded-2xl shadow-sm p-4 mb-6">
                        <div class="flex flex-wrap gap-4">
                            <div class="flex-1 min-w-[200px]">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                                <select id="filterKelas" onchange="filterTP()" class="w-full px-4 py-2 border border-gray-200 rounded-xl">
                                    <option value="">Semua Kelas</option>
                                    ${generateKelasOptions(userData?.jenjang)}
                                </select>
                            </div>
                            <div class="flex-1 min-w-[200px]">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Elemen</label>
                                <select id="filterElemen" onchange="filterTP()" class="w-full px-4 py-2 border border-gray-200 rounded-xl">
                                    <option value="">Semua Elemen</option>
                                    <option value="Al-Quran">Al-Quran & Hadis</option>
                                    <option value="Akidah">Akidah</option>
                                    <option value="Akhlak">Akhlak</option>
                                    <option value="Fikih">Fikih</option>
                                    <option value="Sejarah">Sejarah Peradaban Islam</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- CP List -->
                    <div class="bg-white rounded-2xl shadow-sm p-6 mb-6">
                        <h3 class="font-bold text-gray-800 mb-4">Capaian Pembelajaran (CP)</h3>
                        <div id="cpList" class="space-y-4">
                            ${isPAI && CP_PAI_DEFAULT[fase] ? CP_PAI_DEFAULT[fase].elemen.map(el => `
                                <div class="p-4 bg-gray-50 rounded-xl border-l-4 border-islamic-500">
                                    <div class="flex items-start justify-between">
                                        <div>
                                            <span class="px-2 py-1 bg-islamic-100 text-islamic-700 text-xs font-bold rounded">${el.kode}</span>
                                            <h4 class="font-semibold text-gray-800 mt-2">${el.nama}</h4>
                                            <p class="text-sm text-gray-600 mt-1">${el.deskripsi}</p>
                                        </div>
                                    </div>
                                </div>
                            `).join('') : '<p class="text-gray-500 text-center py-4">Silakan input CP untuk mata pelajaran Anda</p>'}
                        </div>
                    </div>

                    <!-- TP List -->
                    <div class="bg-white rounded-2xl shadow-sm p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-bold text-gray-800">Tujuan Pembelajaran (TP)</h3>
                            <button onclick="showImportTPModal()" class="px-3 py-1 text-sm bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200">
                                <i class="fas fa-file-import mr-1"></i>Import CSV
                            </button>
                        </div>
                        <div id="tpList" class="space-y-3">
                            <p class="text-gray-500 text-center py-8">Belum ada Tujuan Pembelajaran. Klik "Tambah TP" untuk memulai.</p>
                        </div>
                    </div>
                </div>
            `;

            loadTPData();
        }

        function getFaseByJenjang(jenjang) {
            const faseMap = {
                'SD': { 1: 'A', 2: 'A', 3: 'B', 4: 'B', 5: 'C', 6: 'C' },
                'SMP': 'D',
                'SMA': { 10: 'E', 11: 'F', 12: 'F' },
                'SMK': { 10: 'E', 11: 'F', 12: 'F' }
            };
            if (jenjang === 'SD') return 'A-C';
            if (jenjang === 'SMP') return 'D';
            if (jenjang === 'SMA' || jenjang === 'SMK') return 'E-F';
            return 'D';
        }

        function generateKelasOptions(jenjang) {
            const kelasMap = {
                'SD': [1, 2, 3, 4, 5, 6],
                'SMP': [7, 8, 9],
                'SMA': [10, 11, 12],
                'SMK': [10, 11, 12]
            };
            return (kelasMap[jenjang] || [7, 8, 9]).map(k => `<option value="${k}">Kelas ${k}</option>`).join('');
        }

        async function loadDefaultCP() {
            showLoading();
            try {
                const fase = getFaseByJenjang(userData?.jenjang);
                const fases = fase.includes('-') ? fase.split('-') : [fase];
                
                for (const f of fases) {
                    if (CP_PAI_DEFAULT[f]) {
                        for (const elemen of CP_PAI_DEFAULT[f].elemen) {
                            await db.collection('users').doc(currentUser.uid).collection('cp').doc(elemen.kode).set({
                                ...elemen,
                                fase: f,
                                jenjang: userData.jenjang,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        }
                    }
                }
                
                hideLoading();
                showToast('CP Default PAI berhasil dimuat!', 'success');
                loadCPTP();
            } catch (error) {
                hideLoading();
                showToast('Gagal memuat CP Default', 'error');
                console.error(error);
            }
        }

        async function loadTPData() {
            try {
                const snapshot = await db.collection('users').doc(currentUser.uid)
                    .collection('tp').orderBy('kode').get();
                
                const tpList = document.getElementById('tpList');
                
                if (snapshot.empty) {
                    tpList.innerHTML = '<p class="text-gray-500 text-center py-8">Belum ada Tujuan Pembelajaran. Klik "Tambah TP" untuk memulai.</p>';
                    return;
                }

                tpList.innerHTML = snapshot.docs.map((doc, idx) => {
                    const data = doc.data();
                    return `
                        <div class="p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition">
                            <div class="flex items-start justify-between gap-4">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="px-2 py-1 bg-islamic-500 text-white text-xs font-bold rounded">${data.kode || `TP.${idx + 1}`}</span>
                                        <span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs font-medium rounded">${data.elemen || ''}</span>
                                        <span class="px-2 py-1 bg-gray-200 text-gray-600 text-xs font-medium rounded">Kelas ${data.kelas || ''}</span>
                                    </div>
                                    <p class="text-gray-800">${data.tujuan}</p>
                                    <p class="text-sm text-gray-500 mt-1">Alokasi: ${data.alokasi || 0} JP</p>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="editTP('${doc.id}')" class="p-2 text-blue-500 hover:bg-blue-50 rounded-lg">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteTP('${doc.id}')" class="p-2 text-red-500 hover:bg-red-50 rounded-lg">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading TP:', error);
            }
        }

        function showAddTPModal(editData = null) {
            const modal = document.createElement('div');
            modal.id = 'tpModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
                    <div class="p-6 border-b border-gray-100">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-bold text-gray-800">${editData ? 'Edit' : 'Tambah'} Tujuan Pembelajaran</h3>
                            <button onclick="closeTPModal()" class="p-2 hover:bg-gray-100 rounded-lg">
                                <i class="fas fa-times text-gray-500"></i>
                            </button>
                        </div>
                    </div>
                    <form id="tpForm" class="p-6 space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Kode TP</label>
                                <input type="text" id="tpKode" value="${editData?.kode || ''}" required
                                       class="w-full px-4 py-3 border border-gray-200 rounded-xl"
                                       placeholder="TP.1.1">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                                <select id="tpKelas" required class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                                    ${generateKelasOptions(userData?.jenjang)}
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Elemen</label>
                            <select id="tpElemen" required class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                                <option value="Al-Quran & Hadis">Al-Quran & Hadis</option>
                                <option value="Akidah">Akidah</option>
                                <option value="Akhlak">Akhlak</option>
                                <option value="Fikih">Fikih</option>
                                <option value="Sejarah Peradaban Islam">Sejarah Peradaban Islam</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tujuan Pembelajaran</label>
                            <textarea id="tpTujuan" rows="3" required
                                      class="w-full px-4 py-3 border border-gray-200 rounded-xl"
                                      placeholder="Peserta didik mampu...">${editData?.tujuan || ''}</textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Alokasi Waktu (JP)</label>
                            <input type="number" id="tpAlokasi" value="${editData?.alokasi || 2}" min="1" required
                                   class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Profil Pelajar Pancasila</label>
                            <div class="grid grid-cols-2 gap-2">
                                ${DIMENSI_PROFIL.map(d => `
                                    <label class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                                        <input type="checkbox" name="dimensi" value="${d.kode}" class="w-4 h-4 text-islamic-600 rounded">
                                        <span class="text-sm text-gray-700">${d.nama}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                        <input type="hidden" id="tpId" value="${editData?.id || ''}">
                        <button type="submit" class="w-full py-3 bg-islamic-600 text-white rounded-xl font-semibold hover:bg-islamic-700">
                            <i class="fas fa-save mr-2"></i>Simpan
                        </button>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);

            if (editData) {
                document.getElementById('tpKelas').value = editData.kelas;
                document.getElementById('tpElemen').value = editData.elemen;
            }

            document.getElementById('tpForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoading();

                const dimensiChecked = [...document.querySelectorAll('input[name="dimensi"]:checked')].map(cb => cb.value);
                const tpData = {
                    kode: document.getElementById('tpKode').value,
                    kelas: document.getElementById('tpKelas').value,
                    elemen: document.getElementById('tpElemen').value,
                    tujuan: document.getElementById('tpTujuan').value,
                    alokasi: parseInt(document.getElementById('tpAlokasi').value),
                    dimensiProfil: dimensiChecked,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                try {
                    const tpId = document.getElementById('tpId').value;
                    if (tpId) {
                        await db.collection('users').doc(currentUser.uid).collection('tp').doc(tpId).update(tpData);
                    } else {
                        tpData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        await db.collection('users').doc(currentUser.uid).collection('tp').add(tpData);
                    }

                    hideLoading();
                    closeTPModal();
                    loadTPData();
                    showToast('Tujuan Pembelajaran berhasil disimpan', 'success');
                } catch (error) {
                    hideLoading();
                    showToast('Gagal menyimpan', 'error');
                    console.error(error);
                }
            });
        }

        function closeTPModal() {
            document.getElementById('tpModal')?.remove();
        }

        async function deleteTP(tpId) {
            if (!confirm('Hapus Tujuan Pembelajaran ini?')) return;
            
            showLoading();
            try {
                await db.collection('users').doc(currentUser.uid).collection('tp').doc(tpId).delete();
                hideLoading();
                loadTPData();
                showToast('TP dihapus', 'success');
            } catch (error) {
                hideLoading();
                showToast('Gagal menghapus', 'error');
            }
        }

        function showImportTPModal() {
            const modal = document.createElement('div');
            modal.id = 'importTPModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg">
                    <div class="p-6 border-b border-gray-100">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-bold text-gray-800">Import TP dari CSV</h3>
                            <button onclick="closeImportTPModal()" class="p-2 hover:bg-gray-100 rounded-lg">
                                <i class="fas fa-times text-gray-500"></i>
                            </button>
                        </div>
                    </div>
                    <div class="p-6 space-y-4">
                        <div class="bg-blue-50 p-4 rounded-xl">
                            <p class="text-sm text-blue-800 mb-2"><strong>Format CSV:</strong></p>
                            <code class="text-xs bg-blue-100 p-2 rounded block">kode,kelas,elemen,tujuan,alokasi</code>
                            <p class="text-xs text-blue-600 mt-2">Contoh: TP.1.1,7,Akidah,Peserta didik mampu...,2</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">URL Google Spreadsheet (Published)</label>
                            <input type="url" id="csvUrl" 
                                   class="w-full px-4 py-3 border border-gray-200 rounded-xl"
                                   placeholder="https://docs.google.com/spreadsheets/d/.../pub?output=csv">
                        </div>
                        <p class="text-center text-gray-400 text-sm">atau</p>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Upload File CSV</label>
                            <input type="file" id="csvFile" accept=".csv"
                                   class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                        </div>
                        <button onclick="processImportTP()" class="w-full py-3 bg-islamic-600 text-white rounded-xl font-semibold hover:bg-islamic-700">
                            <i class="fas fa-file-import mr-2"></i>Import Data
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeImportTPModal() {
            document.getElementById('importTPModal')?.remove();
        }

        async function processImportTP() {
            showLoading();
            
            const csvUrl = document.getElementById('csvUrl').value;
            const csvFile = document.getElementById('csvFile').files[0];
            
            try {
                let csvText = '';
                
                if (csvUrl) {
                    const response = await fetch(csvUrl);
                    csvText = await response.text();
                } else if (csvFile) {
                    csvText = await csvFile.text();
                } else {
                    hideLoading();
                    showToast('Masukkan URL atau pilih file CSV', 'warning');
                    return;
                }

                const lines = csvText.trim().split('\n');
                const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                
                let imported = 0;
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',');
                    if (values.length >= 4) {
                        const tpData = {
                            kode: values[0]?.trim() || `TP.${i}`,
                            kelas: values[1]?.trim() || '7',
                            elemen: values[2]?.trim() || 'Akidah',
                            tujuan: values[3]?.trim() || '',
                            alokasi: parseInt(values[4]?.trim()) || 2,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        
                        if (tpData.tujuan) {
                            await db.collection('users').doc(currentUser.uid).collection('tp').add(tpData);
                            imported++;
                        }
                    }
                }

                hideLoading();
                closeImportTPModal();
                loadTPData();
                showToast(`${imported} TP berhasil diimport!`, 'success');
            } catch (error) {
                hideLoading();
                showToast('Gagal import data: ' + error.message, 'error');
                console.error(error);
            }
        }

        // Students Page
        function loadStudents() {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="p-4 lg:p-8">
                    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between mb-8">
                        <div>
                            <h1 class="text-2xl lg:text-3xl font-bold text-gray-800">Data Siswa</h1>
                            <p class="text-gray-500 mt-1">Kelola data peserta didik</p>
                        </div>
                        <div class="mt-4 lg:mt-0 flex gap-2">
                            <button onclick="showImportStudentsModal()" class="px-4 py-2 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 transition">
                                <i class="fas fa-file-import mr-2"></i>Import CSV
                            </button>
                            <button onclick="showAddStudentModal()" class="px-4 py-2 bg-islamic-600 text-white rounded-xl font-medium hover:bg-islamic-700 transition">
                                <i class="fas fa-plus mr-2"></i>Tambah Siswa
                            </button>
                        </div>
                    </div>

                    <!-- AI Prompt Guide -->
                    <div class="bg-gradient-to-r from-purple-600 to-purple-500 rounded-2xl p-6 text-white mb-6">
                        <div class="flex items-start gap-4">
                            <div class="w-12 h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-robot text-xl"></i>
                            </div>
                            <div>
                                <h3 class="font-bold mb-2">Prompt AI untuk Generate Data Siswa</h3>
                                <div class="bg-black bg-opacity-20 rounded-xl p-3 font-mono text-xs">
                                    <code>"Buatlah file CSV dengan kolom: nisn,nama_siswa,jenis_kelamin,kelas,rombel. Isi dengan 30 data siswa Indonesia untuk kelas 7A SMP. Gunakan L untuk laki-laki dan P untuk perempuan. NISN 10 digit angka."</code>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Filter -->
                    <div class="bg-white rounded-2xl shadow-sm p-4 mb-6">
                        <div class="flex flex-wrap gap-4">
                            <div class="flex-1 min-w-[150px]">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                                <select id="filterStudentKelas" onchange="filterStudents()" class="w-full px-4 py-2 border border-gray-200 rounded-xl">
                                    <option value="">Semua Kelas</option>
                                    ${generateKelasOptions(userData?.jenjang)}
                                </select>
                            </div>
                            <div class="flex-1 min-w-[150px]">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Rombel</label>
                                <select id="filterStudentRombel" onchange="filterStudents()" class="w-full px-4 py-2 border border-gray-200 rounded-xl">
                                    <option value="">Semua Rombel</option>
                                    <option value="A">A</option>
                                    <option value="B">B</option>
                                    <option value="C">C</option>
                                    <option value="D">D</option>
                                </select>
                            </div>
                            <div class="flex-1 min-w-[200px]">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Cari</label>
                                <input type="text" id="searchStudent" onkeyup="filterStudents()" 
                                       class="w-full px-4 py-2 border border-gray-200 rounded-xl"
                                       placeholder="Nama atau NISN...">
                            </div>
                        </div>
                    </div>

                    <!-- Students Stats -->
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div class="bg-white rounded-xl shadow-sm p-4">
                            <p class="text-sm text-gray-500">Total Siswa</p>
                            <p id="statTotalSiswa" class="text-2xl font-bold text-gray-800">0</p>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm p-4">
                            <p class="text-sm text-gray-500">Laki-laki</p>
                            <p id="statLakiLaki" class="text-2xl font-bold text-blue-600">0</p>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm p-4">
                            <p class="text-sm text-gray-500">Perempuan</p>
                            <p id="statPerempuan" class="text-2xl font-bold text-pink-600">0</p>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm p-4">
                            <p class="text-sm text-gray-500">Jumlah Rombel</p>
                            <p id="statRombel" class="text-2xl font-bold text-gray-800">0</p>
                        </div>
                    </div>

                    <!-- Students Table -->
                    <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">No</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">NISN</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Nama Siswa</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">L/P</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Kelas</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="studentsTableBody">
                                    <tr>
                                        <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                                            Belum ada data siswa. Klik "Import CSV" atau "Tambah Siswa".
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            loadStudentsData();
        }

        let allStudents = [];

        async function loadStudentsData() {
            try {
                const snapshot = await db.collection('users').doc(currentUser.uid)
                    .collection('students').orderBy('kelas').orderBy('rombel').orderBy('nama').get();
                
                allStudents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Update stats
                document.getElementById('statTotalSiswa').textContent = allStudents.length;
                document.getElementById('statLakiLaki').textContent = allStudents.filter(s => s.jenis_kelamin === 'L').length;
                document.getElementById('statPerempuan').textContent = allStudents.filter(s => s.jenis_kelamin === 'P').length;
                
                const rombels = new Set(allStudents.map(s => `${s.kelas}${s.rombel}`));
                document.getElementById('statRombel').textContent = rombels.size;

                renderStudentsTable(allStudents);
            } catch (error) {
                console.error('Error loading students:', error);
            }
        }

        function renderStudentsTable(students) {
            const tbody = document.getElementById('studentsTableBody');
            
            if (students.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                            Tidak ada data yang sesuai filter.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = students.map((student, idx) => `
                <tr class="border-t border-gray-100 hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm text-gray-600">${idx + 1}</td>
                    <td class="px-4 py-3 text-sm font-mono text-gray-800">${student.nisn || '-'}</td>
                    <td class="px-4 py-3 text-sm font-medium text-gray-800">${student.nama}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 text-xs font-medium rounded ${student.jenis_kelamin === 'L' ? 'bg-blue-100 text-blue-700' : 'bg-pink-100 text-pink-700'}">
                            ${student.jenis_kelamin}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-600">${student.kelas}${student.rombel}</td>
                    <td class="px-4 py-3">
                        <div class="flex gap-2">
                            <button onclick="editStudent('${student.id}')" class="p-2 text-blue-500 hover:bg-blue-50 rounded-lg">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteStudent('${student.id}')" class="p-2 text-red-500 hover:bg-red-50 rounded-lg">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function filterStudents() {
            const kelas = document.getElementById('filterStudentKelas').value;
            const rombel = document.getElementById('filterStudentRombel').value;
            const search = document.getElementById('searchStudent').value.toLowerCase();

            const filtered = allStudents.filter(s => {
                const matchKelas = !kelas || s.kelas == kelas;
                const matchRombel = !rombel || s.rombel === rombel;
                const matchSearch = !search || s.nama.toLowerCase().includes(search) || s.nisn?.includes(search);
                return matchKelas && matchRombel && matchSearch;
            });

            renderStudentsTable(filtered);
        }

        function showAddStudentModal(editData = null) {
            const modal = document.createElement('div');
            modal.id = 'studentModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md">
                    <div class="p-6 border-b border-gray-100">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-bold text-gray-800">${editData ? 'Edit' : 'Tambah'} Siswa</h3>
                            <button onclick="closeStudentModal()" class="p-2 hover:bg-gray-100 rounded-lg">
                                <i class="fas fa-times text-gray-500"></i>
                            </button>
                        </div>
                    </div>
                    <form id="studentForm" class="p-6 space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">NISN</label>
                            <input type="text" id="studentNISN" value="${editData?.nisn || ''}"
                                   class="w-full px-4 py-3 border border-gray-200 rounded-xl"
                                   placeholder="0012345678" maxlength="10">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap</label>
                            <input type="text" id="studentNama" value="${editData?.nama || ''}" required
                                   class="w-full px-4 py-3 border border-gray-200 rounded-xl"
                                   placeholder="Ahmad Fauzi">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Kelamin</label>
                                <select id="studentJK" required class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                                    <option value="L" ${editData?.jenis_kelamin === 'L' ? 'selected' : ''}>Laki-laki</option>
                                    <option value="P" ${editData?.jenis_kelamin === 'P' ? 'selected' : ''}>Perempuan</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                                <select id="studentKelas" required class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                                    ${generateKelasOptions(userData?.jenjang)}
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Rombel</label>
                            <select id="studentRombel" required class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="C">C</option>
                                <option value="D">D</option>
                                <option value="E">E</option>
                                <option value="F">F</option>
                            </select>
                        </div>
                        <input type="hidden" id="studentId" value="${editData?.id || ''}">
                        <button type="submit" class="w-full py-3 bg-islamic-600 text-white rounded-xl font-semibold hover:bg-islamic-700">
                            <i class="fas fa-save mr-2"></i>Simpan
                        </button>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);

            if (editData) {
                document.getElementById('studentKelas').value = editData.kelas;
                document.getElementById('studentRombel').value = editData.rombel;
            }

            document.getElementById('studentForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoading();

                const studentData = {
                    nisn: document.getElementById('studentNISN').value,
                    nama: document.getElementById('studentNama').value,
                    jenis_kelamin: document.getElementById('studentJK').value,
                    kelas: document.getElementById('studentKelas').value,
                    rombel: document.getElementById('studentRombel').value,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                try {
                    const studentId = document.getElementById('studentId').value;
                    if (studentId) {
                        await db.collection('users').doc(currentUser.uid).collection('students').doc(studentId).update(studentData);
                    } else {
                        studentData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        await db.collection('users').doc(currentUser.uid).collection('students').add(studentData);
                    }

                    hideLoading();
                    closeStudentModal();
                    loadStudentsData();
                    showToast('Data siswa berhasil disimpan', 'success');
                } catch (error) {
                    hideLoading();
                    showToast('Gagal menyimpan', 'error');
                }
            });
        }

        function closeStudentModal() {
            document.getElementById('studentModal')?.remove();
        }

        function editStudent(studentId) {
            const student = allStudents.find(s => s.id === studentId);
            if (student) {
                showAddStudentModal(student);
            }
        }

        async function deleteStudent(studentId) {
            if (!confirm('Hapus data siswa ini?')) return;
            
            showLoading();
            try {
                await db.collection('users').doc(currentUser.uid).collection('students').doc(studentId).delete();
                hideLoading();
                loadStudentsData();
                showToast('Data siswa dihapus', 'success');
            } catch (error) {
                hideLoading();
                showToast('Gagal menghapus', 'error');
            }
        }

        function showImportStudentsModal() {
            const modal = document.createElement('div');
            modal.id = 'importStudentsModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg">
                    <div class="p-6 border-b border-gray-100">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-bold text-gray-800">Import Data Siswa</h3>
                            <button onclick="closeImportStudentsModal()" class="p-2 hover:bg-gray-100 rounded-lg">
                                <i class="fas fa-times text-gray-500"></i>
                            </button>
                        </div>
                    </div>
                    <div class="p-6 space-y-4">
                        <div class="bg-blue-50 p-4 rounded-xl">
                            <p class="text-sm text-blue-800 mb-2"><strong>Format CSV:</strong></p>
                            <code class="text-xs bg-blue-100 p-2 rounded block">nisn,nama_siswa,jenis_kelamin,kelas,rombel</code>
                            <p class="text-xs text-blue-600 mt-2">Contoh: 0012345678,Ahmad Fauzi,L,7,A</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">URL Google Spreadsheet</label>
                            <input type="url" id="studentCsvUrl" 
                                   class="w-full px-4 py-3 border border-gray-200 rounded-xl"
                                   placeholder="https://docs.google.com/spreadsheets/d/.../pub?output=csv">
                            <p class="text-xs text-gray-500 mt-1">Pastikan spreadsheet sudah dipublish sebagai CSV</p>
                        </div>
                        <p class="text-center text-gray-400 text-sm">atau</p>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Upload File CSV</label>
                            <input type="file" id="studentCsvFile" accept=".csv"
                                   class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                        </div>
                        <button onclick="processImportStudents()" class="w-full py-3 bg-islamic-600 text-white rounded-xl font-semibold hover:bg-islamic-700">
                            <i class="fas fa-file-import mr-2"></i>Import Data
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeImportStudentsModal() {
            document.getElementById('importStudentsModal')?.remove();
        }

        async function processImportStudents() {
            showLoading();
            
            const csvUrl = document.getElementById('studentCsvUrl').value;
            const csvFile = document.getElementById('studentCsvFile').files[0];
            
            try {
                let csvText = '';
                
                if (csvUrl) {
                    const response = await fetch(csvUrl);
                    csvText = await response.text();
                } else if (csvFile) {
                    csvText = await csvFile.text();
                } else {
                    hideLoading();
                    showToast('Masukkan URL atau pilih file CSV', 'warning');
                    return;
                }

                const lines = csvText.trim().split('\n');
                
                let imported = 0;
                const batch = db.batch();
                
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                    if (values.length >= 5 && values[1]) {
                        const studentRef = db.collection('users').doc(currentUser.uid).collection('students').doc();
                        batch.set(studentRef, {
                            nisn: values[0] || '',
                            nama: values[1],
                            jenis_kelamin: values[2]?.toUpperCase() === 'P' ? 'P' : 'L',
                            kelas: values[3] || '7',
                            rombel: values[4]?.toUpperCase() || 'A',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        imported++;
                    }
                }

                await batch.commit();

                hideLoading();
                closeImportStudentsModal();
                loadStudentsData();
                showToast(`${imported} siswa berhasil diimport!`, 'success');
            } catch (error) {
                hideLoading();
                showToast('Gagal import: ' + error.message, 'error');
                console.error(error);
            }
        }

        // ATP Page
        function loadATP() {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="p-4 lg:p-8">
                    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between mb-8">
                        <div>
                            <h1 class="text-2xl lg:text-3xl font-bold text-gray-800">Alur Tujuan Pembelajaran (ATP)</h1>
                            <p class="text-gray-500 mt-1">ATP dihasilkan otomatis dari data Tujuan Pembelajaran</p>
                        </div>
                        <div class="mt-4 lg:mt-0 flex gap-2">
                            <button onclick="generateATP()" class="px-4 py-2 bg-yellow-500 text-white rounded-xl font-medium hover:bg-yellow-600 transition">
                                <i class="fas fa-magic mr-2"></i>Generate ATP
                            </button>
                            <button onclick="exportATP()" class="px-4 py-2 bg-islamic-600 text-white rounded-xl font-medium hover:bg-islamic-700 transition">
                                <i class="fas fa-file-export mr-2"></i>Export
                            </button>
                        </div>
                    </div>

                    <!-- Info Banner -->
                    <div class="bg-blue-50 border border-blue-200 rounded-2xl p-4 mb-6">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-info-circle text-blue-500 mt-1"></i>
                            <div>
                                <p class="text-sm text-blue-800">
                                    <strong>ATP (Alur Tujuan Pembelajaran)</strong> adalah rangkaian tujuan pembelajaran yang disusun secara sistematis dan logis.
                                    ATP akan di-generate otomatis berdasarkan TP yang sudah Anda input.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Filter -->
                    <div class="bg-white rounded-2xl shadow-sm p-4 mb-6">
                        <div class="flex flex-wrap gap-4">
                            <div class="flex-1 min-w-[150px]">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                                <select id="atpFilterKelas" onchange="loadATPData()" class="w-full px-4 py-2 border border-gray-200 rounded-xl">
                                    <option value="">Semua Kelas</option>
                                    ${generateKelasOptions(userData?.jenjang)}
                                </select>
                            </div>
                            <div class="flex-1 min-w-[150px]">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Semester</label>
                                <select id="atpFilterSemester" onchange="loadATPData()" class="w-full px-4 py-2 border border-gray-200 rounded-xl">
                                    <option value="">Semua Semester</option>
                                    <option value="1">Semester 1</option>
                                    <option value="2">Semester 2</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- ATP Table -->
                    <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">No</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Kode</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Elemen</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Tujuan Pembelajaran</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Alokasi</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Profil</th>
                                    </tr>
                                </thead>
                                <tbody id="atpTableBody">
                                    <tr>
                                        <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                                            Klik "Generate ATP" untuk membuat ATP dari data TP.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            loadATPData();
        }

        async function loadATPData() {
            try {
                const kelas = document.getElementById('atpFilterKelas')?.value || '';
                let query = db.collection('users').doc(currentUser.uid).collection('tp').orderBy('kode');
                
                const snapshot = await query.get();
                const tbody = document.getElementById('atpTableBody');

                if (snapshot.empty) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                                Belum ada data TP. Silakan input TP terlebih dahulu di menu CP & TP.
                            </td>
                        </tr>
                    `;
                    return;
                }

                let tpData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                if (kelas) {
                    tpData = tpData.filter(tp => tp.kelas === kelas);
                }

                tbody.innerHTML = tpData.map((tp, idx) => `
                    <tr class="border-t border-gray-100 hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm text-gray-600">${idx + 1}</td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 bg-islamic-100 text-islamic-700 text-xs font-bold rounded">${tp.kode}</span>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600">${tp.elemen}</td>
                        <td class="px-4 py-3 text-sm text-gray-800 max-w-md">${tp.tujuan}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${tp.alokasi} JP</td>
                        <td class="px-4 py-3">
                            <div class="flex flex-wrap gap-1">
                                ${(tp.dimensiProfil || []).map(d => `
                                    <span class="px-1 py-0.5 bg-purple-100 text-purple-700 text-xs rounded">${d}</span>
                                `).join('')}
                            </div>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading ATP:', error);
            }
        }

        async function generateATP() {
            showToast('ATP di-generate dari data TP yang ada', 'info');
            loadATPData();
        }

        function exportATP() {
            showToast('Fitur export akan segera tersedia', 'info');
        }

        // Prota Page
        function loadProta() {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="p-4 lg:p-8">
                    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between mb-8">
                        <div>
                            <h1 class="text-2xl lg:text-3xl font-bold text-gray-800">Program Tahunan (Prota)</h1>
                            <p class="text-gray-500 mt-1">Rencana pembelajaran selama satu tahun ajaran</p>
                        </div>
                        <div class="mt-4 lg:mt-0 flex gap-2">
                            <button onclick="generateProta()" class="px-4 py-2 bg-yellow-500 text-white rounded-xl font-medium hover:bg-yellow-600 transition">
                                <i class="fas fa-magic mr-2"></i>Generate Prota
                            </button>
                            <button onclick="exportProta()" class="px-4 py-2 bg-islamic-600 text-white rounded-xl font-medium hover:bg-islamic-700 transition">
                                <i class="fas fa-file-export mr-2"></i>Export
                            </button>
                        </div>
                    </div>

                    <!-- Prota Header Info -->
                    <div class="bg-white rounded-2xl shadow-sm p-6 mb-6">
                        <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Satuan Pendidikan</label>
                                <input type="text" value="${userData?.profile?.namaSekolah || ''}" disabled
                                       class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-xl text-gray-600">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Mata Pelajaran</label>
                                <input type="text" value="${userData?.mapel || ''}" disabled
                                       class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-xl text-gray-600">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                                <select id="protaKelas" onchange="generateProta()" class="w-full px-4 py-2 border border-gray-200 rounded-xl">
                                    ${generateKelasOptions(userData?.jenjang)}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tahun Pelajaran</label>
                                <input type="text" value="${userData?.profile?.tahunAjar || '2024/2025'}" disabled
                                       class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-xl text-gray-600">
                            </div>
                        </div>
                    </div>

                    <!-- Prota Table -->
                    <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th rowspan="2" class="px-4 py-3 text-center text-sm font-semibold text-gray-600 border-r">No</th>
                                        <th rowspan="2" class="px-4 py-3 text-center text-sm font-semibold text-gray-600 border-r">Kode</th>
                                        <th rowspan="2" class="px-4 py-3 text-left text-sm font-semibold text-gray-600 border-r">Tujuan Pembelajaran</th>
                                        <th colspan="2" class="px-4 py-3 text-center text-sm font-semibold text-gray-600 border-r bg-blue-50">Semester 1</th>
                                        <th colspan="2" class="px-4 py-3 text-center text-sm font-semibold text-gray-600 bg-green-50">Semester 2</th>
                                    </tr>
                                    <tr>
                                        <th class="px-4 py-2 text-center text-xs font-semibold text-gray-600 border-r bg-blue-50">JP</th>
                                        <th class="px-4 py-2 text-center text-xs font-semibold text-gray-600 border-r bg-blue-50">Ket</th>
                                        <th class="px-4 py-2 text-center text-xs font-semibold text-gray-600 bg-green-50">JP</th>
                                        <th class="px-4 py-2 text-center text-xs font-semibold text-gray-600 bg-green-50">Ket</th>
                                    </tr>
                                </thead>
                                <tbody id="protaTableBody">
                                    <tr>
                                        <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                                            Pilih kelas dan klik "Generate Prota" untuk membuat Program Tahunan.
                                        </td>
                                    </tr>
                                </tbody>
                                <tfoot class="bg-gray-50">
                                    <tr>
                                        <td colspan="3" class="px-4 py-3 text-right font-semibold text-gray-700">Total JP:</td>
                                        <td id="protaTotalSem1" class="px-4 py-3 text-center font-bold text-blue-600">0</td>
                                        <td class="px-4 py-3"></td>
                                        <td id="protaTotalSem2" class="px-4 py-3 text-center font-bold text-green-600">0</td>
                                        <td class="px-4 py-3"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        async function generateProta() {
            showLoading();
            try {
                const kelas = document.getElementById('protaKelas').value;
                const snapshot = await db.collection('users').doc(currentUser.uid)
                    .collection('tp').where('kelas', '==', kelas).orderBy('kode').get();

                const tbody = document.getElementById('protaTableBody');
                let totalSem1 = 0;
                let totalSem2 = 0;

                if (snapshot.empty) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                                Tidak ada TP untuk kelas ${kelas}. Silakan input TP terlebih dahulu.
                            </td>
                        </tr>
                    `;
                    hideLoading();
                    return;
                }

                const tpData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const half = Math.ceil(tpData.length / 2);

                tbody.innerHTML = tpData.map((tp, idx) => {
                    const isSem1 = idx < half;
                    const jp = tp.alokasi || 2;
                    
                    if (isSem1) totalSem1 += jp;
                    else totalSem2 += jp;

                    return `
                        <tr class="border-t border-gray-100 hover:bg-gray-50">
                            <td class="px-4 py-3 text-center text-sm text-gray-600 border-r">${idx + 1}</td>
                            <td class="px-4 py-3 text-center border-r">
                                <span class="px-2 py-1 bg-islamic-100 text-islamic-700 text-xs font-bold rounded">${tp.kode}</span>
                            </td>
                            <td class="px-4 py-3 text-sm text-gray-800 border-r">${tp.tujuan}</td>
                            <td class="px-4 py-3 text-center text-sm border-r ${isSem1 ? 'bg-blue-50 font-medium' : ''}">${isSem1 ? jp : '-'}</td>
                            <td class="px-4 py-3 text-center text-sm border-r ${isSem1 ? 'bg-blue-50' : ''}"></td>
                            <td class="px-4 py-3 text-center text-sm ${!isSem1 ? 'bg-green-50 font-medium' : ''}">${!isSem1 ? jp : '-'}</td>
                            <td class="px-4 py-3 text-center text-sm ${!isSem1 ? 'bg-green-50' : ''}"></td>
                        </tr>
                    `;
                }).join('');

                document.getElementById('protaTotalSem1').textContent = totalSem1;
                document.getElementById('protaTotalSem2').textContent = totalSem2;

                hideLoading();
                showToast('Prota berhasil di-generate!', 'success');
            } catch (error) {
                hideLoading();
                showToast('Gagal generate Prota', 'error');
                console.error(error);
            }
        }

        function exportProta() {
            showToast('Fitur export akan segera tersedia', 'info');
        }

        // Promes Page
        function loadPromes() {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="p-4 lg:p-8">
                    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between mb-8">
                        <div>
                            <h1 class="text-2xl lg:text-3xl font-bold text-gray-800">Program Semester (Promes)</h1>
                            <p class="text-gray-500 mt-1">Rencana pembelajaran per semester dengan alokasi per minggu</p>
                        </div>
                        <div class="mt-4 lg:mt-0 flex gap-2">
                            <button onclick="generatePromes()" class="px-4 py-2 bg-yellow-500 text-white rounded-xl font-medium hover:bg-yellow-600 transition">
                                <i class="fas fa-magic mr-2"></i>Generate Promes
                            </button>
                            <button onclick="exportPromes()" class="px-4 py-2 bg-islamic-600 text-white rounded-xl font-medium hover:bg-islamic-700 transition">
                                <i class="fas fa-file-export mr-2"></i>Export
                            </button>
                        </div>
                    </div>

                    <!-- Filter -->
                    <div class="bg-white rounded-2xl shadow-sm p-4 mb-6">
                        <div class="grid md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                                <select id="promesKelas" class="w-full px-4 py-2 border border-gray-200 rounded-xl">
                                    ${generateKelasOptions(userData?.jenjang)}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Semester</label>
                                <select id="promesSemester" class="w-full px-4 py-2 border border-gray-200 rounded-xl">
                                    <option value="1">Semester 1 (Ganjil)</option>
                                    <option value="2">Semester 2 (Genap)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">JP per Minggu</label>
                                <input type="number" id="promesJPPerMinggu" value="3" min="1" max="10"
                                       class="w-full px-4 py-2 border border-gray-200 rounded-xl">
                            </div>
                        </div>
                    </div>

                    <!-- Promes Table -->
                    <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th rowspan="2" class="px-3 py-2 text-center font-semibold text-gray-600 border">No</th>
                                        <th rowspan="2" class="px-3 py-2 text-center font-semibold text-gray-600 border">Kode</th>
                                        <th rowspan="2" class="px-3 py-2 text-left font-semibold text-gray-600 border min-w-[200px]">Tujuan Pembelajaran</th>
                                        <th rowspan="2" class="px-3 py-2 text-center font-semibold text-gray-600 border">JP</th>
                                        <th colspan="4" class="px-3 py-2 text-center font-semibold text-gray-600 border bg-blue-50">Juli</th>
                                        <th colspan="4" class="px-3 py-2 text-center font-semibold text-gray-600 border bg-green-50">Agustus</th>
                                        <th colspan="4" class="px-3 py-2 text-center font-semibold text-gray-600 border bg-yellow-50">September</th>
                                        <th colspan="4" class="px-3 py-2 text-center font-semibold text-gray-600 border bg-purple-50">Oktober</th>
                                    </tr>
                                    <tr>
                                        ${[1,2,3,4].map(w => '<th class="px-2 py-1 text-center text-xs text-gray-500 border bg-blue-50">'+w+'</th>').join('')}
                                        ${[1,2,3,4].map(w => '<th class="px-2 py-1 text-center text-xs text-gray-500 border bg-green-50">'+w+'</th>').join('')}
                                        ${[1,2,3,4].map(w => '<th class="px-2 py-1 text-center text-xs text-gray-500 border bg-yellow-50">'+w+'</th>').join('')}
                                        ${[1,2,3,4].map(w => '<th class="px-2 py-1 text-center text-xs text-gray-500 border bg-purple-50">'+w+'</th>').join('')}
                                    </tr>
                                </thead>
                                <tbody id="promesTableBody">
                                    <tr>
                                        <td colspan="20" class="px-4 py-8 text-center text-gray-500">
                                            Pilih kelas dan semester, lalu klik "Generate Promes".
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        async function generatePromes() {
            showLoading();
            try {
                const kelas = document.getElementById('promesKelas').value;
                const semester = document.getElementById('promesSemester').value;
                const jpPerMinggu = parseInt(document.getElementById('promesJPPerMinggu').value);

                const snapshot = await db.collection('users').doc(currentUser.uid)
                    .collection('tp').where('kelas', '==', kelas).orderBy('kode').get();

                const tbody = document.getElementById('promesTableBody');

                if (snapshot.empty) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="20" class="px-4 py-8 text-center text-gray-500">
                                Tidak ada TP untuk kelas ${kelas}. Silakan input TP terlebih dahulu.
                            </td>
                        </tr>
                    `;
                    hideLoading();
                    return;
                }

                const allTP = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const half = Math.ceil(allTP.length / 2);
                const tpData = semester === '1' ? allTP.slice(0, half) : allTP.slice(half);

                let currentWeek = 0;
                tbody.innerHTML = tpData.map((tp, idx) => {
                    const jp = tp.alokasi || 2;
                    const weeksNeeded = Math.ceil(jp / jpPerMinggu);
                    
                    let weekCells = '';
                    for (let m = 0; m < 4; m++) {
                        for (let w = 0; w < 4; w++) {
                            const globalWeek = m * 4 + w;
                            const isActive = globalWeek >= currentWeek && globalWeek < currentWeek + weeksNeeded;
                            weekCells += `<td class="px-2 py-1 text-center border ${isActive ? 'bg-islamic-500 text-white font-bold' : ''}">${isActive ? jp : ''}</td>`;
                        }
                    }
                    currentWeek += weeksNeeded;

                    return `
                        <tr class="hover:bg-gray-50">
                            <td class="px-3 py-2 text-center border">${idx + 1}</td>
                            <td class="px-3 py-2 text-center border">
                                <span class="px-2 py-1 bg-islamic-100 text-islamic-700 text-xs font-bold rounded">${tp.kode}</span>
                            </td>
                            <td class="px-3 py-2 border text-gray-800">${tp.tujuan.substring(0, 80)}${tp.tujuan.length > 80 ? '...' : ''}</td>
                            <td class="px-3 py-2 text-center border font-medium">${jp}</td>
                            ${weekCells}
                        </tr>
                    `;
                }).join('');

                hideLoading();
                showToast('Promes berhasil di-generate!', 'success');
            } catch (error) {
                hideLoading();
                showToast('Gagal generate Promes', 'error');
                console.error(error);
            }
        }

        function exportPromes() {
            showToast('Fitur export akan segera tersedia', 'info');
        }

        // Modul Ajar Page (Premium)
        function loadModulAjar() {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="p-4 lg:p-8">
                    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between mb-8">
                        <div>
                            <h1 class="text-2xl lg:text-3xl font-bold text-gray-800">
                                Modul Ajar
                                <span class="ml-2 px-2 py-1 text-xs font-bold bg-yellow-400 text-yellow-900 rounded-full">PREMIUM</span>
                            </h1>
                            <p class="text-gray-500 mt-1">Buat dan kelola modul ajar berbasis TP</p>
                        </div>
                        <div class="mt-4 lg:mt-0">
                            <button onclick="showAddModulModal()" class="px-4 py-2 bg-islamic-600 text-white rounded-xl font-medium hover:bg-islamic-700 transition">
                                <i class="fas fa-plus mr-2"></i>Buat Modul Ajar
                            </button>
                        </div>
                    </div>

                    <!-- Modul List -->
                    <div id="modulList" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="col-span-full text-center py-12 text-gray-500">
                            <i class="fas fa-book-open text-6xl text-gray-300 mb-4"></i>
                            <p>Belum ada Modul Ajar. Klik "Buat Modul Ajar" untuk memulai.</p>
                        </div>
                    </div>
                </div>
            `;

            loadModulData();
        }

        async function loadModulData() {
            try {
                const snapshot = await db.collection('users').doc(currentUser.uid)
                    .collection('modul_ajar').orderBy('createdAt', 'desc').get();

                const modulList = document.getElementById('modulList');

                if (snapshot.empty) {
                    modulList.innerHTML = `
                        <div class="col-span-full text-center py-12 text-gray-500">
                            <i class="fas fa-book-open text-6xl text-gray-300 mb-4"></i>
                            <p>Belum ada Modul Ajar. Klik "Buat Modul Ajar" untuk memulai.</p>
                        </div>
                    `;
                    return;
                }

                modulList.innerHTML = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return `
                        <div class="bg-white rounded-2xl shadow-sm p-6 card-hover">
                            <div class="flex items-start justify-between mb-4">
                                <span class="px-3 py-1 bg-islamic-100 text-islamic-700 text-xs font-bold rounded-full">Kelas ${data.kelas}</span>
                                <div class="flex gap-1">
                                    <button onclick="viewModul('${doc.id}')" class="p-2 text-blue-500 hover:bg-blue-50 rounded-lg">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button onclick="deleteModul('${doc.id}')" class="p-2 text-red-500 hover:bg-red-50 rounded-lg">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <h3 class="font-bold text-gray-800 mb-2">${data.judul || 'Modul Tanpa Judul'}</h3>
                            <p class="text-sm text-gray-500 mb-4">${data.deskripsi?.substring(0, 100) || 'Tidak ada deskripsi'}...</p>
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-400">${data.alokasi || 0} JP</span>
                                ${data.lkpdEnabled ? '<span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded">+LKPD</span>' : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading modul:', error);
            }
        }

        function showAddModulModal() {
            const modal = document.createElement('div');
            modal.id = 'modulModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                    <div class="p-6 border-b border-gray-100 sticky top-0 bg-white">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-bold text-gray-800">Buat Modul Ajar</h3>
                            <button onclick="closeModulModal()" class="p-2 hover:bg-gray-100 rounded-lg">
                                <i class="fas fa-times text-gray-500"></i>
                            </button>
                        </div>
                    </div>
                    <form id="modulForm" class="p-6 space-y-6">
                        <!-- Informasi Umum -->
                        <div>
                            <h4 class="font-semibold text-gray-800 mb-3">Informasi Umum</h4>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Judul Modul</label>
                                    <input type="text" id="modulJudul" required
                                           class="w-full px-4 py-3 border border-gray-200 rounded-xl"
                                           placeholder="Contoh: Mengenal Rukun Iman">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                                    <select id="modulKelas" required class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                                        ${generateKelasOptions(userData?.jenjang)}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Alokasi Waktu (JP)</label>
                                    <input type="number" id="modulAlokasi" value="2" min="1" required
                                           class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Pertemuan Ke</label>
                                    <input type="number" id="modulPertemuan" value="1" min="1"
                                           class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                                </div>
                            </div>
                        </div>

                        <!-- Tujuan Pembelajaran -->
                        <div>
                            <h4 class="font-semibold text-gray-800 mb-3">Tujuan Pembelajaran</h4>
                            <select id="modulTP" class="w-full px-4 py-3 border border-gray-200 rounded-xl mb-2">
                                <option value="">Pilih TP terkait (opsional)</option>
                            </select>
                            <textarea id="modulTujuan" rows="2" required
                                      class="w-full px-4 py-3 border border-gray-200 rounded-xl"
                                      placeholder="Peserta didik mampu..."></textarea>
                        </div>

                        <!-- Kegiatan Pembelajaran -->
                        <div>
                            <h4 class="font-semibold text-gray-800 mb-3">Kegiatan Pembelajaran</h4>
                            
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Pendahuluan (10 menit)</label>
                                <textarea id="modulPendahuluan" rows="2"
                                          class="w-full px-4 py-3 border border-gray-200 rounded-xl"
                                          placeholder="Salam, doa pembuka, apersepsi..."></textarea>
                            </div>

                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Kegiatan Inti</label>
                                <textarea id="modulInti" rows="4"
                                          class="w-full px-4 py-3 border border-gray-200 rounded-xl"
                                          placeholder="Langkah-langkah pembelajaran..."></textarea>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Penutup (10 menit)</label>
                                <textarea id="modulPenutup" rows="2"
                                          class="w-full px-4 py-3 border border-gray-200 rounded-xl"
                                          placeholder="Kesimpulan, refleksi, doa penutup..."></textarea>
                            </div>
                        </div>

                        <!-- Materi Arab (Opsional) -->
                        <div>
                            <h4 class="font-semibold text-gray-800 mb-3">
                                <i class="fas fa-mosque mr-2 text-islamic-600"></i>Materi Berbahasa Arab (Opsional)
                            </h4>
                            <textarea id="modulArab" rows="3" dir="rtl"
                                      class="w-full px-4 py-3 border border-gray-200 rounded-xl font-arabic text-xl text-right"
                                      placeholder="   ..."></textarea>
                        </div>

                        <!-- LKPD Toggle -->
                        <div class="bg-yellow-50 rounded-xl p-4">
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input type="checkbox" id="modulLKPD" class="w-5 h-5 text-islamic-600 rounded">
                                <div>
                                    <span class="font-medium text-gray-800">Sertakan LKPD</span>
                                    <p class="text-sm text-gray-500">Lembar Kerja Peserta Didik akan dibuat terpisah</p>
                                </div>
                            </label>
                        </div>

                        <button type="submit" class="w-full py-3 bg-islamic-600 text-white rounded-xl font-semibold hover:bg-islamic-700">
                            <i class="fas fa-save mr-2"></i>Simpan Modul Ajar
                        </button>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);

            // Load TP options
            loadTPOptions();

            document.getElementById('modulForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoading();

                try {
                    await db.collection('users').doc(currentUser.uid).collection('modul_ajar').add({
                        judul: document.getElementById('modulJudul').value,
                        kelas: document.getElementById('modulKelas').value,
                        alokasi: parseInt(document.getElementById('modulAlokasi').value),
                        pertemuan: parseInt(document.getElementById('modulPertemuan').value),
                        tpId: document.getElementById('modulTP').value,
                        tujuan: document.getElementById('modulTujuan').value,
                        pendahuluan: document.getElementById('modulPendahuluan').value,
                        inti: document.getElementById('modulInti').value,
                        penutup: document.getElementById('modulPenutup').value,
                        materiArab: document.getElementById('modulArab').value,
                        lkpdEnabled: document.getElementById('modulLKPD').checked,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    hideLoading();
                    closeModulModal();
                    loadModulData();
                    showToast('Modul Ajar berhasil disimpan!', 'success');
                } catch (error) {
                    hideLoading();
                    showToast('Gagal menyimpan modul', 'error');
                    console.error(error);
                }
            });
        }

        async function loadTPOptions() {
            try {
                const snapshot = await db.collection('users').doc(currentUser.uid)
                    .collection('tp').orderBy('kode').get();
                
                const select = document.getElementById('modulTP');
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = `${data.kode} - ${data.tujuan.substring(0, 50)}...`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading TP options:', error);
            }
        }

        function closeModulModal() {
            document.getElementById('modulModal')?.remove();
        }

        async function deleteModul(modulId) {
            if (!confirm('Hapus modul ajar ini?')) return;
            
            showLoading();
            try {
                await db.collection('users').doc(currentUser.uid).collection('modul_ajar').doc(modulId).delete();
                hideLoading();
                loadModulData();
                showToast('Modul dihapus', 'success');
            } catch (error) {
                hideLoading();
                showToast('Gagal menghapus', 'error');
            }
        }

        // Jurnal Page
        function loadJurnal() {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="p-4 lg:p-8">
                    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between mb-8">
                        <div>
                            <h1 class="text-2xl lg:text-3xl font-bold text-gray-800">Jurnal Pembelajaran</h1>
                            <p class="text-gray-500 mt-1">Catatan pelaksanaan pembelajaran harian</p>
                        </div>
                        <div class="mt-4 lg:mt-0">
                            <button onclick="showAddJurnalModal()" class="px-4 py-2 bg-islamic-600 text-white rounded-xl font-medium hover:bg-islamic-700 transition">
                                <i class="fas fa-plus mr-2"></i>Tambah Jurnal
                            </button>
                        </div>
                    </div>

                    <!-- Filter -->
                    <div class="bg-white rounded-2xl shadow-sm p-4 mb-6">
                        <div class="flex flex-wrap gap-4">
                            <div class="flex-1 min-w-[150px]">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                                <input type="date" id="filterJurnalDate" onchange="filterJurnal()" 
                                       class="w-full px-4 py-2 border border-gray-200 rounded-xl">
                            </div>
                            <div class="flex-1 min-w-[150px]">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                                <select id="filterJurnalKelas" onchange="filterJurnal()" class="w-full px-4 py-2 border border-gray-200 rounded-xl">
                                    <option value="">Semua Kelas</option>
                                    ${generateKelasOptions(userData?.jenjang)}
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Jurnal List -->
                    <div id="jurnalList" class="space-y-4">
                        <div class="text-center py-12 text-gray-500">
                            <i class="fas fa-pen-fancy text-6xl text-gray-300 mb-4"></i>
                            <p>Belum ada jurnal. Klik "Tambah Jurnal" untuk mencatat pembelajaran.</p>
                        </div>
                    </div>
                </div>
            `;

            loadJurnalData();
        }

        async function loadJurnalData() {
            try {
                const snapshot = await db.collection('users').doc(currentUser.uid)
                    .collection('jurnal').orderBy('tanggal', 'desc').limit(50).get();

                const jurnalList = document.getElementById('jurnalList');

                if (snapshot.empty) {
                    jurnalList.innerHTML = `
                        <div class="text-center py-12 text-gray-500">
                            <i class="fas fa-pen-fancy text-6xl text-gray-300 mb-4"></i>
                            <p>Belum ada jurnal. Klik "Tambah Jurnal" untuk mencatat pembelajaran.</p>
                        </div>
                    `;
                    return;
                }

                jurnalList.innerHTML = snapshot.docs.map(doc => {
                    const data = doc.data();
                    const tanggal = data.tanggal?.toDate?.() || new Date();
                    return `
                        <div class="bg-white rounded-2xl shadow-sm p-6">
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 bg-islamic-100 rounded-xl flex items-center justify-center">
                                        <span class="text-lg font-bold text-islamic-600">${tanggal.getDate()}</span>
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-800">${tanggal.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}</p>
                                        <p class="text-sm text-gray-500">Kelas ${data.kelas}${data.rombel} - Jam ke ${data.jamKe || '-'}</p>
                                    </div>
                                </div>
                                <button onclick="deleteJurnal('${doc.id}')" class="p-2 text-red-500 hover:bg-red-50 rounded-lg">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <div class="space-y-2">
                                <p class="text-sm"><strong>Materi:</strong> ${data.materi || '-'}</p>
                                <p class="text-sm"><strong>Kegiatan:</strong> ${data.kegiatan || '-'}</p>
                                ${data.catatan ? `<p class="text-sm"><strong>Catatan:</strong> ${data.catatan}</p>` : ''}
                            </div>
                            <div class="mt-4 flex gap-2">
                                <span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded">Hadir: ${data.hadir || 0}</span>
                                <span class="px-2 py-1 bg-red-100 text-red-700 text-xs rounded">Tidak Hadir: ${data.tidakHadir || 0}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading jurnal:', error);
            }
        }

        function showAddJurnalModal() {
            const today = new Date().toISOString().split('T')[0];
            
            const modal = document.createElement('div');
            modal.id = 'jurnalModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
                    <div class="p-6 border-b border-gray-100">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-bold text-gray-800">Tambah Jurnal Pembelajaran</h3>
                            <button onclick="closeJurnalModal()" class="p-2 hover:bg-gray-100 rounded-lg">
                                <i class="fas fa-times text-gray-500"></i>
                            </button>
                        </div>
                    </div>
                    <form id="jurnalForm" class="p-6 space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                                <input type="date" id="jurnalTanggal" value="${today}" required
                                       class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Jam Ke</label>
                                <input type="text" id="jurnalJam" placeholder="1-2"
                                       class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                                <select id="jurnalKelas" required class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                                    ${generateKelasOptions(userData?.jenjang)}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Rombel</label>
                                <select id="jurnalRombel" required class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                                    <option value="A">A</option>
                                    <option value="B">B</option>
                                    <option value="C">C</option>
                                    <option value="D">D</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Materi Pembelajaran</label>
                            <input type="text" id="jurnalMateri" required
                                   class="w-full px-4 py-3 border border-gray-200 rounded-xl"
                                   placeholder="Topik atau materi yang diajarkan">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Kegiatan Pembelajaran</label>
                            <textarea id="jurnalKegiatan" rows="3" required
                                      class="w-full px-4 py-3 border border-gray-200 rounded-xl"
                                      placeholder="Deskripsi kegiatan yang dilakukan..."></textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Jumlah Hadir</label>
                                <input type="number" id="jurnalHadir" min="0" value="30"
                                       class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tidak Hadir</label>
                                <input type="number" id="jurnalTidakHadir" min="0" value="0"
                                       class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Catatan (Opsional)</label>
                            <textarea id="jurnalCatatan" rows="2"
                                      class="w-full px-4 py-3 border border-gray-200 rounded-xl"
                                      placeholder="Catatan tambahan..."></textarea>
                        </div>
                        <button type="submit" class="w-full py-3 bg-islamic-600 text-white rounded-xl font-semibold hover:bg-islamic-700">
                            <i class="fas fa-save mr-2"></i>Simpan Jurnal
                        </button>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);

            document.getElementById('jurnalForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoading();

                try {
                    await db.collection('users').doc(currentUser.uid).collection('jurnal').add({
                        tanggal: firebase.firestore.Timestamp.fromDate(new Date(document.getElementById('jurnalTanggal').value)),
                        jamKe: document.getElementById('jurnalJam').value,
                        kelas: document.getElementById('jurnalKelas').value,
                        rombel: document.getElementById('jurnalRombel').value,
                        materi: document.getElementById('jurnalMateri').value,
                        kegiatan: document.getElementById('jurnalKegiatan').value,
                        hadir: parseInt(document.getElementById('jurnalHadir').value) || 0,
                        tidakHadir: parseInt(document.getElementById('jurnalTidakHadir').value) || 0,
                        catatan: document.getElementById('jurnalCatatan').value,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    hideLoading();
                    closeJurnalModal();
                    loadJurnalData();
                    showToast('Jurnal berhasil disimpan!', 'success');
                } catch (error) {
                    hideLoading();
                    showToast('Gagal menyimpan jurnal', 'error');
                    console.error(error);
                }
            });
        }

        function closeJurnalModal() {
            document.getElementById('jurnalModal')?.remove();
        }

        async function deleteJurnal(jurnalId) {
            if (!confirm('Hapus jurnal ini?')) return;
            
            showLoading();
            try {
                await db.collection('users').doc(currentUser.uid).collection('jurnal').doc(jurnalId).delete();
                hideLoading();
                loadJurnalData();
                showToast('Jurnal dihapus', 'success');
            } catch (error) {
                hideLoading();
                showToast('Gagal menghapus', 'error');
            }
        }

        // Nilai Page
        function loadNilai() {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="p-4 lg:p-8">
                    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between mb-8">
                        <div>
                            <h1 class="text-2xl lg:text-3xl font-bold text-gray-800">Daftar Nilai</h1>
                            <p class="text-gray-500 mt-1">Kelola nilai siswa (PH, PTS, PAS)</p>
                        </div>
                        <div class="mt-4 lg:mt-0 flex gap-2">
                            <button onclick="showAddKomponenModal()" class="px-4 py-2 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 transition">
                                <i class="fas fa-plus mr-2"></i>Tambah Komponen
                            </button>
                            <button onclick="exportNilai()" class="px-4 py-2 bg-islamic-600 text-white rounded-xl font-medium hover:bg-islamic-700 transition">
                                <i class="fas fa-file-export mr-2"></i>Export
                            </button>
                        </div>
                    </div>

                    <!-- Filter -->
                    <div class="bg-white rounded-2xl shadow-sm p-4 mb-6">
                        <div class="grid md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                                <select id="nilaiKelas" onchange="loadNilaiData()" class="w-full px-4 py-2 border border-gray-200 rounded-xl">
                                    ${generateKelasOptions(userData?.jenjang)}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Rombel</label>
                                <select id="nilaiRombel" onchange="loadNilaiData()" class="w-full px-4 py-2 border border-gray-200 rounded-xl">
                                    <option value="A">A</option>
                                    <option value="B">B</option>
                                    <option value="C">C</option>
                                    <option value="D">D</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Semester</label>
                                <select id="nilaiSemester" onchange="loadNilaiData()" class="w-full px-4 py-2 border border-gray-200 rounded-xl">
                                    <option value="1">Semester 1</option>
                                    <option value="2">Semester 2</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Nilai Table -->
                    <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-3 text-left font-semibold text-gray-600 border-r">No</th>
                                        <th class="px-3 py-3 text-left font-semibold text-gray-600 border-r min-w-[150px]">Nama Siswa</th>
                                        <th class="px-3 py-3 text-center font-semibold text-gray-600 border-r">PH1</th>
                                        <th class="px-3 py-3 text-center font-semibold text-gray-600 border-r">PH2</th>
                                        <th class="px-3 py-3 text-center font-semibold text-gray-600 border-r">PH3</th>
                                        <th class="px-3 py-3 text-center font-semibold text-gray-600 border-r bg-blue-50">PTS</th>
                                        <th class="px-3 py-3 text-center font-semibold text-gray-600 border-r bg-green-50">PAS</th>
                                        <th class="px-3 py-3 text-center font-semibold text-gray-600 bg-yellow-50">NR</th>
                                    </tr>
                                </thead>
                                <tbody id="nilaiTableBody">
                                    <tr>
                                        <td colspan="8" class="px-4 py-8 text-center text-gray-500">
                                            Pilih kelas dan rombel untuk menampilkan daftar nilai.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            loadNilaiData();
        }

        async function loadNilaiData() {
            try {
                const kelas = document.getElementById('nilaiKelas').value;
                const rombel = document.getElementById('nilaiRombel').value;
                
                // Get students
                const studentsSnap = await db.collection('users').doc(currentUser.uid)
                    .collection('students')
                    .where('kelas', '==', kelas)
                    .where('rombel', '==', rombel)
                    .orderBy('nama')
                    .get();

                const tbody = document.getElementById('nilaiTableBody');

                if (studentsSnap.empty) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" class="px-4 py-8 text-center text-gray-500">
                                Tidak ada siswa di kelas ${kelas}${rombel}. Import data siswa terlebih dahulu.
                            </td>
                        </tr>
                    `;
                    return;
                }

                // Get nilai data
                const nilaiSnap = await db.collection('users').doc(currentUser.uid)
                    .collection('nilai')
                    .where('kelas', '==', kelas)
                    .where('rombel', '==', rombel)
                    .get();

                const nilaiMap = {};
                nilaiSnap.forEach(doc => {
                    const data = doc.data();
                    nilaiMap[data.studentId] = data;
                });

                tbody.innerHTML = studentsSnap.docs.map((doc, idx) => {
                    const student = doc.data();
                    const nilai = nilaiMap[doc.id] || {};
                    
                    const ph1 = nilai.ph1 || '';
                    const ph2 = nilai.ph2 || '';
                    const ph3 = nilai.ph3 || '';
                    const pts = nilai.pts || '';
                    const pas = nilai.pas || '';
                    
                    // Calculate NR (Nilai Raport)
                    let nr = '';
                    const scores = [ph1, ph2, ph3].filter(s => s !== '').map(Number);
                    if (scores.length > 0 && pts && pas) {
                        const avgPH = scores.reduce((a, b) => a + b, 0) / scores.length;
                        nr = Math.round((avgPH * 0.5) + (Number(pts) * 0.25) + (Number(pas) * 0.25));
                    }

                    return `
                        <tr class="border-t hover:bg-gray-50">
                            <td class="px-3 py-2 border-r">${idx + 1}</td>
                            <td class="px-3 py-2 border-r font-medium">${student.nama}</td>
                            <td class="px-3 py-2 border-r">
                                <input type="number" value="${ph1}" min="0" max="100" 
                                       onchange="updateNilai('${doc.id}', 'ph1', this.value)"
                                       class="w-full text-center border-0 bg-transparent focus:bg-yellow-50 focus:outline-none">
                            </td>
                            <td class="px-3 py-2 border-r">
                                <input type="number" value="${ph2}" min="0" max="100"
                                       onchange="updateNilai('${doc.id}', 'ph2', this.value)"
                                       class="w-full text-center border-0 bg-transparent focus:bg-yellow-50 focus:outline-none">
                            </td>
                            <td class="px-3 py-2 border-r">
                                <input type="number" value="${ph3}" min="0" max="100"
                                       onchange="updateNilai('${doc.id}', 'ph3', this.value)"
                                       class="w-full text-center border-0 bg-transparent focus:bg-yellow-50 focus:outline-none">
                            </td>
                            <td class="px-3 py-2 border-r bg-blue-50">
                                <input type="number" value="${pts}" min="0" max="100"
                                       onchange="updateNilai('${doc.id}', 'pts', this.value)"
                                       class="w-full text-center border-0 bg-transparent focus:bg-blue-100 focus:outline-none">
                            </td>
                            <td class="px-3 py-2 border-r bg-green-50">
                                <input type="number" value="${pas}" min="0" max="100"
                                       onchange="updateNilai('${doc.id}', 'pas', this.value)"
                                       class="w-full text-center border-0 bg-transparent focus:bg-green-100 focus:outline-none">
                            </td>
                            <td class="px-3 py-2 bg-yellow-50 text-center font-bold ${nr >= 75 ? 'text-green-600' : nr ? 'text-red-600' : ''}">${nr}</td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading nilai:', error);
            }
        }

        async function updateNilai(studentId, field, value) {
            try {
                const kelas = document.getElementById('nilaiKelas').value;
                const rombel = document.getElementById('nilaiRombel').value;
                const semester = document.getElementById('nilaiSemester').value;

                const nilaiRef = db.collection('users').doc(currentUser.uid)
                    .collection('nilai').doc(`${studentId}_${semester}`);

                await nilaiRef.set({
                    studentId: studentId,
                    kelas: kelas,
                    rombel: rombel,
                    semester: semester,
                    [field]: value ? parseInt(value) : null,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                // Refresh to update NR calculation
                loadNilaiData();
            } catch (error) {
                console.error('Error updating nilai:', error);
                showToast('Gagal menyimpan nilai', 'error');
            }
        }

        function exportNilai() {
            showToast('Fitur export akan segera tersedia', 'info');
        }

        // LKPD Page (Premium)
        function loadLKPD() {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="p-4 lg:p-8">
                    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between mb-8">
                        <div>
                            <h1 class="text-2xl lg:text-3xl font-bold text-gray-800">
                                LKPD
                                <span class="ml-2 px-2 py-1 text-xs font-bold bg-yellow-400 text-yellow-900 rounded-full">PREMIUM</span>
                            </h1>
                            <p class="text-gray-500 mt-1">Lembar Kerja Peserta Didik dengan dukungan teks Arab</p>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm p-8 text-center">
                        <i class="fas fa-file-alt text-6xl text-gray-300 mb-4"></i>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">LKPD Terintegrasi dengan Modul Ajar</h3>
                        <p class="text-gray-500 mb-4">
                            LKPD akan otomatis tersedia ketika Anda mengaktifkan opsi "Sertakan LKPD" saat membuat Modul Ajar.
                        </p>
                        <button onclick="loadPage('modul-ajar')" class="px-6 py-3 bg-islamic-600 text-white rounded-xl font-medium hover:bg-islamic-700 transition">
                            <i class="fas fa-arrow-right mr-2"></i>Buka Modul Ajar
                        </button>
                    </div>
                </div>
            `;
        }

        // Bank Soal Page (Premium)
        function loadBankSoal() {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="p-4 lg:p-8">
                    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between mb-8">
                        <div>
                            <h1 class="text-2xl lg:text-3xl font-bold text-gray-800">
                                Bank Soal
                                <span class="ml-2 px-2 py-1 text-xs font-bold bg-yellow-400 text-yellow-900 rounded-full">PREMIUM</span>
                            </h1>
                            <p class="text-gray-500 mt-1">Kelola soal berdasarkan ATP dengan dukungan teks Arab</p>
                        </div>
                        <div class="mt-4 lg:mt-0">
                            <button onclick="showAddSoalModal()" class="px-4 py-2 bg-islamic-600 text-white rounded-xl font-medium hover:bg-islamic-700 transition">
                                <i class="fas fa-plus mr-2"></i>Tambah Soal
                            </button>
                        </div>
                    </div>

                    <!-- Filter -->
                    <div class="bg-white rounded-2xl shadow-sm p-4 mb-6">
                        <div class="flex flex-wrap gap-4">
                            <div class="flex-1 min-w-[150px]">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                                <select id="soalKelas" onchange="loadBankSoalData()" class="w-full px-4 py-2 border border-gray-200 rounded-xl">
                                    <option value="">Semua Kelas</option>
                                    ${generateKelasOptions(userData?.jenjang)}
                                </select>
                            </div>
                            <div class="flex-1 min-w-[150px]">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tipe Soal</label>
                                <select id="soalTipe" onchange="loadBankSoalData()" class="w-full px-4 py-2 border border-gray-200 rounded-xl">
                                    <option value="">Semua Tipe</option>
                                    <option value="pg">Pilihan Ganda</option>
                                    <option value="essay">Essay</option>
                                    <option value="isian">Isian Singkat</option>
                                </select>
                            </div>
                            <div class="flex-1 min-w-[150px]">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Elemen</label>
                                <select id="soalElemen" onchange="loadBankSoalData()" class="w-full px-4 py-2 border border-gray-200 rounded-xl">
                                    <option value="">Semua Elemen</option>
                                    <option value="Al-Quran">Al-Quran & Hadis</option>
                                    <option value="Akidah">Akidah</option>
                                    <option value="Akhlak">Akhlak</option>
                                    <option value="Fikih">Fikih</option>
                                    <option value="Sejarah">Sejarah</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Soal List -->
                    <div id="soalList" class="space-y-4">
                        <div class="text-center py-12 text-gray-500">
                            <i class="fas fa-question-circle text-6xl text-gray-300 mb-4"></i>
                            <p>Belum ada soal. Klik "Tambah Soal" untuk mulai membuat bank soal.</p>
                        </div>
                    </div>
                </div>
            `;

            loadBankSoalData();
        }

        async function loadBankSoalData() {
            try {
                const snapshot = await db.collection('users').doc(currentUser.uid)
                    .collection('bank_soal').orderBy('createdAt', 'desc').get();

                const soalList = document.getElementById('soalList');

                if (snapshot.empty) {
                    soalList.innerHTML = `
                        <div class="text-center py-12 text-gray-500">
                            <i class="fas fa-question-circle text-6xl text-gray-300 mb-4"></i>
                            <p>Belum ada soal. Klik "Tambah Soal" untuk mulai membuat bank soal.</p>
                        </div>
                    `;
                    return;
                }

                soalList.innerHTML = snapshot.docs.map((doc, idx) => {
                    const data = doc.data();
                    const tipeLabels = { pg: 'Pilihan Ganda', essay: 'Essay', isian: 'Isian Singkat' };
                    
                    return `
                        <div class="bg-white rounded-2xl shadow-sm p-6">
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex items-center gap-2">
                                    <span class="w-8 h-8 bg-islamic-100 text-islamic-700 rounded-full flex items-center justify-center font-bold text-sm">${idx + 1}</span>
                                    <span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded">${tipeLabels[data.tipe] || data.tipe}</span>
                                    <span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded">Kelas ${data.kelas}</span>
                                    <span class="px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded">${data.elemen}</span>
                                </div>
                                <button onclick="deleteSoal('${doc.id}')" class="p-2 text-red-500 hover:bg-red-50 rounded-lg">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <div class="mb-4">
                                <p class="text-gray-800">${data.pertanyaan}</p>
                                ${data.pertanyaanArab ? `<p class="text-xl font-arabic text-right mt-2 rtl-text" dir="rtl">${data.pertanyaanArab}</p>` : ''}
                            </div>
                            ${data.tipe === 'pg' ? `
                                <div class="grid grid-cols-2 gap-2 text-sm">
                                    <div class="p-2 ${data.jawaban === 'A' ? 'bg-green-100 text-green-700' : 'bg-gray-50'} rounded">A. ${data.opsiA || ''}</div>
                                    <div class="p-2 ${data.jawaban === 'B' ? 'bg-green-100 text-green-700' : 'bg-gray-50'} rounded">B. ${data.opsiB || ''}</div>
                                    <div class="p-2 ${data.jawaban === 'C' ? 'bg-green-100 text-green-700' : 'bg-gray-50'} rounded">C. ${data.opsiC || ''}</div>
                                    <div class="p-2 ${data.jawaban === 'D' ? 'bg-green-100 text-green-700' : 'bg-gray-50'} rounded">D. ${data.opsiD || ''}</div>
                                </div>
                            ` : `
                                <div class="p-3 bg-green-50 rounded-xl text-sm">
                                    <strong>Jawaban:</strong> ${data.jawaban}
                                </div>
                            `}
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading bank soal:', error);
            }
        }

        function showAddSoalModal() {
            const modal = document.createElement('div');
            modal.id = 'soalModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                    <div class="p-6 border-b border-gray-100">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-bold text-gray-800">Tambah Soal</h3>
                            <button onclick="closeSoalModal()" class="p-2 hover:bg-gray-100 rounded-lg">
                                <i class="fas fa-times text-gray-500"></i>
                            </button>
                        </div>
                    </div>
                    <form id="soalForm" class="p-6 space-y-4">
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                                <select id="soalFormKelas" required class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                                    ${generateKelasOptions(userData?.jenjang)}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Elemen</label>
                                <select id="soalFormElemen" required class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                                    <option value="Al-Quran">Al-Quran & Hadis</option>
                                    <option value="Akidah">Akidah</option>
                                    <option value="Akhlak">Akhlak</option>
                                    <option value="Fikih">Fikih</option>
                                    <option value="Sejarah">Sejarah</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tipe Soal</label>
                                <select id="soalFormTipe" required onchange="toggleSoalOptions()" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                                    <option value="pg">Pilihan Ganda</option>
                                    <option value="essay">Essay</option>
                                    <option value="isian">Isian Singkat</option>
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Pertanyaan</label>
                            <textarea id="soalFormPertanyaan" rows="2" required
                                      class="w-full px-4 py-3 border border-gray-200 rounded-xl"
                                      placeholder="Tuliskan pertanyaan..."></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                <i class="fas fa-mosque mr-1 text-islamic-600"></i>Pertanyaan dalam Bahasa Arab (Opsional)
                            </label>
                            <textarea id="soalFormArab" rows="2" dir="rtl"
                                      class="w-full px-4 py-3 border border-gray-200 rounded-xl font-arabic text-xl text-right"
                                      placeholder="  ..."></textarea>
                        </div>

                        <div id="pgOptions" class="space-y-3">
                            <label class="block text-sm font-medium text-gray-700">Pilihan Jawaban</label>
                            <div class="grid grid-cols-2 gap-3">
                                <input type="text" id="soalOpsiA" placeholder="A. ..." class="px-4 py-2 border border-gray-200 rounded-xl">
                                <input type="text" id="soalOpsiB" placeholder="B. ..." class="px-4 py-2 border border-gray-200 rounded-xl">
                                <input type="text" id="soalOpsiC" placeholder="C. ..." class="px-4 py-2 border border-gray-200 rounded-xl">
                                <input type="text" id="soalOpsiD" placeholder="D. ..." class="px-4 py-2 border border-gray-200 rounded-xl">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Kunci Jawaban</label>
                                <select id="soalKunci" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                                    <option value="A">A</option>
                                    <option value="B">B</option>
                                    <option value="C">C</option>
                                    <option value="D">D</option>
                                </select>
                            </div>
                        </div>

                        <div id="essayAnswer" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Kunci/Pedoman Jawaban</label>
                            <textarea id="soalFormJawaban" rows="3"
                                      class="w-full px-4 py-3 border border-gray-200 rounded-xl"
                                      placeholder="Tuliskan kunci jawaban atau pedoman penilaian..."></textarea>
                        </div>

                        <button type="submit" class="w-full py-3 bg-islamic-600 text-white rounded-xl font-semibold hover:bg-islamic-700">
                            <i class="fas fa-save mr-2"></i>Simpan Soal
                        </button>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);

                        document.getElementById('soalForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoading();

                const tipe = document.getElementById('soalFormTipe').value;
                const soalData = {
                    kelas: document.getElementById('soalFormKelas').value,
                    elemen: document.getElementById('soalFormElemen').value,
                    tipe: tipe,
                    pertanyaan: document.getElementById('soalFormPertanyaan').value,
                    pertanyaanArab: document.getElementById('soalFormArab').value,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                if (tipe === 'pg') {
                    soalData.opsiA = document.getElementById('soalOpsiA').value;
                    soalData.opsiB = document.getElementById('soalOpsiB').value;
                    soalData.opsiC = document.getElementById('soalOpsiC').value;
                    soalData.opsiD = document.getElementById('soalOpsiD').value;
                    soalData.jawaban = document.getElementById('soalKunci').value;
                } else {
                    soalData.jawaban = document.getElementById('soalFormJawaban').value;
                }

                try {
                    await db.collection('users').doc(currentUser.uid).collection('bank_soal').add(soalData);
                    hideLoading();
                    closeSoalModal();
                    loadBankSoalData();
                    showToast('Soal berhasil disimpan!', 'success');
                } catch (error) {
                    hideLoading();
                    showToast('Gagal menyimpan soal', 'error');
                    console.error(error);
                }
            });
        }

        function toggleSoalOptions() {
            const tipe = document.getElementById('soalFormTipe').value;
            const pgOptions = document.getElementById('pgOptions');
            const essayAnswer = document.getElementById('essayAnswer');

            if (tipe === 'pg') {
                pgOptions.classList.remove('hidden');
                essayAnswer.classList.add('hidden');
            } else {
                pgOptions.classList.add('hidden');
                essayAnswer.classList.remove('hidden');
            }
        }

        function closeSoalModal() {
            document.getElementById('soalModal')?.remove();
        }

        async function deleteSoal(soalId) {
            if (!confirm('Hapus soal ini?')) return;
            
            showLoading();
            try {
                await db.collection('users').doc(currentUser.uid).collection('bank_soal').doc(soalId).delete();
                hideLoading();
                loadBankSoalData();
                showToast('Soal dihapus', 'success');
            } catch (error) {
                hideLoading();
                showToast('Gagal menghapus', 'error');
            }
        }

        // Admin Users Page (Super Admin Only)
        async function loadAdminUsers() {
            if (userData?.role !== 'super_admin') {
                showToast('Akses ditolak', 'error');
                loadDashboard();
                return;
            }

            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="p-4 lg:p-8">
                    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between mb-8">
                        <div>
                            <h1 class="text-2xl lg:text-3xl font-bold text-gray-800">
                                <i class="fas fa-users-cog mr-2 text-red-500"></i>Kelola User
                            </h1>
                            <p class="text-gray-500 mt-1">Panel Super Admin - Kelola semua pengguna</p>
                        </div>
                        <div class="mt-4 lg:mt-0">
                            <button onclick="exportUsers()" class="px-4 py-2 bg-islamic-600 text-white rounded-xl font-medium hover:bg-islamic-700 transition">
                                <i class="fas fa-file-export mr-2"></i>Export Data
                            </button>
                        </div>
                    </div>

                    <!-- Stats -->
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div class="bg-white rounded-xl shadow-sm p-4">
                            <p class="text-sm text-gray-500">Total User</p>
                            <p id="adminStatTotal" class="text-2xl font-bold text-gray-800">0</p>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm p-4">
                            <p class="text-sm text-gray-500">User Free</p>
                            <p id="adminStatFree" class="text-2xl font-bold text-gray-600">0</p>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm p-4">
                            <p class="text-sm text-gray-500">User Premium</p>
                            <p id="adminStatPremium" class="text-2xl font-bold text-yellow-600">0</p>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm p-4">
                            <p class="text-sm text-gray-500">Hari Ini</p>
                            <p id="adminStatToday" class="text-2xl font-bold text-green-600">0</p>
                        </div>
                    </div>

                    <!-- Search -->
                    <div class="bg-white rounded-2xl shadow-sm p-4 mb-6">
                        <div class="flex gap-4">
                            <div class="flex-1">
                                <input type="text" id="adminSearchUser" onkeyup="searchUsers()"
                                       class="w-full px-4 py-2 border border-gray-200 rounded-xl"
                                       placeholder="Cari nama atau email...">
                            </div>
                            <select id="adminFilterSubs" onchange="searchUsers()" class="px-4 py-2 border border-gray-200 rounded-xl">
                                <option value="">Semua Status</option>
                                <option value="free">Free</option>
                                <option value="premium">Premium</option>
                            </select>
                        </div>
                    </div>

                    <!-- Users Table -->
                    <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-600">No</th>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-600">Nama</th>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-600">Email</th>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-600">Jenjang</th>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-600">Mapel</th>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-600">Status</th>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-600">Terdaftar</th>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-600">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="adminUsersTableBody">
                                    <tr>
                                        <td colspan="8" class="px-4 py-8 text-center text-gray-500">Memuat data...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            loadAllUsers();
        }

        let allUsersData = [];

        async function loadAllUsers() {
            try {
                const snapshot = await db.collection('users').orderBy('createdAt', 'desc').get();
                
                allUsersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Update stats
                document.getElementById('adminStatTotal').textContent = allUsersData.length;
                document.getElementById('adminStatFree').textContent = allUsersData.filter(u => u.subscription !== 'premium').length;
                document.getElementById('adminStatPremium').textContent = allUsersData.filter(u => u.subscription === 'premium').length;
                
                const today = new Date().toDateString();
                document.getElementById('adminStatToday').textContent = allUsersData.filter(u => {
                    const created = u.createdAt?.toDate?.();
                    return created && created.toDateString() === today;
                }).length;

                renderUsersTable(allUsersData);
            } catch (error) {
                console.error('Error loading users:', error);
                showToast('Gagal memuat data user', 'error');
            }
        }

        function renderUsersTable(users) {
            const tbody = document.getElementById('adminUsersTableBody');
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="px-4 py-8 text-center text-gray-500">Tidak ada data</td></tr>';
                return;
            }

            tbody.innerHTML = users.map((user, idx) => {
                const createdAt = user.createdAt?.toDate?.();
                const dateStr = createdAt ? createdAt.toLocaleDateString('id-ID') : '-';
                
                return `
                    <tr class="border-t hover:bg-gray-50">
                        <td class="px-4 py-3">${idx + 1}</td>
                        <td class="px-4 py-3 font-medium">${user.name || '-'}</td>
                        <td class="px-4 py-3">${user.email}</td>
                        <td class="px-4 py-3">${user.jenjang || '-'}</td>
                        <td class="px-4 py-3">${user.mapel || '-'}</td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 text-xs font-bold rounded-full ${user.subscription === 'premium' ? 'bg-yellow-100 text-yellow-700' : 'bg-gray-100 text-gray-600'}">
                                ${user.subscription === 'premium' ? 'PREMIUM' : 'FREE'}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-gray-500">${dateStr}</td>
                        <td class="px-4 py-3">
                            <div class="flex gap-1">
                                <button onclick="togglePremium('${user.id}', '${user.subscription}')" 
                                        class="px-2 py-1 text-xs ${user.subscription === 'premium' ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'} rounded hover:opacity-80">
                                    ${user.subscription === 'premium' ? 'Revoke' : 'Upgrade'}
                                </button>
                                <button onclick="viewUserDetail('${user.id}')" class="p-1 text-blue-500 hover:bg-blue-50 rounded">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function searchUsers() {
            const search = document.getElementById('adminSearchUser').value.toLowerCase();
            const filter = document.getElementById('adminFilterSubs').value;

            const filtered = allUsersData.filter(u => {
                const matchSearch = !search || 
                    u.name?.toLowerCase().includes(search) || 
                    u.email?.toLowerCase().includes(search);
                const matchFilter = !filter || 
                    (filter === 'premium' && u.subscription === 'premium') ||
                    (filter === 'free' && u.subscription !== 'premium');
                return matchSearch && matchFilter;
            });

            renderUsersTable(filtered);
        }

        async function togglePremium(userId, currentStatus) {
            const newStatus = currentStatus === 'premium' ? 'free' : 'premium';
            const action = newStatus === 'premium' ? 'upgrade ke Premium' : 'revoke status Premium';
            
            if (!confirm(`Yakin ingin ${action} user ini?`)) return;

            showLoading();
            try {
                await db.collection('users').doc(userId).update({
                    subscription: newStatus,
                    subscriptionExpiry: newStatus === 'premium' 
                        ? firebase.firestore.Timestamp.fromDate(new Date(Date.now() + 365 * 24 * 60 * 60 * 1000))
                        : null,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                hideLoading();
                loadAllUsers();
                showToast(`Status berhasil diubah ke ${newStatus.toUpperCase()}`, 'success');
            } catch (error) {
                hideLoading();
                showToast('Gagal mengubah status', 'error');
                console.error(error);
            }
        }

        function viewUserDetail(userId) {
            const user = allUsersData.find(u => u.id === userId);
            if (!user) return;

            const modal = document.createElement('div');
            modal.id = 'userDetailModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md">
                    <div class="p-6 border-b border-gray-100">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-bold text-gray-800">Detail User</h3>
                            <button onclick="document.getElementById('userDetailModal').remove()" class="p-2 hover:bg-gray-100 rounded-lg">
                                <i class="fas fa-times text-gray-500"></i>
                            </button>
                        </div>
                    </div>
                    <div class="p-6 space-y-4">
                        <div class="flex items-center gap-4">
                            <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(user.name || 'User')}&background=10b981&color=fff" 
                                 class="w-16 h-16 rounded-full">
                            <div>
                                <h4 class="font-bold text-gray-800">${user.name || '-'}</h4>
                                <p class="text-sm text-gray-500">${user.email}</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div class="p-3 bg-gray-50 rounded-xl">
                                <p class="text-gray-500">Jenjang</p>
                                <p class="font-medium">${user.jenjang || '-'}</p>
                            </div>
                            <div class="p-3 bg-gray-50 rounded-xl">
                                <p class="text-gray-500">Mapel</p>
                                <p class="font-medium">${user.mapel || '-'}</p>
                            </div>
                            <div class="p-3 bg-gray-50 rounded-xl">
                                <p class="text-gray-500">Sekolah</p>
                                <p class="font-medium">${user.profile?.namaSekolah || '-'}</p>
                            </div>
                            <div class="p-3 bg-gray-50 rounded-xl">
                                <p class="text-gray-500">Status</p>
                                <p class="font-medium ${user.subscription === 'premium' ? 'text-yellow-600' : ''}">${user.subscription?.toUpperCase() || 'FREE'}</p>
                            </div>
                        </div>
                        <div class="p-3 bg-gray-50 rounded-xl text-sm">
                            <p class="text-gray-500">User ID</p>
                            <p class="font-mono text-xs break-all">${user.id}</p>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function exportUsers() {
            const csvContent = "data:text/csv;charset=utf-8," 
                + "Nama,Email,Jenjang,Mapel,Sekolah,Status,Terdaftar\n"
                + allUsersData.map(u => {
                    const date = u.createdAt?.toDate?.()?.toLocaleDateString('id-ID') || '';
                    return `"${u.name || ''}","${u.email}","${u.jenjang || ''}","${u.mapel || ''}","${u.profile?.namaSekolah || ''}","${u.subscription || 'free'}","${date}"`;
                }).join("\n");

            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", "users_export.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('Data berhasil diexport!', 'success');
        }

        // Admin Subscription Page
        async function loadAdminSubscription() {
            if (userData?.role !== 'super_admin') {
                showToast('Akses ditolak', 'error');
                loadDashboard();
                return;
            }

            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="p-4 lg:p-8">
                    <div class="mb-8">
                        <h1 class="text-2xl lg:text-3xl font-bold text-gray-800">
                            <i class="fas fa-credit-card mr-2 text-red-500"></i>Kelola Langganan
                        </h1>
                        <p class="text-gray-500 mt-1">Panel Super Admin - Kelola paket dan aktivasi premium</p>
                    </div>

                    <!-- Quick Activate -->
                    <div class="bg-white rounded-2xl shadow-sm p-6 mb-6">
                        <h3 class="font-bold text-gray-800 mb-4">Aktivasi Premium Manual</h3>
                        <div class="flex gap-4">
                            <input type="email" id="activateEmail" 
                                   class="flex-1 px-4 py-3 border border-gray-200 rounded-xl"
                                   placeholder="Email user yang akan diaktivasi...">
                            <select id="activateDuration" class="px-4 py-3 border border-gray-200 rounded-xl">
                                <option value="30">30 Hari</option>
                                <option value="90">90 Hari</option>
                                <option value="180">180 Hari</option>
                                <option value="365" selected>1 Tahun</option>
                            </select>
                            <button onclick="activatePremiumByEmail()" class="px-6 py-3 bg-yellow-500 text-white rounded-xl font-medium hover:bg-yellow-600">
                                <i class="fas fa-crown mr-2"></i>Aktivasi
                            </button>
                        </div>
                    </div>

                    <!-- Pricing Settings -->
                    <div class="bg-white rounded-2xl shadow-sm p-6 mb-6">
                        <h3 class="font-bold text-gray-800 mb-4">Pengaturan Harga</h3>
                        <div class="grid md:grid-cols-2 gap-6">
                            <div class="border-2 border-gray-200 rounded-xl p-4">
                                <h4 class="font-semibold text-gray-800 mb-3">Paket Perorangan</h4>
                                <div class="space-y-3">
                                    <div>
                                        <label class="text-sm text-gray-600">Harga/Tahun</label>
                                        <input type="number" id="pricePersonal" value="99000" 
                                               class="w-full px-4 py-2 border border-gray-200 rounded-lg">
                                    </div>
                                </div>
                            </div>
                            <div class="border-2 border-yellow-300 rounded-xl p-4 bg-yellow-50">
                                <h4 class="font-semibold text-gray-800 mb-3">Paket Sekolah</h4>
                                <div class="space-y-3">
                                    <div>
                                        <label class="text-sm text-gray-600">Harga/Tahun (max 20 guru)</label>
                                        <input type="number" id="priceSchool" value="599000"
                                               class="w-full px-4 py-2 border border-gray-200 rounded-lg">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button onclick="savePricing()" class="mt-4 px-6 py-2 bg-islamic-600 text-white rounded-xl font-medium hover:bg-islamic-700">
                            <i class="fas fa-save mr-2"></i>Simpan Pengaturan
                        </button>
                    </div>

                    <!-- Recent Transactions -->
                    <div class="bg-white rounded-2xl shadow-sm p-6">
                        <h3 class="font-bold text-gray-800 mb-4">Aktivasi Terbaru</h3>
                        <div id="recentActivations" class="space-y-3">
                            <p class="text-gray-500 text-center py-4">Memuat data...</p>
                        </div>
                    </div>
                </div>
            `;

            loadRecentActivations();
        }

        async function activatePremiumByEmail() {
            const email = document.getElementById('activateEmail').value.trim();
            const duration = parseInt(document.getElementById('activateDuration').value);

            if (!email) {
                showToast('Masukkan email user', 'warning');
                return;
            }

            showLoading();
            try {
                // Find user by email
                const snapshot = await db.collection('users').where('email', '==', email).get();
                
                if (snapshot.empty) {
                    hideLoading();
                    showToast('User tidak ditemukan', 'error');
                    return;
                }

                const userDoc = snapshot.docs[0];
                const expiryDate = new Date(Date.now() + duration * 24 * 60 * 60 * 1000);

                await db.collection('users').doc(userDoc.id).update({
                    subscription: 'premium',
                    subscriptionExpiry: firebase.firestore.Timestamp.fromDate(expiryDate),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Log activation
                await db.collection('activations').add({
                    userId: userDoc.id,
                    email: email,
                    duration: duration,
                    expiry: firebase.firestore.Timestamp.fromDate(expiryDate),
                    activatedBy: currentUser.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                hideLoading();
                document.getElementById('activateEmail').value = '';
                loadRecentActivations();
                showToast(`Premium berhasil diaktifkan untuk ${email}!`, 'success');
            } catch (error) {
                hideLoading();
                showToast('Gagal mengaktifkan premium', 'error');
                console.error(error);
            }
        }

        async function loadRecentActivations() {
            try {
                const snapshot = await db.collection('activations')
                    .orderBy('createdAt', 'desc')
                    .limit(10)
                    .get();

                const container = document.getElementById('recentActivations');

                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-4">Belum ada aktivasi</p>';
                    return;
                }

                container.innerHTML = snapshot.docs.map(doc => {
                    const data = doc.data();
                    const date = data.createdAt?.toDate?.();
                    const dateStr = date ? date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' }) : '-';
                    
                    return `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                            <div>
                                <p class="font-medium text-gray-800">${data.email}</p>
                                <p class="text-sm text-gray-500">${data.duration} hari</p>
                            </div>
                            <span class="text-sm text-gray-400">${dateStr}</span>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading activations:', error);
            }
        }

        async function savePricing() {
            showLoading();
            try {
                await db.collection('settings').doc('pricing').set({
                    personal: parseInt(document.getElementById('pricePersonal').value),
                    school: parseInt(document.getElementById('priceSchool').value),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                hideLoading();
                showToast('Pengaturan harga disimpan', 'success');
            } catch (error) {
                hideLoading();
                showToast('Gagal menyimpan', 'error');
            }
        }

        // =====================================================
        // INITIALIZATION & AUTH STATE
        // =====================================================

        // Check authentication state
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                showLoading();

                try {
                    // Get user data from Firestore
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    
                    if (userDoc.exists) {
                        userData = userDoc.data();
                    } else {
                        // Create user document if not exists (for Google sign-in edge cases)
                        userData = {
                            uid: user.uid,
                            name: user.displayName || 'User',
                            email: user.email,
                            jenjang: '',
                            mapel: '',
                            role: user.email === SUPER_ADMIN_EMAIL ? 'super_admin' : 'guru',
                            subscription: 'free',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            profile: {}
                        };
                        await db.collection('users').doc(user.uid).set(userData);
                    }

                    // Update UI with user info
                    updateUserUI();

                    // Show admin menu if super admin
                    if (userData.role === 'super_admin') {
                        document.getElementById('adminMenu').classList.remove('hidden');
                        document.getElementById('upgradeBanner').classList.add('hidden');
                    }

                    // Hide upgrade banner for premium users
                    if (userData.subscription === 'premium') {
                        document.getElementById('upgradeBanner').classList.add('hidden');
                    }

                    // Load dashboard
                    loadDashboard();
                    hideLoading();
                } catch (error) {
                    console.error('Error loading user data:', error);
                    hideLoading();
                    showToast('Terjadi kesalahan', 'error');
                }
            } else {
                // User not logged in, redirect to login
                window.location.href = 'index.html';
            }
        });

        function updateUserUI() {
            // Update sidebar user info
            document.getElementById('userName').textContent = userData?.name || 'User';
            document.getElementById('userEmail').textContent = userData?.email || '';
            
            // Update avatar
            const avatarUrl = userData?.profile?.photo || 
                `https://ui-avatars.com/api/?name=${encodeURIComponent(userData?.name || 'User')}&background=10b981&color=fff`;
            document.getElementById('userAvatar').src = avatarUrl;

            // Update subscription badge
            const badge = document.getElementById('subscriptionBadge');
            if (userData?.subscription === 'premium' || userData?.role === 'super_admin') {
                badge.textContent = userData?.role === 'super_admin' ? 'ADMIN' : 'PREMIUM';
                badge.className = 'px-2 py-1 text-xs font-bold text-white rounded-full premium-badge';
            } else {
                badge.textContent = 'FREE';
                badge.className = 'px-2 py-1 text-xs font-bold text-white rounded-full free-badge';
            }
        }

        // Handle window resize for sidebar
        window.addEventListener('resize', () => {
            if (window.innerWidth >= 1024) {
                document.getElementById('sidebar').classList.remove('open');
                document.getElementById('sidebarOverlay').classList.add('hidden');
            }
        });

        // Close modals on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeEventModal();
                closeScheduleModal();
                closeTPModal();
                closeImportTPModal();
                closeStudentModal();
                closeImportStudentsModal();
                closeModulModal();
                closeJurnalModal();
                closeSoalModal();
                closeUpgradeModal();
            }
        });
    </script>
</body>
</html>
                                    