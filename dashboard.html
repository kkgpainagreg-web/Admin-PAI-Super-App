<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - ADMIN GURU SUPER APP</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“š</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        secondary: '#1e40af',
                        accent: '#3b82f6',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                        dark: '#1f2937',
                        sidebar: '#0f172a',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        arabic: ['Amiri', 'serif'],
                    }
                }
            }
        }
    </script>
    <style>
        * { font-family: 'Inter', sans-serif; }
        .arabic-text { font-family: 'Amiri', serif; direction: rtl; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #a1a1a1; }
        
        .sidebar { transition: transform 0.3s ease, width 0.3s ease; }
        .sidebar-collapsed { transform: translateX(-100%); }
        @media (min-width: 1024px) {
            .sidebar-collapsed { transform: translateX(0); width: 80px; }
            .sidebar-collapsed .sidebar-text { display: none; }
            .sidebar-collapsed .sidebar-logo-text { display: none; }
        }
        
        .menu-item.active { background: rgba(59, 130, 246, 0.2); border-left: 3px solid #3b82f6; }
        .menu-item:hover { background: rgba(255, 255, 255, 0.1); }
        
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0,0,0,0.15); }
        
        .loading-overlay {
            position: fixed; inset: 0;
            background: rgba(255,255,255,0.9);
            display: flex; align-items: center; justify-content: center;
            z-index: 9999;
        }
        
        .spinner {
            width: 50px; height: 50px;
            border: 4px solid #e5e7eb;
            border-top-color: #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .premium-badge { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        
        [dir="rtl"] { direction: rtl; text-align: right; }
        
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
        }
        
        .modal-enter { animation: modalEnter 0.3s ease; }
        @keyframes modalEnter {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="text-center">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-gray-600">Memuat aplikasi...</p>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar fixed lg:relative z-40 h-full w-72 bg-sidebar text-white flex flex-col">
            <!-- Logo -->
            <div class="p-5 border-b border-white/10">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-primary rounded-xl flex items-center justify-center">
                        <i class="fas fa-chalkboard-teacher text-lg"></i>
                    </div>
                    <div class="sidebar-logo-text">
                        <h1 class="font-bold text-lg">ADMIN GURU</h1>
                        <p class="text-xs text-gray-400">Super App v1.0</p>
                    </div>
                </div>
            </div>

            <!-- User Info -->
            <div class="p-4 border-b border-white/10">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-gradient-to-br from-primary to-purple-600 rounded-full flex items-center justify-center">
                        <span id="userInitial" class="text-lg font-bold">G</span>
                    </div>
                    <div class="sidebar-text flex-1 min-w-0">
                        <p id="userName" class="font-semibold truncate">Guru</p>
                        <div class="flex items-center gap-2">
                            <span id="userSubscription" class="text-xs px-2 py-0.5 bg-gray-600 rounded-full">Free</span>
                            <span id="userRole" class="text-xs text-gray-400">Guru</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <nav class="flex-1 overflow-y-auto p-3">
                <!-- Main Menu -->
                <div class="mb-6">
                    <p class="sidebar-text text-xs text-gray-500 uppercase tracking-wider mb-3 px-3">Menu Utama</p>
                    <ul class="space-y-1">
                        <li>
                            <a href="#" onclick="loadPage('dashboard')" data-page="dashboard" class="menu-item flex items-center gap-3 px-3 py-3 rounded-lg transition-all active">
                                <i class="fas fa-home w-5 text-center"></i>
                                <span class="sidebar-text">Dashboard</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" onclick="loadPage('profile')" data-page="profile" class="menu-item flex items-center gap-3 px-3 py-3 rounded-lg transition-all">
                                <i class="fas fa-user w-5 text-center"></i>
                                <span class="sidebar-text">Profil</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- Data Dasar -->
                <div class="mb-6">
                    <p class="sidebar-text text-xs text-gray-500 uppercase tracking-wider mb-3 px-3">Data Dasar</p>
                    <ul class="space-y-1">
                        <li>
                            <a href="#" onclick="loadPage('calendar')" data-page="calendar" class="menu-item flex items-center gap-3 px-3 py-3 rounded-lg transition-all">
                                <i class="fas fa-calendar-alt w-5 text-center"></i>
                                <span class="sidebar-text">Kalender Pendidikan</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" onclick="loadPage('schedule')" data-page="schedule" class="menu-item flex items-center gap-3 px-3 py-3 rounded-lg transition-all">
                                <i class="fas fa-clock w-5 text-center"></i>
                                <span class="sidebar-text">Jadwal Pelajaran</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" onclick="loadPage('students')" data-page="students" class="menu-item flex items-center gap-3 px-3 py-3 rounded-lg transition-all">
                                <i class="fas fa-users w-5 text-center"></i>
                                <span class="sidebar-text">Data Siswa</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" onclick="loadPage('cp')" data-page="cp" class="menu-item flex items-center gap-3 px-3 py-3 rounded-lg transition-all">
                                <i class="fas fa-book w-5 text-center"></i>
                                <span class="sidebar-text">Capaian Pembelajaran</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- Dokumen Administrasi -->
                <div class="mb-6">
                    <p class="sidebar-text text-xs text-gray-500 uppercase tracking-wider mb-3 px-3">Dokumen</p>
                    <ul class="space-y-1">
                        <li>
                            <a href="#" onclick="loadPage('atp')" data-page="atp" class="menu-item flex items-center gap-3 px-3 py-3 rounded-lg transition-all">
                                <i class="fas fa-route w-5 text-center"></i>
                                <span class="sidebar-text">ATP</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" onclick="loadPage('prota')" data-page="prota" class="menu-item flex items-center gap-3 px-3 py-3 rounded-lg transition-all">
                                <i class="fas fa-calendar-check w-5 text-center"></i>
                                <span class="sidebar-text">Prota</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" onclick="loadPage('promes')" data-page="promes" class="menu-item flex items-center gap-3 px-3 py-3 rounded-lg transition-all">
                                <i class="fas fa-calendar-week w-5 text-center"></i>
                                <span class="sidebar-text">Promes</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" onclick="loadPage('modul')" data-page="modul" class="menu-item premium-feature flex items-center gap-3 px-3 py-3 rounded-lg transition-all">
                                <i class="fas fa-file-alt w-5 text-center"></i>
                                <span class="sidebar-text">Modul Ajar</span>
                                <span class="premium-badge text-xs px-2 py-0.5 rounded-full text-white ml-auto">PRO</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- Pembelajaran -->
                <div class="mb-6">
                    <p class="sidebar-text text-xs text-gray-500 uppercase tracking-wider mb-3 px-3">Pembelajaran</p>
                    <ul class="space-y-1">
                        <li>
                            <a href="#" onclick="loadPage('journal')" data-page="journal" class="menu-item flex items-center gap-3 px-3 py-3 rounded-lg transition-all">
                                <i class="fas fa-book-open w-5 text-center"></i>
                                <span class="sidebar-text">Jurnal Mengajar</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" onclick="loadPage('attendance')" data-page="attendance" class="menu-item flex items-center gap-3 px-3 py-3 rounded-lg transition-all">
                                <i class="fas fa-clipboard-check w-5 text-center"></i>
                                <span class="sidebar-text">Absensi</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" onclick="loadPage('grades')" data-page="grades" class="menu-item flex items-center gap-3 px-3 py-3 rounded-lg transition-all">
                                <i class="fas fa-star w-5 text-center"></i>
                                <span class="sidebar-text">Daftar Nilai</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" onclick="loadPage('lkpd')" data-page="lkpd" class="menu-item premium-feature flex items-center gap-3 px-3 py-3 rounded-lg transition-all">
                                <i class="fas fa-tasks w-5 text-center"></i>
                                <span class="sidebar-text">LKPD</span>
                                <span class="premium-badge text-xs px-2 py-0.5 rounded-full text-white ml-auto">PRO</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" onclick="loadPage('banksoal')" data-page="banksoal" class="menu-item premium-feature flex items-center gap-3 px-3 py-3 rounded-lg transition-all">
                                <i class="fas fa-question-circle w-5 text-center"></i>
                                <span class="sidebar-text">Bank Soal</span>
                                <span class="premium-badge text-xs px-2 py-0.5 rounded-full text-white ml-auto">PRO</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- Admin Menu -->
                <div id="adminMenu" class="mb-6 hidden">
                    <p class="sidebar-text text-xs text-gray-500 uppercase tracking-wider mb-3 px-3">Admin</p>
                    <ul class="space-y-1">
                        <li>
                            <a href="#" onclick="loadPage('admin-users')" data-page="admin-users" class="menu-item flex items-center gap-3 px-3 py-3 rounded-lg transition-all">
                                <i class="fas fa-users-cog w-5 text-center"></i>
                                <span class="sidebar-text">Kelola User</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" onclick="loadPage('admin-subscriptions')" data-page="admin-subscriptions" class="menu-item flex items-center gap-3 px-3 py-3 rounded-lg transition-all">
                                <i class="fas fa-credit-card w-5 text-center"></i>
                                <span class="sidebar-text">Langganan</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- Tools -->
                <div class="mb-6">
                    <p class="sidebar-text text-xs text-gray-500 uppercase tracking-wider mb-3 px-3">Tools</p>
                    <ul class="space-y-1">
                        <li>
                            <a href="#" onclick="loadPage('ai-assistant')" data-page="ai-assistant" class="menu-item flex items-center gap-3 px-3 py-3 rounded-lg transition-all">
                                <i class="fas fa-robot w-5 text-center"></i>
                                <span class="sidebar-text">AI Assistant</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" onclick="loadPage('guide')" data-page="guide" class="menu-item flex items-center gap-3 px-3 py-3 rounded-lg transition-all">
                                <i class="fas fa-book-reader w-5 text-center"></i>
                                <span class="sidebar-text">Panduan</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Sidebar Footer -->
            <div class="p-4 border-t border-white/10">
                <button onclick="logout()" class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded-lg transition-all">
                    <i class="fas fa-sign-out-alt"></i>
                    <span class="sidebar-text">Keluar</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Top Header -->
            <header class="bg-white border-b border-gray-200 px-4 lg:px-6 py-4 flex items-center justify-between no-print">
                <div class="flex items-center gap-4">
                    <button onclick="toggleSidebar()" class="lg:hidden p-2 hover:bg-gray-100 rounded-lg">
                        <i class="fas fa-bars text-gray-600"></i>
                    </button>
                    <div>
                        <h2 id="pageTitle" class="text-xl font-bold text-gray-800">Dashboard</h2>
                        <p id="pageSubtitle" class="text-sm text-gray-500">Selamat datang di Admin Guru Super App</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="showQuickGenerate()" class="hidden md:flex items-center gap-2 px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-all">
                        <i class="fas fa-magic"></i>
                        <span>Generate Dokumen</span>
                    </button>
                    
                    <button class="relative p-2 hover:bg-gray-100 rounded-lg">
                        <i class="fas fa-bell text-gray-600"></i>
                        <span class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span>
                    </button>
                    
                    <div class="relative">
                        <button onclick="toggleUserMenu()" class="flex items-center gap-2 p-2 hover:bg-gray-100 rounded-lg">
                            <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center">
                                <span id="headerUserInitial" class="text-white text-sm font-semibold">G</span>
                            </div>
                            <i class="fas fa-chevron-down text-gray-400 text-xs"></i>
                        </button>
                        <div id="userMenuDropdown" class="absolute right-0 top-full mt-2 w-48 bg-white rounded-xl shadow-lg border border-gray-100 py-2 hidden z-50">
                            <a href="#" onclick="loadPage('profile')" class="flex items-center gap-3 px-4 py-2 hover:bg-gray-50">
                                <i class="fas fa-user text-gray-400"></i>
                                <span>Profil Saya</span>
                            </a>
                            <a href="#" onclick="loadPage('guide')" class="flex items-center gap-3 px-4 py-2 hover:bg-gray-50">
                                <i class="fas fa-question-circle text-gray-400"></i>
                                <span>Bantuan</span>
                            </a>
                            <hr class="my-2">
                            <a href="#" onclick="logout()" class="flex items-center gap-3 px-4 py-2 hover:bg-gray-50 text-red-500">
                                <i class="fas fa-sign-out-alt"></i>
                                <span>Keluar</span>
                            </a>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Page Content -->
            <main id="mainContent" class="flex-1 overflow-y-auto p-4 lg:p-6">
                <!-- Content loaded here -->
            </main>
        </div>
    </div>

    <!-- Mobile Sidebar Overlay -->
    <div id="sidebarOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-30 hidden lg:hidden"></div>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <!-- Modal Container -->
    <div id="modalContainer"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <script>
// ==========================================
// FIREBASE CONFIGURATION
// ==========================================
const firebaseConfig = {
    apiKey: "AIzaSyDpiK4F4ilnDDNEwO0djGY-ClwgwBl1eFk",
    authDomain: "asap-1d653.firebaseapp.com",
    projectId: "asap-1d653",
    storageBucket: "asap-1d653.firebasestorage.app",
    messagingSenderId: "143263188364",
    appId: "1:143263188364:web:47b4c003972b3503e882a9",
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

// ==========================================
// GLOBAL CONSTANTS
// ==========================================
const SUPER_ADMIN_EMAIL = 'afifaro@gmail.com';

// 8 Dimensi Profil Lulusan (Kepka BSKAP No. 046/H/KR/2025)
const DIMENSI_LULUSAN = [
    { id: 1, nama: 'Keimanan', deskripsi: 'Beriman dan bertakwa kepada Tuhan Yang Maha Esa', icon: 'fa-pray', color: 'bg-emerald-100 text-emerald-700' },
    { id: 2, nama: 'Kewargaan', deskripsi: 'Berkewarganegaraan yang baik dan cinta tanah air', icon: 'fa-flag', color: 'bg-red-100 text-red-700' },
    { id: 3, nama: 'Penalaran Kritis', deskripsi: 'Bernalar kritis dalam memecahkan masalah', icon: 'fa-brain', color: 'bg-purple-100 text-purple-700' },
    { id: 4, nama: 'Kreativitas', deskripsi: 'Kreatif dan inovatif dalam berkarya', icon: 'fa-lightbulb', color: 'bg-yellow-100 text-yellow-700' },
    { id: 5, nama: 'Kolaborasi', deskripsi: 'Bergotong royong dan mampu bekerja sama', icon: 'fa-users', color: 'bg-blue-100 text-blue-700' },
    { id: 6, nama: 'Kemandirian', deskripsi: 'Mandiri dan bertanggung jawab', icon: 'fa-user-check', color: 'bg-indigo-100 text-indigo-700' },
    { id: 7, nama: 'Kesehatan', deskripsi: 'Sehat jasmani dan rohani', icon: 'fa-heartbeat', color: 'bg-pink-100 text-pink-700' },
    { id: 8, nama: 'Komunikasi', deskripsi: 'Berkomunikasi efektif dan santun', icon: 'fa-comments', color: 'bg-cyan-100 text-cyan-700' }
];

// CP PAI Default Data per Fase
const CP_PAI_DEFAULT = {
    'A': {
        fase: 'A',
        jenjang: 'SD/MI Kelas 1-2',
        dimensi_fokus: ['Keimanan', 'Kemandirian', 'Komunikasi'],
        elemen: [
            { id: 'A1', nama: 'Al-Quran Hadis', materi: 'Mengenal huruf Hijaiah, tanda baca, dan membaca surah pendek', dimensi: ['Keimanan', 'Komunikasi'] },
            { id: 'A2', nama: 'Akidah', materi: 'Mengenal Rukun Iman (Iman kepada Allah)', dimensi: ['Keimanan'] },
            { id: 'A3', nama: 'Akhlak', materi: 'Akhlak kepada diri sendiri dan keluarga', dimensi: ['Kemandirian', 'Komunikasi'] },
            { id: 'A4', nama: 'Fikih', materi: 'Mengenal Rukun Islam, thaharah, dan shalat', dimensi: ['Keimanan', 'Kemandirian'] },
            { id: 'A5', nama: 'Sejarah Islam', materi: 'Kisah Nabi Adam, Nuh, dan Ibrahim', dimensi: ['Keimanan', 'Penalaran Kritis'] }
        ]
    },
    'B': {
        fase: 'B',
        jenjang: 'SD/MI Kelas 3-4',
        dimensi_fokus: ['Keimanan', 'Kolaborasi', 'Penalaran Kritis'],
        elemen: [
            { id: 'B1', nama: 'Al-Quran Hadis', materi: 'Membaca ayat tentang shalat dan berbuat baik', dimensi: ['Keimanan', 'Komunikasi'] },
            { id: 'B2', nama: 'Akidah', materi: 'Mengenal sifat-sifat Allah (Asmaul Husna)', dimensi: ['Keimanan', 'Penalaran Kritis'] },
            { id: 'B3', nama: 'Akhlak', materi: 'Adab kepada orang tua dan guru', dimensi: ['Kolaborasi', 'Komunikasi'] },
            { id: 'B4', nama: 'Fikih', materi: 'Puasa Ramadhan, tanda-tanda baligh', dimensi: ['Keimanan', 'Kemandirian'] },
            { id: 'B5', nama: 'Sejarah Islam', materi: 'Sirah Nabawiyah periode Makkah', dimensi: ['Keimanan', 'Penalaran Kritis'] }
        ]
    },
    'C': {
        fase: 'C',
        jenjang: 'SD/MI Kelas 5-6',
        dimensi_fokus: ['Keimanan', 'Kewargaan', 'Kolaborasi'],
        elemen: [
            { id: 'C1', nama: 'Al-Quran Hadis', materi: 'Ayat tentang keragaman dan toleransi', dimensi: ['Keimanan', 'Kewargaan'] },
            { id: 'C2', nama: 'Akidah', materi: 'Iman kepada Hari Akhir dan Qada Qadar', dimensi: ['Keimanan', 'Penalaran Kritis'] },
            { id: 'C3', nama: 'Akhlak', materi: 'Adab sosial dan bermasyarakat', dimensi: ['Kewargaan', 'Kolaborasi'] },
            { id: 'C4', nama: 'Fikih', materi: 'Zakat, infaq, sedekah', dimensi: ['Keimanan', 'Kolaborasi'] },
            { id: 'C5', nama: 'Sejarah Islam', materi: 'Sirah Nabawiyah periode Madinah', dimensi: ['Keimanan', 'Kewargaan'] }
        ]
    },
    'D': {
        fase: 'D',
        jenjang: 'SMP/MTs Kelas 7-9',
        dimensi_fokus: ['Keimanan', 'Kewargaan', 'Penalaran Kritis', 'Kolaborasi'],
        elemen: [
            { id: 'D1', nama: 'Al-Quran Hadis', materi: 'Ayat tentang toleransi dan kerukunan', dimensi: ['Keimanan', 'Kewargaan'] },
            { id: 'D2', nama: 'Akidah', materi: 'Pendalaman Rukun Iman', dimensi: ['Keimanan', 'Penalaran Kritis'] },
            { id: 'D3', nama: 'Akhlak', materi: 'Akhlak terpuji dan tercela', dimensi: ['Kemandirian', 'Kolaborasi'] },
            { id: 'D4', nama: 'Fikih', materi: 'Sujud, haji, umrah, muamalah', dimensi: ['Keimanan', 'Kolaborasi'] },
            { id: 'D5', nama: 'Sejarah Islam', materi: 'Peradaban Bani Umayyah hingga Mughal', dimensi: ['Penalaran Kritis', 'Kewargaan'] }
        ]
    },
    'E': {
        fase: 'E',
        jenjang: 'SMA/MA Kelas 10',
        dimensi_fokus: ['Keimanan', 'Penalaran Kritis', 'Kreativitas', 'Kemandirian'],
        elemen: [
            { id: 'E1', nama: 'Al-Quran Hadis', materi: 'Kompetisi dalam kebaikan (Fastabiqul Khairat)', dimensi: ['Keimanan', 'Kreativitas'] },
            { id: 'E2', nama: 'Akidah', materi: "Syu'ab al-Iman", dimensi: ['Keimanan', 'Penalaran Kritis'] },
            { id: 'E3', nama: 'Akhlak', materi: 'Etika dalam kehidupan modern', dimensi: ['Komunikasi', 'Kemandirian'] },
            { id: 'E4', nama: 'Fikih', materi: 'Sumber hukum Islam dan ijtihad', dimensi: ['Keimanan', 'Penalaran Kritis'] },
            { id: 'E5', nama: 'Sejarah Islam', materi: 'Perkembangan Islam di Indonesia', dimensi: ['Kewargaan', 'Penalaran Kritis'] }
        ]
    },
    'F': {
        fase: 'F',
        jenjang: 'SMA/MA Kelas 11-12',
        dimensi_fokus: ['Keimanan', 'Penalaran Kritis', 'Kreativitas', 'Komunikasi', 'Kewargaan'],
        elemen: [
            { id: 'F1', nama: 'Al-Quran Hadis', materi: 'Ayat tentang berpikir kritis dan ilmu pengetahuan', dimensi: ['Keimanan', 'Penalaran Kritis'] },
            { id: 'F2', nama: 'Akidah', materi: 'Moderasi beragama dan anti radikalisme', dimensi: ['Keimanan', 'Kewargaan'] },
            { id: 'F3', nama: 'Akhlak', materi: 'Etika digital dan media sosial', dimensi: ['Komunikasi', 'Kemandirian'] },
            { id: 'F4', nama: 'Fikih', materi: 'Mawaris, munakahat, ekonomi Islam', dimensi: ['Keimanan', 'Penalaran Kritis'] },
            { id: 'F5', nama: 'Sejarah Islam', materi: 'Organisasi Islam di Indonesia dan dunia', dimensi: ['Kewargaan', 'Kolaborasi'] }
        ]
    }
};

// ==========================================
// GLOBAL STATE
// ==========================================
let currentUser = null;
let userData = null;
let currentPage = 'dashboard';
let selectedPhase = null;
let tujuanPembelajaran = [];
let calendarEvents = [];
let currentSemester = 1;
let classes = [];
let schedules = [];
let students = [];

// ==========================================
// UTILITY FUNCTIONS
// ==========================================
function showToast(type, title, message, duration = 5000) {
    const container = document.getElementById('toastContainer');
    const icons = { success: 'fa-check-circle', error: 'fa-times-circle', warning: 'fa-exclamation-circle', info: 'fa-info-circle' };
    const colors = { success: 'bg-green-500', error: 'bg-red-500', warning: 'bg-yellow-500', info: 'bg-blue-500' };

    const toast = document.createElement('div');
    toast.className = 'bg-white rounded-xl shadow-lg p-4 flex items-start gap-3 max-w-sm transform translate-x-full transition-transform duration-300';
    toast.innerHTML = `
        <div class="w-8 h-8 ${colors[type]} rounded-full flex items-center justify-center flex-shrink-0">
            <i class="fas ${icons[type]} text-white"></i>
        </div>
        <div class="flex-1">
            <p class="font-semibold text-gray-800">${title}</p>
            <p class="text-sm text-gray-600">${message}</p>
        </div>
        <button onclick="this.parentElement.remove()" class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    container.appendChild(toast);
    setTimeout(() => toast.classList.remove('translate-x-full'), 10);
    setTimeout(() => {
        toast.classList.add('translate-x-full');
        setTimeout(() => toast.remove(), 300);
    }, duration);
}

function showModal(content, options = {}) {
    const container = document.getElementById('modalContainer');
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4';
    modal.innerHTML = `
        <div class="bg-white rounded-2xl shadow-2xl w-full ${options.size || 'max-w-lg'} max-h-[90vh] overflow-hidden modal-enter">
            ${options.title ? `
                <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                    <h3 class="text-xl font-bold text-gray-800">${options.title}</h3>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 p-1">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            ` : ''}
            <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
                ${content}
            </div>
        </div>
    `;
    modal.onclick = (e) => { if (e.target === modal) closeModal(); };
    container.innerHTML = '';
    container.appendChild(modal);
}

function closeModal() {
    document.getElementById('modalContainer').innerHTML = '';
}

function formatDate(date, format = 'long') {
    const d = new Date(date);
    const options = format === 'long' 
        ? { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }
        : { year: 'numeric', month: '2-digit', day: '2-digit' };
    return d.toLocaleDateString('id-ID', options);
}

function generateUUID() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
    });
}

function parseCSV(text) {
    const lines = text.trim().split('\n');
    const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
    return lines.slice(1).map(line => {
        const values = line.split(',').map(v => v.trim());
        const row = {};
        headers.forEach((h, i) => row[h] = values[i] || '');
        return row;
    });
}

function checkPremiumAccess() {
    if (!userData) return false;
    if (userData.role === 'superadmin') return true;
    if (userData.subscription === 'premium' || userData.subscription === 'school') {
        if (userData.subscriptionExpiry) {
            return new Date(userData.subscriptionExpiry.toDate()) > new Date();
        }
    }
    return false;
}

function getDimensiDescription(nama) {
    const desc = {
        'Keimanan': 'Penguatan iman dan takwa kepada Allah SWT, pemahaman akidah, dan pengamalan ibadah.',
        'Kewargaan': 'Sikap cinta tanah air, menghargai keragaman, toleransi, dan partisipasi dalam bermasyarakat.',
        'Penalaran Kritis': 'Kemampuan berpikir logis, analitis, dan reflektif dalam memahami ajaran Islam.',
        'Kreativitas': 'Kemampuan menghasilkan ide-ide baru dan inovasi dalam dakwah dan pembelajaran.',
        'Kolaborasi': 'Kemampuan bekerja sama, bergotong royong, dan membangun hubungan harmonis.',
        'Kemandirian': 'Sikap bertanggung jawab, disiplin, dan mampu mengambil inisiatif.',
        'Kesehatan': 'Pemeliharaan kesehatan jasmani dan rohani sesuai ajaran Islam.',
        'Komunikasi': 'Kemampuan menyampaikan pesan dengan baik dan santun dalam berbicara.'
    };
    return desc[nama] || 'Deskripsi tidak tersedia.';
}

// ==========================================
// UI FUNCTIONS
// ==========================================
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebarOverlay');
    sidebar.classList.toggle('sidebar-collapsed');
    overlay.classList.toggle('hidden');
}

function toggleUserMenu() {
    document.getElementById('userMenuDropdown').classList.toggle('hidden');
}

document.addEventListener('click', (e) => {
    const dropdown = document.getElementById('userMenuDropdown');
    if (dropdown && !e.target.closest('[onclick="toggleUserMenu()"]') && !dropdown.contains(e.target)) {
        dropdown.classList.add('hidden');
    }
});

// ==========================================
// PAGE TEMPLATES
// ==========================================
const pageTemplates = {
    dashboard: () => `
        <div class="space-y-6">
            <div class="bg-gradient-to-r from-primary to-purple-600 rounded-2xl p-6 text-white">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div>
                        <h2 class="text-2xl font-bold mb-2">Selamat Datang, ${userData?.name || 'Guru'}! ðŸ‘‹</h2>
                        <p class="text-white/80">Kelola administrasi mengajar dengan mudah dan efisien.</p>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="loadPage('calendar')" class="px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg transition-all">
                            <i class="fas fa-calendar-plus mr-2"></i>Atur Kalender
                        </button>
                        <button onclick="showQuickGenerate()" class="px-4 py-2 bg-white text-primary rounded-lg hover:bg-gray-100 transition-all font-semibold">
                            <i class="fas fa-magic mr-2"></i>Generate
                        </button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-white rounded-xl p-5 shadow-sm card-hover">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                            <i class="fas fa-users text-blue-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-gray-800" id="statStudents">0</p>
                            <p class="text-sm text-gray-500">Total Siswa</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl p-5 shadow-sm card-hover">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                            <i class="fas fa-chalkboard text-green-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-gray-800" id="statClasses">0</p>
                            <p class="text-sm text-gray-500">Kelas Diampu</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl p-5 shadow-sm card-hover">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                            <i class="fas fa-file-alt text-purple-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-gray-800" id="statDocs">0</p>
                            <p class="text-sm text-gray-500">Dokumen</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl p-5 shadow-sm card-hover">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center">
                            <i class="fas fa-calendar-check text-orange-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-gray-800" id="statEffectiveDays">0</p>
                            <p class="text-sm text-gray-500">Hari Efektif</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">
                        <i class="fas fa-bolt text-primary mr-2"></i>Aksi Cepat
                    </h3>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <button onclick="loadPage('calendar')" class="p-4 border-2 border-dashed border-gray-200 rounded-xl hover:border-primary hover:bg-primary/5 transition-all group">
                            <i class="fas fa-calendar-alt text-3xl text-gray-400 group-hover:text-primary mb-2"></i>
                            <p class="font-medium text-gray-700">Kalender</p>
                        </button>
                        <button onclick="loadPage('schedule')" class="p-4 border-2 border-dashed border-gray-200 rounded-xl hover:border-primary hover:bg-primary/5 transition-all group">
                            <i class="fas fa-clock text-3xl text-gray-400 group-hover:text-primary mb-2"></i>
                            <p class="font-medium text-gray-700">Jadwal</p>
                        </button>
                        <button onclick="loadPage('cp')" class="p-4 border-2 border-dashed border-gray-200 rounded-xl hover:border-primary hover:bg-primary/5 transition-all group">
                            <i class="fas fa-book text-3xl text-gray-400 group-hover:text-primary mb-2"></i>
                            <p class="font-medium text-gray-700">CP/TP</p>
                        </button>
                        <button onclick="loadPage('atp')" class="p-4 border-2 border-dashed border-gray-200 rounded-xl hover:border-primary hover:bg-primary/5 transition-all group">
                            <i class="fas fa-route text-3xl text-gray-400 group-hover:text-primary mb-2"></i>
                            <p class="font-medium text-gray-700">ATP</p>
                        </button>
                        <button onclick="loadPage('prota')" class="p-4 border-2 border-dashed border-gray-200 rounded-xl hover:border-primary hover:bg-primary/5 transition-all group">
                            <i class="fas fa-calendar-check text-3xl text-gray-400 group-hover:text-primary mb-2"></i>
                            <p class="font-medium text-gray-700">Prota</p>
                        </button>
                        <button onclick="loadPage('promes')" class="p-4 border-2 border-dashed border-gray-200 rounded-xl hover:border-primary hover:bg-primary/5 transition-all group">
                            <i class="fas fa-calendar-week text-3xl text-gray-400 group-hover:text-primary mb-2"></i>
                            <p class="font-medium text-gray-700">Promes</p>
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">
                        <i class="fas fa-crown text-warning mr-2"></i>Status Langganan
                    </h3>
                    <div class="text-center py-4">
                        ${userData?.subscription === 'premium' || userData?.subscription === 'school' ? `
                            <div class="w-16 h-16 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full flex items-center justify-center mx-auto mb-3">
                                <i class="fas fa-crown text-white text-2xl"></i>
                            </div>
                            <p class="text-xl font-bold text-gray-800 mb-1">${userData.subscription === 'school' ? 'Paket Sekolah' : 'Premium'}</p>
                            <p class="text-sm text-gray-500">Aktif</p>
                        ` : `
                            <div class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center mx-auto mb-3">
                                <i class="fas fa-user text-gray-400 text-2xl"></i>
                            </div>
                            <p class="text-xl font-bold text-gray-800 mb-1">Free</p>
                            <p class="text-sm text-gray-500 mb-4">Upgrade untuk fitur lengkap</p>
                            <button onclick="showUpgradeModal()" class="w-full py-3 bg-gradient-to-r from-yellow-400 to-orange-500 text-white font-semibold rounded-xl hover:shadow-lg transition-all">
                                <i class="fas fa-arrow-up mr-2"></i>Upgrade
                            </button>
                        `}
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">
                    <i class="fas fa-tasks text-primary mr-2"></i>Alur Kerja Single Input
                </h3>
                <div class="flex flex-wrap gap-4">
                    <div class="flex items-center gap-3 p-3 bg-blue-50 rounded-lg flex-1 min-w-[200px]">
                        <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold">1</div>
                        <span class="text-sm">Input Kalender</span>
                    </div>
                    <div class="flex items-center gap-3 p-3 bg-blue-50 rounded-lg flex-1 min-w-[200px]">
                        <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold">2</div>
                        <span class="text-sm">Atur Jadwal</span>
                    </div>
                    <div class="flex items-center gap-3 p-3 bg-blue-50 rounded-lg flex-1 min-w-[200px]">
                        <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold">3</div>
                        <span class="text-sm">Input TP</span>
                    </div>
                    <div class="flex items-center gap-3 p-3 bg-green-50 rounded-lg flex-1 min-w-[200px]">
                        <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white"><i class="fas fa-magic"></i></div>
                        <span class="text-sm font-semibold text-green-700">Auto Generate!</span>
                    </div>
                </div>
            </div>
        </div>
    `,

    profile: () => `
        <div class="max-w-4xl mx-auto space-y-6">
            <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
                <div class="h-32 bg-gradient-to-r from-primary to-purple-600"></div>
                <div class="px-6 pb-6">
                    <div class="flex flex-col md:flex-row md:items-end gap-4 -mt-16">
                        <div class="w-32 h-32 bg-white rounded-2xl shadow-lg flex items-center justify-center border-4 border-white">
                            <span class="text-5xl font-bold text-primary">${userData?.name?.charAt(0) || 'G'}</span>
                        </div>
                        <div class="flex-1">
                            <h2 class="text-2xl font-bold text-gray-800">${userData?.name || 'Nama Guru'}</h2>
                            <p class="text-gray-500">${userData?.email}</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-sm p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-6"><i class="fas fa-user-circle text-primary mr-2"></i>Informasi Profil</h3>
                <form id="profileForm" class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                        <input type="text" id="profileName" value="${userData?.name || ''}" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">NIP</label>
                        <input type="text" id="profileNip" value="${userData?.profile?.nip || ''}" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Nomor Induk Pegawai">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">NUPTK</label>
                        <input type="text" id="profileNuptk" value="${userData?.profile?.nuptk || ''}" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label>
                        <select id="profileMapel" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent">
                            <option value="PAI & Budi Pekerti" ${userData?.profile?.mata_pelajaran === 'PAI & Budi Pekerti' ? 'selected' : ''}>PAI & Budi Pekerti</option>
                            <option value="Matematika" ${userData?.profile?.mata_pelajaran === 'Matematika' ? 'selected' : ''}>Matematika</option>
                            <option value="Bahasa Indonesia" ${userData?.profile?.mata_pelajaran === 'Bahasa Indonesia' ? 'selected' : ''}>Bahasa Indonesia</option>
                            <option value="IPA" ${userData?.profile?.mata_pelajaran === 'IPA' ? 'selected' : ''}>IPA</option>
                            <option value="Lainnya" ${userData?.profile?.mata_pelajaran === 'Lainnya' ? 'selected' : ''}>Lainnya</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Jenjang</label>
                        <select id="profileJenjang" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent">
                            <option value="">Pilih Jenjang</option>
                            <option value="SD/MI" ${userData?.profile?.jenjang === 'SD/MI' ? 'selected' : ''}>SD/MI</option>
                            <option value="SMP/MTs" ${userData?.profile?.jenjang === 'SMP/MTs' ? 'selected' : ''}>SMP/MTs</option>
                            <option value="SMA/MA" ${userData?.profile?.jenjang === 'SMA/MA' ? 'selected' : ''}>SMA/MA</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Fase</label>
                        <select id="profileFase" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent">
                            <option value="">Pilih Fase</option>
                            ${Object.keys(CP_PAI_DEFAULT).map(f => `<option value="${f}" ${userData?.profile?.fase === f ? 'selected' : ''}>Fase ${f} - ${CP_PAI_DEFAULT[f].jenjang}</option>`).join('')}
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Satuan Pendidikan</label>
                        <input type="text" id="profileSekolah" value="${userData?.profile?.satuan_pendidikan || ''}" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Nama Sekolah">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nama Kepala Sekolah</label>
                        <input type="text" id="profileKepsek" value="${userData?.profile?.nama_kepala_sekolah || ''}" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>
                    <div class="md:col-span-2">
                        <button type="submit" class="w-full py-3 bg-primary text-white font-semibold rounded-xl hover:bg-secondary transition-all">
                            <i class="fas fa-save mr-2"></i>Simpan Perubahan
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `,

    cp: () => `
        <div class="space-y-6">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">Capaian Pembelajaran (CP)</h2>
                    <p class="text-gray-500">Berdasarkan Kepka BSKAP 046/H/KR/2025</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="loadDefaultCP()" class="px-4 py-2 border border-gray-200 rounded-lg hover:bg-gray-50 transition-all">
                        <i class="fas fa-sync mr-2"></i>Load CP Default PAI
                    </button>
                    <button onclick="showAddCPModal()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-all">
                        <i class="fas fa-plus mr-2"></i>Tambah CP
                    </button>
                </div>
            </div>

            <!-- 8 Dimensi Profil Lulusan -->
            <div class="bg-gradient-to-r from-emerald-500 to-teal-600 rounded-2xl p-6 text-white">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                        <i class="fas fa-star text-2xl"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold">8 Dimensi Profil Lulusan</h3>
                        <p class="text-white/80 text-sm">Kepka BSKAP No. 046/H/KR/2025</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    ${DIMENSI_LULUSAN.map(d => `
                        <div class="bg-white/10 backdrop-blur rounded-xl p-3 flex items-center gap-3 hover:bg-white/20 transition-all cursor-pointer" onclick="showDimensiDetail('${d.nama}')">
                            <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center">
                                <i class="fas ${d.icon}"></i>
                            </div>
                            <div>
                                <p class="font-semibold text-sm">${d.nama}</p>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>

            <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                <div class="flex items-start gap-3">
                    <i class="fas fa-info-circle text-blue-500 mt-1"></i>
                    <p class="text-sm text-blue-700">CP PAI & Budi Pekerti terintegrasi dengan <strong>8 Dimensi Profil Lulusan</strong>. Guru mapel lain dapat menambahkan CP manual.</p>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4"><i class="fas fa-layer-group text-primary mr-2"></i>Pilih Fase</h3>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                    ${Object.keys(CP_PAI_DEFAULT).map(fase => `
                        <button onclick="selectPhase('${fase}')" class="phase-btn p-4 border-2 border-gray-200 rounded-xl hover:border-primary transition-all text-center" data-fase="${fase}">
                            <div class="text-3xl font-bold text-primary mb-2">Fase ${fase}</div>
                            <p class="text-sm text-gray-500">${CP_PAI_DEFAULT[fase].jenjang}</p>
                        </button>
                    `).join('')}
                </div>
            </div>

            <div id="cpContent" class="bg-white rounded-xl shadow-sm p-6">
                <div class="text-center py-12 text-gray-400">
                    <i class="fas fa-book-open text-6xl mb-4"></i>
                    <p class="text-lg">Pilih Fase untuk melihat Capaian Pembelajaran</p>
                </div>
            </div>

            <div id="tpSection" class="hidden">
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-800"><i class="fas fa-bullseye text-primary mr-2"></i>Tujuan Pembelajaran (TP)</h3>
                        <button onclick="showAddTPModal()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-all">
                            <i class="fas fa-plus mr-2"></i>Tambah TP
                        </button>
                    </div>
                    <div id="tpList" class="space-y-4"></div>
                </div>
            </div>
        </div>
    `,

    calendar: () => `
        <div class="space-y-6">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">Kalender Pendidikan</h2>
                    <p class="text-gray-500">Atur hari efektif, libur, dan kegiatan akademik</p>
                </div>
                <div class="flex gap-3">
                    <select id="calendarYear" onchange="loadCalendarData()" class="px-4 py-2 border border-gray-200 rounded-lg">
                        <option value="2024">2024/2025</option>
                        <option value="2025" selected>2025/2026</option>
                    </select>
                    <button onclick="showAddEventModal()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-all">
                        <i class="fas fa-plus mr-2"></i>Tambah Kegiatan
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-white rounded-xl p-4 shadow-sm">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center"><i class="fas fa-check-circle text-green-600"></i></div>
                        <div><p class="text-2xl font-bold text-gray-800" id="totalEffective">0</p><p class="text-sm text-gray-500">Hari Efektif</p></div>
                    </div>
                </div>
                <div class="bg-white rounded-xl p-4 shadow-sm">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center"><i class="fas fa-calendar-times text-red-600"></i></div>
                        <div><p class="text-2xl font-bold text-gray-800" id="totalHoliday">0</p><p class="text-sm text-gray-500">Hari Libur</p></div>
                    </div>
                </div>
                <div class="bg-white rounded-xl p-4 shadow-sm">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center"><i class="fas fa-book-reader text-blue-600"></i></div>
                        <div><p class="text-2xl font-bold text-gray-800" id="totalExam">0</p><p class="text-sm text-gray-500">Hari Ujian</p></div>
                    </div>
                </div>
                <div class="bg-white rounded-xl p-4 shadow-sm">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center"><i class="fas fa-graduation-cap text-purple-600"></i></div>
                        <div><p class="text-2xl font-bold text-gray-800" id="totalWeeks">0</p><p class="text-sm text-gray-500">Minggu Efektif</p></div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                <div class="border-b border-gray-200">
                    <div class="flex">
                        <button onclick="switchSemester(1)" id="sem1Tab" class="flex-1 py-4 text-center font-semibold border-b-2 border-primary text-primary">Semester 1 (Ganjil)</button>
                        <button onclick="switchSemester(2)" id="sem2Tab" class="flex-1 py-4 text-center font-semibold border-b-2 border-transparent text-gray-500">Semester 2 (Genap)</button>
                    </div>
                </div>
                <div class="p-6">
                    <div id="calendarGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4"><i class="fas fa-list text-primary mr-2"></i>Daftar Kegiatan</h3>
                <div id="eventsList" class="space-y-3"></div>
            </div>
        </div>
    `,

    schedule: () => `
        <div class="space-y-6">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">Jadwal Pelajaran</h2>
                    <p class="text-gray-500">Atur jadwal mengajar dengan validasi anti-bentrok</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="showTimeSettingsModal()" class="px-4 py-2 border border-gray-200 rounded-lg hover:bg-gray-50"><i class="fas fa-cog mr-2"></i>Atur Jam</button>
                    <button onclick="showAddScheduleModal()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary"><i class="fas fa-plus mr-2"></i>Tambah Jadwal</button>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4"><i class="fas fa-school text-primary mr-2"></i>Kelas yang Diampu</h3>
                <div id="classesGrid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3"></div>
                <button onclick="showAddClassModal()" class="mt-4 px-4 py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-primary hover:text-primary transition-all w-full">
                    <i class="fas fa-plus mr-2"></i>Tambah Kelas/Rombel
                </button>
            </div>

            <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-lg font-bold text-gray-800"><i class="fas fa-calendar-week text-primary mr-2"></i>Jadwal Mingguan</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 w-24">Jam</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Senin</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Selasa</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Rabu</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Kamis</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Jumat</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Sabtu</th>
                            </tr>
                        </thead>
                        <tbody id="scheduleTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    `,

    students: () => `
        <div class="space-y-6">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">Data Siswa</h2>
                    <p class="text-gray-500">Kelola data siswa dengan import CSV</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="showImportStudentsModal()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600"><i class="fas fa-file-csv mr-2"></i>Import CSV</button>
                    <button onclick="showAddStudentModal()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary"><i class="fas fa-plus mr-2"></i>Tambah Siswa</button>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-4">
                <div class="flex flex-col md:flex-row gap-4">
                    <div class="flex-1 relative">
                        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input type="text" id="searchStudent" onkeyup="filterStudents()" placeholder="Cari nama atau NISN..." class="w-full pl-12 pr-4 py-3 border border-gray-200 rounded-xl">
                    </div>
                    <select id="filterClass" onchange="filterStudents()" class="px-4 py-3 border border-gray-200 rounded-xl"><option value="">Semua Kelas</option></select>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">No</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">NISN</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Nama Siswa</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">L/P</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Kelas</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Rombel</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTableBody">
                            <tr><td colspan="7" class="px-4 py-12 text-center text-gray-400"><i class="fas fa-users text-4xl mb-2"></i><p>Belum ada data siswa</p></td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="px-6 py-4 border-t border-gray-200">
                    <p class="text-sm text-gray-500">Total: <span id="totalCount">0</span> siswa</p>
                </div>
            </div>
        </div>
    `,

    atp: () => `
        <div class="space-y-6">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">Alur Tujuan Pembelajaran (ATP)</h2>
                    <p class="text-gray-500">Generate ATP otomatis dari CP dan TP</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="generateATP()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600"><i class="fas fa-magic mr-2"></i>Generate ATP</button>
                    <button onclick="exportATP()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary"><i class="fas fa-file-pdf mr-2"></i>Export PDF</button>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-4">
                <div class="flex flex-wrap gap-4">
                    <select id="atpFase" class="px-4 py-2 border border-gray-200 rounded-lg">
                        <option value="">Pilih Fase</option>
                        ${Object.keys(CP_PAI_DEFAULT).map(f => `<option value="${f}">Fase ${f} - ${CP_PAI_DEFAULT[f].jenjang}</option>`).join('')}
                    </select>
                    <select id="atpSemester" class="px-4 py-2 border border-gray-200 rounded-lg">
                        <option value="">Pilih Semester</option>
                        <option value="1">Semester 1</option>
                        <option value="2">Semester 2</option>
                    </select>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">No</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Elemen</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">CP</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">TP</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">JP</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Dimensi</th>
                            </tr>
                        </thead>
                        <tbody id="atpTableBody">
                            <tr><td colspan="6" class="px-4 py-12 text-center text-gray-400"><i class="fas fa-route text-4xl mb-2"></i><p>Pilih Fase dan Semester, lalu klik Generate ATP</p></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `,

    prota: () => `
        <div class="space-y-6">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">Program Tahunan (Prota)</h2>
                    <p class="text-gray-500">Sinkronisasi dengan Kalender dan Jadwal</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="generateProta()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600"><i class="fas fa-magic mr-2"></i>Generate Prota</button>
                    <button onclick="exportProta()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary"><i class="fas fa-file-pdf mr-2"></i>Export PDF</button>
                </div>
            </div>

            <div class="grid md:grid-cols-3 gap-4">
                <div class="bg-white rounded-xl p-4 shadow-sm"><p class="text-sm text-gray-500">Tahun Pelajaran</p><p class="text-xl font-bold text-gray-800">2025/2026</p></div>
                <div class="bg-white rounded-xl p-4 shadow-sm"><p class="text-sm text-gray-500">Total Minggu Efektif</p><p class="text-xl font-bold text-gray-800" id="protaMinggu">0</p></div>
                <div class="bg-white rounded-xl p-4 shadow-sm"><p class="text-sm text-gray-500">Total Jam Pelajaran</p><p class="text-xl font-bold text-gray-800" id="protaJP">0</p></div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-6">
                <div class="text-center py-12 text-gray-400">
                    <i class="fas fa-calendar-check text-4xl mb-2"></i>
                    <p>Klik Generate Prota untuk membuat Program Tahunan</p>
                </div>
            </div>
        </div>
    `,

    promes: () => `
        <div class="space-y-6">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">Program Semester (Promes)</h2>
                    <p class="text-gray-500">Detail perencanaan per semester</p>
                </div>
                <div class="flex gap-3">
                    <select id="promesSemester" class="px-4 py-2 border border-gray-200 rounded-lg">
                        <option value="1">Semester 1</option>
                        <option value="2">Semester 2</option>
                    </select>
                    <button onclick="generatePromes()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600"><i class="fas fa-magic mr-2"></i>Generate</button>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-6">
                <div class="text-center py-12 text-gray-400">
                    <i class="fas fa-calendar-week text-4xl mb-2"></i>
                    <p>Klik Generate Promes untuk membuat Program Semester</p>
                </div>
            </div>
        </div>
    `,

    guide: () => `
        <div class="max-w-4xl mx-auto space-y-6">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-2">Panduan Penggunaan</h2>
                <p class="text-gray-500">Pelajari cara menggunakan Admin Guru Super App</p>
            </div>

            <div class="bg-gradient-to-r from-primary to-purple-600 rounded-2xl p-6 text-white">
                <h3 class="text-xl font-bold mb-4"><i class="fas fa-rocket mr-2"></i>Quick Start</h3>
                <div class="grid md:grid-cols-4 gap-4 text-center">
                    <div><div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-2"><span class="text-xl font-bold">1</span></div><p class="text-sm">Lengkapi Profil</p></div>
                    <div><div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-2"><span class="text-xl font-bold">2</span></div><p class="text-sm">Atur Kalender</p></div>
                    <div><div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-2"><span class="text-xl font-bold">3</span></div><p class="text-sm">Input Jadwal</p></div>
                    <div><div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-2"><span class="text-xl font-bold">4</span></div><p class="text-sm">Generate!</p></div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4"><i class="fas fa-star text-emerald-500 mr-2"></i>8 Dimensi Profil Lulusan</h3>
                <p class="text-gray-600 mb-4">Berdasarkan Kepka BSKAP No. 046/H/KR/2025:</p>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    ${DIMENSI_LULUSAN.map(d => `
                        <div class="p-3 ${d.color} rounded-lg">
                            <div class="flex items-center gap-2 mb-1">
                                <i class="fas ${d.icon}"></i>
                                <span class="font-semibold text-sm">${d.nama}</span>
                            </div>
                            <p class="text-xs opacity-80">${d.deskripsi}</p>
                        </div>
                    `).join('')}
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4"><i class="fas fa-file-csv text-green-500 mr-2"></i>Format Import CSV Siswa</h3>
                <code class="block bg-gray-100 p-4 rounded-lg text-sm mb-4">nisn,nama_siswa,jenis_kelamin,kelas,rombel</code>
                <p class="text-gray-600 text-sm">Contoh: 0012345678,Ahmad Fauzi,L,7,A</p>
            </div>
        </div>
    `,

    'ai-assistant': () => `
        <div class="max-w-4xl mx-auto space-y-6">
            <div class="text-center">
                <div class="w-20 h-20 bg-gradient-to-br from-primary to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-robot text-white text-3xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800">AI Assistant</h2>
                <p class="text-gray-500">Bantuan membuat file CSV dan dokumen</p>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4"><i class="fas fa-lightbulb text-warning mr-2"></i>Template Prompt</h3>
                <div class="grid md:grid-cols-2 gap-4">
                    <div onclick="usePromptTemplate('csv')" class="border border-gray-200 rounded-xl p-4 hover:border-primary cursor-pointer">
                        <h4 class="font-semibold text-gray-800 mb-2"><i class="fas fa-file-csv text-green-500 mr-2"></i>CSV Data Siswa</h4>
                        <p class="text-sm text-gray-600">Generate file CSV format data siswa</p>
                    </div>
                    <div onclick="usePromptTemplate('modul')" class="border border-gray-200 rounded-xl p-4 hover:border-primary cursor-pointer">
                        <h4 class="font-semibold text-gray-800 mb-2"><i class="fas fa-file-alt text-blue-500 mr-2"></i>Modul Ajar</h4>
                        <p class="text-sm text-gray-600">Buat konten modul ajar</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4"><i class="fas fa-code text-primary mr-2"></i>Prompt Output</h3>
                <div id="promptOutput" class="bg-gray-50 rounded-xl p-4 min-h-[200px] font-mono text-sm text-gray-700 whitespace-pre-wrap">Pilih template di atas untuk melihat prompt AI.</div>
                <div class="flex gap-3 mt-4">
                    <button onclick="copyPrompt()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary"><i class="fas fa-copy mr-2"></i>Salin</button>
                </div>
            </div>
        </div>
    `
};

// ==========================================
// PAGE FUNCTIONS
// ==========================================
function loadPage(pageName) {
    currentPage = pageName;
    
    document.querySelectorAll('.menu-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.page === pageName) item.classList.add('active');
    });

    const titles = {
        'dashboard': { title: 'Dashboard', subtitle: 'Selamat datang di Admin Guru Super App' },
        'profile': { title: 'Profil', subtitle: 'Kelola informasi profil Anda' },
        'calendar': { title: 'Kalender Pendidikan', subtitle: 'Atur hari efektif dan kegiatan' },
        'schedule': { title: 'Jadwal Pelajaran', subtitle: 'Atur jadwal mengajar' },
        'students': { title: 'Data Siswa', subtitle: 'Kelola data siswa' },
        'cp': { title: 'Capaian Pembelajaran', subtitle: 'Kelola CP dan TP' },
        'atp': { title: 'ATP', subtitle: 'Alur Tujuan Pembelajaran' },
        'prota': { title: 'Prota', subtitle: 'Program Tahunan' },
        'promes': { title: 'Promes', subtitle: 'Program Semester' },
        'guide': { title: 'Panduan', subtitle: 'Cara menggunakan aplikasi' },
        'ai-assistant': { title: 'AI Assistant', subtitle: 'Bantuan pembuatan dokumen' }
    };

    const info = titles[pageName] || { title: pageName, subtitle: '' };
    document.getElementById('pageTitle').textContent = info.title;
    document.getElementById('pageSubtitle').textContent = info.subtitle;

    const mainContent = document.getElementById('mainContent');
    if (pageTemplates[pageName]) {
        mainContent.innerHTML = pageTemplates[pageName]();
        initializePage(pageName);
    } else {
        mainContent.innerHTML = `<div class="text-center py-20"><i class="fas fa-hard-hat text-6xl text-gray-300 mb-4"></i><h3 class="text-xl font-bold text-gray-800">Dalam pengembangan</h3></div>`;
    }

    if (window.innerWidth < 1024) {
        document.getElementById('sidebar').classList.add('sidebar-collapsed');
        document.getElementById('sidebarOverlay').classList.add('hidden');
    }
}

function initializePage(pageName) {
    switch (pageName) {
        case 'dashboard': loadDashboardStats(); break;
        case 'profile': initProfileForm(); break;
        case 'calendar': loadCalendarData(); break;
        case 'schedule': initSchedule(); break;
        case 'students': loadStudents(); break;
    }
}

// Dashboard
async function loadDashboardStats() {
    if (!currentUser) return;
    try {
        const studentsSnap = await db.collection('users').doc(currentUser.uid).collection('students').get();
        document.getElementById('statStudents').textContent = studentsSnap.size;
        
        const classesSnap = await db.collection('users').doc(currentUser.uid).collection('classes').get();
        document.getElementById('statClasses').textContent = classesSnap.size;
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

// Profile
function initProfileForm() {
    const form = document.getElementById('profileForm');
    if (form) {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            await saveProfile();
        });
    }
}

async function saveProfile() {
    if (!currentUser) return;
    const profileData = {
        name: document.getElementById('profileName').value,
        profile: {
            nip: document.getElementById('profileNip').value,
            nuptk: document.getElementById('profileNuptk').value,
            mata_pelajaran: document.getElementById('profileMapel').value,
            jenjang: document.getElementById('profileJenjang').value,
            fase: document.getElementById('profileFase').value,
            satuan_pendidikan: document.getElementById('profileSekolah').value,
            nama_kepala_sekolah: document.getElementById('profileKepsek').value
        },
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    try {
        await db.collection('users').doc(currentUser.uid).update(profileData);
        userData = { ...userData, ...profileData };
        document.getElementById('userName').textContent = profileData.name;
        document.getElementById('userInitial').textContent = profileData.name.charAt(0);
        document.getElementById('headerUserInitial').textContent = profileData.name.charAt(0);
        showToast('success', 'Berhasil', 'Profil berhasil disimpan');
    } catch (error) {
        showToast('error', 'Gagal', 'Tidak dapat menyimpan profil');
    }
}

// CP Functions
function selectPhase(fase) {
    selectedPhase = fase;
    document.querySelectorAll('.phase-btn').forEach(btn => {
        btn.classList.remove('border-primary', 'bg-primary/5');
        btn.classList.add('border-gray-200');
    });
    document.querySelector(`[data-fase="${fase}"]`).classList.add('border-primary', 'bg-primary/5');
    document.querySelector(`[data-fase="${fase}"]`).classList.remove('border-gray-200');
    
    const cpData = CP_PAI_DEFAULT[fase];
    document.getElementById('cpContent').innerHTML = `
        <div class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
            <div>
                <h3 class="text-xl font-bold text-gray-800">Fase ${fase} - ${cpData.jenjang}</h3>
                <p class="text-gray-500">Capaian Pembelajaran PAI & Budi Pekerti</p>
            </div>
            <div class="flex flex-wrap gap-2">
                ${cpData.dimensi_fokus.map(d => {
                    const dim = DIMENSI_LULUSAN.find(x => x.nama === d);
                    return `<span class="px-3 py-1.5 ${dim?.color || 'bg-gray-100'} rounded-full text-sm font-medium flex items-center gap-1"><i class="fas ${dim?.icon || 'fa-circle'} text-xs"></i>${d}</span>`;
                }).join('')}
            </div>
        </div>
        <div class="space-y-4">
            ${cpData.elemen.map(el => `
                <div class="border border-gray-200 rounded-xl p-4 hover:shadow-md transition-all">
                    <div class="flex items-start gap-4">
                        <div class="w-12 h-12 bg-primary/10 rounded-xl flex items-center justify-center flex-shrink-0">
                            <span class="font-bold text-primary">${el.id}</span>
                        </div>
                        <div class="flex-1">
                            <div class="flex flex-col md:flex-row md:items-center justify-between gap-2 mb-2">
                                <h4 class="font-semibold text-gray-800 text-lg">${el.nama}</h4>
                                <div class="flex flex-wrap gap-1">
                                    ${el.dimensi.map(d => {
                                        const dim = DIMENSI_LULUSAN.find(x => x.nama === d);
                                        return `<span class="px-2 py-0.5 ${dim?.color || 'bg-gray-100'} rounded text-xs font-medium"><i class="fas ${dim?.icon} mr-1"></i>${d}</span>`;
                                    }).join('')}
                                </div>
                            </div>
                            <p class="text-gray-600">${el.materi}</p>
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
    
    document.getElementById('tpSection').classList.remove('hidden');
    loadTujuanPembelajaran(fase);
}

async function loadTujuanPembelajaran(fase) {
    if (!currentUser) return;
    try {
        const snap = await db.collection('users').doc(currentUser.uid).collection('tp').where('fase', '==', fase).orderBy('urutan').get();
        tujuanPembelajaran = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderTujuanPembelajaran();
    } catch (error) {
        console.error('Error:', error);
        tujuanPembelajaran = [];
        renderTujuanPembelajaran();
    }
}

function renderTujuanPembelajaran() {
    const container = document.getElementById('tpList');
    if (!container) return;
    
    if (tujuanPembelajaran.length === 0) {
        container.innerHTML = `<div class="text-center py-8 text-gray-400"><i class="fas fa-bullseye text-4xl mb-2"></i><p>Belum ada TP</p><button onclick="showAddTPModal()" class="mt-2 text-primary hover:underline">Tambah TP</button></div>`;
        return;
    }

    container.innerHTML = tujuanPembelajaran.map((tp, i) => `
        <div class="border border-gray-200 rounded-xl p-4 hover:shadow-md transition-all">
            <div class="flex items-start gap-4">
                <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0">
                    <span class="font-bold text-green-600 text-sm">${tp.urutan || i + 1}</span>
                </div>
                <div class="flex-1">
                    <div class="flex flex-wrap items-center gap-2 mb-2">
                        <span class="text-xs px-2 py-0.5 bg-blue-100 text-blue-700 rounded font-medium">${tp.elemen}</span>
                        <span class="text-xs px-2 py-0.5 bg-purple-100 text-purple-700 rounded">${tp.alokasi} JP</span>
                        ${(tp.dimensi || []).map(d => {
                            const dim = DIMENSI_LULUSAN.find(x => x.nama === d);
                            return `<span class="text-xs px-2 py-0.5 ${dim?.color || 'bg-gray-100'} rounded flex items-center gap-1"><i class="fas ${dim?.icon}"></i>${d}</span>`;
                        }).join('')}
                    </div>
                    <p class="text-gray-800">${tp.deskripsi}</p>
                </div>
                <button onclick="deleteTP('${tp.id}')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg"><i class="fas fa-trash"></i></button>
            </div>
        </div>
    `).join('');
}

function showAddTPModal() {
    if (!selectedPhase) { showToast('warning', 'Perhatian', 'Pilih fase dulu'); return; }
    const cpData = CP_PAI_DEFAULT[selectedPhase];
    
    const content = `
        <form id="addTPForm" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Elemen CP</label>
                <select id="tpElemen" required class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                    ${cpData.elemen.map(el => `<option value="${el.nama}">${el.id} - ${el.nama}</option>`).join('')}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Dimensi Lulusan</label>
                <div class="grid grid-cols-2 gap-2">
                    ${DIMENSI_LULUSAN.map(d => `
                        <label class="flex items-center gap-2 p-2 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" name="dimensi" value="${d.nama}" class="w-4 h-4 text-primary rounded">
                            <i class="fas ${d.icon} text-gray-400 text-sm"></i>
                            <span class="text-sm text-gray-700">${d.nama}</span>
                        </label>
                    `).join('')}
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi TP</label>
                <textarea id="tpDeskripsi" required rows="3" class="w-full px-4 py-3 border border-gray-200 rounded-xl" placeholder="Peserta didik mampu..."></textarea>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Alokasi (JP)</label>
                    <input type="number" id="tpAlokasi" required min="1" value="2" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Urutan</label>
                    <input type="number" id="tpUrutan" required min="1" value="${tujuanPembelajaran.length + 1}" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                </div>
            </div>
            <div class="flex gap-3 pt-4">
                <button type="button" onclick="closeModal()" class="flex-1 py-3 border border-gray-200 rounded-xl font-medium hover:bg-gray-50">Batal</button>
                <button type="submit" class="flex-1 py-3 bg-primary text-white rounded-xl font-medium hover:bg-secondary">Simpan</button>
            </div>
        </form>
    `;
    
    showModal(content, { title: 'Tambah Tujuan Pembelajaran', size: 'max-w-xl' });
    document.getElementById('addTPForm').addEventListener('submit', async (e) => { e.preventDefault(); await saveTP(); });
}

async function saveTP() {
    if (!currentUser || !selectedPhase) return;
    const selectedDimensi = Array.from(document.querySelectorAll('input[name="dimensi"]:checked')).map(cb => cb.value);
    if (selectedDimensi.length === 0) { showToast('warning', 'Perhatian', 'Pilih minimal 1 dimensi'); return; }

    try {
        await db.collection('users').doc(currentUser.uid).collection('tp').add({
            fase: selectedPhase,
            elemen: document.getElementById('tpElemen').value,
            deskripsi: document.getElementById('tpDeskripsi').value,
            alokasi: parseInt(document.getElementById('tpAlokasi').value),
            urutan: parseInt(document.getElementById('tpUrutan').value),
            dimensi: selectedDimensi,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        closeModal();
        showToast('success', 'Berhasil', 'TP berhasil ditambahkan');
        loadTujuanPembelajaran(selectedPhase);
    } catch (error) {
        showToast('error', 'Gagal', 'Tidak dapat menyimpan TP');
    }
}

async function deleteTP(tpId) {
    if (!confirm('Hapus TP ini?')) return;
    try {
        await db.collection('users').doc(currentUser.uid).collection('tp').doc(tpId).delete();
        showToast('success', 'Berhasil', 'TP dihapus');
        loadTujuanPembelajaran(selectedPhase);
    } catch (error) {
        showToast('error', 'Gagal', 'Tidak dapat menghapus TP');
    }
}

function showDimensiDetail(nama) {
    const dimensi = DIMENSI_LULUSAN.find(d => d.nama === nama);
    if (!dimensi) return;
    
    const content = `
        <div class="space-y-6">
            <div class="flex items-center gap-4">
                <div class="w-16 h-16 ${dimensi.color} rounded-2xl flex items-center justify-center">
                    <i class="fas ${dimensi.icon} text-3xl"></i>
                </div>
                <div>
                    <h3 class="text-2xl font-bold text-gray-800">${dimensi.nama}</h3>
                    <p class="text-gray-600">${dimensi.deskripsi}</p>
                </div>
            </div>
            <div class="bg-gray-50 rounded-xl p-4">
                <h4 class="font-semibold text-gray-700 mb-2">Tentang Dimensi Ini</h4>
                <p class="text-gray-600 text-sm">${getDimensiDescription(dimensi.nama)}</p>
            </div>
            <button onclick="closeModal()" class="w-full py-3 bg-primary text-white rounded-xl font-medium hover:bg-secondary">Tutup</button>
        </div>
    `;
    showModal(content, { title: `Dimensi: ${dimensi.nama}` });
}

function loadDefaultCP() {
    showToast('info', 'Info', 'CP PAI default sudah tersedia. Pilih fase untuk melihat.');
}

// Calendar Functions
async function loadCalendarData() {
    if (!currentUser) return;
    const year = document.getElementById('calendarYear')?.value || '2025';
    
    try {
        const snap = await db.collection('users').doc(currentUser.uid).collection('calendar').where('year', '==', year).get();
        calendarEvents = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderCalendarGrid();
        renderEventsList();
        updateCalendarSummary();
    } catch (error) {
        console.error('Error:', error);
    }
}

function switchSemester(sem) {
    currentSemester = sem;
    document.getElementById('sem1Tab').classList.toggle('border-primary', sem === 1);
    document.getElementById('sem1Tab').classList.toggle('text-primary', sem === 1);
    document.getElementById('sem2Tab').classList.toggle('border-primary', sem === 2);
    document.getElementById('sem2Tab').classList.toggle('text-primary', sem === 2);
    renderCalendarGrid();
}

function renderCalendarGrid() {
    const year = parseInt(document.getElementById('calendarYear')?.value || '2025');
    const months = currentSemester === 1 
        ? [{m:6,y:year},{m:7,y:year},{m:8,y:year},{m:9,y:year},{m:10,y:year},{m:11,y:year}]
        : [{m:0,y:year+1},{m:1,y:year+1},{m:2,y:year+1},{m:3,y:year+1},{m:4,y:year+1},{m:5,y:year+1}];

    const monthNames = ['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];
    const dayNames = ['Min','Sen','Sel','Rab','Kam','Jum','Sab'];

    const container = document.getElementById('calendarGrid');
    if (!container) return;

    container.innerHTML = months.map(({m, y}) => {
        const firstDay = new Date(y, m, 1).getDay();
        const daysInMonth = new Date(y, m + 1, 0).getDate();
        
        let daysHtml = '';
        for (let i = 0; i < firstDay; i++) daysHtml += '<div class="h-8"></div>';
        
        for (let d = 1; d <= daysInMonth; d++) {
            const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const event = calendarEvents.find(e => e.date === dateStr);
            const isWeekend = new Date(y, m, d).getDay() === 0;
            
            let bgClass = 'bg-white hover:bg-gray-100';
            let textClass = isWeekend ? 'text-red-500' : 'text-gray-700';
            
            if (event) {
                bgClass = event.type === 'holiday' ? 'bg-red-100' : event.type === 'exam' ? 'bg-blue-100' : 'bg-purple-100';
                textClass = event.type === 'holiday' ? 'text-red-700' : event.type === 'exam' ? 'text-blue-700' : 'text-purple-700';
            }
            
            daysHtml += `<div class="h-8 flex items-center justify-center rounded cursor-pointer text-sm font-medium ${bgClass} ${textClass} transition-all" title="${event?.name || ''}">${d}</div>`;
        }
        
        return `
            <div class="bg-gray-50 rounded-xl p-4">
                <h4 class="font-semibold text-gray-800 mb-3 text-center">${monthNames[m]} ${y}</h4>
                <div class="grid grid-cols-7 gap-1 text-center text-xs text-gray-500 mb-2">${dayNames.map(d => `<div>${d}</div>`).join('')}</div>
                <div class="grid grid-cols-7 gap-1">${daysHtml}</div>
            </div>
        `;
    }).join('');
}

function renderEventsList() {
    const container = document.getElementById('eventsList');
    if (!container) return;
    
    if (calendarEvents.length === 0) {
        container.innerHTML = `<div class="text-center py-8 text-gray-400"><i class="fas fa-calendar-plus text-4xl mb-2"></i><p>Belum ada kegiatan</p></div>`;
        return;
    }

    container.innerHTML = calendarEvents.sort((a,b) => a.date.localeCompare(b.date)).map(event => `
        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
            <div class="flex items-center gap-4">
                <div class="text-center"><p class="text-2xl font-bold text-gray-800">${new Date(event.date).getDate()}</p><p class="text-xs text-gray-500">${new Date(event.date).toLocaleDateString('id-ID',{month:'short'})}</p></div>
                <div><p class="font-semibold text-gray-800">${event.name}</p><span class="text-xs px-2 py-0.5 rounded ${event.type==='holiday'?'bg-red-100 text-red-700':event.type==='exam'?'bg-blue-100 text-blue-700':'bg-purple-100 text-purple-700'}">${event.type==='holiday'?'Libur':event.type==='exam'?'Ujian':'Kegiatan'}</span></div>
            </div>
            <button onclick="deleteEvent('${event.id}')" class="text-red-500 hover:bg-red-50 p-2 rounded-lg"><i class="fas fa-trash"></i></button>
        </div>
    `).join('');
}

function updateCalendarSummary() {
    const holidays = calendarEvents.filter(e => e.type === 'holiday').length;
    const exams = calendarEvents.filter(e => e.type === 'exam').length;
    const effective = 200 - holidays;
    
    const el1 = document.getElementById('totalEffective'); if (el1) el1.textContent = effective;
    const el2 = document.getElementById('totalHoliday'); if (el2) el2.textContent = holidays;
    const el3 = document.getElementById('totalExam'); if (el3) el3.textContent = exams;
    const el4 = document.getElementById('totalWeeks'); if (el4) el4.textContent = Math.floor(effective / 5);
}

function showAddEventModal() {
    const content = `
        <form id="addEventForm" class="space-y-4">
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Nama Kegiatan</label><input type="text" id="eventName" required class="w-full px-4 py-3 border border-gray-200 rounded-xl" placeholder="Contoh: Libur Hari Raya"></div>
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label><input type="date" id="eventDate" required class="w-full px-4 py-3 border border-gray-200 rounded-xl"></div>
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Jenis</label><select id="eventType" class="w-full px-4 py-3 border border-gray-200 rounded-xl"><option value="holiday">Libur</option><option value="exam">Ujian</option><option value="activity">Kegiatan</option></select></div>
            <div class="flex gap-3 pt-4">
                <button type="button" onclick="closeModal()" class="flex-1 py-3 border border-gray-200 rounded-xl font-medium hover:bg-gray-50">Batal</button>
                <button type="submit" class="flex-1 py-3 bg-primary text-white rounded-xl font-medium hover:bg-secondary">Simpan</button>
            </div>
        </form>
    `;
    showModal(content, { title: 'Tambah Kegiatan' });
    document.getElementById('addEventForm').addEventListener('submit', async (e) => { e.preventDefault(); await saveEvent(); });
}

async function saveEvent() {
    if (!currentUser) return;
    const year = document.getElementById('calendarYear').value;
    try {
        await db.collection('users').doc(currentUser.uid).collection('calendar').add({
            name: document.getElementById('eventName').value,
            date: document.getElementById('eventDate').value,
            type: document.getElementById('eventType').value,
            year,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        closeModal();
        showToast('success', 'Berhasil', 'Kegiatan ditambahkan');
        loadCalendarData();
    } catch (error) {
        showToast('error', 'Gagal', 'Tidak dapat menyimpan');
    }
}

async function deleteEvent(eventId) {
    if (!confirm('Hapus kegiatan?')) return;
    try {
        await db.collection('users').doc(currentUser.uid).collection('calendar').doc(eventId).delete();
        showToast('success', 'Berhasil', 'Kegiatan dihapus');
        loadCalendarData();
    } catch (error) {
        showToast('error', 'Gagal', 'Tidak dapat menghapus');
    }
}

// Schedule Functions
const timeSlots = [
    {id:1,start:'07:00',end:'07:40'},{id:2,start:'07:40',end:'08:20'},{id:3,start:'08:20',end:'09:00'},
    {id:4,start:'09:15',end:'09:55'},{id:5,start:'09:55',end:'10:35'},{id:6,start:'10:35',end:'11:15'},
    {id:7,start:'11:15',end:'11:55'},{id:8,start:'12:30',end:'13:10'}
];

async function initSchedule() {
    await loadClasses();
    await loadSchedules();
    renderClassesGrid();
    renderScheduleTable();
}

async function loadClasses() {
    if (!currentUser) return;
    try {
        const snap = await db.collection('users').doc(currentUser.uid).collection('classes').orderBy('name').get();
        classes = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    } catch (error) {
        console.error('Error:', error);
    }
}

async function loadSchedules() {
    if (!currentUser) return;
    try {
        const snap = await db.collection('users').doc(currentUser.uid).collection('schedules').get();
        schedules = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    } catch (error) {
        console.error('Error:', error);
    }
}

function renderClassesGrid() {
    const container = document.getElementById('classesGrid');
    if (!container) return;
    
    if (classes.length === 0) {
        container.innerHTML = `<div class="col-span-full text-center py-4 text-gray-400">Belum ada kelas</div>`;
        return;
    }

    container.innerHTML = classes.map(cls => `
        <div class="relative group">
            <div class="p-4 bg-primary/10 border-2 border-primary/20 rounded-xl text-center">
                <p class="font-bold text-primary">${cls.name}</p>
                <p class="text-xs text-gray-500">${cls.studentCount || 0} siswa</p>
            </div>
            <button onclick="deleteClass('${cls.id}')" class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full text-xs hidden group-hover:flex items-center justify-center"><i class="fas fa-times"></i></button>
        </div>
    `).join('');
}

function renderScheduleTable() {
    const days = ['Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'];
    const tbody = document.getElementById('scheduleTableBody');
    if (!tbody) return;
    
    tbody.innerHTML = timeSlots.map(slot => `
        <tr class="border-b border-gray-100">
            <td class="px-4 py-3 text-sm font-medium text-gray-700">${slot.start}<br><span class="text-gray-400">${slot.end}</span></td>
            ${days.map(day => {
                const schedule = schedules.find(s => s.day === day && s.slotId === slot.id);
                return schedule ? `
                    <td class="px-2 py-2 text-center">
                        <div class="p-2 bg-primary/10 rounded-lg">
                            <p class="font-semibold text-primary text-sm">${schedule.className}</p>
                        </div>
                    </td>
                ` : `
                    <td class="px-2 py-2 text-center">
                        <button onclick="quickAddSchedule('${day}', ${slot.id})" class="w-full p-2 border border-dashed border-gray-200 rounded-lg text-gray-400 hover:border-primary hover:text-primary"><i class="fas fa-plus"></i></button>
                    </td>
                `;
            }).join('')}
        </tr>
    `).join('');
}

function showAddClassModal() {
    const content = `
        <form id="addClassForm" class="space-y-4">
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Nama Kelas</label><input type="text" id="className" required class="w-full px-4 py-3 border border-gray-200 rounded-xl" placeholder="VII A"></div>
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Jumlah Siswa</label><input type="number" id="classStudentCount" min="0" value="0" class="w-full px-4 py-3 border border-gray-200 rounded-xl"></div>
            <div class="flex gap-3 pt-4">
                <button type="button" onclick="closeModal()" class="flex-1 py-3 border border-gray-200 rounded-xl font-medium hover:bg-gray-50">Batal</button>
                <button type="submit" class="flex-1 py-3 bg-primary text-white rounded-xl font-medium hover:bg-secondary">Simpan</button>
            </div>
        </form>
    `;
    showModal(content, { title: 'Tambah Kelas' });
    document.getElementById('addClassForm').addEventListener('submit', async (e) => { e.preventDefault(); await addClass(); });
}

async function addClass() {
    if (!currentUser) return;
    try {
        await db.collection('users').doc(currentUser.uid).collection('classes').add({
            name: document.getElementById('className').value.trim(),
            studentCount: parseInt(document.getElementById('classStudentCount').value) || 0,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        closeModal();
        showToast('success', 'Berhasil', 'Kelas ditambahkan');
        await loadClasses();
        renderClassesGrid();
    } catch (error) {
        showToast('error', 'Gagal', 'Tidak dapat menyimpan');
    }
}

async function deleteClass(classId) {
    if (!confirm('Hapus kelas?')) return;
    try {
        await db.collection('users').doc(currentUser.uid).collection('classes').doc(classId).delete();
        showToast('success', 'Berhasil', 'Kelas dihapus');
        await loadClasses();
        renderClassesGrid();
    } catch (error) {
        showToast('error', 'Gagal', 'Tidak dapat menghapus');
    }
}

function quickAddSchedule(day, slotId) {
    if (classes.length === 0) { showToast('warning', 'Perhatian', 'Tambahkan kelas dulu'); return; }
    const slot = timeSlots.find(s => s.id === slotId);
    
    const content = `
        <form id="quickScheduleForm" class="space-y-4">
            <div class="bg-gray-50 p-4 rounded-xl"><p class="font-semibold text-gray-800">${day}</p><p class="text-gray-500">${slot.start} - ${slot.end}</p></div>
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label><select id="scheduleClass" required class="w-full px-4 py-3 border border-gray-200 rounded-xl"><option value="">Pilih</option>${classes.map(c => `<option value="${c.name}">${c.name}</option>`).join('')}</select></div>
            <div class="flex gap-3 pt-4">
                <button type="button" onclick="closeModal()" class="flex-1 py-3 border border-gray-200 rounded-xl font-medium hover:bg-gray-50">Batal</button>
                <button type="submit" class="flex-1 py-3 bg-primary text-white rounded-xl font-medium hover:bg-secondary">Simpan</button>
            </div>
        </form>
    `;
    showModal(content, { title: 'Tambah Jadwal' });
    document.getElementById('quickScheduleForm').addEventListener('submit', async (e) => { e.preventDefault(); await saveSchedule(day, slotId); });
}

async function saveSchedule(day, slotId) {
    if (!currentUser) return;
    const slot = timeSlots.find(s => s.id === slotId);
    try {
        await db.collection('users').doc(currentUser.uid).collection('schedules').add({
            day, slotId,
            className: document.getElementById('scheduleClass').value,
            startTime: slot.start,
            endTime: slot.end,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        closeModal();
        showToast('success', 'Berhasil', 'Jadwal ditambahkan');
        await loadSchedules();
        renderScheduleTable();
    } catch (error) {
        showToast('error', 'Gagal', 'Tidak dapat menyimpan');
    }
}

// Students Functions
async function loadStudents() {
    if (!currentUser) return;
    try {
        const snap = await db.collection('users').doc(currentUser.uid).collection('students').orderBy('nama_siswa').get();
        students = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const uniqueClasses = [...new Set(students.map(s => s.kelas))].filter(Boolean).sort();
        const filterClass = document.getElementById('filterClass');
        if (filterClass) filterClass.innerHTML = '<option value="">Semua Kelas</option>' + uniqueClasses.map(c => `<option value="${c}">${c}</option>`).join('');
        
        renderStudentsTable();
    } catch (error) {
        console.error('Error:', error);
    }
}

function filterStudents() { renderStudentsTable(); }

function renderStudentsTable() {
    const search = (document.getElementById('searchStudent')?.value || '').toLowerCase();
    const filterClass = document.getElementById('filterClass')?.value || '';
    
    let filtered = students.filter(s => {
        const matchSearch = s.nama_siswa?.toLowerCase().includes(search) || s.nisn?.includes(search);
        const matchClass = !filterClass || s.kelas === filterClass;
        return matchSearch && matchClass;
    });

    const tbody = document.getElementById('studentsTableBody');
    if (!tbody) return;
    
    if (filtered.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="px-4 py-12 text-center text-gray-400"><i class="fas fa-users text-4xl mb-2"></i><p>Tidak ada data</p></td></tr>`;
    } else {
        tbody.innerHTML = filtered.map((s, i) => `
            <tr class="border-b border-gray-100 hover:bg-gray-50">
                <td class="px-4 py-3 text-sm">${i + 1}</td>
                <td class="px-4 py-3 text-sm font-mono">${s.nisn || '-'}</td>
                <td class="px-4 py-3 text-sm font-medium">${s.nama_siswa}</td>
                <td class="px-4 py-3 text-sm text-center"><span class="px-2 py-1 rounded ${s.jenis_kelamin === 'L' ? 'bg-blue-100 text-blue-700' : 'bg-pink-100 text-pink-700'}">${s.jenis_kelamin}</span></td>
                <td class="px-4 py-3 text-sm text-center">${s.kelas || '-'}</td>
                <td class="px-4 py-3 text-sm text-center">${s.rombel || '-'}</td>
                <td class="px-4 py-3 text-center"><button onclick="deleteStudent('${s.id}')" class="p-1 text-red-600 hover:bg-red-50 rounded"><i class="fas fa-trash"></i></button></td>
            </tr>
        `).join('');
    }

    const el = document.getElementById('totalCount'); if (el) el.textContent = filtered.length;
}

function showImportStudentsModal() {
    const content = `
        <div class="space-y-6">
            <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                <h4 class="font-semibold text-blue-800 mb-2">Format CSV:</h4>
                <code class="text-sm text-blue-700">nisn,nama_siswa,jenis_kelamin,kelas,rombel</code>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Upload File CSV</label>
                <input type="file" id="csvFile" accept=".csv" class="w-full px-4 py-3 border border-gray-200 rounded-xl" onchange="previewCSV(this.files[0])">
            </div>
            <div id="csvPreview" class="hidden">
                <p id="csvPreviewCount" class="text-sm text-gray-500 mb-2"></p>
            </div>
            <div class="flex gap-3">
                <button type="button" onclick="closeModal()" class="flex-1 py-3 border border-gray-200 rounded-xl font-medium hover:bg-gray-50">Batal</button>
                <button type="button" onclick="importStudentsFromCSV()" id="importBtn" disabled class="flex-1 py-3 bg-primary text-white rounded-xl font-medium hover:bg-secondary disabled:opacity-50">Import</button>
            </div>
        </div>
    `;
    showModal(content, { title: 'Import Data Siswa', size: 'max-w-lg' });
}

let csvData = [];

function previewCSV(file) {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        csvData = parseCSV(e.target.result);
        if (csvData.length === 0) { showToast('error', 'Error', 'File kosong'); return; }
        document.getElementById('csvPreview').classList.remove('hidden');
        document.getElementById('csvPreviewCount').textContent = `Total: ${csvData.length} data`;
        document.getElementById('importBtn').disabled = false;
    };
    reader.readAsText(file);
}

async function importStudentsFromCSV() {
    if (!currentUser || csvData.length === 0) return;
    const btn = document.getElementById('importBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Importing...';
    
    try {
        const batch = db.batch();
        for (const row of csvData) {
            const ref = db.collection('users').doc(currentUser.uid).collection('students').doc();
            batch.set(ref, {
                nisn: row.nisn || '',
                nama_siswa: row.nama_siswa || row['nama siswa'] || '',
                jenis_kelamin: (row.jenis_kelamin || row['jenis kelamin'] || 'L').toUpperCase(),
                kelas: row.kelas || '',
                rombel: row.rombel || '',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
        await batch.commit();
        closeModal();
        showToast('success', 'Berhasil', `${csvData.length} data diimport`);
        csvData = [];
        await loadStudents();
    } catch (error) {
        showToast('error', 'Gagal', 'Tidak dapat import');
        console.error(error);
    }
}

async function deleteStudent(studentId) {
    if (!confirm('Hapus siswa?')) return;
    try {
        await db.collection('users').doc(currentUser.uid).collection('students').doc(studentId).delete();
        showToast('success', 'Berhasil', 'Siswa dihapus');
        await loadStudents();
    } catch (error) {
        showToast('error', 'Gagal', 'Tidak dapat menghapus');
    }
}

// ATP, Prota, Promes Generate
async function generateATP() {
    const fase = document.getElementById('atpFase')?.value;
    const semester = document.getElementById('atpSemester')?.value;
    if (!fase || !semester) { showToast('warning', 'Perhatian', 'Pilih Fase dan Semester'); return; }
    
    try {
        const snap = await db.collection('users').doc(currentUser.uid).collection('tp').where('fase', '==', fase).get();
        if (snap.empty) { showToast('warning', 'Perhatian', 'Belum ada TP untuk fase ini'); return; }
        
        const tpList = snap.docs.map(doc => doc.data());
        const tbody = document.getElementById('atpTableBody');
        
        tbody.innerHTML = tpList.map((tp, i) => `
            <tr class="border-b border-gray-100">
                <td class="px-4 py-3 text-center">${i + 1}</td>
                <td class="px-4 py-3">${tp.elemen}</td>
                <td class="px-4 py-3">${CP_PAI_DEFAULT[fase].elemen.find(e => e.nama === tp.elemen)?.materi || '-'}</td>
                <td class="px-4 py-3">${tp.deskripsi}</td>
                <td class="px-4 py-3 text-center">${tp.alokasi} JP</td>
                <td class="px-4 py-3 text-center">
                    <div class="flex flex-wrap gap-1 justify-center">
                        ${(tp.dimensi || []).map(d => {
                            const dim = DIMENSI_LULUSAN.find(x => x.nama === d);
                            return `<span class="px-1.5 py-0.5 ${dim?.color || 'bg-gray-100'} rounded text-xs">${d.substring(0,3)}</span>`;
                        }).join('')}
                    </div>
                </td>
            </tr>
        `).join('');
        
        showToast('success', 'Berhasil', `ATP dengan ${tpList.length} TP berhasil di-generate`);
    } catch (error) {
        showToast('error', 'Gagal', 'Tidak dapat generate ATP');
        console.error(error);
    }
}

function generateProta() {
    showToast('info', 'Info', 'Pastikan Kalender dan ATP sudah diatur terlebih dahulu');
}

function generatePromes() {
    showToast('info', 'Info', 'Pastikan Prota dan Jadwal sudah diatur terlebih dahulu');
}

function exportATP() {
    showToast('info', 'Info', 'Fitur export PDF akan segera tersedia');
}

function exportProta() {
    showToast('info', 'Info', 'Fitur export PDF akan segera tersedia');
}

// AI Assistant
function usePromptTemplate(type) {
    const templates = {
        'csv': `Buatlah file CSV dengan format data siswa:

Kolom: nisn,nama_siswa,jenis_kelamin,kelas,rombel

Contoh isi:
nisn,nama_siswa,jenis_kelamin,kelas,rombel
0012345678,Ahmad Fauzi,L,7,A
0012345679,Siti Aisyah,P,7,A
0012345680,Muhammad Rizki,L,7,B

Tolong buatkan data siswa untuk:
- Kelas: [SEBUTKAN KELAS, misal: 7, 8, 9]
- Jumlah: [SEBUTKAN JUMLAH SISWA]
- Rombel: [SEBUTKAN ROMBEL, misal: A, B, C]

Pastikan:
- NISN unik 10 digit
- Jenis kelamin L atau P
- Nama realistis Indonesia`,

        'modul': `Buatlah Modul Ajar PAI & Budi Pekerti dengan format:

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
MODUL AJAR PAI & BUDI PEKERTI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

A. INFORMASI UMUM
1. Identitas Modul
   - Satuan Pendidikan : [NAMA SEKOLAH]
   - Kelas/Semester    : [KELAS] / [SEMESTER]
   - Fase              : [FASE]
   - Tahun Pelajaran   : 2025/2026
   - Alokasi Waktu     : [JUMLAH] JP

2. Kompetensi Awal
   [Kemampuan prasyarat siswa]

3. 8 Dimensi Profil Lulusan yang Dikembangkan
   â˜‘ Keimanan       â˜ Kreativitas     â˜ Kesehatan
   â˜ Kewargaan      â˜ Kolaborasi      â˜ Komunikasi
   â˜ Penalaran Kritis   â˜ Kemandirian

4. Sarana & Prasarana
   [Alat dan bahan yang dibutuhkan]

5. Target Peserta Didik
   [Regular/Berkebutuhan khusus/Berbakat]

6. Model Pembelajaran
   [Tatap Muka/PJJ/Blended]

B. KOMPONEN INTI
1. Tujuan Pembelajaran
   [Deskripsi TP sesuai ATP]

2. Pemahaman Bermakna
   [Konsep utama yang dipelajari]

3. Pertanyaan Pemantik
   - [Pertanyaan 1]
   - [Pertanyaan 2]

4. Kegiatan Pembelajaran
   
   PENDAHULUAN (10 menit)
   - Salam dan doa
   - Apersepsi
   - Motivasi
   
   INTI (60 menit)
   - Kegiatan 1: [Mengamati/Membaca]
   - Kegiatan 2: [Diskusi/Tanya Jawab]
   - Kegiatan 3: [Praktik/Presentasi]
   
   PENUTUP (10 menit)
   - Refleksi
   - Kesimpulan
   - Doa penutup

5. Asesmen
   - Diagnostik : [Jenis asesmen]
   - Formatif   : [Jenis asesmen]
   - Sumatif    : [Jenis asesmen]

6. Refleksi

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Buatkan untuk:
- Materi: [SEBUTKAN MATERI]
- Kelas/Fase: [SEBUTKAN]
- Alokasi: [JUMLAH JP]`
    };

    const output = document.getElementById('promptOutput');
    if (output) output.textContent = templates[type] || 'Template tidak ditemukan';
}

function copyPrompt() {
    const text = document.getElementById('promptOutput')?.textContent || '';
    navigator.clipboard.writeText(text).then(() => {
        showToast('success', 'Berhasil', 'Prompt berhasil disalin ke clipboard');
    }).catch(() => {
        showToast('error', 'Gagal', 'Tidak dapat menyalin');
    });
}

// Utility Modals
function showUpgradeModal() {
    const content = `
        <div class="text-center py-4">
            <div class="w-20 h-20 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-crown text-white text-3xl"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Upgrade ke Premium</h3>
            <p class="text-gray-600 mb-6">Dapatkan akses ke semua fitur lengkap</p>
            
            <div class="space-y-3 mb-6 text-left">
                <div class="flex items-center gap-3 p-3 bg-green-50 rounded-lg">
                    <i class="fas fa-check-circle text-green-500"></i>
                    <span>Modul Ajar Lengkap</span>
                </div>
                <div class="flex items-center gap-3 p-3 bg-green-50 rounded-lg">
                    <i class="fas fa-check-circle text-green-500"></i>
                    <span>LKPD dengan Teks Arab (RTL)</span>
                </div>
                <div class="flex items-center gap-3 p-3 bg-green-50 rounded-lg">
                    <i class="fas fa-check-circle text-green-500"></i>
                    <span>Bank Soal Terintegrasi ATP</span>
                </div>
                <div class="flex items-center gap-3 p-3 bg-green-50 rounded-lg">
                    <i class="fas fa-check-circle text-green-500"></i>
                    <span>Export PDF & Excel</span>
                </div>
            </div>
            
            <div class="bg-gray-100 rounded-xl p-4 mb-6">
                <p class="text-3xl font-bold text-primary">Rp 99.000<span class="text-sm text-gray-500 font-normal">/tahun</span></p>
            </div>
            
            <p class="text-sm text-gray-500 mb-4">Hubungi admin untuk proses pembayaran:</p>
            <a href="mailto:afifaro@gmail.com" class="inline-flex items-center gap-2 px-6 py-3 bg-primary text-white rounded-xl hover:bg-secondary transition-all">
                <i class="fas fa-envelope"></i>
                <span>afifaro@gmail.com</span>
            </a>
        </div>
    `;
    showModal(content, { title: '' });
}

function showQuickGenerate() {
    const content = `
        <div class="space-y-4">
            <p class="text-gray-600">Pilih dokumen yang ingin di-generate:</p>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="closeModal(); loadPage('atp')" class="p-4 border border-gray-200 rounded-xl hover:border-primary hover:bg-primary/5 transition-all text-left">
                    <i class="fas fa-route text-primary text-xl mb-2"></i>
                    <p class="font-semibold text-gray-800">ATP</p>
                    <p class="text-xs text-gray-500">Alur Tujuan Pembelajaran</p>
                </button>
                <button onclick="closeModal(); loadPage('prota')" class="p-4 border border-gray-200 rounded-xl hover:border-primary hover:bg-primary/5 transition-all text-left">
                    <i class="fas fa-calendar-check text-primary text-xl mb-2"></i>
                    <p class="font-semibold text-gray-800">Prota</p>
                    <p class="text-xs text-gray-500">Program Tahunan</p>
                </button>
                <button onclick="closeModal(); loadPage('promes')" class="p-4 border border-gray-200 rounded-xl hover:border-primary hover:bg-primary/5 transition-all text-left">
                    <i class="fas fa-calendar-week text-primary text-xl mb-2"></i>
                    <p class="font-semibold text-gray-800">Promes</p>
                    <p class="text-xs text-gray-500">Program Semester</p>
                </button>
                <button onclick="closeModal(); loadPage('modul')" class="p-4 border border-gray-200 rounded-xl hover:border-primary hover:bg-primary/5 transition-all text-left relative">
                    <i class="fas fa-file-alt text-primary text-xl mb-2"></i>
                    <p class="font-semibold text-gray-800">Modul Ajar</p>
                    <p class="text-xs text-gray-500">Rencana Pembelajaran</p>
                    ${!checkPremiumAccess() ? '<span class="absolute top-2 right-2 px-2 py-0.5 bg-yellow-100 text-yellow-700 text-xs rounded">PRO</span>' : ''}
                </button>
            </div>
        </div>
    `;
    showModal(content, { title: 'Generate Dokumen' });
}

function showAddStudentModal() {
    const content = `
        <form id="addStudentForm" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">NISN</label>
                <input type="text" id="studentNisn" required maxlength="10" class="w-full px-4 py-3 border border-gray-200 rounded-xl" placeholder="10 digit NISN">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                <input type="text" id="studentName" required class="w-full px-4 py-3 border border-gray-200 rounded-xl" placeholder="Nama lengkap siswa">
            </div>
            <div class="grid grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">L/P</label>
                    <select id="studentGender" required class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                        <option value="L">Laki-laki</option>
                        <option value="P">Perempuan</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                    <input type="text" id="studentClass" required class="w-full px-4 py-3 border border-gray-200 rounded-xl" placeholder="7">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Rombel</label>
                    <input type="text" id="studentRombel" required class="w-full px-4 py-3 border border-gray-200 rounded-xl" placeholder="A">
                </div>
            </div>
            <div class="flex gap-3 pt-4">
                <button type="button" onclick="closeModal()" class="flex-1 py-3 border border-gray-200 rounded-xl font-medium hover:bg-gray-50">Batal</button>
                <button type="submit" class="flex-1 py-3 bg-primary text-white rounded-xl font-medium hover:bg-secondary">Simpan</button>
            </div>
        </form>
    `;
    showModal(content, { title: 'Tambah Siswa' });
    document.getElementById('addStudentForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        await addStudent();
    });
}

async function addStudent() {
    if (!currentUser) return;
    try {
        await db.collection('users').doc(currentUser.uid).collection('students').add({
            nisn: document.getElementById('studentNisn').value,
            nama_siswa: document.getElementById('studentName').value,
            jenis_kelamin: document.getElementById('studentGender').value,
            kelas: document.getElementById('studentClass').value,
            rombel: document.getElementById('studentRombel').value,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        closeModal();
        showToast('success', 'Berhasil', 'Siswa berhasil ditambahkan');
        await loadStudents();
    } catch (error) {
        showToast('error', 'Gagal', 'Tidak dapat menyimpan siswa');
        console.error(error);
    }
}

function showTimeSettingsModal() {
    const content = `
        <div class="space-y-4">
            <p class="text-gray-600">Pengaturan jam pelajaran default:</p>
            <div class="max-h-64 overflow-y-auto space-y-2">
                ${timeSlots.map((slot, i) => `
                    <div class="flex items-center gap-4 p-3 bg-gray-50 rounded-lg">
                        <span class="w-16 font-semibold text-gray-700">Jam ${i + 1}</span>
                        <span class="text-gray-600">${slot.start} - ${slot.end}</span>
                    </div>
                `).join('')}
            </div>
            <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                <p class="text-sm text-blue-700"><i class="fas fa-info-circle mr-2"></i>Fitur kustomisasi jam akan tersedia di versi berikutnya.</p>
            </div>
            <button onclick="closeModal()" class="w-full py-3 bg-primary text-white rounded-xl font-medium hover:bg-secondary">Tutup</button>
        </div>
    `;
    showModal(content, { title: 'Pengaturan Jam Pelajaran' });
}

function showAddScheduleModal() {
    if (classes.length === 0) {
        showToast('warning', 'Perhatian', 'Tambahkan kelas terlebih dahulu');
        return;
    }
    
    const days = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
    const content = `
        <form id="addScheduleForm" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Hari</label>
                <select id="scheduleDay" required class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                    ${days.map(d => `<option value="${d}">${d}</option>`).join('')}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Jam Ke</label>
                <select id="scheduleSlot" required class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                    ${timeSlots.map(s => `<option value="${s.id}">Jam ${s.id} (${s.start} - ${s.end})</option>`).join('')}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                <select id="scheduleClassFull" required class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                    ${classes.map(c => `<option value="${c.name}">${c.name}</option>`).join('')}
                </select>
            </div>
            <div class="flex gap-3 pt-4">
                <button type="button" onclick="closeModal()" class="flex-1 py-3 border border-gray-200 rounded-xl font-medium hover:bg-gray-50">Batal</button>
                <button type="submit" class="flex-1 py-3 bg-primary text-white rounded-xl font-medium hover:bg-secondary">Simpan</button>
            </div>
        </form>
    `;
    showModal(content, { title: 'Tambah Jadwal' });
    document.getElementById('addScheduleForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const day = document.getElementById('scheduleDay').value;
        const slotId = parseInt(document.getElementById('scheduleSlot').value);
        
        // Check conflict
        const existing = schedules.find(s => s.day === day && s.slotId === slotId);
        if (existing) {
            showToast('error', 'Konflik', `Jam tersebut sudah diisi oleh ${existing.className}`);
            return;
        }
        
        await saveScheduleFull(day, slotId);
    });
}

async function saveScheduleFull(day, slotId) {
    if (!currentUser) return;
    const slot = timeSlots.find(s => s.id === slotId);
    try {
        await db.collection('users').doc(currentUser.uid).collection('schedules').add({
            day,
            slotId,
            className: document.getElementById('scheduleClassFull').value,
            startTime: slot.start,
            endTime: slot.end,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        closeModal();
        showToast('success', 'Berhasil', 'Jadwal berhasil ditambahkan');
        await loadSchedules();
        renderScheduleTable();
    } catch (error) {
        showToast('error', 'Gagal', 'Tidak dapat menyimpan jadwal');
    }
}

function showAddCPModal() {
    const content = `
        <div class="space-y-4">
            <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4">
                <p class="text-sm text-yellow-700"><i class="fas fa-info-circle mr-2"></i>
                    CP PAI & Budi Pekerti sudah tersedia secara default. Fitur ini untuk guru mata pelajaran lain yang ingin menambahkan CP secara manual.
                </p>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label>
                <input type="text" id="cpMapel" class="w-full px-4 py-3 border border-gray-200 rounded-xl" placeholder="Contoh: Matematika">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Fase</label>
                <select id="cpFase" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                    ${Object.keys(CP_PAI_DEFAULT).map(f => `<option value="${f}">Fase ${f}</option>`).join('')}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Elemen</label>
                <input type="text" id="cpElemen" class="w-full px-4 py-3 border border-gray-200 rounded-xl" placeholder="Nama elemen CP">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi CP</label>
                <textarea id="cpDeskripsi" rows="3" class="w-full px-4 py-3 border border-gray-200 rounded-xl" placeholder="Deskripsi capaian pembelajaran..."></textarea>
            </div>
            <div class="flex gap-3 pt-4">
                <button type="button" onclick="closeModal()" class="flex-1 py-3 border border-gray-200 rounded-xl font-medium hover:bg-gray-50">Batal</button>
                <button type="button" onclick="saveCustomCP()" class="flex-1 py-3 bg-primary text-white rounded-xl font-medium hover:bg-secondary">Simpan</button>
            </div>
        </div>
    `;
    showModal(content, { title: 'Tambah Capaian Pembelajaran' });
}

async function saveCustomCP() {
    if (!currentUser) return;
    try {
        await db.collection('users').doc(currentUser.uid).collection('custom_cp').add({
            mata_pelajaran: document.getElementById('cpMapel').value,
            fase: document.getElementById('cpFase').value,
            elemen: document.getElementById('cpElemen').value,
            deskripsi: document.getElementById('cpDeskripsi').value,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        closeModal();
        showToast('success', 'Berhasil', 'CP berhasil ditambahkan');
    } catch (error) {
        showToast('error', 'Gagal', 'Tidak dapat menyimpan CP');
    }
}

// Logout Function
async function logout() {
    try {
        await auth.signOut();
        localStorage.clear();
        window.location.href = 'index.html';
    } catch (error) {
        showToast('error', 'Gagal', 'Tidak dapat keluar');
    }
}

// ==========================================
// AUTH STATE & INITIALIZATION
// ==========================================
auth.onAuthStateChanged(async (user) => {
    if (user) {
        currentUser = user;
        
        try {
            const userDoc = await db.collection('users').doc(user.uid).get();
            
            if (userDoc.exists) {
                userData = userDoc.data();
                
                // Update UI
                document.getElementById('userName').textContent = userData.name || user.displayName || 'Guru';
                document.getElementById('userInitial').textContent = (userData.name || user.displayName || 'G').charAt(0).toUpperCase();
                document.getElementById('headerUserInitial').textContent = (userData.name || user.displayName || 'G').charAt(0).toUpperCase();
                document.getElementById('userSubscription').textContent = userData.subscription === 'premium' ? 'Premium' : userData.subscription === 'school' ? 'Sekolah' : 'Free';
                document.getElementById('userRole').textContent = userData.role === 'superadmin' ? 'Admin' : 'Guru';
                
                // Show admin menu for super admin
                if (userData.role === 'superadmin' || user.email === SUPER_ADMIN_EMAIL) {
                    document.getElementById('adminMenu').classList.remove('hidden');
                    if (!userData.role || userData.role !== 'superadmin') {
                        // Update role in database
                        await db.collection('users').doc(user.uid).update({ role: 'superadmin' });
                        userData.role = 'superadmin';
                    }
                }
                
                // Hide loading and load dashboard
                document.getElementById('loadingOverlay').classList.add('hidden');
                loadPage('dashboard');
                
            } else {
                // Create new user document
                const newUserData = {
                    name: user.displayName || '',
                    email: user.email,
                    role: user.email === SUPER_ADMIN_EMAIL ? 'superadmin' : 'guru',
                    subscription: 'free',
                    subscriptionExpiry: null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    profile: {
                        satuan_pendidikan: '',
                        nama_kepala_sekolah: '',
                        nip: '',
                        nuptk: '',
                        mata_pelajaran: 'PAI & Budi Pekerti',
                        jenjang: '',
                        fase: ''
                    }
                };
                
                await db.collection('users').doc(user.uid).set(newUserData);
                userData = newUserData;
                
                document.getElementById('loadingOverlay').classList.add('hidden');
                loadPage('dashboard');
                
                showToast('success', 'Selamat Datang!', 'Silakan lengkapi profil Anda');
            }
        } catch (error) {
            console.error('Error loading user data:', error);
            document.getElementById('loadingOverlay').classList.add('hidden');
            showToast('error', 'Error', 'Gagal memuat data pengguna: ' + error.message);
        }
    } else {
        // Not logged in - redirect to login page
        window.location.href = 'index.html';
    }
});

// Prevent flash of content
document.addEventListener('DOMContentLoaded', function() {
    // Loading overlay is shown by default
    console.log('Admin Guru Super App v1.0 - Ready');
});
    </script>
</body>
</html>